{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{{ encuesta.titulo }}{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-md-10 mx-auto">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0">{{ encuesta.titulo }}</h2>
                </div>
                <div class="card-body">
                    {% if encuesta.descripcion %}
                    <div class="alert alert-info">
                        {{ encuesta.descripcion }}
                    </div>
                    {% endif %}
                    
                    <form method="post" id="encuestaForm">
                        {% csrf_token %}
                        
                        {% if messages %}
                        <div class="messages">
                            {% for message in messages %}
                            <div{% if message.tags %} class="alert alert-{{ message.tags }}"{% endif %}>
                                {{ message }}
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        {% for seccion in secciones %}
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h4 class="mb-0">{{ seccion }}</h4>
                            </div>
                            <div class="card-body">
                                {% for item in todas_preguntas %}
                                {% if item.seccion == seccion %}
                                <div class="pregunta mb-4 p-3 {% if item.pregunta.requerida %}border-left border-danger{% endif %}">
                                    <div class="pregunta-texto">
                                        <h5>
                                            {{ item.pregunta.texto }}
                                            {% if item.pregunta.requerida %}
                                            <span class="text-danger">*</span>
                                            {% endif %}
                                        </h5>
                                        {% if item.pregunta.ayuda %}
                                        <small class="text-muted">{{ item.pregunta.ayuda }}</small>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="pregunta-formulario mt-3">
                                        {% if item.tipo == 'texto' %}
                                            {{ item.formulario.respuesta }}
                                            {% if item.formulario.respuesta.errors %}
                                            <div class="text-danger">{{ item.formulario.respuesta.errors }}</div>
                                            {% endif %}
                                        
                                        {% elif item.tipo == 'texto_multiple' %}
                                            {{ item.formulario.respuesta }}
                                            {% if item.formulario.respuesta.errors %}
                                            <div class="text-danger">{{ item.formulario.respuesta.errors }}</div>
                                            {% endif %}
                                        
                                        {% elif item.tipo == 'opcion_multiple' %}
                                            <div class="opciones">
                                                {% for radio in item.formulario.opcion %}
                                                <div class="form-check">
                                                    {{ radio.tag }}
                                                    <label class="form-check-label" for="{{ radio.id_for_label }}">
                                                        {{ radio.choice_label }}
                                                    </label>
                                                </div>
                                                {% endfor %}
                                                
                                                {% if item.formulario.opcion_otro %}
                                                <div class="form-check">
                                                    <input type="radio" name="{{ item.formulario.prefix }}-opcion" 
                                                           id="{{ item.formulario.prefix }}-opcion-otro" value="otro" 
                                                           class="form-check-input opcion-otro-radio">
                                                    <label class="form-check-label" for="{{ item.formulario.prefix }}-opcion-otro">
                                                        Otro:
                                                    </label>
                                                    {{ item.formulario.texto_otro }}
                                                </div>
                                                {% endif %}
                                            </div>
                                            
                                            {% if item.formulario.opcion.errors %}
                                            <div class="text-danger">{{ item.formulario.opcion.errors }}</div>
                                            {% endif %}
                                        
                                        {% elif item.tipo == 'casillas' %}
                                            <div class="opciones">
                                                {% for checkbox in item.formulario.opciones %}
                                                <div class="form-check">
                                                    {{ checkbox.tag }}
                                                    <label class="form-check-label" for="{{ checkbox.id_for_label }}">
                                                        {{ checkbox.choice_label }}
                                                    </label>
                                                </div>
                                                {% endfor %}
                                                
                                                {% if item.formulario.opcion_otro %}
                                                <div class="form-check">
                                                    <input type="checkbox" name="{{ item.formulario.prefix }}-opcion_otro" 
                                                           id="{{ item.formulario.prefix }}-opcion_otro" 
                                                           class="form-check-input opcion-otro-checkbox">
                                                    <label class="form-check-label" for="{{ item.formulario.prefix }}-opcion_otro">
                                                        Otro:
                                                    </label>
                                                    {{ item.formulario.texto_otro }}
                                                </div>
                                                {% endif %}
                                            </div>
                                            
                                            {% if item.formulario.opciones.errors %}
                                            <div class="text-danger">{{ item.formulario.opciones.errors }}</div>
                                            {% endif %}
                                        
                                        {% elif item.tipo == 'menu' %}
                                            {{ item.formulario.opcion }}
                                            {% if item.formulario.opcion.errors %}
                                            <div class="text-danger">{{ item.formulario.opcion.errors }}</div>
                                            {% endif %}
                                        
                                        {% elif item.tipo == 'estrellas' %}
                                            <div class="estrellas-container">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span class="etiqueta-inicio">{{ item.formulario.etiqueta_inicio }}</span>
                                                    <span class="etiqueta-fin">{{ item.formulario.etiqueta_fin }}</span>
                                                </div>
                                                <div class="stars-rating">
                                                    <input type="range" name="{{ item.formulario.prefix }}-valor" 
                                                           min="1" max="{{ item.formulario.max_estrellas }}" value="0" 
                                                           class="form-control-range star-rating-input">
                                                    <div class="star-rating-display">
                                                        {% for i in "12345" %}
                                                        {% if forloop.counter <= item.formulario.max_estrellas %}
                                                        <span class="star" data-value="{{ forloop.counter }}">★</span>
                                                        {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                {% if item.formulario.valor.errors %}
                                                <div class="text-danger">{{ item.formulario.valor.errors }}</div>
                                                {% endif %}
                                            </div>
                                        
                                        {% elif item.tipo == 'escala' %}
                                            <div class="escala-container">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span class="etiqueta-min">{{ item.formulario.etiqueta_min }}</span>
                                                    <span class="etiqueta-max">{{ item.formulario.etiqueta_max }}</span>
                                                </div>
                                                {{ item.formulario.valor }}
                                                <div class="escala-valores d-flex justify-content-between mt-1">
                                                    {% with min=item.formulario.min_valor max=item.formulario.max_valor %}
                                                    {% for i in "0123456789" %}
                                                    {% if forloop.counter0|add:min <= max %}
                                                    <span class="escala-valor">{{ forloop.counter0|add:min }}</span>
                                                    {% endif %}
                                                    {% endfor %}
                                                    {% endwith %}
                                                </div>
                                                {% if item.formulario.valor.errors %}
                                                <div class="text-danger">{{ item.formulario.valor.errors }}</div>
                                                {% endif %}
                                            </div>
                                        
                                        {% elif item.tipo == 'matriz' %}
                                            <div class="matriz-container table-responsive">
                                                <table class="table table-bordered">
                                                    <thead>
                                                        <tr>
                                                            <th></th>
                                                            <th colspan="{{ item.formulario.escala.max_valor|add:1|sub:item.formulario.escala.min_valor }}" 
                                                                class="text-center">
                                                                {{ item.formulario.escala.etiqueta_min }} - {{ item.formulario.escala.etiqueta_max }}
                                                            </th>
                                                        </tr>
                                                        <tr>
                                                            <th></th>
                                                            {% with min=item.formulario.escala.min_valor max=item.formulario.escala.max_valor %}
                                                            {% for i in "0123456789" %}
                                                            {% if forloop.counter0|add:min <= max %}
                                                            <th class="text-center">{{ forloop.counter0|add:min }}</th>
                                                            {% endif %}
                                                            {% endfor %}
                                                            {% endwith %}
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for item_matriz in item.formulario.items %}
                                                        <tr>
                                                            <td>{{ item_matriz.texto }}</td>
                                                            {% with min=item.formulario.escala.min_valor max=item.formulario.escala.max_valor %}
                                                            {% for i in "0123456789" %}
                                                            {% if forloop.counter0|add:min <= max %}
                                                            <td class="text-center">
                                                                <input type="radio" 
                                                                       name="{{ item.formulario.prefix }}-item_{{ item_matriz.id }}" 
                                                                       value="{{ forloop.counter0|add:min }}">
                                                            </td>
                                                            {% endif %}
                                                            {% endfor %}
                                                            {% endwith %}
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                                {% for field_name, errors in item.formulario.errors.items %}
                                                {% if errors %}
                                                <div class="text-danger">{{ errors }}</div>
                                                {% endif %}
                                                {% endfor %}
                                            </div>
                                        
                                        {% elif item.tipo == 'fecha' %}
                                            {{ item.formulario.valor }}
                                            {% if item.formulario.valor.errors %}
                                            <div class="text-danger">{{ item.formulario.valor.errors }}</div>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- Preguntas sin sección -->
                        <div class="mb-4">
                            {% for item in todas_preguntas %}
                            {% if not item.seccion %}
                            <div class="pregunta mb-4 p-3 {% if item.pregunta.requerida %}border-left border-danger{% endif %}">
                                <div class="pregunta-texto">
                                    <h5>
                                        {{ item.pregunta.texto }}
                                        {% if item.pregunta.requerida %}
                                        <span class="text-danger">*</span>
                                        {% endif %}
                                    </h5>
                                    {% if item.pregunta.ayuda %}
                                    <small class="text-muted">{{ item.pregunta.ayuda }}</small>
                                    {% endif %}
                                </div>
                                
                                <div class="pregunta-formulario mt-3">
                                    <!-- Mismo contenido que arriba para cada tipo de pregunta -->
                                    {% if item.tipo == 'texto' %}
                                        {{ item.formulario.respuesta }}
                                        {% if item.formulario.respuesta.errors %}
                                        <div class="text-danger">{{ item.formulario.respuesta.errors }}</div>
                                        {% endif %}
                                    {% elif item.tipo == 'texto_multiple' %}
                                        {{ item.formulario.respuesta }}
                                        {% if item.formulario.respuesta.errors %}
                                        <div class="text-danger">{{ item.formulario.respuesta.errors }}</div>
                                        {% endif %}
                                    <!-- Repetir el mismo patrón para los demás tipos -->
                                    <!-- ... -->
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">Enviar Respuestas</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template para la página de encuesta completada -->
{% endblock %}

{% block extra_js %}
<script>
    // Script para manejar estrellas y control de opciones "Otro"
    document.addEventListener('DOMContentLoaded', function() {
        // Manejo de valoración con estrellas
        const starRatingInputs = document.querySelectorAll('.star-rating-input');
        starRatingInputs.forEach(input => {
            const starsContainer = input.nextElementSibling;
            const stars = starsContainer.querySelectorAll('.star');
            
            // Actualizar estrellas al cambiar el valor
            input.addEventListener('input', function() {
                const value = parseInt(this.value);
                stars.forEach(star => {
                    const starValue = parseInt(star.dataset.value);
                    if (starValue <= value) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });
            });
            
            // Permitir hacer clic en las estrellas
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const value = parseInt(this.dataset.value);
                    input.value = value;
                    input.dispatchEvent(new Event('input'));
                });
            });
        });
        
        // Manejar opción "Otro" en radio buttons
        const otroRadios = document.querySelectorAll('.opcion-otro-radio');
        otroRadios.forEach(radio => {
            const textoOtro = radio.parentNode.querySelector('input[type="text"]');
            
            radio.addEventListener('change', function() {
                if (this.checked) {
                    textoOtro.focus();
                }
            });
            
            textoOtro.addEventListener('focus', function() {
                radio.checked = true;
            });
        });
        
        // Manejar opción "Otro" en checkboxes
        const otroCheckboxes = document.querySelectorAll('.opcion-otro-checkbox');
        otroCheckboxes.forEach(checkbox => {
            const textoOtro = checkbox.parentNode.querySelector('input[type="text"]');
            
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    textoOtro.focus();
                } else {
                    textoOtro.value = '';
                }
            });
            
            textoOtro.addEventListener('focus', function() {
                checkbox.checked = true;
            });
            
            textoOtro.addEventListener('blur', function() {
                if (!this.value) {
                    checkbox.checked = false;
                }
            });
        });
    });
</script>
<style>
    /* Estilos para las encuestas */

/* Estilo general para preguntas */
.pregunta {
    position: relative;
    background-color: #f9f9f9;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.pregunta:hover {
    background-color: #f0f0f0;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.pregunta.border-left {
    border-left: 4px solid #dc3545 !important;
}

/* Estrellas de valoración */
.stars-rating {
    position: relative;
}

.star-rating-input {
    position: absolute;
    width: 100%;
    height: 30px;
    opacity: 0;
    cursor: pointer;
    z-index: 10;
}

.star-rating-display {
    display: flex;
    justify-content: space-between;
    font-size: 2rem;
    padding: 0 10px;
}

.star {
    color: #ccc;
    cursor: pointer;
    transition: color 0.2s ease;
}

.star:hover, .star.active {
    color: #ffc107;
}

/* Estilos para escalas */
.escala-container {
    padding: 10px 0;
}

.escala-valores {
    margin-top: 5px;
    font-size: 0.8rem;
    color: #666;
}

input[type="range"] {
    width: 100%;
    cursor: pointer;
}

/* Matriz de preguntas */
.matriz-container th {
    background-color: #f8f9fa;
}

.matriz-container td {
    vertical-align: middle;
}

/* Estilos para campos requeridos */
.text-danger {
    font-size: 0.9rem;
    margin-top: 5px;
}

/* Campos "otro" */
.form-check input[type="text"] {
    margin-left: 5px;
    display: inline-block;
    width: auto;
}

/* Mensaje de ayuda */
.pregunta small.text-muted {
    display: block;
    margin-top: 5px;
    font-style: italic;
}

/* Estilos para secciones */
.card-header h4 {
    font-weight: 500;
}

/* Estilos responsive */
@media (max-width: 768px) {
    .matriz-container {
        font-size: 0.85rem;
    }
    
    .star-rating-display {
        font-size: 1.5rem;
    }
    
    .escala-valores {
        font-size: 0.7rem;
    }
}
</style>
{% endblock %}