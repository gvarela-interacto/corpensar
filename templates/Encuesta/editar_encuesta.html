{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="container mt-4">
    <h2>Editar Encuesta: {{ encuesta.titulo }}</h2>
    
    <div class="card mt-4">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs">
                <li class="nav-item">
                    <a class="nav-link active" href="#configuracion" data-toggle="tab">Configuración</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#preguntas" data-toggle="tab">Preguntas</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#diseno" data-toggle="tab">Diseño</a>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content">
                <div class="tab-pane active" id="configuracion">
                    <form method="post" id="formConfiguracion">
                        {% csrf_token %}
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-light py-3">
                                <h5 class="mb-0"><i class="fas fa-cog me-2 text-primary"></i>Información básica</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="id_titulo" class="form-label fw-bold">{{ form.titulo.label }}</label>
                                            <input type="text" name="titulo" id="id_titulo" class="form-control rounded-3" value="{{ form.titulo.value|default:'' }}" maxlength="200" required>
                                            {% if form.titulo.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.titulo.errors }}
                                                </div>
                                            {% endif %}
                                            <div class="form-text">Elige un título claro y conciso para tu encuesta.</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="id_tema" class="form-label fw-bold">{{ form.tema.label }}</label>
                                            <select name="tema" id="id_tema" class="form-select rounded-3">
                                                {% for value, text in form.tema.field.choices %}
                                                    <option value="{{ value }}" {% if form.tema.value == value %}selected{% endif %}>{{ text }}</option>
                                                {% endfor %}
                                            </select>
                                            <div class="form-text">El tema determina los colores principales de tu encuesta.</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="id_region" class="form-label fw-bold">{{ form.region.label }}</label>
                                            <select name="region" id="id_region" class="form-control rounded-3">
                                                <option value="">Selecciona una región</option>
                                                {% for region in regiones %}
                                                    <option value="{{ region.id }}" {% if form.region.value == region.id %}selected{% endif %}>{{ region.nombre }}</option>
                                                {% endfor %}
                                            </select>
                                            {% if form.region.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.region.errors }}
                                                </div>
                                            {% endif %}
                                            <div class="form-text">{{ form.region.help_text }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="id_categoria" class="form-label fw-bold">Categoría</label>
                                            <select name="categoria" id="id_categoria" class="form-select rounded-3">
                                                <option value="">Selecciona una categoría</option>
                                                {% for categoria in categorias %}
                                                    <option value="{{ categoria.id }}" {% if form.categoria.value == categoria.id %}selected{% endif %}>{{ categoria.nombre }}</option>
                                                {% endfor %}
                                            </select>
                                            <div class="form-text">Selecciona la categoría a la que pertenece la encuesta</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group mb-3">
                                    <label for="id_descripcion" class="form-label fw-bold">{{ form.descripcion.label }}</label>
                                    <textarea name="descripcion" id="id_descripcion" class="form-control rounded-3" rows="3" style="min-height: 100px;">{{ form.descripcion.value|default:'' }}</textarea>
                                    <div class="form-text">Añade detalles sobre el propósito de la encuesta y otra información relevante.</div>
                                </div>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-light py-3">
                                <h5 class="mb-0"><i class="fas fa-calendar-alt me-2 text-primary"></i>Duración</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="id_fecha_inicio" class="form-label fw-bold">{{ form.fecha_inicio.label }}</label>
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                                <input type="datetime-local" 
                                                    name="fecha_inicio" 
                                                    id="id_fecha_inicio"
                                                    class="form-control rounded-end" 
                                                    value="{{ encuesta.fecha_inicio|date:'Y-m-d\TH:i' }}"
                                                    required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="id_fecha_fin" class="form-label fw-bold">{{ form.fecha_fin.label }}</label>
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                                <input type="datetime-local" 
                                                    name="fecha_fin" 
                                                    id="id_fecha_fin"
                                                    class="form-control rounded-end" 
                                                    value="{{ encuesta.fecha_fin|date:'Y-m-d\TH:i' }}"
                                                    required>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-light py-3">
                                <h5 class="mb-0"><i class="fas fa-sliders-h me-2 text-primary"></i>Opciones</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch mb-3">
                                            <div class="d-flex flex-column">
                                                <div class="d-flex align-items-center">
                                                    <input type="checkbox" 
                                                        name="activa" 
                                                        id="id_activa" 
                                                        class="form-check-input me-2"
                                                        role="switch"
                                                        {% if form.activa.value %}checked{% endif %}>
                                                    <label class="form-check-label fw-bold mb-0" for="id_activa">
                                                        {{ form.activa.label }}
                                                    </label>
                                                </div>
                                                <div class="form-text ms-4 mt-1">
                                                    Si está activa, los usuarios podrán responder a la encuesta.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch mb-3">
                                            <div class="d-flex flex-column">
                                                <div class="d-flex align-items-center">
                                                    <input type="checkbox" 
                                                        name="es_publica" 
                                                        id="id_es_publica" 
                                                        class="form-check-input me-2"
                                                        role="switch"
                                                        {% if form.es_publica.value %}checked{% endif %}>
                                                    <label class="form-check-label fw-bold mb-0" for="id_es_publica">
                                                        {{ form.es_publica.label }}
                                                    </label>
                                                </div>
                                                <div class="form-text ms-4 mt-1">
                                                    {{ form.es_publica.help_text }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button type="submit" class="btn btn-primary rounded-3 px-4">
                                <i class="fas fa-save me-2"></i> Guardar Cambios
                            </button>
                            <div>
                                <a href="{% url 'duplicar_encuesta' encuesta.id %}" class="btn btn-info rounded-3 px-4 me-2">
                                    <i class="fas fa-copy me-2"></i> Duplicar
                                </a>
                                <button type="button" class="btn btn-danger rounded-3 px-4" data-toggle="modal" data-target="#modalEliminarEncuesta">
                                    <i class="fas fa-trash me-2"></i> Eliminar Encuesta
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="tab-pane" id="preguntas">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="mb-0"><i class="fas fa-question-circle text-primary me-2"></i>Preguntas de la encuesta</h4>
                        <button type="button" class="btn btn-primary rounded-3 px-4" data-toggle="modal" data-target="#modalAgregarPregunta">
                            <i class="fas fa-plus me-2"></i> Agregar Pregunta
                        </button>
                    </div>
                    
                    {% if preguntas %}
                        <div class="row">
                            {% for pregunta in preguntas %}
                                <div class="col-md-6 mb-3 pregunta-{{ pregunta.id }}" data-seccion="{{ pregunta.seccion|default:'General' }}">
                                    <div class="card shadow-sm hover-card h-100">
                                        <div class="card-header d-flex justify-content-between align-items-center" style="background-color:#4361ee ;">
                                            <h5 class="card-title mb-0" style="color: white; font-weight: bold;">{{ pregunta.texto }}</h5>
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-sm btn-light edit-question-btn" 
                                                        data-bs-toggle="tooltip" data-bs-placement="top" title="Editar pregunta"
                                                        data-question-id="{{ pregunta.id }}" data-question-text="{{ pregunta.texto }}">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-danger delete-question-btn" 
                                                        data-bs-toggle="tooltip" data-bs-placement="top" title="Eliminar pregunta"
                                                        data-question-id="{{ pregunta.id }}" data-question-text="{{ pregunta.texto }}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <h5 class="card-title mb-3 fw-bold text-truncate">{{ pregunta.texto }}</h5>
                                            <div class="d-flex justify-content-between">
                                                <p class="card-text text-muted small">
                                                    <i class="fas fa-sort-numeric-down me-1"></i> Orden: {{ pregunta.orden }}
                                                </p>
                                                <p class="card-text text-muted small">
                                                    <i class="fas fa-layer-group me-1"></i> Sección: {{ pregunta.seccion|default:'General' }}
                                                </p>
                                            </div>
                                            
                                            {% if pregunta.ayuda %}
                                            <div class="alert alert-light mb-3 py-2 small">
                                                <i class="fas fa-info-circle text-primary me-1"></i> 
                                                {{ pregunta.ayuda }}
                                            </div>
                                            {% endif %}
                                            
                                            {% if pregunta.tipo == 'RADIO' or pregunta.tipo == 'CHECK' or pregunta.tipo == 'SELECT' %}
                                                <div class="mt-2">
                                                    <small class="text-muted fw-bold mb-2 d-block">Opciones:</small>
                                                    <div class="list-group list-group-flush">
                                                        {% for opcion in pregunta.opciones.all|slice:":3" %}
                                                            <div class="list-group-item border-0 py-1 px-0 small">
                                                                <i class="fas fa-circle fa-xs text-primary me-2"></i>{{ opcion.texto }}
                                                            </div>
                                                        {% endfor %}
                                                        {% if pregunta.opciones.count > 3 %}
                                                            <div class="list-group-item border-0 py-1 px-0 small text-muted">
                                                                <i class="fas fa-ellipsis-h me-2"></i>{{ pregunta.opciones.count|add:"-3" }} opciones más
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="card-footer bg-white border-0">
                                            <div class="d-flex justify-content-end">
                                                <button type="button" class="btn btn-outline-primary btn-sm me-2 rounded-3" data-toggle="modal" data-target="#modalEditarPregunta{{ pregunta.id }}">
                                                    <i class="fas fa-edit me-1"></i> Editar
                                                </button>
                                                <button type="button" class="btn btn-outline-danger btn-sm rounded-3" data-toggle="modal" data-target="#modalEliminarPregunta{{ pregunta.id }}">
                                                    <i class="fas fa-trash me-1"></i> Eliminar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="card border-0 shadow-sm">
                            <div class="card-body text-center py-5">
                                <i class="fas fa-info-circle fa-3x text-primary mb-3"></i>
                                <h5 class="mb-3">No hay preguntas en esta encuesta</h5>
                                <p class="text-muted mb-4">Agrega una pregunta para comenzar a crear tu encuesta.</p>
                                <button type="button" class="btn btn-primary rounded-3 px-4" data-toggle="modal" data-target="#modalAgregarPregunta">
                                    <i class="fas fa-plus me-2"></i> Agregar Primera Pregunta
                                </button>
                            </div>
                        </div>
                    {% endif %}
                </div>
                <div class="tab-pane" id="diseno">
                    <h4 class="mb-4">Personalización de Diseño</h4>
                    <form method="post" id="formDiseno" enctype="multipart/form-data" action="{% url 'actualizar_diseno' encuesta.id %}">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0">Tema de colores</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-group">
                                            <label for="tema" class="form-label">Selecciona un tema</label>
                                            <select class="form-select" id="tema" name="tema">
                                                <option value="default" {% if encuesta.tema == 'default' %}selected{% endif %}>Tema por defecto</option>
                                                <option value="azul" {% if encuesta.tema == 'azul' %}selected{% endif %}>Tema Azul</option>
                                                <option value="verde" {% if encuesta.tema == 'verde' %}selected{% endif %}>Tema Verde</option>
                                                <option value="rojo" {% if encuesta.tema == 'rojo' %}selected{% endif %}>Tema Rojo</option>
                                                <option value="morado" {% if encuesta.tema == 'morado' %}selected{% endif %}>Tema Morado</option>
                                                <option value="naranja" {% if encuesta.tema == 'naranja' %}selected{% endif %}>Tema Naranja</option>
                                                <option value="turquesa" {% if encuesta.tema == 'turquesa' %}selected{% endif %}>Tema Turquesa</option>
                                                <option value="rosa" {% if encuesta.tema == 'rosa' %}selected{% endif %}>Tema Rosa</option>
                                                <option value="esmeralda" {% if encuesta.tema == 'esmeralda' %}selected{% endif %}>Tema Esmeralda</option>
                                                <option value="indigo" {% if encuesta.tema == 'indigo' %}selected{% endif %}>Tema Índigo</option>
                                                <option value="cielo" {% if encuesta.tema == 'cielo' %}selected{% endif %}>Tema Cielo</option>
                                                <option value="coral" {% if encuesta.tema == 'coral' %}selected{% endif %}>Tema Coral</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <div class="tema-preview" id="tema-preview">
                                                <div class="preview-header"></div>
                                                <div class="preview-body">
                                                    <div class="preview-text"></div>
                                                    <div class="preview-button"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0">Imagen de encabezado</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-group">
                                            <label class="form-label">Imagen actual</label>
                                            <div id="header-image-preview" class="mb-3">
                                                {% if encuesta.imagen_encabezado %}
                                                    <img src="{{ encuesta.imagen_encabezado.url }}" alt="Imagen de encabezado" class="img-fluid img-thumbnail">
                                                {% else %}
                                                    <div class="alert alert-light text-center py-5">
                                                        <i class="fas fa-image fa-3x mb-3 text-muted"></i>
                                                        <p class="mb-0">No hay imagen de encabezado</p>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="imagen_encabezado" class="form-label">Subir nueva imagen</label>
                                                <input type="file" class="form-control" id="imagen_encabezado" name="imagen_encabezado" accept="image/*">
                                                <div class="form-text">Recomendado: 1200x300 píxeles (JPG, PNG o GIF)</div>
                                            </div>
                                            
                                            {% if encuesta.imagen_encabezado %}
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="eliminar_imagen" name="eliminar_imagen">
                                                <label class="form-check-label" for="eliminar_imagen">Eliminar imagen actual</label>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0">Logotipo</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-group">
                                            <label class="form-label">Logotipo actual</label>
                                            <div id="logo-preview" class="mb-3">
                                                {% if encuesta.logotipo %}
                                                    <img src="{{ encuesta.logotipo.url }}" alt="Logotipo" class="img-fluid img-thumbnail" style="max-height: 100px;">
                                                {% else %}
                                                    <div class="alert alert-light text-center py-4">
                                                        <i class="fas fa-image fa-2x mb-2 text-muted"></i>
                                                        <p class="mb-0">No hay logotipo</p>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="logotipo" class="form-label">Subir nuevo logotipo</label>
                                                <input type="file" class="form-control" id="logotipo" name="logotipo" accept="image/*">
                                                <div class="form-text">Recomendado: formato cuadrado o rectangular (JPG, PNG o GIF)</div>
                                            </div>
                                            
                                            {% if encuesta.logotipo %}
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="eliminar_logo" name="eliminar_logo">
                                                <label class="form-check-label" for="eliminar_logo">Eliminar logotipo actual</label>
                                            </div>
                                            {% endif %}
                                            
                                            <div class="form-check mt-3">
                                                <input type="checkbox" class="form-check-input" id="mostrar_logo" name="mostrar_logo" {% if encuesta.mostrar_logo %}checked{% endif %}>
                                                <label class="form-check-label" for="mostrar_logo">Mostrar logotipo en la encuesta</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0">Estilo y fuentes</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-group mb-3">
                                            <label for="estilo_fuente" class="form-label">Estilo de fuente</label>
                                            <select class="form-select" id="estilo_fuente" name="estilo_fuente">
                                                <option value="default" {% if encuesta.estilo_fuente == 'default' %}selected{% endif %}>Por defecto</option>
                                                <option value="serif" {% if encuesta.estilo_fuente == 'serif' %}selected{% endif %}>Serif</option>
                                                <option value="sans-serif" {% if encuesta.estilo_fuente == 'sans-serif' %}selected{% endif %}>Sans-serif</option>
                                                <option value="monospace" {% if encuesta.estilo_fuente == 'monospace' %}selected{% endif %}>Monospace</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group mb-3">
                                            <label for="tamano_fuente" class="form-label">Tamaño de fuente</label>
                                            <select class="form-select" id="tamano_fuente" name="tamano_fuente">
                                                <option value="normal" {% if encuesta.tamano_fuente == 'normal' %}selected{% endif %}>Normal</option>
                                                <option value="grande" {% if encuesta.tamano_fuente == 'grande' %}selected{% endif %}>Grande</option>
                                                <option value="pequeno" {% if encuesta.tamano_fuente == 'pequeno' %}selected{% endif %}>Pequeño</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="estilo_bordes" class="form-label">Estilo de bordes</label>
                                            <select class="form-select" id="estilo_bordes" name="estilo_bordes">
                                                <option value="redondeado" {% if encuesta.estilo_bordes == 'redondeado' %}selected{% endif %}>Redondeado</option>
                                                <option value="cuadrado" {% if encuesta.estilo_bordes == 'cuadrado' %}selected{% endif %}>Cuadrado</option>
                                                <option value="suave" {% if encuesta.estilo_bordes == 'suave' %}selected{% endif %}>Suave</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Fondo de la encuesta</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="tipo_fondo" class="form-label">Tipo de fondo</label>
                                            <select class="form-select" id="tipo_fondo" name="tipo_fondo">
                                                <option value="color" {% if encuesta.tipo_fondo == 'color' %}selected{% endif %}>Color sólido</option>
                                                <option value="gradiente" {% if encuesta.tipo_fondo == 'gradiente' %}selected{% endif %}>Gradiente</option>
                                                <option value="imagen" {% if encuesta.tipo_fondo == 'imagen' %}selected{% endif %}>Imagen</option>
                                                <option value="patron" {% if encuesta.tipo_fondo == 'patron' %}selected{% endif %}>Patrón</option>
                                            </select>
                                        </div>
                                        
                                        <div id="opcion-color" class="mb-3 fondo-opcion">
                                            <label for="color_fondo" class="form-label">Color de fondo</label>
                                            <input type="color" class="form-control form-control-color" id="color_fondo" name="color_fondo" value="{{ encuesta.color_fondo|default:'#f0f2f5' }}">
                                        </div>
                                        
                                        <div id="opcion-gradiente" class="mb-3 fondo-opcion" style="display:none;">
                                            <label class="form-label">Colores del gradiente</label>
                                            <div class="d-flex gap-2">
                                                <input type="color" class="form-control form-control-color" id="color_gradiente_1" name="color_gradiente_1" value="{{ encuesta.color_gradiente_1|default:'#4361ee' }}">
                                                <input type="color" class="form-control form-control-color" id="color_gradiente_2" name="color_gradiente_2" value="{{ encuesta.color_gradiente_2|default:'#3a0ca3' }}">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div id="opcion-imagen" class="mb-3 fondo-opcion" style="display:none;">
                                            <label for="imagen_fondo" class="form-label">Imagen de fondo</label>
                                            <input type="file" class="form-control" id="imagen_fondo" name="imagen_fondo" accept="image/*">
                                            
                                            {% if encuesta.imagen_fondo %}
                                            <div class="mt-2">
                                                <img src="{{ encuesta.imagen_fondo.url }}" alt="Imagen de fondo" class="img-fluid img-thumbnail" style="max-height: 100px;">
                                                <div class="form-check mt-2">
                                                    <input type="checkbox" class="form-check-input" id="eliminar_imagen_fondo" name="eliminar_imagen_fondo">
                                                    <label class="form-check-label" for="eliminar_imagen_fondo">Eliminar imagen</label>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                        
                                        <div id="opcion-patron" class="mb-3 fondo-opcion" style="display:none;">
                                            <label class="form-label">Selecciona un patrón</label>
                                            <div class="d-flex flex-wrap gap-2">
                                                <div class="form-check patron-option">
                                                    <input class="form-check-input" type="radio" name="patron_fondo" id="patron1" value="patron1" {% if encuesta.patron_fondo == 'patron1' %}checked{% endif %}>
                                                    <label class="form-check-label" for="patron1">
                                                        <div class="patron-preview patron1"></div>
                                                    </label>
                                                </div>
                                                <div class="form-check patron-option">
                                                    <input class="form-check-input" type="radio" name="patron_fondo" id="patron2" value="patron2" {% if encuesta.patron_fondo == 'patron2' %}checked{% endif %}>
                                                    <label class="form-check-label" for="patron2">
                                                        <div class="patron-preview patron2"></div>
                                                    </label>
                                                </div>
                                                <div class="form-check patron-option">
                                                    <input class="form-check-input" type="radio" name="patron_fondo" id="patron3" value="patron3" {% if encuesta.patron_fondo == 'patron3' %}checked{% endif %}>
                                                    <label class="form-check-label" for="patron3">
                                                        <div class="patron-preview patron3"></div>
                                                    </label>
                                                </div>
                                                <div class="form-check patron-option">
                                                    <input class="form-check-input" type="radio" name="patron_fondo" id="patron4" value="patron4" {% if encuesta.patron_fondo == 'patron4' %}checked{% endif %}>
                                                    <label class="form-check-label" for="patron4">
                                                        <div class="patron-preview patron4"></div>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-secondary" id="previsualizar-diseno">
                                <i class="fas fa-eye"></i> Previsualizar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Guardar Diseño
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para eliminar encuesta -->
<div class="modal fade" id="modalEliminarEncuesta" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Eliminar Encuesta</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar la encuesta "{{ encuesta.titulo }}"?</p>
                <p class="text-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    Esta acción no se puede deshacer y eliminará todas las preguntas y respuestas asociadas.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <form method="post" action="{% url 'eliminar_encuesta' encuesta.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Sí, Eliminar Encuesta
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal para agregar pregunta -->
<div class="modal fade" id="modalAgregarPregunta" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle me-2"></i>Agregar Nueva Pregunta
                </h5>
                <button type="button" class="btn-close bg-white" data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'agregar_pregunta' encuesta.id %}" class="form-agregar-pregunta">
                    {% csrf_token %}
                    
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-light py-3">
                            <h6 class="mb-0 fw-bold text-primary">Información básica</h6>
                        </div>
                        <div class="card-body">
                            <div class="form-group mb-3">
                                <label for="texto_nueva" class="form-label fw-bold">Texto de la pregunta</label>
                                <input type="text" class="form-control rounded-3" id="texto_nueva" 
                                       name="texto" required>
                                <div class="form-text">El texto principal de la pregunta que verán los usuarios.</div>
                            </div>

                            <div class="form-group mb-3">
                                <label for="tipo_nueva" class="form-label fw-bold">Tipo de pregunta</label>
                                <select class="form-select rounded-3" id="tipo_nueva" name="tipo" required>
                                    <option value="TEXT">Texto corto</option>
                                    <option value="MTEXT">Texto largo</option>
                                    <option value="RADIO">Opción múltiple (una respuesta)</option>
                                    <option value="CHECK">Casillas de verificación (múltiples respuestas)</option>
                                    <option value="SELECT">Menú desplegable</option>
                                    <option value="SCALE">Escala numérica</option>
                                    <option value="MATRIX">Matriz de opciones</option>
                                    <option value="DATE">Fecha y hora</option>
                                    <option value="STARS">Calificación con estrellas</option>
                                </select>
                                <div class="form-text">Selecciona el tipo de respuesta que deseas recibir.</div>
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="seccion_nueva" class="form-label fw-bold">Sección</label>
                                <div class="input-group">
                                    <select class="form-select rounded-start" id="seccion_nueva" name="seccion">
                                        <option value="General">General</option>
                                        {% for seccion in preguntas|dictsort:"seccion"|dictsortreversed:"seccion"|unique:"seccion" %}
                                            {% if seccion.seccion and seccion.seccion != "General" %}
                                                <option value="{{ seccion.seccion }}">{{ seccion.seccion }}</option>
                                            {% endif %}
                                        {% endfor %}
                                        <option value="nueva_seccion">+ Nueva sección</option>
                                    </select>
                                    <input type="text" id="nueva_seccion_input" class="form-control rounded-end" 
                                           style="display: none;" placeholder="Nombre de la nueva sección">
                                </div>
                                <div class="form-text">Sección a la que pertenece esta pregunta.</div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="orden_nueva" class="form-label fw-bold">Orden</label>
                                        <input type="number" class="form-control rounded-3" id="orden_nueva" 
                                               name="orden" value="{{ preguntas|length|add:"1" }}" required readonly>
                                        <div class="form-text">Posición de la pregunta en la encuesta.</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3 mt-4">
                                        <div class="d-flex flex-column">
                                            <div class="d-flex align-items-center">
                                                <input type="checkbox" class="form-check-input me-2" id="requerida_nueva" 
                                                       name="requerida" role="switch">
                                                <label class="form-check-label fw-bold mb-0" for="requerida_nueva">
                                                    Pregunta requerida
                                                </label>
                                            </div>
                                            <div class="form-text ms-4 mt-1">
                                                Si está activa, el usuario deberá responderla obligatoriamente.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group mb-3">
                                <label for="ayuda_nueva" class="form-label fw-bold">Texto de ayuda</label>
                                <input type="text" class="form-control rounded-3" id="ayuda_nueva" 
                                       name="ayuda">
                                <div class="form-text">Texto adicional para explicar mejor la pregunta (opcional).</div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección dinámica para opciones -->
                    <div id="seccion-opciones" class="card border-0 shadow-sm mb-3" style="display: none;">
                        <div class="card-header bg-light py-3">
                            <h6 class="mb-0 fw-bold text-primary">Opciones de respuesta</h6>
                        </div>
                        <div class="card-body">
                            <div class="opciones-container">
                                <div class="form-group opcion-item mb-2">
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">
                                            <i class="fas fa-list-ul text-primary"></i>
                                        </span>
                                        <input type="text" class="form-control rounded-end" name="opciones[]" 
                                               placeholder="Escribe una opción">
                                        <button type="button" class="btn btn-outline-danger ms-2 eliminar-opcion rounded-3">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary mt-2 agregar-opcion rounded-3">
                                <i class="fas fa-plus me-2"></i> Agregar Opción
                            </button>
                        </div>
                    </div>

                    <!-- Sección para configuración de escala -->
                    <div id="seccion-escala" class="card border-0 shadow-sm mb-3" style="display: none;">
                        <div class="card-header bg-light py-3">
                            <h6 class="mb-0 fw-bold text-primary">Configuración de escala</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="escala_min" class="form-label fw-bold">Valor mínimo</label>
                                        <input type="number" class="form-control rounded-3" id="escala_min" 
                                               name="escala_min" value="1">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="escala_max" class="form-label fw-bold">Valor máximo</label>
                                        <input type="number" class="form-control rounded-3" id="escala_max" 
                                               name="escala_max" value="5">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="escala_paso" class="form-label fw-bold">Paso</label>
                                <input type="number" class="form-control rounded-3" id="escala_paso" 
                                       name="escala_paso" value="1">
                                <div class="form-text">El incremento entre cada valor de la escala.</div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección para configuración de matriz -->
                    <div id="seccion-matriz" class="card border-0 shadow-sm mb-3" style="display: none;">
                        <div class="card-header bg-light py-3">
                            <h6 class="mb-0 fw-bold text-primary">Configuración de matriz</h6>
                        </div>
                        <div class="card-body">
                            <div class="form-group mb-3">
                                <label class="form-label fw-bold">Filas (elementos a evaluar)</label>
                                <div id="filas-container">
                                    <div class="input-group mb-2">
                                        <span class="input-group-text bg-light">
                                            <i class="fas fa-grip-lines text-primary"></i>
                                        </span>
                                        <input type="text" class="form-control" name="filas[]" placeholder="Elemento">
                                        <button type="button" class="btn btn-outline-danger ms-2 eliminar-fila rounded-3">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm mt-2 agregar-fila">
                                    <i class="fas fa-plus me-2"></i>Agregar Fila
                                </button>
                            </div>

                            <div class="form-group">
                                <label class="form-label fw-bold">Columnas (opciones de respuesta)</label>
                                <div id="columnas-container">
                                    <div class="input-group mb-2">
                                        <span class="input-group-text bg-light">
                                            <i class="fas fa-grip-lines-vertical text-primary"></i>
                                        </span>
                                        <input type="text" class="form-control" name="columnas[]" placeholder="Opción">
                                        <button type="button" class="btn btn-outline-danger ms-2 eliminar-columna rounded-3">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm mt-2 agregar-columna">
                                    <i class="fas fa-plus me-2"></i>Agregar Columna
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-outline-secondary rounded-3" data-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary rounded-3">
                            <i class="fas fa-plus me-2"></i>Agregar Pregunta
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modales para editar preguntas -->
{% for pregunta in preguntas %}
<div class="modal fade" id="modalEditarPregunta{{ pregunta.id }}" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Editar Pregunta
                </h5>
                <button type="button" class="btn-close bg-white" data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'editar_pregunta' pregunta.id %}" class="form-editar-pregunta">
                    {% csrf_token %}
                    
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-light py-3">
                            <h6 class="mb-0 fw-bold text-primary">Información básica</h6>
                        </div>
                        <div class="card-body">
                            <div class="form-group mb-3">
                                <label for="texto_{{ pregunta.id }}" class="form-label fw-bold">Texto de la pregunta</label>
                                <input type="text" class="form-control rounded-3" id="texto_{{ pregunta.id }}" 
                                name="texto" value="{{ pregunta.texto }}" required>
                                <div class="form-text">El texto principal de la pregunta que verán los usuarios.</div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <div class="d-inline-block">
                                            <label for="orden_{{ pregunta.id }}" class="form-label fw-bold">Orden</label>
                                            <input type="number" class="form-control rounded-3" id="orden_{{ pregunta.id }}" 
                                            name="orden" value="{{ pregunta.orden }}" required>
                                        </div>
                                        <div class="form-text">Posición de la pregunta en la encuesta.</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3 mt-4">
                                        <div>
                                            <label class="form-check-label fw-bold" for="requerida_{{ pregunta.id }}">
                                                Pregunta requerida
                                            </label>
                                            <input type="checkbox" class="form-check-input" id="requerida_{{ pregunta.id }}" 
                                            name="requerida" role="switch" {% if pregunta.requerida %}checked{% endif %}>
                                        </div>
                                        <div class="form-text">Si está activa, el usuario deberá responderla obligatoriamente.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% if pregunta.tipo == 'TEXT' or pregunta.tipo == 'MTEXT' %}
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-light py-3">
                            <h6 class="mb-0 fw-bold text-primary">Configuración de texto</h6>
                        </div>
                        <div class="card-body">
                            <div class="form-group mb-3">
                                <label for="placeholder_{{ pregunta.id }}" class="form-label fw-bold">Texto de ayuda (placeholder)</label>
                                <input type="text" class="form-control rounded-3" id="placeholder_{{ pregunta.id }}" 
                                       name="placeholder" value="{{ pregunta.placeholder }}">
                                <div class="form-text">Texto que aparecerá en el campo antes de que el usuario escriba.</div>
                            </div>
                            <div class="form-group mb-3">
                                <label for="max_longitud_{{ pregunta.id }}" class="form-label fw-bold">Longitud máxima</label>
                                <input type="number" class="form-control rounded-3" id="max_longitud_{{ pregunta.id }}" 
                                       name="max_longitud" value="{{ pregunta.max_longitud }}">
                                <div class="form-text">Número máximo de caracteres permitidos en la respuesta.</div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if pregunta.tipo == 'RADIO' or pregunta.tipo == 'CHECK' or pregunta.tipo == 'SELECT' %}
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-header bg-light py-3">
                            <h6 class="mb-0 fw-bold text-primary">Opciones de respuesta</h6>
                        </div>
                        <div class="card-body">
                            <div class="opciones-container">
                                {% for opcion in pregunta.opciones.all %}
                                <div class="form-group opcion-item mb-2">
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">
                                            <i class="fas fa-list-ul text-primary"></i>
                                        </span>
                                        <input type="text" class="form-control rounded-end" name="opciones[]" 
                                               value="{{ opcion.texto }}" required>
                                        <button type="button" class="btn btn-outline-danger ms-2 eliminar-opcion rounded-3">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                                <button type="button" class="btn btn-outline-primary mt-2 agregar-opcion rounded-3">
                                    <i class="fas fa-plus me-2"></i> Agregar Opción
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-outline-secondary rounded-3" data-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary rounded-3">
                            <i class="fas fa-save me-2"></i>Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal para eliminar pregunta -->
<div class="modal fade" id="modalEliminarPregunta{{ pregunta.id }}" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-trash me-2"></i>Eliminar Pregunta
                </h5>
                <button type="button" class="btn-close bg-white" data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Atención:</strong> Estás a punto de eliminar una pregunta
                </div>
                <p>¿Estás seguro de que deseas eliminar la pregunta "<strong>{{ pregunta.texto }}</strong>"?</p>
                <p class="text-danger">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    Esta acción no se puede deshacer y eliminará todas las respuestas asociadas.
                </p>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-outline-secondary rounded-3" data-dismiss="modal">Cancelar</button>
                <form method="post" action="{% url 'eliminar_pregunta' pregunta.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger rounded-3">
                        <i class="fas fa-trash me-2"></i> Sí, Eliminar Pregunta
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% block extra_js %}
<script>
    // Inicializar los campos de fecha y hora
    document.addEventListener('DOMContentLoaded', function() {
        // Formatear las fechas al formato requerido por datetime-local
        function formatDateForInput(date) {
            return date.substring(0, 16); // Toma solo YYYY-MM-DDTHH:mm
        }

        // Establecer valores iniciales
        var fechaInicio = document.querySelector('input[name="fecha_inicio"]');
        var fechaFin = document.querySelector('input[name="fecha_fin"]');

        if (fechaInicio.value) {
            fechaInicio.value = formatDateForInput(fechaInicio.value);
        }
        if (fechaFin.value) {
            fechaFin.value = formatDateForInput(fechaFin.value);
        }

        // Validar que la fecha de fin no sea anterior a la de inicio
        fechaInicio.addEventListener('change', function() {
            if (fechaFin.value && this.value > fechaFin.value) {
                alert('La fecha de inicio no puede ser posterior a la fecha de finalización');
                this.value = fechaFin.value;
            }
        });

        fechaFin.addEventListener('change', function() {
            if (fechaInicio.value && this.value < fechaInicio.value) {
                alert('La fecha de finalización no puede ser anterior a la fecha de inicio');
                this.value = fechaInicio.value;
            }
        });
    });

    // Funcionalidad para agregar/eliminar opciones en preguntas de opción múltiple
    document.addEventListener('DOMContentLoaded', function() {
        // Agregar opción
        document.querySelectorAll('.agregar-opcion').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const container = this.closest('.opciones-container');
                const opcionTemplate = `
                    <div class="form-group opcion-item">
                        <div class="input-group">
                            <input type="text" class="form-control" name="opciones[]" required>
                            <div class="input-group-append">
                                <button type="button" class="btn btn-danger eliminar-opcion">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', opcionTemplate);
            });
        });

        // Eliminar opción
        document.addEventListener('click', function(e) {
            if (e.target.closest('.eliminar-opcion')) {
                e.target.closest('.opcion-item').remove();
            }
        });
        
        // Funcionalidad para la pestaña de diseño
        if (document.getElementById('tipo_fondo')) {
            // Control de visibilidad de las opciones de fondo
            const tipoFondo = document.getElementById('tipo_fondo');
            const opcionesVisibles = {
                'color': document.getElementById('opcion-color'),
                'gradiente': document.getElementById('opcion-gradiente'),
                'imagen': document.getElementById('opcion-imagen'),
                'patron': document.getElementById('opcion-patron')
            };
            
            function actualizarOpcionesFondo() {
                const seleccionado = tipoFondo.value;
                
                // Ocultar todas las opciones
                Object.values(opcionesVisibles).forEach(function(opcion) {
                    if (opcion) opcion.style.display = 'none';
                });
                
                // Mostrar la opción seleccionada
                if (opcionesVisibles[seleccionado]) {
                    opcionesVisibles[seleccionado].style.display = 'block';
                }
            }
            
            tipoFondo.addEventListener('change', actualizarOpcionesFondo);
            
            // Inicializar el estado de la opción de fondo
            actualizarOpcionesFondo();
            
            // Actualización de la vista previa del tema
            const temaSelect = document.getElementById('tema');
            const temaPreview = document.getElementById('tema-preview');
            
            function actualizarTemaPreview() {
                const temaSeleccionado = temaSelect.value;
                // Remover clases de temas anteriores
                temaPreview.className = temaPreview.className.replace(/tema-\w+/g, '');
                // Agregar la clase del tema seleccionado
                temaPreview.classList.add('tema-' + temaSeleccionado);
            }
            
            temaSelect.addEventListener('change', actualizarTemaPreview);
            
            // Inicializar la vista previa
            actualizarTemaPreview();
            
            // Previsualización de la encuesta
            const btnPrevisualizar = document.getElementById('previsualizar-diseno');
            if (btnPrevisualizar) {
                btnPrevisualizar.addEventListener('click', function() {
                    // Abrir una ventana de previsualización
                    const encuestaId = '{{ encuesta.id }}';
                    const url = '/encuestas/' + encuestaId + '/preview-diseno/?tema=' + temaSelect.value;
                    window.open(url, '_blank', 'width=800,height=800');
                });
            }
            
            // Vista previa de archivos
            const inputImagenEncabezado = document.getElementById('imagen_encabezado');
            const previewImagenEncabezado = document.getElementById('header-image-preview');
            
            if (inputImagenEncabezado && previewImagenEncabezado) {
                inputImagenEncabezado.addEventListener('change', function() {
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewImagenEncabezado.innerHTML = '<img src="' + e.target.result + '" alt="Vista previa" class="img-fluid img-thumbnail">';
                        };
                        reader.readAsDataURL(this.files[0]);
                    }
                });
            }
            
            const inputLogotipo = document.getElementById('logotipo');
            const previewLogotipo = document.getElementById('logo-preview');
            
            if (inputLogotipo && previewLogotipo) {
                inputLogotipo.addEventListener('change', function() {
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewLogotipo.innerHTML = '<img src="' + e.target.result + '" alt="Vista previa" class="img-fluid img-thumbnail" style="max-height: 100px;">';
                        };
                        reader.readAsDataURL(this.files[0]);
                    }
                });
            }
        }

        // Agregar animaciones y efectos visuales
        const cards = document.querySelectorAll('.hover-card');
        cards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.classList.add('shadow-lg');
            });
            card.addEventListener('mouseleave', function() {
                this.classList.remove('shadow-lg');
            });
        });

        // Inicializar las secciones
        actualizarSecciones();
    });

    // Función para actualizar las secciones en el desplegable
    function actualizarSecciones() {
        const seccionSelect = document.getElementById('seccion_nueva');
        if (!seccionSelect) return; // Si no existe el elemento, salir
        
        // Obtener todas las secciones existentes de los elementos con el atributo data-seccion
        const elementos = document.querySelectorAll('[data-seccion]');
        const secciones = [];
        elementos.forEach(el => {
            const seccion = el.getAttribute('data-seccion');
            if (seccion && !secciones.includes(seccion)) {
                secciones.push(seccion);
            }
        });
        
        // Mantener solo las opciones por defecto: "General" y "+ Nueva sección"
        while (seccionSelect.options.length > 0) {
            seccionSelect.remove(0);
        }
        
        // Agregar la opción "General"
        const optionGeneral = document.createElement('option');
        optionGeneral.value = 'General';
        optionGeneral.textContent = 'General';
        seccionSelect.appendChild(optionGeneral);
        
        // Agregar las secciones existentes
        secciones.sort().forEach(seccion => {
            if (seccion && seccion !== 'General') {
                const option = document.createElement('option');
                option.value = seccion;
                option.textContent = seccion;
                seccionSelect.appendChild(option);
            }
        });
        
        // Agregar la opción "+ Nueva sección"
        const optionNueva = document.createElement('option');
        optionNueva.value = 'nueva_seccion';
        optionNueva.textContent = '+ Nueva sección';
        seccionSelect.appendChild(optionNueva);
    }

    // JavaScript para manejar nueva sección
    document.addEventListener('DOMContentLoaded', function() {
        const seccionSelect = document.getElementById('seccion_nueva');
        const nuevaSeccionInput = document.getElementById('nueva_seccion_input');
        
        // Inicializar secciones
        actualizarSecciones();
        
        if (seccionSelect && nuevaSeccionInput) {
            seccionSelect.addEventListener('change', function() {
                if (this.value === 'nueva_seccion') {
                    nuevaSeccionInput.style.display = 'block';
                    nuevaSeccionInput.focus();
                    nuevaSeccionInput.required = true;
                    this.name = '_ignorar_seccion';
                } else {
                    nuevaSeccionInput.style.display = 'none';
                    nuevaSeccionInput.required = false;
                    this.name = 'seccion';
                }
            });
            
            nuevaSeccionInput.addEventListener('input', function() {
                if (this.value.trim() !== '') {
                    this.name = 'seccion';
                } else {
                    this.name = '';
                }
            });
        }
        
        // Manejo del envío del formulario para actualizar el orden automáticamente
        const formAgregarPreguntaEl = document.querySelector('.form-agregar-pregunta');
        if (formAgregarPreguntaEl) {
            formAgregarPreguntaEl.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Obtener el último orden de las preguntas existentes
                const numPreguntas = parseInt("{{ preguntas|length }}");
                const ordenInput = document.getElementById('orden_nueva');
                ordenInput.value = numPreguntas + 1;
                
                const formData = new FormData(this);
                const url = this.getAttribute('action');
                
                fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Cerrar el modal
                        $('#modalAgregarPregunta').modal('hide');
                        // Recargar la página para mostrar la nueva pregunta
                        window.location.reload();
                    } else {
                        alert('Error al agregar la pregunta: ' + (data.error || 'Error desconocido'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al agregar la pregunta. Por favor, inténtalo de nuevo.');
                });
            });
        }
    });
</script>

<style>
    /* Estilos para la pestaña de diseño */
    .tema-preview {
        width: 100%;
        height: 150px;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .preview-header {
        height: 40px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    }
    
    .preview-body {
        height: 110px;
        background: #fff;
        padding: 15px;
    }
    
    .preview-text {
        height: 15px;
        width: 80%;
        background-color: #e9ecef;
        margin-bottom: 15px;
        border-radius: 4px;
    }
    
    .preview-button {
        height: 30px;
        width: 100px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-radius: 6px;
    }
    
    /* Clases para cada tema */
    .tema-default {
        --primary-color: #4361ee;
        --secondary-color: #3a0ca3;
        --accent-color: #f72585;
    }
    
    .tema-azul {
        --primary-color: #4361ee;
        --secondary-color: #3a0ca3;
        --accent-color: #4cc9f0;
    }
    
    .tema-verde {
        --primary-color: #2ecc71;
        --secondary-color: #27ae60;
        --accent-color: #1abc9c;
    }
    
    .tema-rojo {
        --primary-color: #e74c3c;
        --secondary-color: #c0392b;
        --accent-color: #f39c12;
    }
    
    .tema-morado {
        --primary-color: #9b59b6;
        --secondary-color: #8e44ad;
        --accent-color: #3498db;
    }
    
    .tema-naranja {
        --primary-color: #f39c12;
        --secondary-color: #d35400;
        --accent-color: #e67e22;
    }
    
    .tema-turquesa {
        --primary-color: #1abc9c;
        --secondary-color: #16a085;
        --accent-color: #2ecc71;
    }
    
    .tema-rosa {
        --primary-color: #e84393;
        --secondary-color: #fd79a8;
        --accent-color: #ff6b81;
    }
    
    .tema-esmeralda {
        --primary-color: #2ecc71;
        --secondary-color: #27ae60;
        --accent-color: #1abc9c;
    }
    
    .tema-indigo {
        --primary-color: #4834d4;
        --secondary-color: #686de0;
        --accent-color: #7ed6df;
    }
    
    .tema-cielo {
        --primary-color: #3498db;
        --secondary-color: #2980b9;
        --accent-color: #74b9ff;
    }
    
    .tema-coral {
        --primary-color: #ff7f50;
        --secondary-color: #ff6347;
        --accent-color: #ff8c00;
    }
    
    /* Estilos para patrones */
    .patron-preview {
        width: 50px;
        height: 50px;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .patron1 {
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.2'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }
    
    .patron2 {
        background-image: url("data:image/svg+xml,%3Csvg width='52' height='26' viewBox='0 0 52 26' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.2'%3E%3Cpath d='M10 10c0-2.21-1.79-4-4-4-3.314 0-6-2.686-6-6h2c0 2.21 1.79 4 4 4 3.314 0 6 2.686 6 6 0 2.21 1.79 4 4 4 3.314 0 6 2.686 6 6 0 2.21 1.79 4 4 4v2c-3.314 0-6-2.686-6-6 0-2.21-1.79-4-4-4-3.314 0-6-2.686-6-6zm25.464-1.95l8.486 8.486-1.414 1.414-8.486-8.486 1.414-1.414z' /%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }
    
    .patron3 {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='4' height='4' viewBox='0 0 4 4'%3E%3Cpath fill='%239C92AC' fill-opacity='0.2' d='M1 3h1v1H1V3zm2-2h1v1H3V1z'%3E%3C/path%3E%3C/svg%3E");
    }
    
    .patron4 {
        background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.2' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
    }
    
    .patron-option {
        margin-right: 10px;
    }
    
    .patron-option input:checked + label .patron-preview {
        border: 2px solid var(--primary-color);
        box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.3);
    }
    
    /* Estilos generales mejorados */
    .card-header {
        padding-top: 12px;
        padding-bottom: 12px;
    }
    
    .hover-card {
        transition: all 0.3s ease;
    }
    
    .hover-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
    }
    
    .nav-tabs .nav-link {
        color: #555;
        font-weight: 600;
        border: none;
        padding: 12px 20px;
        border-radius: 0;
        position: relative;
    }
    
    .nav-tabs .nav-link.active {
        color: #4361ee;
        background: none;
        border: none;
    }
    
    .nav-tabs .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background-color: #4361ee;
    }
    
    .nav-tabs .nav-link:hover:not(.active) {
        background-color: rgba(0,0,0,0.03);
        border: none;
    }
    
    .form-control, .form-select {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #4361ee;
        box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
    }
    
    .btn-primary {
        background-color: #4361ee;
        border-color: #4361ee;
    }
    
    .btn-primary:hover {
        background-color: #3a56d6;
        border-color: #3a56d6;
    }
    
    .btn-danger {
        background-color: #e74c3c;
        border-color: #e74c3c;
    }
    
    .btn-danger:hover {
        background-color: #d62c1a;
        border-color: #d62c1a;
    }
    
    .form-check-input:checked {
        background-color: #4361ee;
        border-color: #4361ee;
    }
    
    .badge {
        padding: 0.35em 0.65em;
        font-weight: 600;
    }
    
    /* Ajustes para la visualización móvil */
    @media (max-width: 768px) {
        .card-title {
            font-size: 1rem;
        }
        
        .card-header h6 {
            font-size: 0.85rem;
        }
    }

    /* Estilos para checkboxes y switches */
    .form-check {
        display: flex;
        align-items: center;
        padding-left: 0;
        margin-bottom: 1rem;
    }

    .form-check-input {
        float: none;
        margin-left: 0;
        margin-right: 0.5rem;
    }

    .form-check-label {
        margin-bottom: 0;
        cursor: pointer;
    }

    .form-switch {
        padding-left: 2.5rem;
    }

    .form-switch .form-check-input {
        margin-left: -2.5rem;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='rgba%280, 0, 0, 0.25%29'/%3e%3c/svg%3e");
        background-position: left center;
        border-radius: 2rem;
        transition: background-position .15s ease-in-out;
        width: 2rem;
    }

    .form-switch .form-check-input:checked {
        background-position: right center;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e");
    }

    /* Ajustes específicos para los switches en la configuración */
    .card-body .form-switch {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }

    .card-body .form-switch .form-check-input {
        margin-top: 0.5rem;
    }

    .card-body .form-switch .form-text {
        margin-top: 0.25rem;
        margin-left: 2.5rem;
    }

    /* Estilos para los checkboxes en las opciones de respuesta */
    .opciones-container .form-check {
        margin: 0.5rem 0;
    }

    .opciones-container .form-check-input {
        margin-right: 1rem;
    }

    /* Mejoras visuales para los switches */
    .form-switch .form-check-input:focus {
        border-color: rgba(67, 97, 238, 0.25);
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
    }

    .form-switch .form-check-input:checked {
        background-color: #4361ee;
        border-color: #4361ee;
    }
</style>
{% endblock %}
{% endblock %}