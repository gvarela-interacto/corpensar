{% extends 'base.html' %}
{% load static %}

{% block content %}
    
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-10 offset-md-1">
                <h1 class="mb-4">Crear Nueva Encuesta</h1>
                
                <form id="survey-form" method="post">
                    {% csrf_token %}
                    
                    <!-- Información básica de la encuesta -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Información de la Encuesta</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="titulo" class="form-label">Título <span class="required-asterisk">*</span></label>
                                <input type="text" class="form-control" id="titulo" name="titulo" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="slug" class="form-label">URL personalizada <span class="required-asterisk">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">encuestas/</span>
                                    <input type="text" class="form-control" id="slug" name="slug" required>
                                </div>
                                <div class="form-text">Este será el identificador único en la URL de tu encuesta.</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="descripcion" class="form-label">Descripción</label>
                                <textarea class="form-control" id="descripcion" name="descripcion" rows="3"></textarea>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="fecha_inicio" class="form-label">Fecha de inicio <span class="required-asterisk">*</span></label>
                                    <input type="datetime-local" class="form-control" id="fecha_inicio" name="fecha_inicio" required>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="fecha_fin" class="form-label">Fecha de finalización <span class="required-asterisk">*</span></label>
                                    <input type="datetime-local" class="form-control" id="fecha_fin" name="fecha_fin" required>
                                </div>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="activa" name="activa" checked>
                                <label class="form-check-label" for="activa">
                                    Encuesta activa
                                </label>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="es_publica" name="es_publica">
                                <label class="form-check-label" for="es_publica">
                                    Encuesta pública (cualquiera puede responder sin iniciar sesión)
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Secciones y Preguntas -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Preguntas</h5>
                            <button type="button" class="btn btn-light btn-sm" id="add-section">
                                <i class="fas fa-folder-plus"></i> Añadir Sección
                            </button>
                        </div>
                        
                        <div class="card-body" id="questions-container">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> Añade preguntas a tu encuesta utilizando el botón de abajo.
                            </div>
                            
                            <!-- Las preguntas se agregarán aquí dinámicamente -->
                        </div>
                        
                        <div class="card-footer">
                            <button type="button" class="btn btn-success" id="add-question">
                                <i class="fas fa-plus-circle"></i> Añadir Pregunta
                            </button>
                        </div>
                    </div>
                    
                    <!-- Vista previa -->
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">Vista Previa</h5>
                        </div>
                        <div class="card-body">
                            <div id="question-preview" class="bg-light">
                                <div class="text-center text-muted">
                                    <i class="fas fa-eye fa-2x mb-2"></i>
                                    <p>La vista previa de la encuesta aparecerá aquí.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones de acción -->
                    <div class="d-flex justify-content-between mb-5">
                        <button type="button" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <div>
                            <button type="button" class="btn btn-outline-primary me-2">
                                <i class="fas fa-save"></i> Guardar Borrador
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-check-circle"></i> Crear Encuesta
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Plantilla para nueva pregunta -->
    <template id="question-template">
        <div class="question-card card mb-3" data-question-id="{id}">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <span class="drag-handle me-2"><i class="fas fa-grip-vertical"></i></span>
                    <span class="question-number">Pregunta {number}</span>
                </div>
                <div>
                    <button type="button" class="btn btn-outline-secondary btn-sm preview-btn" title="Vista previa">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm delete-question" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Texto de la pregunta <span class="required-asterisk">*</span></label>
                    <textarea class="form-control question-text" name="questions[{id}][text]" rows="2" required></textarea>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Tipo de pregunta <span class="required-asterisk">*</span></label>
                        <select class="form-select question-type" name="questions[{id}][type]" required>
                            <option value="TEXT">Texto simple</option>
                            <option value="MTEXT">Texto múltiple</option>
                            <option value="RADIO">Opción múltiple</option>
                            <option value="CHECK">Casillas de verificación</option>
                            <option value="SELECT">Menú desplegable</option>
                            <option value="STAR">Valoración con estrellas</option>
                            <option value="SCALE">Escala mejor/peor</option>
                            <option value="MATRIX">Matriz de valoración</option>
                            <option value="DATE">Fecha</option>
                            <option value="DATETIME">Fecha y hora</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Sección</label>
                        <select class="form-select question-section" name="questions[{id}][section]">
                            <option value="">Sin sección</option>
                        </select>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input question-required" type="checkbox" name="questions[{id}][required]" id="required-{id}" checked>
                            <label class="form-check-label" for="required-{id}">
                                Respuesta obligatoria
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Orden</label>
                        <input type="number" class="form-control question-order" name="questions[{id}][order]" min="1" value="{number}">
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Texto de ayuda</label>
                    <input type="text" class="form-control question-help" name="questions[{id}][help]" placeholder="Instrucciones o aclaraciones para el encuestado">
                </div>
                
                <div class="question-options-container">
                    <!-- Opciones específicas según el tipo de pregunta aparecerán aquí -->
                </div>
            </div>
        </div>
    </template>
    
    <!-- Plantillas para opciones específicas de cada tipo de pregunta -->
    <template id="text-options-template">
        <div class="text-options">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Longitud máxima</label>
                    <input type="number" class="form-control" name="questions[{id}][max_length]" value="250">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Texto de ejemplo (placeholder)</label>
                    <input type="text" class="form-control" name="questions[{id}][placeholder]">
                </div>
            </div>
        </div>
    </template>
    
    <template id="mtext-options-template">
        <div class="mtext-options">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Longitud máxima</label>
                    <input type="number" class="form-control" name="questions[{id}][max_length]" value="1000">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Número de filas</label>
                    <input type="number" class="form-control" name="questions[{id}][rows]" value="4" min="2">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Texto de ejemplo</label>
                    <input type="text" class="form-control" name="questions[{id}][placeholder]">
                </div>
            </div>
        </div>
    </template>
    
    <template id="radio-options-template">
        <div class="radio-options">
            <div class="mb-3">
                <label class="form-label">Opciones <span class="required-asterisk">*</span></label>
                <div class="options-list mb-2">
                    <div class="option-row input-group">
                        <span class="input-group-text"><i class="fas fa-grip-vertical"></i></span>
                        <input type="text" class="form-control" name="questions[{id}][options][0][text]" placeholder="Texto de la opción" required>
                        <input type="hidden" name="questions[{id}][options][0][order]" value="1">
                        <button type="button" class="btn btn-outline-danger remove-option"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm add-option">
                    <i class="fas fa-plus"></i> Añadir Opción
                </button>
            </div>
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input include-other" type="checkbox" name="questions[{id}][option_other]" id="other-option-{id}">
                    <label class="form-check-label" for="other-option-{id}">
                        Incluir opción "Otro"
                    </label>
                </div>
            </div>
            <div class="mb-3 other-text-container d-none">
                <label class="form-label">Texto para opción "Otro"</label>
                <input type="text" class="form-control" name="questions[{id}][other_text]" value="Otro">
            </div>
        </div>
    </template>
    
    <template id="check-options-template">
        <div class="check-options">
            <div class="mb-3">
                <label class="form-label">Opciones <span class="required-asterisk">*</span></label>
                <div class="options-list mb-2">
                    <div class="option-row input-group">
                        <span class="input-group-text"><i class="fas fa-grip-vertical"></i></span>
                        <input type="text" class="form-control" name="questions[{id}][options][0][text]" placeholder="Texto de la opción" required>
                        <input type="hidden" name="questions[{id}][options][0][order]" value="1">
                        <button type="button" class="btn btn-outline-danger remove-option"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm add-option">
                    <i class="fas fa-plus"></i> Añadir Opción
                </button>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Mínimo de selecciones</label>
                    <input type="number" class="form-control" name="questions[{id}][min_selections]" value="1" min="1">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Máximo de selecciones</label>
                    <input type="number" class="form-control" name="questions[{id}][max_selections]" placeholder="Sin límite">
                </div>
            </div>
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input include-other" type="checkbox" name="questions[{id}][option_other]" id="other-option-check-{id}">
                    <label class="form-check-label" for="other-option-check-{id}">
                        Incluir opción "Otro"
                    </label>
                </div>
            </div>
            <div class="mb-3 other-text-container d-none">
                <label class="form-label">Texto para opción "Otro"</label>
                <input type="text" class="form-control" name="questions[{id}][other_text]" value="Otro">
            </div>
        </div>
    </template>
    
    <template id="select-options-template">
        <div class="select-options">
            <div class="mb-3">
                <label class="form-label">Opciones <span class="required-asterisk">*</span></label>
                <div class="options-list mb-2">
                    <div class="option-row input-group">
                        <span class="input-group-text"><i class="fas fa-grip-vertical"></i></span>
                        <input type="text" class="form-control" name="questions[{id}][options][0][text]" placeholder="Texto de la opción" required>
                        <input type="hidden" name="questions[{id}][options][0][order]" value="1">
                        <button type="button" class="btn btn-outline-danger remove-option"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm add-option">
                    <i class="fas fa-plus"></i> Añadir Opción
                </button>
            </div>
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="questions[{id}][empty_option]" id="empty-option-{id}" checked>
                    <label class="form-check-label" for="empty-option-{id}">
                        Incluir opción vacía inicial
                    </label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Texto para opción vacía</label>
                <input type="text" class="form-control" name="questions[{id}][empty_text]" value="Seleccione...">
            </div>
        </div>
    </template>
    
    <template id="star-options-template">
        <div class="star-options">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label">Número de estrellas</label>
                    <input type="number" class="form-control" name="questions[{id}][max_stars]" value="5" min="1" max="10">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Etiqueta para valor mínimo</label>
                    <input type="text" class="form-control" name="questions[{id}][label_start]" placeholder="Muy malo">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Etiqueta para valor máximo</label>
                    <input type="text" class="form-control" name="questions[{id}][label_end]" placeholder="Excelente">
                </div>
            </div>
            <div class="mb-3">
                <div class="star-rating-preview">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                </div>
            </div>
        </div>
    </template>
    
    <template id="scale-options-template">
        <div class="scale-options">
            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="form-label">Valor mínimo</label>
                    <input type="number" class="form-control" name="questions[{id}][min_value]" value="1">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Valor máximo</label>
                    <input type="number" class="form-control" name="questions[{id}][max_value]" value="5">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Paso</label>
                    <input type="number" class="form-control" name="questions[{id}][step]" value="1" min="1">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Vista previa</label>
                    <div class="form-range">
                        <input type="range" class="form-range" min="1" max="5" step="1" value="3">
                    </div>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Etiqueta para valor mínimo <span class="required-asterisk">*</span></label>
                    <input type="text" class="form-control" name="questions[{id}][label_min]" placeholder="Muy en desacuerdo" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Etiqueta para valor máximo <span class="required-asterisk">*</span></label>
                    <input type="text" class="form-control" name="questions[{id}][label_max]" placeholder="Muy de acuerdo" required>
                </div>
            </div>
        </div>
    </template>
    
    <template id="matrix-options-template">
        <div class="matrix-options">
            <div class="mb-3">
                <label class="form-label">Escala a utilizar <span class="required-asterisk">*</span></label>
                <select class="form-select" name="questions[{id}][scale_id]" required>
                    <option value="">Seleccionar escala</option>
                    <!-- Aquí se cargarían las escalas disponibles desde el backend -->
                    <option value="new">Crear nueva escala</option>
                </select>
            </div>
            <div class="mb-3 new-scale-container d-none">
                <!-- Aquí irían las opciones para crear una nueva escala -->
            </div>
            <div class="mb-3">
                <label class="form-label">Ítems de la matriz <span class="required-asterisk">*</span></label>
                <div class="items-list mb-2">
                    <div class="option-row input-group">
                        <span class="input-group-text"><i class="fas fa-grip-vertical"></i></span>
                        <input type="text" class="form-control" name="questions[{id}][items][0][text]" placeholder="Texto del ítem" required>
                        <input type="hidden" name="questions[{id}][items][0][order]" value="1">
                        <button type="button" class="btn btn-outline-danger remove-item"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm add-item">
                    <i class="fas fa-plus"></i> Añadir Ítem
                </button>
            </div>
        </div>
    </template>
    
    <template id="date-options-template">
        <div class="date-options">
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="questions[{id}][include_time]" id="include-time-{id}">
                    <label class="form-check-label" for="include-time-{id}">
                        Incluir hora
                    </label>
                </div>
            </div>
        </div>
    </template>
    
    <template id="section-template">
        <div class="section-divider d-flex justify-content-between align-items-center" data-section-id="{section_id}">
            <div class="d-flex align-items-center">
                <span class="drag-handle me-2"><i class="fas fa-grip-vertical"></i></span>
                <input type="text" class="form-control form-control-sm section-title" 
                       name="sections[{section_id}][title]" placeholder="Título de la sección" style="width: 300px;">
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger delete-section">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </template>
    <style>
        .question-card {
            border-left: 4px solid #007bff;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section-divider {
            background-color: #f8f9fa;
            padding: 8px 15px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
            border-radius: 4px;
        }
        .delete-btn {
            color: #dc3545;
        }
        .required-asterisk {
            color: #dc3545;
            margin-left: 4px;
        }
        .drag-handle {
            cursor: move;
            color: #6c757d;
            padding: 5px;
        }
        #question-preview {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
            margin-top: 20px;
        }
        .option-row {
            margin-bottom: 8px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    
    <script>
        $(document).ready(function() {
            let questionCounter = 0;
            let sectionCounter = 0;
            
            // Inicializar sortable para las preguntas
            new Sortable(document.getElementById('questions-container'), {
                handle: '.drag-handle',
                animation: 150,
                onEnd: function() {
                    renumberQuestions();
                }
            });
            
            // Añadir nueva pregunta
            $('#add-question').click(function() {
                addNewQuestion();
            });
            
            // Añadir nueva sección
            $('#add-section').click(function() {
                addNewSection();
            });
            
            // Función para añadir nueva pregunta
            function addNewQuestion() {
                questionCounter++;
                const template = $('#question-template').html();
                const questionHtml = template
                    .replace(/{id}/g, questionCounter)
                    .replace(/{number}/g, $('.question-card').length + 1);
                
                $('#questions-container').append(questionHtml);
                
                // Inicializar las opciones según el tipo seleccionado
                const $newQuestion = $(`[data-question-id="${questionCounter}"]`);
                updateQuestionOptions($newQuestion, 'TEXT');
                
                // Actualizar las secciones disponibles
                updateSectionSelects();
                
                // Establecer handlers para los eventos
                setupQuestionEventHandlers($newQuestion);
            }
            
            // Función para añadir nueva sección
            function addNewSection() {
                sectionCounter++;
                const template = $('#section-template').html();
                const sectionHtml = template.replace(/{section_id}/g, sectionCounter);
                
                $('#questions-container').append(sectionHtml);
                
                // Actualizar selects de sección en todas las preguntas
                updateSectionSelects();
                
                // Configurar evento para eliminar sección
                $(`.section-divider[data-section-id="${sectionCounter}"] .delete-section`).click(function() {
                    $(this).closest('.section-divider').remove();
                    updateSectionSelects();
                });
                
                // Actualizar título de sección cuando cambie
                $(`.section-divider[data-section-id="${sectionCounter}"] .section-title`).on('input', function() {
                    updateSectionSelects();
                });
            }
            
            // Función para configurar los manejadores de eventos de las preguntas
            function setupQuestionEventHandlers($question) {
                const questionId = $question.data('question-id');
                
                // Cambiar tipo de pregunta
                $question.find('.question-type').change(function() {
                    const type = $(this).val();
                    updateQuestionOptions($question, type);
                });
                
                // Vista previa de la pregunta
                $question.find('.preview-btn').click(function() {
                    previewQuestion($question);
                });
                
                // Eliminar pregunta
                $question.find('.delete-question').click(function() {
                    $question.remove();
                    renumberQuestions();
                });
                
                // Opciones específicas para cada tipo
                setupOptionTypeHandlers($question);
            }
            
            // Configurar manejadores para tipos específicos de preguntas
            function setupOptionTypeHandlers($question) {
                // Para preguntas con opciones (radio, check, select)
                $question.find('.add-option').click(function() {
                    const optionsList = $(this).closest('.mb-3').find('.options-list');
                    const optionsCount = optionsList.children().length;
                    const questionId = $question.data('question-id');
                    
                    const newOption = `
                        <div class="option-row input-group">
                            <span class="input-group-text"><i class="fas fa-grip-vertical"></i></span>
                            <input type="text" class="form-control" name="questions[${questionId}][options][${optionsCount}][text]" placeholder="Texto de la opción" required>
                            <input type="hidden" name="questions[${questionId}][options][${optionsCount}][order]" value="${optionsCount + 1}">
                            <button type="button" class="btn btn-outline-danger remove-option"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                    optionsList.append(newOption);
                    
                    // Configurar evento para eliminar opción
                    optionsList.find('.remove-option').last().click(function() {
                        if (optionsList.children().length > 1) {
                            $(this).closest('.option-row').remove();
                            renumberOptionOrders(optionsList);
                        } else {
                            alert('Debe haber al menos una opción.');
                        }
                    });
                });
                
                // Para preguntas tipo matriz
                $question.find('.add-item').click(function() {
                    const itemsList = $(this).closest('.mb-3').find('.items-list');
                    const itemsCount = itemsList.children().length;
                    const questionId = $question.data('question-id');
                    
                    const newItem = `
                        <div class="option-row input-group">
                            <span class="input-group-text"><i class="fas fa-grip-vertical"></i></span>
                            <input type="text" class="form-control" name="questions[${questionId}][items][${itemsCount}][text]" placeholder="Texto del ítem" required>
                            <input type="hidden" name="questions[${questionId}][items][${itemsCount}][order]" value="${itemsCount + 1}">
                            <button type="button" class="btn btn-outline-danger remove-item"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                    
                    itemsList.append(newItem);
                    
                    // Configurar evento para eliminar ítem
                    itemsList.find('.remove-item').last().click(function() {
                        if (itemsList.children().length > 1) {
                            $(this).closest('.option-row').remove();
                            renumberOptionOrders(itemsList);
                        } else {
                            alert('Debe haber al menos un ítem en la matriz.');
                        }
                    });
                });
                
                // Para opción "Otro"
                $question.find('.include-other').change(function() {
                    const otherTextContainer = $(this).closest('.mb-3').siblings('.other-text-container');
                    $(this).is(':checked') ? otherTextContainer.removeClass('d-none') : otherTextContainer.addClass('d-none');
                });
            }
            
            // Actualizar opciones específicas según el tipo de pregunta
            function updateQuestionOptions($question, type) {
                const questionId = $question.data('question-id');
                const optionsContainer = $question.find('.question-options-container');
                optionsContainer.empty();
                
                let template;
                switch (type) {
                    case 'TEXT':
                        template = $('#text-options-template').html();
                        break;
                    case 'MTEXT':
                        template = $('#mtext-options-template').html();
                        break;
                    case 'RADIO':
                        template = $('#radio-options-template').html();
                        break;
                    case 'CHECK':
                        template = $('#check-options-template').html();
                        break;
                    case 'SELECT':
                        template = $('#select-options-template').html();
                        break;
                    case 'STAR':
                        template = $('#star-options-template').html();
                        break;
                    case 'SCALE':
                        template = $('#scale-options-template').html();
                        break;
                    case 'MATRIX':
                        template = $('#matrix-options-template').html();
                        break;
                    case 'DATE':
                    case 'DATETIME':
                        template = $('#date-options-template').html();
                        break;
                }
                
                if (template) {
                    const optionsHtml = template.replace(/{id}/g, questionId);
                    optionsContainer.html(optionsHtml);
                    setupOptionTypeHandlers($question);
                }
            }
            
            // Renumerar preguntas
            function renumberQuestions() {
                $('.question-card').each(function(index) {
                    $(this).find('.question-number').text(`Pregunta ${index + 1}`);
                    $(this).find('.question-order').val(index + 1);
                });
            }
            
            // Renumerar opciones
            function renumberOptionOrders($container) {
                $container.find('.option-row').each(function(index) {
                    $(this).find('input[name$="[order]"]').val(index + 1);
                });
            }
            
            // Actualizar select de secciones
            function updateSectionSelects() {
                // Recopilar todas las secciones
                const sections = [];
                $('.section-divider').each(function() {
                    const sectionId = $(this).data('section-id');
                    const sectionTitle = $(this).find('.section-title').val() || `Sección ${sectionId}`;
                    sections.push({ id: sectionId, title: sectionTitle });
                });
                
                // Actualizar todos los selects de sección
                $('.question-section').each(function() {
                    const currentVal = $(this).val();
                    $(this).find('option:not(:first)').remove();
                    
                    sections.forEach(section => {
                        $(this).append(`<option value="${section.id}" ${currentVal == section.id ? 'selected' : ''}>${section.title}</option>`);
                    });
                });
            }
            
            // Vista previa de pregunta
            function previewQuestion($question) {
                const questionType = $question.find('.question-type').val();
                const questionText = $question.find('.question-text').val() || 'Texto de la pregunta';
                const isRequired = $question.find('.question-required').is(':checked');
                const helpText = $question.find('.question-help').val();
                
                let previewHTML = `
                    <div class="preview-question mb-4">
                        <label class="form-label fw-bold">${questionText} ${isRequired ? '<span class="text-danger">*</span>' : ''}</label>
                        ${helpText ? `<p class="form-text text-muted mb-2">${helpText}</p>` : ''}
                `;
                
                switch (questionType) {
                    case 'TEXT':
                        const textPlaceholder = $question.find('input[name$="[placeholder]"]').val() || '';
                        previewHTML += `<input type="text" class="form-control" placeholder="${textPlaceholder}" ${isRequired ? 'required' : ''}>`;
                        break;
                    case 'MTEXT':
                        const mtextPlaceholder = $question.find('input[name$="[placeholder]"]').val() || '';
                        const rows = $question.find('input[name$="[rows]"]').val() || 4;
                        previewHTML += `<textarea class="form-control" rows="${rows}" placeholder="${mtextPlaceholder}" ${isRequired ? 'required' : ''}></textarea>`;
                        break;
                    case 'RADIO':
                        const radioOptions = [];
                        $question.find('.options-list .option-row').each(function() {
                            const optionText = $(this).find('input[type="text"]').val() || 'Opción';
                            radioOptions.push(`
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="preview_radio_${$question.data('question-id')}" ${isRequired ? 'required' : ''}>
                                    <label class="form-check-label">${optionText}</label>
                                </div>
                            `);
                        });
                        
                        if ($question.find('.include-other').is(':checked')) {
                            const otherText = $question.find('input[name$="[other_text]"]').val() || 'Otro';
                            radioOptions.push(`
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="preview_radio_${$question.data('question-id')}">
                                    <label class="form-check-label">${otherText}</label>
                                    <input type="text" class="form-control mt-1" placeholder="Especifique">
                                </div>
                            `);
                        }
                        
                        previewHTML += radioOptions.join('');
                        break;
                    case 'CHECK':
                        const checkOptions = [];
                        $question.find('.options-list .option-row').each(function() {
                            const optionText = $(this).find('input[type="text"]').val() || 'Opción';
                            checkOptions.push(`
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" ${isRequired ? 'required' : ''}>
                                    <label class="form-check-label">${optionText}</label>
                                </div>
                            `);
                        });
                        
                        if ($question.find('.include-other').is(':checked')) {
                            const otherText = $question.find('input[name$="[other_text]"]').val() || 'Otro';
                            checkOptions.push(`
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox">
                                    <label class="form-check-label">${otherText}</label>
                                    <input type="text" class="form-control mt-1" placeholder="Especifique">
                                </div>
                            `);
                        }
                        
                        previewHTML += checkOptions.join('');
                        break;
                    case 'SELECT':
                        const selectOptions = [];
                        
                        if ($question.find('input[name$="[empty_option]"]').is(':checked')) {
                            const emptyText = $question.find('input[name$="[empty_text]"]').val() || 'Seleccione...';
                            selectOptions.push(`<option value="">${emptyText}</option>`);
                        }
                        
                        $question.find('.options-list .option-row').each(function() {
                            const optionText = $(this).find('input[type="text"]').val() || 'Opción';
                            selectOptions.push(`<option value="${optionText}">${optionText}</option>`);
                        });
                        
                        previewHTML += `
                            <select class="form-select" ${isRequired ? 'required' : ''}>
                                ${selectOptions.join('')}
                            </select>
                        `;
                        break;
                    case 'STAR':
                        const maxStars = $question.find('input[name$="[max_stars]"]').val() || 5;
                        const startLabel = $question.find('input[name$="[label_start]"]').val();
                        const endLabel = $question.find('input[name$="[label_end]"]').val();
                        
                        previewHTML += `
                            <div class="mb-2">
                                ${startLabel ? `<span class="me-2">${startLabel}</span>` : ''}
                                ${Array(parseInt(maxStars)).fill(0).map(() => '<i class="far fa-star fa-lg text-warning me-1" style="cursor:pointer;"></i>').join('')}
                                ${endLabel ? `<span class="ms-2">${endLabel}</span>` : ''}
                            </div>
                        `;
                        break;
                    case 'SCALE':
                        const minValue = $question.find('input[name$="[min_value]"]').val() || 1;
                        const maxValue = $question.find('input[name$="[max_value]"]').val() || 5;
                        const step = $question.find('input[name$="[step]"]').val() || 1;
                        const labelMin = $question.find('input[name$="[label_min]"]').val() || 'Mínimo';
                        const labelMax = $question.find('input[name$="[label_max]"]').val() || 'Máximo';
                        
                        previewHTML += `
                            <div class="mb-2">
                                <div class="d-flex justify-content-between mb-1">
                                    <small>${labelMin}</small>
                                    <small>${labelMax}</small>
                                </div>
                                <input type="range" class="form-range" min="${minValue}" max="${maxValue}" step="${step}" ${isRequired ? 'required' : ''}>
                            </div>
                        `;
                        break;
                    case 'MATRIX':
                        const matrixItems = [];
                        $question.find('.items-list .option-row').each(function() {
                            const itemText = $(this).find('input[type="text"]').val() || 'Ítem';
                            matrixItems.push(itemText);
                        });
                        
                        previewHTML += '<div class="table-responsive"><table class="table table-sm table-bordered">';
                        previewHTML += '<thead><tr><th></th>';
                        
                        // valores de ejemplo 1-5
                        for (let i = 1; i <= 5; i++) {
                            previewHTML += `<th class="text-center">${i}</th>`;
                        }
                        previewHTML += '</tr></thead><tbody>';
                        
                        matrixItems.forEach(item => {
                            previewHTML += `<tr><td>${item}</td>`;
                            for (let i = 1; i <= 5; i++) {
                                previewHTML += `
                                    <td class="text-center">
                                        <input class="form-check-input" type="radio" name="matrix_${item.replace(/\s/g, '_')}">
                                    </td>
                                `;
                            }
                            previewHTML += '</tr>';
                        });
                        
                        previewHTML += '</tbody></table></div>';
                        break;
                    case 'DATE':
                    case 'DATETIME':
                        const includeTime = questionType === 'DATETIME' || $question.find('input[name$="[include_time]"]').is(':checked');
                        previewHTML += `<input type="${includeTime ? 'datetime-local' : 'date'}" class="form-control" ${isRequired ? 'required' : ''}>`;
                        break;
                }
                
                previewHTML += '</div>';
                
                $('#question-preview').html(previewHTML);
            }
            
            // Validación antes de enviar
            $('#survey-form').submit(function(e) {
                // Por ahora solo validamos que haya al menos una pregunta
                if ($('.question-card').length === 0) {
                    e.preventDefault();
                    alert('Debe añadir al menos una pregunta a la encuesta.');
                    return false;
                }
                
                // Aquí podrían ir más validaciones específicas
                return true;
            });
            
            // Auto-generar slug a partir del título
            $('#titulo').on('input', function() {
                const titulo = $(this).val();
                if (!$('#slug').data('manual-edit')) {
                    const slug = titulo
                        .toLowerCase()
                        .replace(/[^\w ]+/g, '')
                        .replace(/ +/g, '-');
                    $('#slug').val(slug);
                }
            });
            
            $('#slug').on('focus', function() {
                $(this).data('manual-edit', true);
            });
            
            // Inicializar con una pregunta
            addNewQuestion();
        });
    </script>
{% endblock %}