{% extends 'base.html' %}
{% load static %}

{% block content %}
    <!-- Agregar referencia al nuevo archivo CSS -->
    <link rel="stylesheet" href="{% static 'css/encuesta/crear_encuesta.css' %}">
    
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-10 offset-md-1">
                <h1 class="mb-4 text-center">Crear Nueva Encuesta</h1>
                
                <form id="survey-form" method="post">
                    {% csrf_token %}
                    
                    <!-- Información básica de la encuesta -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Información de la Encuesta</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="titulo" class="form-label">Título <span class="required-asterisk">*</span></label>
                                <input type="text" class="form-control" id="titulo" name="titulo" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="slug" class="form-label">URL personalizada <span class="required-asterisk">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">encuestas/</span>
                                    <input type="text" class="form-control" id="slug" name="slug" readonly>
                                </div>
                                <div class="form-text">Este será el identificador único en la URL de tu encuesta.</div>
                            </div>

                            <div class="mb-3">
                                <label for="categoria" class="form-label">Categoría</label>
                                <select class="form-select" id="categoria" name="categoria">
                                    <option value="">Seleccione una categoría</option>
                                    {% for categoria in categorias %}
                                        <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Seleccione la categoría para la encuesta.</div>
                            </div>
                            

                            <div class="mb-3">
                                <label for="tema" class="form-label">Tema de la encuesta</label>
                                <select class="form-select" id="tema" name="tema">
                                    <option value="default">Tema por defecto</option>
                                    <option value="azul">Tema Azul</option>
                                    <option value="verde">Tema Verde</option>
                                    <option value="rojo">Tema Rojo</option>
                                    <option value="morado">Tema Morado</option>
                                    <option value="naranja">Tema Naranja</option>
                                    <option value="turquesa">Tema Turquesa</option>
                                    <option value="rosa">Tema Rosa</option>
                                    <option value="esmeralda">Tema Esmeralda</option>
                                    <option value="indigo">Tema Índigo</option>
                                    <option value="cielo">Tema Cielo</option>
                                    <option value="coral">Tema Coral</option>
                                </select>
                                <div class="form-text">Elige un tema para personalizar la apariencia de tu encuesta.</div>
                            </div>

                            <div class="mb-3">
                                <label for="region" class="form-label">Región <span class="required-asterisk">*</span></label>
                                <select class="form-select" id="region" name="region" required>
                                    <option value="">Seleccione una región</option>
                                    {% for region in regiones %}
                                        <option value="{{ region.id }}">{{ region.nombre }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Seleccione la región a la que pertenece esta encuesta.</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="descripcion" class="form-label">Descripción</label>
                                <textarea class="form-control" id="descripcion" name="descripcion" rows="3"></textarea>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="fecha_inicio" class="form-label">Fecha de inicio <span class="required-asterisk">*</span></label>
                                    <input type="datetime-local" class="form-control" id="fecha_inicio" name="fecha_inicio" required>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="fecha_fin" class="form-label">Fecha de finalización <span class="required-asterisk">*</span></label>
                                    <input type="datetime-local" class="form-control" id="fecha_fin" name="fecha_fin" required>
                                </div>
                            </div>
                            
                            <!-- Switches centrados -->
                            <div class="text-center mt-3 mb-2">
                                <div class="d-inline-flex gap-5 justify-content-center">
                                    <div class="form-check blue-sidebar-checkbox">
                                        <input class="form-check-input" type="checkbox" id="activa" name="activa" checked>
                                        <label class="form-check-label" for="activa">
                                            <i class="fas fa-toggle-on me-1"></i>
                                            Encuesta activa
                                        </label>
                                    </div>
                                    
                                    <div class="form-check blue-sidebar-checkbox">
                                        <input class="form-check-input" type="checkbox" id="es_publica" name="es_publica">
                                        <label class="form-check-label" for="es_publica">
                                            <i class="fas fa-globe me-1"></i>
                                            Encuesta pública
                                        </label>
                                    </div>
                                </div>
                                <div class="form-text text-muted small mt-1">
                                    La encuesta pública permite que cualquiera pueda responder sin iniciar sesión
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Secciones y Preguntas -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Preguntas</h5>
                            
                        </div>
                        
                        <div class="card-body" id="questions-container">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> Añade preguntas a tu encuesta utilizando el botón de abajo.
                            </div>
                            
                            <!-- Las preguntas se agregarán aquí dinámicamente -->
                        </div>
                        
                        <div class="card-footer">
                            <button type="button" class="btn btn-success" id="add-question">
                                <i class="fas fa-plus-circle"></i> Añadir Pregunta
                            </button>
                            <button type="button" class="btn btn-sm" id="add-section">
                                <i class="fas fa-folder-plus"></i> Añadir Sección
                            </button>
                        </div>
                    </div>
                    
                    <!-- Vista previa -->
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">Vista Previa</h5>
                        </div>
                        <div class="card-body">
                            <div id="question-preview" class="bg-light">
                                <div class="text-center text-muted">
                                    <i class="fas fa-eye fa-2x mb-2"></i>
                                    <p>La vista previa de la encuesta aparecerá aquí.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones de acción -->
                    <div class="d-flex justify-content-between mb-5">
                        <button type="button" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <div>
                            <button type="button" class="btn btn-outline-primary me-2">
                                <i class="fas fa-save"></i> Guardar Borrador
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-check-circle"></i> Crear Encuesta
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Plantilla para nueva pregunta -->
    <template id="question-template">
        <div class="question-card card mb-3" data-question-id="{id}">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <span class="drag-handle me-2"><i class="fas fa-grip-vertical"></i></span>
                    <span class="question-number">Pregunta {number}</span>
                </div>
                <div>
                    <button type="button" class="btn btn-outline-secondary btn-sm preview-btn" title="Vista previa">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm delete-question" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Texto de la pregunta <span class="required-asterisk">*</span></label>
                    <textarea class="form-control question-text" name="questions[{id}][text]" rows="2" required></textarea>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Tipo de pregunta <span class="required-asterisk">*</span></label>
                        <select class="form-select question-type" name="questions[{id}][type]" required>
                            <option value="TEXT">Texto simple</option>
                            <option value="MTEXT">Texto múltiple</option>
                            <option value="RADIO">Opción múltiple</option>
                            <option value="CHECK">Casillas de verificación</option>
                            <option value="SELECT">Menú desplegable</option>
                            <option value="STAR">Valoración con estrellas</option>
                            <option value="SCALE">Escala mejor/peor</option>
                            <option value="MATRIX">Matriz de valoración</option>
                            <option value="DATE">Fecha</option>
                            <option value="DATETIME">Fecha y hora</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Sección</label>
                        <select class="form-select question-section" name="questions[{id}][section]">
                            <option value="">Sin sección</option>
                        </select>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-check blue-sidebar-checkbox">
                            <input class="form-check-input question-required" type="checkbox" name="questions[{id}][required]" id="required-{id}" checked>
                            <label class="form-check-label" for="required-{id}">
                                Respuesta obligatoria
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Texto de ayuda</label>
                            <input type="text" class="form-control question-help" name="questions[{id}][help]" placeholder="Instrucciones o aclaraciones para el encuestado">
                        </div>
                    </div>
                </div>
                <div class="question-options-container">
                    <!-- Opciones específicas según el tipo de pregunta aparecerán aquí -->
                </div>
            </div>
        </div>
    </template>
    
    <!-- Plantillas para opciones específicas de cada tipo de pregunta -->
    <template id="text-options-template">
        <div class="text-options">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Longitud máxima</label>
                    <input type="number" class="form-control" name="questions[{id}][max_length]" value="250">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Texto de ejemplo (placeholder)</label>
                    <input type="text" class="form-control" name="questions[{id}][placeholder]">
                </div>
            </div>
        </div>
    </template>

    <template id="mtext-options-template">
        <div class="mtext-options">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Longitud máxima</label>
                    <input type="number" class="form-control" name="questions[{id}][max_length]" value="1000">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Número de filas</label>
                    <input type="number" class="form-control" name="questions[{id}][rows]" value="4" min="2">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Texto de ejemplo</label>
                    <input type="text" class="form-control" name="questions[{id}][placeholder]">
                </div>
            </div>
        </div>
    </template>
    
    <template id="radio-options-template">
        <div class="radio-options">
            <div class="mb-3">
                <label class="form-label">Opciones <span class="required-asterisk">*</span></label>
                <div class="options-list mb-2">
                    <div class="option-row input-group">
                        <span class="input-group-text"><i class="fas fa-grip-vertical"></i></span>
                        <input type="text" class="form-control" name="questions[{id}][opciones][0][texto]" placeholder="Texto de la opción" required>
                        <input type="hidden" name="questions[{id}][opciones][0][orden]" value="1">
                        <button type="button" class="btn btn-outline-danger remove-option" onclick="eliminarOpcion(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm add-option" onclick="agregarOpciones(this)">
                    <i class="fas fa-plus"></i> Añadir Opción
                </button>
            </div>
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input include-other" type="checkbox" name="questions[{id}][option_other]" id="other-option-{id}">
                    <label class="form-check-label" for="other-option-{id}">
                        Incluir opción "Otro"
                    </label>
                </div>
            </div>
            <div class="mb-3 other-text-container d-none">
                <label class="form-label">Texto para opción "Otro"</label>
                <input type="text" class="form-control" name="questions[{id}][other_text]" value="Otro">
            </div>
        </div>
    </template>
    
    <template id="check-options-template">
        <div class="check-options">
            <div class="mb-3">
                <label class="form-label">Opciones <span class="required-asterisk">*</span></label>
                <div class="options-list mb-2">
                    <div class="option-row input-group">
                        <span class="input-group-text"><i class="fas fa-grip-vertical"></i></span>
                        <input type="text" class="form-control" name="questions[{id}][opciones][0][texto]" placeholder="Texto de la opción" required>
                        <input type="hidden" name="questions[{id}][opciones][0][orden]" value="1">
                        <button type="button" class="btn btn-outline-danger remove-option" onclick="eliminarOpcion(this)"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm add-option" onclick="agregarOpciones(this)">
                    <i class="fas fa-plus"></i> Añadir Opción
                </button>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Mínimo de selecciones</label>
                    <input type="number" class="form-control" name="questions[{id}][min_selections]" value="1" min="1">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Máximo de selecciones</label>
                    <input type="number" class="form-control" name="questions[{id}][max_selections]" placeholder="Sin límite">
                </div>
            </div>
            <div class="mb-3">
                <div class="form-check blue-sidebar-checkbox">
                    <input class="form-check-input include-other" type="checkbox" name="questions[{id}][option_other]" id="other-option-check-{id}">
                    <label class="form-check-label" for="other-option-check-{id}">
                        Incluir opción "Otro"
                    </label>
                </div>
            </div>
            <div class="mb-3 other-text-container d-none">
                <label class="form-label">Texto para opción "Otro"</label>
                <input type="text" class="form-control" name="questions[{id}][other_text]" value="Otro">
            </div>
        </div>
    </template>
    
    <template id="select-options-template">
        <div class="select-options">
            <div class="mb-3">
                <label class="form-label">Opciones <span class="required-asterisk">*</span></label>
                <div class="options-list mb-2">
                    <div class="option-row input-group">
                        <span class="input-group-text"><i class="fas fa-grip-vertical"></i></span>
                        <input type="text" class="form-control" name="questions[{id}][opciones][0][texto]" placeholder="Texto de la opción" required>
                        <input type="hidden" name="questions[{id}][opciones][0][orden]" value="1">
                        <button type="button" class="btn btn-outline-danger remove-option" onclick="eliminarOpcion(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm add-option" onclick="agregarOpciones(this)">
                    <i class="fas fa-plus"></i> Añadir Opción
                </button>
            </div>
            <div class="mb-3">
                <div class="form-check blue-sidebar-checkbox">
                    <input class="form-check-input" type="checkbox" name="questions[{id}][empty_option]" id="empty-option-{id}" checked>
                    <label class="form-check-label" for="empty-option-{id}">
                        Incluir opción vacía inicial
                    </label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Texto para opción vacía</label>
                <input type="text" class="form-control" name="questions[{id}][empty_text]" value="Seleccione...">
            </div>
        </div>
    </template>
    
    <template id="star-options-template">
        <div class="star-options">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label">Número de estrellas</label>
                    <input type="number" class="form-control" name="questions[{id}][max_stars]" value="5" min="1" max="10">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Etiqueta para valor mínimo</label>
                    <input type="text" class="form-control" name="questions[{id}][label_start]" placeholder="Muy malo">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Etiqueta para valor máximo</label>
                    <input type="text" class="form-control" name="questions[{id}][label_end]" placeholder="Excelente">
                </div>
            </div>
            <div class="mb-3">
                <div class="star-rating-preview">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                </div>
            </div>
        </div>
    </template>
    
    <template id="scale-options-template">
        <div class="scale-options">
            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="form-label">Valor mínimo</label>
                    <input type="number" class="form-control" name="questions[{id}][min_value]" value="1">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Valor máximo</label>
                    <input type="number" class="form-control" name="questions[{id}][max_value]" value="5">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Paso</label>
                    <input type="number" class="form-control" name="questions[{id}][step]" value="1" min="1">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Vista previa</label>
                    <div class="form-range">
                        <input type="range" class="form-range" min="1" max="5" step="1" value="3">
                    </div>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Etiqueta para valor mínimo <span class="required-asterisk">*</span></label>
                    <input type="text" class="form-control" name="questions[{id}][label_min]" placeholder="Muy en desacuerdo" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Etiqueta para valor máximo <span class="required-asterisk">*</span></label>
                    <input type="text" class="form-control" name="questions[{id}][label_max]" placeholder="Muy de acuerdo" required>
                </div>
            </div>
        </div>
    </template>
    
    <template id="matrix-options-template">
        <div class="matrix-options">
            <div class="mb-3">
                <label class="form-label">Escala a utilizar <span class="required-asterisk">*</span></label>
                <div class="scale-container">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label">Valor mínimo</label>
                            <input type="number" class="form-control" name="questions[{id}][scale][min_valor]" value="1">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Valor máximo</label>
                            <input type="number" class="form-control" name="questions[{id}][scale][max_valor]" value="5">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Paso</label>
                            <input type="number" class="form-control" name="questions[{id}][scale][paso]" value="1" min="1">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Etiqueta para valor mínimo <span class="required-asterisk">*</span></label>
                            <input type="text" class="form-control" name="questions[{id}][scale][etiqueta_min]" placeholder="Muy en desacuerdo" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Etiqueta para valor máximo <span class="required-asterisk">*</span></label>
                            <input type="text" class="form-control" name="questions[{id}][scale][etiqueta_max]" placeholder="Muy de acuerdo" required>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Ítems de la matriz <span class="required-asterisk">*</span></label>
                <div class="items-list mb-2">
                    <!-- Los ítems se agregarán dinámicamente -->
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm add-item" onclick="agregarItem(this)">
                    <i class="fas fa-plus"></i> Añadir Ítem
                </button>
            </div>

            <!-- Vista previa de la matriz -->
            <div class="matrix-preview mt-4">
                <h6>Vista previa de la matriz</h6>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th></th>
                                <th>1</th>
                                <th>2</th>
                                <th>3</th>
                                <th>4</th>
                                <th>5</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Ejemplo de ítem</td>
                                <td><input type="radio" disabled></td>
                                <td><input type="radio" disabled></td>
                                <td><input type="radio" disabled></td>
                                <td><input type="radio" disabled></td>
                                <td><input type="radio" disabled></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </template>
    
    <template id="date-options-template">
        <div class="date-options">
            <div class="mb-3">
                <div class="form-check blue-sidebar-checkbox">
                    <input class="form-check-input" type="checkbox" name="questions[{id}][include_time]" id="include-time-{id}">
                    <label class="form-check-label" for="include-time-{id}">
                        Incluir hora
                    </label>
                </div>
            </div>
        </div>
    </template>
    
    <template id="section-template">
        <div class="section-divider d-flex justify-content-between align-items-center" data-section-id="{section_id}">
            <div class="d-flex align-items-center">
                <span class="drag-handle me-2"><i class="fas fa-grip-vertical"></i></span>
                <input type="text" class="form-control form-control-sm section-title" 
                       name="sections[{section_id}][title]" placeholder="Título de la sección" style="width: 300px;">
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger delete-section">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </template>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #f72585;
            --success-color: #4cc9f0;
            --warning-color: #f8961e;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #343a40;
        }
        
        .container {
            max-width: 1100px;
        }
        
        h1 {
            color: var(--secondary-color);
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 1.5rem;
        }
        
        .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
        }
        
        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: none;
        }
        
        .bg-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)) !important;
        }
        
        .bg-info {
            background: linear-gradient(135deg, var(--success-color), var(--primary-color)) !important;
        }
        
        .card-header h5 {
            font-weight: 700;
            letter-spacing: -0.2px;
            margin-bottom: 0;
        }
        
        .card-body {
            padding: 2rem;
        }
        
        .form-label {
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 0.5rem;
        }
        
        .form-control, .form-select {
            padding: 0.75rem 1rem;
            border-radius: 10px;
            border: 2px solid var(--medium-gray);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
        }
        
        .input-group-text {
            border-radius: 10px 0 0 10px;
            border: 2px solid var(--medium-gray);
            border-right: none;
            background-color: var(--light-gray);
        }
        
        .input-group .form-control {
            border-radius: 0 10px 10px 0;
        }
        
        textarea.form-control {
            min-height: 120px;
        }
        
        .required-asterisk {
            color: var(--accent-color);
            font-weight: bold;
            margin-left: 4px;
        }
        
        .form-text {
            color: #6c757d;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        
        .form-check-input {
            width: 1.25rem;
            height: 1.25rem;
            margin-top: 0.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            transform: scale(1.1);
        }
        
        .form-switch .form-check-input {
            width: 3em;
            height: 1.5em;
            margin-top: 0.15rem;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='rgba%28255, 255, 255, 1%29'/%3e%3c/svg%3e");
        }
        
        .form-switch .form-check-input:focus {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='rgba%28255, 255, 255, 1%29'/%3e%3c/svg%3e");
        }
        
        .form-check-label {
            font-size: 1rem;
            cursor: pointer;
            user-select: none;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(67, 97, 238, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #20c997, var(--success-color));
            border: none;
            box-shadow: 0 4px 15px rgba(32, 201, 151, 0.3);
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, var(--success-color), #20c997);
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(32, 201, 151, 0.4);
        }
        
        .btn-outline-primary, .btn-outline-secondary {
            border-width: 2px;
            font-weight: 600;
        }
        
        .btn-outline-primary:hover, .btn-outline-secondary:hover {
            transform: translateY(-2px);
        }
        
        #add-section {
            background: linear-gradient(135deg, var(--success-color), var(--primary-color));
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(76, 201, 240, 0.3);
            transition: all 0.3s ease;
        }
        
        #add-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(76, 201, 240, 0.4);
        }
        
        .alert-info {
            background-color: rgba(76, 201, 240, 0.1);
            border-left: 4px solid var(--success-color);
            border-top: none;
            border-right: none;
            border-bottom: none;
            border-radius: 10px;
            padding: 1.25rem;
            color: var(--dark-gray);
        }
        
        .question-card {
            border-left: 5px solid var(--primary-color) !important;
            margin-bottom: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .question-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }
        
        .question-card .card-header {
            background-color: rgba(67, 97, 238, 0.05);
            padding: 1rem 1.5rem;
        }
        
        .question-number {
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        .section-divider {
            background: linear-gradient(to right, rgba(76, 201, 240, 0.1), transparent);
            padding: 1rem 1.5rem;
            margin: 2rem 0 1.5rem;
            border-left: 5px solid var(--success-color);
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .section-divider:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .section-title {
            border-radius: 8px;
            border: 2px solid rgba(76, 201, 240, 0.3);
            padding: 0.5rem 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .section-title:focus {
            border-color: var(--success-color);
            box-shadow: 0 0 0 0.25rem rgba(76, 201, 240, 0.25);
        }
        
        .drag-handle {
            cursor: move;
            color: #6c757d;
            padding: 0.5rem;
            transition: all 0.2s ease;
        }
        
        .drag-handle:hover {
            color: var(--dark-gray);
        }
        
        #question-preview {
            border: 1px solid var(--medium-gray);
            border-radius: 12px;
            padding: 2rem;
            background-color: #fff;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.03);
        }
        
        .option-row {
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
        }
        
        .option-row:hover {
            transform: translateX(5px);
        }
        
        .option-row .form-control {
            border-radius: 0 !important;
        }
        
        .option-row .input-group-text {
            border-radius: 10px 0 0 10px !important;
        }
        
        .option-row .btn {
            border-radius: 0 10px 10px 0 !important;
        }
        
        .matrix-preview {
            background-color: var(--light-gray);
            padding: 1.25rem;
            border-radius: 10px;
            margin-top: 1.5rem;
        }
        
        .matrix-preview h6 {
            color: var(--secondary-color);
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .matrix-preview table {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .matrix-preview th {
            background-color: rgba(67, 97, 238, 0.1);
            border-bottom: 2px solid var(--primary-color);
        }
        
        @media (max-width: 768px) {
            .card-body {
                padding: 1.5rem;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .d-flex.justify-content-between {
                flex-direction: column;
                gap: 1rem;
            }
            
            .d-flex.justify-content-between div {
                width: 100%;
            }
            
            .d-flex.justify-content-between div .btn {
                width: 100%;
                margin-right: 0 !important;
                margin-bottom: 0.5rem;
            }
            
            .card-header {
                padding: 1rem;
            }
            
            .section-divider {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .section-title {
                width: 100% !important;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <script>
        // Función global para agregar opciones
        function agregarOpciones(button) {
            console.log('Iniciando agregarOpciones');
            const $button = $(button);
            const optionsList = $button.closest('.mb-3').find('.options-list');
            const optionsCount = optionsList.children().length;
            const questionId = $button.closest('.question-card').data('question-id');
            const questionType = $button.closest('.question-card').find('.question-type').val();
            
            let newOption;
            if (questionType === 'CHECK') {
                newOption = `
                    <div class="option-row input-group">
                        <span class="input-group-text"><i class="fas fa-grip-vertical"></i></span>
                        <input type="text" class="form-control" name="questions[${questionId}][opciones][${optionsCount}][texto]" placeholder="Texto de la opción" required>
                        <input type="hidden" name="questions[${questionId}][opciones][${optionsCount}][orden]" value="${optionsCount + 1}">
                        <button type="button" class="btn btn-outline-danger remove-option" onclick="eliminarOpcion(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            } else {
                newOption = `
                    <div class="option-row input-group">
                        <span class="input-group-text"><i class="fas fa-grip-vertical"></i></span>
                        <input type="text" class="form-control" name="questions[${questionId}][opciones][${optionsCount}][texto]" placeholder="Texto de la opción" required>
                        <input type="hidden" name="questions[${questionId}][opciones][${optionsCount}][orden]" value="${optionsCount + 1}">
                        <button type="button" class="btn btn-outline-danger remove-option" onclick="eliminarOpcion(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }
            optionsList.append(newOption);
        }

        // Función global para eliminar opciones
        function eliminarOpcion(button) {
            const $button = $(button);
            const optionsList = $button.closest('.options-list');
            if (optionsList.children().length > 1) {
                $button.closest('.option-row').remove();
                renumberOptionOrders(optionsList);
            } else {
                alert('Debe haber al menos una opción.');
            }
        }

        // Función global para renumerar las opciones
        function renumberOptionOrders(optionsList) {
            const $options = $(optionsList).find('.option-row');
            $options.each(function(index) {
                const order = index + 1;
                $(this).find('input[name$="[orden]"]').val(order);
                $(this).find('input[name$="[texto]"]').attr('name', function(i, oldName) {
                    return oldName.replace(/\[\d+\]/, `[${order}]`);
                });
            });
        }

        // Función global para agregar ítems a la matriz
        function agregarItem(button) {
            console.log('Iniciando agregarItem');
            const $button = $(button);
            const itemsList = $button.closest('.mb-3').find('.items-list');
            const itemsCount = itemsList.children().length;
            const questionId = $button.closest('.question-card').data('question-id');
            
            const newItem = `
                <div class="option-row input-group">
                    <span class="input-group-text"><i class="fas fa-grip-vertical"></i></span>
                    <input type="text" class="form-control" name="questions[${questionId}][items][${itemsCount}][texto]" placeholder="Texto del ítem" required>
                    <input type="hidden" name="questions[${questionId}][items][${itemsCount}][orden]" value="${itemsCount + 1}">
                    <button type="button" class="btn btn-outline-danger remove-item" onclick="eliminarItem(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            itemsList.append(newItem);
            actualizarVistaPrevia($button.closest('.matrix-options'));
        }

        // Función global para eliminar ítems de la matriz
        function eliminarItem(button) {
            const $button = $(button);
            const itemsList = $button.closest('.items-list');
            if (itemsList.children().length > 1) {
                $button.closest('.option-row').remove();
                renumberItemOrders(itemsList);
                actualizarVistaPrevia($button.closest('.matrix-options'));
            } else {
                alert('Debe haber al menos un ítem.');
            }
        }

        // Función para renumerar los ítems
        function renumberItemOrders(itemsList) {
            const $items = $(itemsList).find('.option-row');
            $items.each(function(index) {
                const order = index + 1;
                $(this).find('input[name$="[orden]"]').val(order);
                $(this).find('input[name$="[texto]"]').attr('name', function(i, oldName) {
                    return oldName.replace(/\[\d+\]/, `[${order}]`);
                });
            });
        }

        // Función para actualizar la vista previa de la matriz
        function actualizarVistaPrevia($container) {
            const minValor = parseInt($container.find('input[name$="[scale][min_valor]"]').val()) || 1;
            const maxValor = parseInt($container.find('input[name$="[scale][max_valor]"]').val()) || 5;
            const paso = parseInt($container.find('input[name$="[scale][paso]"]').val()) || 1;
            const items = $container.find('.items-list .option-row input[name$="[texto]"]').map(function() {
                return $(this).val() || 'Ejemplo de ítem';
            }).get();

            // Construir la tabla de vista previa
            let thead = '<tr><th></th>';
            for (let i = minValor; i <= maxValor; i += paso) {
                thead += `<th>${i}</th>`;
            }
            thead += '</tr>';

            let tbody = '';
            items.forEach(item => {
                tbody += `<tr><td>${item}</td>`;
                for (let i = minValor; i <= maxValor; i += paso) {
                    tbody += '<td><input type="radio" disabled></td>';
                }
                tbody += '</tr>';
            });

            const $preview = $container.find('.matrix-preview table');
            $preview.find('thead').html(thead);
            $preview.find('tbody').html(tbody);
        }

        // Agregar listeners para actualizar la vista previa cuando cambien los valores de la escala
        $(document).on('change', '.matrix-options input[name$="[scale][min_valor]"], .matrix-options input[name$="[scale][max_valor]"], .matrix-options input[name$="[scale][paso]"]', function() {
            actualizarVistaPrevia($(this).closest('.matrix-options'));
        });

        // Agregar listeners para actualizar la vista previa cuando se escriba en los ítems
        $(document).on('input', '.matrix-options .items-list input[name$="[texto]"]', function() {
            actualizarVistaPrevia($(this).closest('.matrix-options'));
        });

        $(document).ready(function() {
            console.log('Documento listo');
            let questionCounter = 0;
            let sectionCounter = 0;
            let slugModifiedManually = false;
            
            // Función para generar slug a partir del título
            function generateSlug(text) {
                return text
                    .toString()
                    .toLowerCase()
                    .normalize('NFD') // Normalizar caracteres especiales
                    .replace(/[\u0300-\u036f]/g, '') // Eliminar diacríticos
                    .replace(/[^a-z0-9\s-]/g, '') // Eliminar caracteres especiales
                    .replace(/\s+/g, '-') // Reemplazar espacios por guiones
                    .replace(/-+/g, '-') // Eliminar guiones múltiples
                    .trim() // Eliminar espacios al inicio y final
                    .replace(/^-+/, '') // Eliminar guiones al inicio
                    .replace(/-+$/, ''); // Eliminar guiones al final
            }

            // Event listener para el campo de título
            $('#titulo').on('input', function() {
                const titulo = $(this).val();
                console.log('Título modificado:', titulo);
                
                // Solo actualizar el slug si no ha sido modificado manualmente
                if (!slugModifiedManually) {
                    const slug = generateSlug(titulo);
                    $('#slug').val(slug);
                    console.log('Slug generado:', slug);
                }
            });

            // Event listener para el campo de slug
            $('#slug').on('input', function() {
                // Marcar que el slug ha sido modificado manualmente
                slugModifiedManually = true;
                console.log('Slug modificado manualmente');
                
                // Limpiar y formatear el slug ingresado
                let slug = generateSlug($(this).val());
                $(this).val(slug);
            });
            
            // Función para renumerar preguntas
            function renumberQuestions() {
                console.log('Iniciando renumeración de preguntas');
                const questions = $('#questions-container .question-card');
                
                questions.each(function(index) {
                    const number = index + 1;
                    console.log(`Renumerando pregunta a: ${number}`);
                    
                    // Actualizar el número visible
                    $(this).find('.question-number').text(`Pregunta ${number}`);
                    
                    // Actualizar el valor del orden
                    $(this).find('.question-order').val(number);
                    
                    // Actualizar los nombres de los campos para mantener el índice correcto
                    $(this).find('[name^="questions["]').each(function() {
                        const oldName = $(this).attr('name');
                        const newName = oldName.replace(/questions\[\d+\]/, `questions[${number}]`);
                        $(this).attr('name', newName);
                    });
                });
                
                console.log('Renumeración completada');
            }
            
            // Función para añadir nueva pregunta
            function addNewQuestion() {
                console.log('Iniciando addNewQuestion');
                questionCounter++;
                const template = $('#question-template').html();
                const questionHtml = template
                    .replace(/{id}/g, questionCounter)
                    .replace(/{number}/g, $('.question-card').length + 1);
                
                $('#questions-container').append(questionHtml);
                
                // Inicializar las opciones según el tipo seleccionado
                const $newQuestion = $(`[data-question-id="${questionCounter}"]`);
                console.log('Nueva pregunta creada con ID:', questionCounter);
                
                updateQuestionOptions($newQuestion, 'TEXT');
                updateSectionSelects();
                
                // Asignar la sección por defecto a la nueva pregunta
                const defaultSection = $('.section-divider').first().find('.section-title').val() || 'General';
                $newQuestion.find('.question-section').val(defaultSection);
                
                // Establecer handlers para los eventos
                setupQuestionEventHandlers($newQuestion);
                console.log('Handlers configurados para pregunta:', questionCounter);
            }
            
            // Función para añadir nueva sección
            function addNewSection() {
                sectionCounter++;
                const template = $('#section-template').html();
                const sectionHtml = template.replace(/{section_id}/g, sectionCounter);
                
                $('#questions-container').append(sectionHtml);
                
                // Actualizar selects de sección en todas las preguntas
                updateSectionSelects();
                
                // Configurar evento para eliminar sección
                $(`.section-divider[data-section-id="${sectionCounter}"] .delete-section`).click(function() {
                    // No permitir eliminar la sección por defecto
                    if ($(this).closest('.section-divider').data('section-id') === 1) {
                        alert('No se puede eliminar la sección por defecto.');
                        return;
                    }
                    
                    $(this).closest('.section-divider').remove();
                    updateSectionSelects();
                });
                
                // Actualizar título de sección cuando cambie
                $(`.section-divider[data-section-id="${sectionCounter}"] .section-title`).on('input', function() {
                    updateSectionSelects();
                });
            }
            
            // Función para configurar los manejadores de eventos de las preguntas
            function setupQuestionEventHandlers($question) {
                console.log('Configurando eventos para pregunta');
                const questionId = $question.data('question-id');
                console.log('ID de la pregunta:', questionId);
                
                // Eliminar manejadores previos si existen
                $(document).off('click', `[data-question-id="${questionId}"] .delete-question`);
                
                // Eliminar pregunta - Usando delegación de eventos
                $(document).on('click', `[data-question-id="${questionId}"] .delete-question`, function(e) {
                    console.log('Botón eliminar clickeado');
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const $questionToRemove = $(`[data-question-id="${questionId}"]`);
                    console.log('Pregunta a eliminar:', $questionToRemove.length ? 'encontrada' : 'no encontrada');
                    
                    if (confirm('¿Estás seguro de que deseas eliminar esta pregunta?')) {
                        console.log('Eliminación confirmada');
                        
                        // Añadir clase de fade out
                        $questionToRemove.fadeOut(300, function() {
                            console.log('Animación completada');
                            $(this).remove();
                            renumberQuestions();
                            console.log('Pregunta eliminada y numeración actualizada');
                        });
                    }
                });
                
                // Cambiar tipo de pregunta
                $question.find('.question-type').change(function() {
                    const type = $(this).val();
                    updateQuestionOptions($question, type);
                });
                
                // Vista previa de la pregunta
                $question.find('.preview-btn').click(function() {
                    previewQuestion($question);
                });
                
                // Opciones específicas para cada tipo
                setupOptionTypeHandlers($question);
            }

            // Configurar manejadores para tipos específicos de preguntas
            function setupOptionTypeHandlers($question) {
                console.log('Configurando manejadores para tipos específicos de preguntas');
                // Para preguntas con opciones (radio, check, select)
                $question.find('.add-option').click(function() {
                    const optionsList = $(this).closest('.mb-3').find('.options-list');
                    const optionsCount = optionsList.children().length;
                    const questionId = $question.data('question-id');
                    
                    const newOption = `
                        <div class="option-row input-group">
                            <span class="input-group-text"><i class="fas fa-grip-vertical"></i></span>
                            <input type="text" class="form-control" name="questions[${questionId}][opciones][${optionsCount}][texto]" placeholder="Texto de la opción" required>
                            <input type="hidden" name="questions[${questionId}][opciones][${optionsCount}][orden]" value="${optionsCount + 1}">
                            <button type="button" class="btn btn-outline-danger remove-option" onclick="eliminarOpcion(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    optionsList.append(newOption);
                });
                
                // Para preguntas tipo matriz
                $question.find('.add-item').click(function() {
                    const itemsList = $(this).closest('.mb-3').find('.items-list');
                    const itemsCount = itemsList.children().length;
                    const questionId = $question.data('question-id');
                    
                    const newItem = `
                        <div class="option-row input-group">
                            <span class="input-group-text"><i class="fas fa-grip-vertical"></i></span>
                            <input type="text" class="form-control" name="questions[${questionId}][items][${itemsCount}][texto]" placeholder="Texto del ítem" required>
                            <input type="hidden" name="questions[${questionId}][items][${itemsCount}][orden]" value="${itemsCount + 1}">
                            <button type="button" class="btn btn-outline-danger remove-item"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                    itemsList.append(newItem);
                });
            }

            // Función para actualizar las opciones según el tipo de pregunta
            function updateQuestionOptions($question, type) {
                // Obtener el contenedor de opciones
                const $optionsContainer = $question.find('.question-options-container');
                const questionId = $question.data('question-id');
                
                // Limpiar opciones anteriores
                $optionsContainer.empty();
                
                // Obtener el template correspondiente según el tipo
                let template = '';
                switch(type) {
                    case 'TEXT':
                        template = $('#text-options-template').html();
                        break;
                    case 'MTEXT':
                        template = $('#mtext-options-template').html();
                        break;
                    case 'RADIO':
                        template = $('#radio-options-template').html();
                        break;
                    case 'CHECK':
                        template = $('#check-options-template').html();
                        break;
                    case 'SELECT':
                        template = $('#select-options-template').html();
                        break;
                    case 'STAR':
                        template = $('#star-options-template').html();
                        break;
                    case 'SCALE':
                        template = $('#scale-options-template').html();
                        break;
                    case 'MATRIX':
                        template = $('#matrix-options-template').html();
                        break;
                    case 'DATE':
                        template = $('#date-options-template').html();
                        break;
                    default:
                        console.log('Tipo de pregunta no reconocido:', type);
                        return;
                }
                
                // Si no hay template, no hacemos nada
                if (!template) {
                    console.log('No se encontró template para el tipo:', type);
                    return;
                }
                
                // Reemplazar los placeholders en el template
                template = template.replace(/{id}/g, questionId);
                $optionsContainer.html(template);
                
                // Configurar eventos específicos según el tipo
                switch(type) {
                    case 'RADIO':
                    case 'CHECK':
                    case 'SELECT':
                        // Inicializar con una opción
                        $optionsContainer.find('.add-option').trigger('click');
                        break;
                    case 'MATRIX':
                        // Inicializar con un ítem
                        $optionsContainer.find('.add-item').trigger('click');
                        break;
                }
            }

            // Función para actualizar los selectores de sección
            function updateSectionSelects() {
                // Obtener todas las secciones
                const sections = [];
                $('.section-divider').each(function() {
                    const sectionId = $(this).data('section-id');
                    const title = $(this).find('.section-title').val() || 'Sin título';
                    sections.push({ id: sectionId, title: title });
                });
                
                // Actualizar todos los selectores de sección
                $('.question-section').each(function() {
                    const currentValue = $(this).val();
                    $(this).empty().append('<option value="">Sin sección</option>');
                    
                    sections.forEach(section => {
                        const option = $('<option></option>')
                            .val(section.title)
                            .text(section.title);
                        $(this).append(option);
                    });
                    
                    // Mantener el valor seleccionado si existía
                    if (currentValue) {
                        $(this).val(currentValue);
                    }
                });
            }

            // Inicializar sortable para las preguntas
            new Sortable(document.getElementById('questions-container'), {
                handle: '.drag-handle',
                animation: 150,
                onEnd: function() {
                    renumberQuestions();
                }
            });

            // Event listeners
            $('#add-question').click(function() {
                addNewQuestion();
            });

            // Añadir nueva sección
            $('#add-section').click(function() {
                addNewSection();
            });
            
            // Crear sección por defecto al cargar la página
            sectionCounter = 1;
            const defaultSectionHtml = $('#section-template').html().replace(/{section_id}/g, sectionCounter);
            $('#questions-container').append(defaultSectionHtml);
            
            // Configurar la sección por defecto
            $('.section-divider[data-section-id="1"] .section-title').val('General');
            $('.section-divider[data-section-id="1"] .delete-section').prop('disabled', true).addClass('disabled');
            
            // Actualizar los selectores de sección
            updateSectionSelects();
        });
    </script>
{% endblock %}