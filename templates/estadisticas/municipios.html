{% extends 'base.html' %}
{% load static %}

{% block title %}Estadísticas de Municipios | Corpensar{% endblock %}

{% block styles %}
<style>
    /* Mejoras generales */
    .container-fluid {
        padding: 2rem;
        max-width: 100%;
    }

    /* Animaciones */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
        from { transform: translateX(-20px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* Contenedor principal de estadísticas */
    .stats-dashboard {
        background-color: #f8f9fc;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        margin-bottom: 2rem;
    }

    /* Tarjetas de estadísticas mejoradas */
    .card {
        transition: all 0.3s ease;
        animation: fadeIn 0.5s ease-out;
        margin-bottom: 1.5rem;
        border: none;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0,0,0,0.1);
    }

    .border-left-primary { border-left: 0.5rem solid #4e73df !important; }
    .border-left-success { border-left: 0.5rem solid #1cc88a !important; }
    .border-left-info { border-left: 0.5rem solid #36b9cc !important; }
    .border-left-warning { border-left: 0.5rem solid #f6c23e !important; }

    /* Tabs mejoradas */
    .nav-tabs-container {
        background-color: white;
        border-radius: 15px 15px 0 0;
        padding: 1rem 1rem 0 1rem;
        box-shadow: 0 -2px 15px rgba(0,0,0,0.03);
    }

    .nav-tabs {
        border-bottom: none;
        margin-bottom: 0;
    }

    .nav-tabs .nav-item {
        margin-bottom: 0;
    }

    .nav-tabs .nav-link {
        border: none;
        color: #858796;
        font-weight: 600;
        padding: 1rem 1.5rem;
        transition: all 0.3s ease;
        position: relative;
        border-radius: 10px 10px 0 0;
    }

    .nav-tabs .nav-link:hover {
        color: #4e73df;
        background-color: #f8f9fc;
    }

    .nav-tabs .nav-link.active {
        color: #4e73df;
        background-color: #f8f9fc;
        border-bottom: 3px solid #4e73df;
    }

    /* Contenedor de gráficos significativamente mejorado */
    .tab-content {
        background-color: #f8f9fc;
        border-radius: 0 0 15px 15px;
        padding: 2rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }

    .chart-container {
        height: 600px; /* Mucho más alto para mejor visualización */
        width: 100%;
        margin: 0;
        padding: 1.5rem;
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }

    .chart-container:hover {
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    .distribution-charts {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    /* Formulario de filtros mejorado */
    .filters-card {
        background-color: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        margin-bottom: 2rem;
    }

    .filters-card .card-header {
        background-color: transparent;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        padding: 1.25rem 1.5rem;
    }

    .form-select {
        border-radius: 10px;
        border: 1px solid #d1d3e2;
        padding: 0.75rem;
        transition: all 0.3s ease;
        background-color: #f8f9fc;
    }

    .form-select:focus {
        border-color: #4e73df;
        box-shadow: 0 0 0 0.2rem rgba(78,115,223,0.25);
    }

    .btn-primary {
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        transition: all 0.3s ease;
        background-color: #4e73df;
        border: none;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(78,115,223,0.2);
        background-color: #3a5ecc;
    }

    /* Lista de encuestas mejorada */
    .encuesta-item {
        padding: 1.5rem;
        background-color: white;
        border-radius: 15px;
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
        border-left: 4px solid #4e73df;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        animation: fadeIn 0.5s ease-out;
        cursor: pointer;
    }

    .encuesta-item:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .encuesta-item h5 {
        color: #2e384d;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .encuesta-item p {
        color: #858796;
        margin-bottom: 1rem;
    }

    /* Badges mejorados */
    .badge {
        padding: 0.5rem 1rem;
        border-radius: 10px;
        font-weight: 600;
    }

    .bg-success {
        background-color: #1cc88a !important;
    }

    /* Responsividad mejorada */
    @media (min-width: 992px) {
        .distribution-charts {
            flex-direction: row;
        }
        
        .chart-box {
            flex: 1;
        }
    }

    @media (max-width: 991px) {
        .chart-container {
            height: 450px;
        }
    }

    @media (max-width: 768px) {
        .container-fluid {
            padding: 1rem;
        }

        .chart-container {
            height: 400px;
            padding: 1rem;
        }

        .nav-tabs .nav-link {
            padding: 0.75rem 1rem;
        }

        .tab-content {
            padding: 1rem;
        }

        .encuesta-item {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">Estadísticas de Municipios</h1>
    
    <!-- Filtros de búsqueda -->
    <div class="row">
        <div class="col-12">
            <div class="filters-card shadow">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Filtrar estadísticas</h6>
                </div>
                <div class="card-body">
                    <form method="get" action="{% url 'estadisticas_municipios' %}" class="row mb-4">
                        <div class="col-md-5">
                            <label for="region" class="form-label">Región:</label>
                            <select id="region" name="region" class="form-select" onchange="cargarMunicipios()">
                                <option value="todas" >Todas las regiones</option>
                                {% for region in regiones %}
                                    <option value="{{ region.id }}">{{ region.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label for="municipio" class="form-label">Municipio:</label>
                            <select id="municipio" name="municipio" class="form-select">
                                <option value="todos" >Todos los municipios</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">Filtrar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de estadísticas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Estadísticas por Municipio</h6>
                    <button class="btn btn-sm btn-success" onclick="exportarExcel()">
                        <i class="fas fa-file-excel"></i> Exportar a Excel
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="tablaEstadisticas">
                            <thead>
                                <tr>
                                    <th>Municipio</th>
                                    <th>Región</th>
                                    <th>Total Encuestas</th>
                                    <th>Total Respuestas</th>
                                    <th>Encuestas Completadas</th>
                                    <th>Tasa de Finalización</th>
                                    <th>Clasificación</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for municipio in datos_municipios.values %}
                                <tr>
                                    <td>{{ municipio.nombre }}</td>
                                    <td>{{ municipio.region }}</td>
                                    <td>{{ municipio.totalEncuestas }}</td>
                                    <td>{{ municipio.totalRespuestas }}</td>
                                    <td>{{ municipio.encuestasRespondidas }}</td>
                                    <td>{{ municipio.tasaFinalizacion }}%</td>
                                    <td>
                                        {% if municipio.tasaFinalizacion >= 80 %}
                                            <span class="badge bg-success">Alto</span>
                                        {% elif municipio.tasaFinalizacion >= 50 %}
                                            <span class="badge bg-warning">Medio</span>
                                        {% else %}
                                            <span class="badge bg-danger">Bajo</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tarjetas de resumen de estadísticas -->
    <div class="row" id="estadisticasResumen">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total de Encuestas</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_encuestas }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Total de Respuestas</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_respuestas }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-comments fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Encuestas Completadas</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_encuestas_completadas }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Tasa de Finalización</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ tasa_finalizacion }}%</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-percentage fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pestañas para diferentes visualizaciones -->
    <div class="stats-dashboard">
        <div class="nav-tabs-container">
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="historial-tab" data-bs-toggle="tab" data-bs-target="#historial" type="button" role="tab">
                        <i class="fas fa-chart-line mr-2"></i>Historial de Respuestas
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="distribucion-tab" data-bs-toggle="tab" data-bs-target="#distribucion" type="button" role="tab">
                        <i class="fas fa-chart-pie mr-2"></i>Distribución de Respuestas
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="encuestas-tab" data-bs-toggle="tab" data-bs-target="#encuestas" type="button" role="tab">
                        <i class="fas fa-list mr-2"></i>Encuestas Disponibles
                    </button>
                </li>
            </ul>
        </div>
        
        <div class="tab-content" id="myTabContent">
            <!-- Historial de Respuestas -->
            <div class="tab-pane fade show active" id="historial" role="tabpanel">
                <div class="chart-container">
                    <div id="historialChart" style="width: 100%; height: 100%;"></div>
                </div>
            </div>
            
            <!-- Distribución de Respuestas -->
            <div class="tab-pane fade" id="distribucion" role="tabpanel">
                <div class="distribution-charts">
                    <div class="chart-box">
                        <div class="chart-container">
                            <div id="pieChart" style="width: 100%; height: 100%;"></div>
                        </div>
                    </div>
                    <div class="chart-box">
                        <div class="chart-container">
                            <div id="barChart" style="width: 100%; height: 100%;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Lista de Encuestas -->
            <div class="tab-pane fade" id="encuestas" role="tabpanel">
                <div class="encuesta-list">
                    {% if encuestas %}
                        {% for encuesta in encuestas %}
                            <div class="encuesta-item" onclick="window.location.href='/encuestas/{{ encuesta.id }}/resultados/'">
                                <h5>{{ encuesta.titulo }}</h5>
                                <p>{{ encuesta.descripcion }}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge {% if encuesta.es_publica %}bg-success{% else %}bg-secondary{% endif %}">
                                        {% if encuesta.es_publica %}Pública{% else %}Privada{% endif %}
                                    </span>
                                    <span>Respuestas: {{ encuesta.total_respuestas }}</span>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="far fa-frown fa-3x text-gray-400 mb-3"></i>
                            <p>No hay encuestas disponibles para mostrar.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script id="datos-municipios" type="application/json">
{% if municipios %}
[
    {% for municipio in municipios %}
    {
        "id": "{{ municipio.id }}",
        "nombre": "{{ municipio.nombre|escapejs }}",
        "region": "{{ municipio.region.id }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
]
{% else %}
[]
{% endif %}
</script>

<script id="datos-graficos" type="application/json">
{
    "historial": {
        "meses": {{ historial_meses|safe }},
        "conteos": {{ historial_conteos|safe }}
    },
    "regiones": {
        "nombres": [{% for nombre, valor in datos_regiones.items %}"{{ nombre|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %}],
        "datos": [{% for nombre, valor in datos_regiones.items %}{ "name": "{{ nombre|escapejs }}", "value": {{ valor }} }{% if not forloop.last %},{% endif %}{% endfor %}]
    },
    "municipios": {
        "nombres": [{% for municipio in top_municipios %}"{{ municipio.nombre|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %}],
        "valores": [{% for municipio in top_municipios %}{{ municipio.totalRespuestas }}{% if not forloop.last %},{% endif %}{% endfor %}]
    }
}
</script>

<script>
    // Asegurarse de que el JSON se carga correctamente
    let todosMunicipios = [];
    let datosGraficos = {};
    
    try {
        const jsonMunicipios = document.getElementById('datos-municipios').textContent.trim();
        if (jsonMunicipios) {
            todosMunicipios = JSON.parse(jsonMunicipios);
        }
        
        const jsonGraficos = document.getElementById('datos-graficos').textContent.trim();
        if (jsonGraficos) {
            datosGraficos = JSON.parse(jsonGraficos);
        }
    } catch (error) {
        console.error("Error al cargar datos JSON:", error);
        todosMunicipios = [];
        datosGraficos = {
            historial: { meses: [], conteos: [] },
            regiones: { nombres: [], datos: [] },
            municipios: { nombres: [], valores: [] }
        };
    }

    function cargarMunicipios() {
        try {
            const regionId = document.getElementById('region').value;
            const municipioSelect = document.getElementById('municipio');
            const municipioSeleccionado = '{{ municipio_seleccionado }}';
            
            if (!municipioSelect) {
                console.error("No se encontró el elemento select de municipio");
                return;
            }
            
            // Guardar la opción seleccionada actualmente antes de limpiar
            const opcionSeleccionadaActual = municipioSelect.value;
            
            // Limpiar opciones actuales
            municipioSelect.innerHTML = '';

            // Opción por defecto
            const optionTodos = document.createElement('option');
            optionTodos.value = 'todos';
            optionTodos.text = 'Todos los municipios';
            if (municipioSeleccionado === 'todos' || !municipioSeleccionado) {
                optionTodos.selected = true;
            }
            municipioSelect.appendChild(optionTodos);

            // Si no hay municipios, terminamos aquí
            if (!todosMunicipios || !todosMunicipios.length) {
                console.warn("No hay datos de municipios disponibles");
                return;
            }

            // Filtrar y agregar municipios por región
            let municipioEncontrado = false;
            let municipiosAgregados = 0;
            
            todosMunicipios.forEach(function(municipio) {
                if (regionId === 'todas' || municipio.region === regionId) {
                    const option = document.createElement('option');
                    option.value = municipio.id;
                    option.text = municipio.nombre;
                    
                    // Marcar como seleccionado si coincide con el municipio previamente seleccionado
                    if (municipio.id === municipioSeleccionado) {
                        option.selected = true;
                        municipioEncontrado = true;
                    }
                    
                    // También mantener la selección actual si estamos cambiando de región
                    if (opcionSeleccionadaActual && municipio.id === opcionSeleccionadaActual && !municipioEncontrado) {
                        option.selected = true;
                    }
                    
                    municipioSelect.appendChild(option);
                    municipiosAgregados++;
                }
            });
            
            // Registrar para debugging
            console.log(`Municipios cargados para región ${regionId}: ${municipiosAgregados}`);
        } catch (error) {
            console.error("Error al cargar municipios:", error);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        try {
            // Configurar correctamente la región seleccionada
            const regionSeleccionada = '{{ region_seleccionada }}';
            const regionSelect = document.getElementById('region');
            
            if (regionSelect) {
                // Si hay una región seleccionada, establecerla
                if (regionSeleccionada) {
                    regionSelect.value = regionSeleccionada;
                }
                
                // Configurar el evento de cambio
                regionSelect.addEventListener('change', cargarMunicipios);
            }
            
            // Cargar municipios inicialmente
            cargarMunicipios();
            
            // Inicializar gráficos
            inicializarGraficos();
            
            // Ajustar tamaño de gráficos al cambiar de pestaña
            var tabLinks = document.querySelectorAll('.nav-link');
            tabLinks.forEach(function(tabLink) {
                tabLink.addEventListener('shown.bs.tab', function (e) {
                    window.dispatchEvent(new Event('resize'));
                });
            });
        } catch (error) {
            console.error("Error durante la inicialización:", error);
        }
    });

    function exportarExcel() {
        try {
            // Obtener la tabla
            const tabla = document.getElementById('tablaEstadisticas');
            
            // Crear un libro de Excel
            const wb = XLSX.utils.book_new();
            
            // Convertir la tabla a una hoja de Excel
            const ws = XLSX.utils.table_to_sheet(tabla);
            
            // Ajustar el ancho de las columnas
            const wscols = [
                {wch: 20}, // Municipio
                {wch: 15}, // Región
                {wch: 15}, // Total Encuestas
                {wch: 15}, // Total Respuestas
                {wch: 20}, // Encuestas Completadas
                {wch: 20}, // Tasa de Finalización
                {wch: 15}  // Clasificación
            ];
            ws['!cols'] = wscols;
            
            // Agregar la hoja al libro
            XLSX.utils.book_append_sheet(wb, ws, "Estadísticas");
            
            // Generar el archivo Excel
            const fecha = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `estadisticas_municipios_${fecha}.xlsx`);
        } catch (error) {
            console.error("Error al exportar a Excel:", error);
            alert("Error al exportar a Excel. Por favor, intente nuevamente.");
        }
    }

    function inicializarGraficos() {
        // Verificar si los elementos DOM existen
        const historialElement = document.getElementById('historialChart');
        const pieElement = document.getElementById('pieChart');
        const barElement = document.getElementById('barChart');
        
        // Si no hay datos, no inicializar gráficos
        if (!datosGraficos || !datosGraficos.historial) {
            console.warn("No hay datos disponibles para los gráficos");
            return;
        }

        // Colores para los gráficos
        const colores = ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#5a5c69', '#858796', '#6f42c1', '#e83e8c', '#fd7e14'];

        // Inicializar gráfico de historial
        if (historialElement) {
            try {
                const trace = {
                    x: datosGraficos.historial.meses,
                    y: datosGraficos.historial.conteos,
                    type: 'bar',
                    name: 'Respuestas',
                    marker: {
                        color: colores[0],
                        line: {
                            color: '#224abe',
                            width: 1
                        }
                    }
                };

                const layout = {
                    title: {
                        text: 'Historial de Respuestas por Mes',
                        font: {
                            size: 20,
                            color: '#2e384d'
                        }
                    },
                    xaxis: {
                        title: 'Mes',
                        tickangle: 45,
                        tickfont: {
                            size: 12,
                            color: '#5a5c69'
                        }
                    },
                    yaxis: {
                        title: 'Número de respuestas',
                        tickfont: {
                            size: 12,
                            color: '#5a5c69'
                        }
                    },
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    margin: {
                        l: 50,
                        r: 50,
                        b: 100,
                        t: 50,
                        pad: 4
                    }
                };

                const config = {
                    responsive: true,
                    displayModeBar: false
                };

                Plotly.newPlot(historialElement, [trace], layout, config);
            } catch (error) {
                console.error("Error al inicializar gráfico de historial:", error);
            }
        }

        // Inicializar gráfico de distribución por región
        if (pieElement) {
            try {
                const trace = {
                    labels: datosGraficos.regiones.nombres,
                    values: datosGraficos.regiones.datos.map(d => d.value),
                    type: 'pie',
                    hole: 0.4,
                    marker: {
                        colors: colores
                    },
                    textinfo: 'label+percent',
                    textposition: 'outside',
                    automargin: true
                };

                const layout = {
                    title: {
                        text: 'Distribución por Región',
                        font: {
                            size: 20,
                            color: '#2e384d'
                        }
                    },
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    margin: {
                        l: 0,
                        r: 0,
                        b: 0,
                        t: 50,
                        pad: 4
                    },
                    showlegend: true,
                    legend: {
                        orientation: 'v',
                        y: 0.5
                    }
                };

                const config = {
                    responsive: true,
                    displayModeBar: false
                };

                Plotly.newPlot(pieElement, [trace], layout, config);
            } catch (error) {
                console.error("Error al inicializar gráfico de distribución por región:", error);
            }
        }

        // Inicializar gráfico de barras de municipios
        if (barElement) {
            try {
                const trace = {
                    x: datosGraficos.municipios.valores,
                    y: datosGraficos.municipios.nombres,
                    type: 'bar',
                    orientation: 'h',
                    marker: {
                        color: colores[1],
                        line: {
                            color: '#159a68',
                            width: 1
                        }
                    }
                };

                const layout = {
                    title: {
                        text: 'Top Municipios por Respuestas',
                        font: {
                            size: 20,
                            color: '#2e384d'
                        }
                    },
                    xaxis: {
                        title: 'Respuestas',
                        tickfont: {
                            size: 12,
                            color: '#5a5c69'
                        }
                    },
                    yaxis: {
                        tickfont: {
                            size: 12,
                            color: '#5a5c69'
                        }
                    },
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    margin: {
                        l: 150,
                        r: 50,
                        b: 50,
                        t: 50,
                        pad: 4
                    }
                };

                const config = {
                    responsive: true,
                    displayModeBar: false
                };

                Plotly.newPlot(barElement, [trace], layout, config);
            } catch (error) {
                console.error("Error al inicializar gráfico de barras de municipios:", error);
            }
        }

        // Manejar la responsividad
        window.addEventListener('resize', function() {
            if (historialElement) {
                try {
                    Plotly.Plots.resize(historialElement);
                } catch (error) {
                    console.error("Error al redimensionar gráfico de historial:", error);
                }
            }
            if (pieElement) {
                try {
                    Plotly.Plots.resize(pieElement);
                } catch (error) {
                    console.error("Error al redimensionar gráfico de distribución:", error);
                }
            }
            if (barElement) {
                try {
                    Plotly.Plots.resize(barElement);
                } catch (error) {
                    console.error("Error al redimensionar gráfico de barras:", error);
                }
            }
        });
    }
</script>
{% endblock %}
