{% extends 'base.html' %}
{% load static %}

{% block title %}Estadísticas Históricas | Corpensar{% endblock %}

{% block styles %}
<style>
    /* Mejoras generales */
    .container-fluid {
        padding: 2rem;
        max-width: 100%;
    }

    /* Animaciones */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
        from { transform: translateX(-20px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* Contenedor principal de estadísticas */
    .stats-dashboard {
        background-color: #f8f9fc;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        margin-bottom: 2rem;
    }

    /* Tarjetas de estadísticas mejoradas */
    .card {
        transition: all 0.3s ease;
        animation: fadeIn 0.5s ease-out;
        margin-bottom: 1.5rem;
        border: none;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0,0,0,0.1);
    }

    .border-left-primary { border-left: 0.5rem solid #4e73df !important; }
    .border-left-success { border-left: 0.5rem solid #1cc88a !important; }
    .border-left-info { border-left: 0.5rem solid #36b9cc !important; }
    .border-left-warning { border-left: 0.5rem solid #f6c23e !important; }

    /* Tabs mejoradas */
    .nav-tabs-container {
        background-color: white;
        border-radius: 15px 15px 0 0;
        padding: 1rem 1rem 0 1rem;
        box-shadow: 0 -2px 15px rgba(0,0,0,0.03);
    }

    .nav-tabs {
        border-bottom: none;
        margin-bottom: 0;
    }

    .nav-tabs .nav-item {
        margin-bottom: 0;
    }

    .nav-tabs .nav-link {
        border: none;
        color: #858796;
        font-weight: 600;
        padding: 1rem 1.5rem;
        transition: all 0.3s ease;
        position: relative;
        border-radius: 10px 10px 0 0;
    }

    .nav-tabs .nav-link:hover {
        color: #4e73df;
        background-color: #f8f9fc;
    }

    .nav-tabs .nav-link.active {
        color: #4e73df;
        background-color: #f8f9fc;
        border-bottom: 3px solid #4e73df;
    }

    /* Contenedor de gráficos significativamente mejorado */
    .tab-content {
        background-color: #f8f9fc;
        border-radius: 0 0 15px 15px;
        padding: 2rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }

    .chart-container {
        height: 600px; /* Mucho más alto para mejor visualización */
        width: 100%;
        margin: 0;
        padding: 1.5rem;
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }

    .chart-container:hover {
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    .distribution-charts {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    /* Formulario de filtros mejorado */
    .filters-card { /* Se puede eliminar o reutilizar si es necesario */
        /* background-color: white; */
        /* border-radius: 15px; */
        /* box-shadow: 0 5px 15px rgba(0,0,0,0.05); */
        margin-bottom: 2rem;
        /* border: 1px solid #e3e6f0; */
        /* padding: 1.5rem; */
    }

    .filters-card .card-header {
        background-color: transparent;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        padding: 1.25rem 1.5rem;
    }

    .form-select {
        border-radius: 10px;
        border: 1px solid #d1d3e2;
        padding: 0.75rem;
        transition: all 0.3s ease;
        background-color: #f8f9fc;
    }

    .form-select:focus {
        border-color: #4e73df;
        box-shadow: 0 0 0 0.2rem rgba(78,115,223,0.25);
    }

    .btn-primary {
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        transition: all 0.3s ease;
        background-color: #4e73df;
        border: none;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(78,115,223,0.2);
        background-color: #3a5ecc;
    }

    /* Lista de encuestas mejorada */
    .encuesta-item {
        padding: 1.5rem;
        background-color: white;
        border-radius: 15px;
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
        border-left: 4px solid #4e73df;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        animation: fadeIn 0.5s ease-out;
        cursor: pointer;
    }

    .encuesta-item:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .encuesta-item h5 {
        color: #2e384d;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .encuesta-item p {
        color: #858796;
        margin-bottom: 1rem;
    }

    /* Badges mejorados */
    .badge {
        font-size: 0.85em;
        padding: 0.35em 0.65em;
        border-radius: 10px;
        font-weight: 600;
    }

    .bg-success {
        background-color: #1cc88a !important;
    }

    /* Responsividad mejorada */
    @media (min-width: 992px) {
        .distribution-charts {
            flex-direction: row;
        }

        .chart-box {
            flex: 1;
        }
    }

    @media (max-width: 991px) {
        .chart-container {
            height: 450px;
        }
    }

    @media (max-width: 768px) {
        .container-fluid {
            padding: 1rem;
        }

        .chart-container {
            height: 400px;
            padding: 1rem;
        }

        .nav-tabs .nav-link {
            padding: 0.75rem 1rem;
        }

        .tab-content {
            padding: 1rem;
        }

        .encuesta-item {
            padding: 1rem;
        }
        
        /* Mejoras en la tabla para dispositivos pequeños */
        .table-responsive-fixed {
            max-height: none; /* Eliminar altura fija */
        }
        
        .categoria-columna {
            min-width: 100px; /* Ancho mínimo para columnas de categorías */
        }
    }

    /* Estilos para las tarjetas de encuestas */
    .hover-card {
        transition: all 0.3s ease;
        border-radius: 10px;
        overflow: hidden;
        height: 100%;
    }

    .hover-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
    }

    .hover-card .card-header {
        background-color: #f8f9fc;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .hover-card .card-body {
        padding: 1.5rem;
    }

    .hover-card .card-footer {
        background-color: white;
        padding: 1rem 1.5rem;
    }

    .hover-card .card-title {
        font-weight: 600;
        color: #2e384d;
        margin-bottom: 0.75rem;
        font-size: 1.1rem;
        height: 2.5rem;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .hover-card .card-text {
        color: #5a5c69;
        height: 4.5rem;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
    }

    /* Estilos para los botones de acción */
    .hover-card .btn-sm {
        border-radius: 20px;
        padding: 0.4rem 0.8rem;
        font-size: 0.75rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .hover-card .btn-sm:hover {
        transform: translateY(-2px);
    }

    .hover-card .btn-primary {
        background-color: #4e73df;
        border-color: #4e73df;
    }

    .hover-card .btn-secondary {
        background-color: #858796;
        border-color: #858796;
    }

    /* Estilos para la tabla con altura fija */
    .table-responsive-fixed {
        overflow-x: auto;
        margin-top: 1.5rem; /* Espacio entre filtros y tabla */
        position: relative;
    }
    
    /* Estilos específicos para dispositivos móviles */
    @media (max-width: 576px) {
        .table-responsive-fixed {
            font-size: 0.9rem;
        }
        
        /* Permitir que la tabla tenga scroll horizontal en móviles */
        #tablaEstadisticas {
            white-space: nowrap;
            min-width: 800px; /* Asegurar que la tabla no se comprima demasiado */
        }
        
        /* Hacer que las columnas principales sean más estrechas */
        #tablaEstadisticas th:first-child,
        #tablaEstadisticas td:first-child {
            max-width: 140px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Reducir tamaño de botones en móvil */
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        /* Mostrar tooltip con el nombre completo al pasar el cursor */
        .ellipsis-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    }

    .table-responsive-fixed thead th {
        position: sticky;
        top: 0;
        background-color: white;
        z-index: 1;
        border-top: none;
    }

    /* Estilos para secciones desplegables */
    .collapsible-section {
        margin-bottom: 1.5rem;
    }

    .collapsible-section .card-header {
        cursor: pointer;
    }

    /* Estilo para el contenedor de filtros dentro de la tabla */
    .filtros-tabla-container {
        border-bottom: 1px solid #e3e6f0;
        padding-bottom: 1.5rem;
        margin-bottom: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- Modal para detalles de municipio -->
    <div class="modal fade" id="detalleFormulariosModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTituloDetalle">Detalle de Formularios</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <strong>Municipio/Región: </strong><span id="modalEntidadNombre"></span>
                    </div>
                    
                    <!-- Pestañas para tipos de vista -->
                    <ul class="nav nav-tabs mb-3" id="detalleModalTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="tabFormularios" data-bs-toggle="tab" data-bs-target="#contenidoFormularios" type="button" role="tab">
                                <i class="fas fa-list-alt me-1"></i> Formularios
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tabMunicipios" data-bs-toggle="tab" data-bs-target="#contenidoMunicipios" type="button" role="tab">
                                <i class="fas fa-map-marker-alt me-1"></i> Respuestas por Municipio
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="detalleModalTabContent">
                        <!-- Tab de Formularios -->
                        <div class="tab-pane fade show active" id="contenidoFormularios" role="tabpanel">
                            <div id="noDataMessage" class="alert alert-info d-none">
                                <i class="fas fa-info-circle me-2"></i> No hay datos de formularios disponibles para esta entidad.
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered" id="tablaFormularios">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Formulario</th>
                                            <th>Categoría</th>
                                            <th>Total Respuestas</th>
                                            <th>Completadas</th>
                                            <th>% Completitud</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cuerpoTablaFormularios">
                                        <!-- Se llenará dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Tab de Respuestas por Municipio -->
                        <div class="tab-pane fade" id="contenidoMunicipios" role="tabpanel">
                            <div id="noMunicipiosMessage" class="alert alert-info d-none">
                                <i class="fas fa-info-circle me-2"></i> No hay datos de municipios disponibles para esta región.
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered" id="tablaRespuestasMunicipios">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Municipio</th>
                                            <th>Total Respuestas</th>
                                            <th>Completadas</th>
                                            <th>% Completitud</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cuerpoTablaRespuestasMunicipios">
                                        <!-- Se llenará dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="exportarDetalleExcel">
                        <i class="fas fa-file-excel me-2"></i> Exportar Detalle
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SECCIÓN 4: TABLA DE ESTADÍSTICAS (Movida) + SECCIÓN 2: FILTROS (Integrada) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h4 class="m-0 font-weight-bold text-primary">Estadísticas Detalladas</h4>
                    <div>
                        <!-- Botón para elegir vista (Pendiente JS) -->
                        <div class="btn-group me-2" role="group" aria-label="Tipo de vista">
                            <input type="radio" class="btn-check" name="vistaTabla" id="vistaMunicipios" autocomplete="off" checked>
                            <label class="btn btn-outline-primary btn-sm" for="vistaMunicipios">Municipios</label>

                            <input type="radio" class="btn-check" name="vistaTabla" id="vistaRegiones" autocomplete="off">
                            <label class="btn btn-outline-primary btn-sm" for="vistaRegiones">Regiones</label>
                        </div>
                        <button class="btn btn-sm btn-success" onclick="exportarExcel()">
                            <i class="fas fa-file-excel"></i> Exportar
                        </button>
                        <!-- Se quita el botón de colapso de tabla por ahora -->
                    </div>
                </div>
                <div class="card-body">
                    <!-- SECCIÓN 2: FILTROS (Integrada aquí) -->
                    <div class="filtros-tabla-container">
                        <form method="get" action="{% url 'estadisticas_municipios' %}" class="row align-items-end">
                            <div class="col-md-5 mb-3 mb-md-0">
                                <label for="region" class="form-label fw-bold small">Región:</label>
                                <select id="region" name="region" class="form-select form-select-sm" onchange="cargarMunicipios()">
                                    <option value="todas" >Todas las regiones</option>
                                    {% for region in regiones %}
                                        <option value="{{ region.id }}" {% if region_seleccionada == region.id|stringformat:"s" %}selected{% endif %}>{{ region.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-5 mb-3 mb-md-0">
                                <label for="municipio" class="form-label fw-bold small">Municipio:</label>
                                <select id="municipio" name="municipio" class="form-select form-select-sm">
                                    <option value="todos" >Todos los municipios</option>
                                    <!-- Opciones se cargan con JS -->
                                    
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary btn-sm w-100">
                                    <i class="fas fa-filter me-1"></i> Filtrar
                                </button>
                            </div>
                        </form>
                    </div>
                    <!-- Fin Filtros Integrados -->

                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="tablaEstadisticas">
                            <thead class="table-light">
                                <!-- El contenido del thead cambiará con JS según vistaMunicipios/vistaRegiones -->
                                <tr>
                                    <th>Municipio</th>
                                    <th>Total Encuestas</th>
                                    <th>Total Respuestas</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- El contenido del tbody cambiará con JS -->   
                            </tbody>
                        </table>
                    </div>
                    <!-- Contenedor para controles de paginación -->
                    <div class="d-flex justify-content-end mt-3" id="paginacionControles"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- SECCIÓN 1: ENCUESTAS DISPONIBLES (Movida) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow collapsible-section">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between" data-bs-toggle="collapse" data-bs-target="#collapseEncuestas">
                    <h6 class="m-0 font-weight-bold text-primary">Encuestas Disponibles</h6>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="collapse" id="collapseEncuestas"> {# Cambiado a collapse por defecto #}
                    <div class="card-body">
                        <!-- Filtros para encuestas -->
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Filtrar encuestas</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3 g-2">
                                    <div class="col-md-3">
                                        <select id="filtroEstado" class="form-select form-select-sm">
                                            <option value="todas">Todas las encuestas</option>
                                            <option value="activas">Encuestas activas</option>
                                            <option value="finalizadas">Encuestas finalizadas</option>
                                            <option value="proximas">Encuestas próximas</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select id="filtroVisibilidad" class="form-select form-select-sm">
                                            <option value="todas">Todas</option>
                                            <option value="publicas">Públicas</option>
                                            <option value="privadas">Privadas</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select id="filtroGrupoInteres" class="form-select form-select-sm">
                                            <option value="todas">Todos los grupos</option>
                                            {% for grupo in grupos_interes %}
                                            <option value="{{ grupo.id }}">{{ grupo.nombre }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="input-group input-group-sm">
                                            <input type="text" id="buscarEncuesta" class="form-control" placeholder="Buscar por título...">
                                            <button class="btn btn-primary" type="button" id="btnBuscarEncuesta">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Grid de encuestas -->
                        <div class="row" id="encuestasGrid">
                            {% if encuestas %}
                                {% for encuesta in encuestas %}
                                    <div class="col-lg-4 col-md-6 mb-4 encuesta-card"
                                        data-estado="{% if encuesta.activa %}activa{% elif encuesta.is_proxima %}proxima{% else %}finalizada{% endif %}"
                                        data-visibilidad="{% if encuesta.es_publica %}publica{% else %}privada{% endif %}"
                                        data-grupo="{{ encuesta.grupo_interes|default:'todos' }}">
                                        <div class="card h-100 shadow-sm hover-card">
                                            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                                                <span class="badge {% if encuesta.activa %}bg-success{% elif encuesta.is_proxima %}bg-warning text-dark{% else %}bg-danger{% endif %} me-2">
                                                    {% if encuesta.activa %}Activa{% elif encuesta.is_proxima %}Próxima{% else %}Finalizada{% endif %}
                                                </span>
                                                <span class="badge {% if encuesta.es_publica %}bg-primary{% else %}bg-info text-dark{% endif %}"> {# Ajustado color badge privado #}
                                                    {% if encuesta.es_publica %}Pública{% else %}Privada{% endif %}
                                                </span>
                                            </div>
                                            <div class="card-body">
                                                <h5 class="card-title">{{ encuesta.titulo }}</h5>
                                                <p class="card-text small">{{ encuesta.descripcion|truncatechars:100 }}</p> {# Truncar descripción #}

                                                <div class="d-flex justify-content-between align-items-center mt-3">
                                                    <small class="text-muted"><i class="fas fa-poll me-1"></i> Respuestas: {{ encuesta.total_respuestas }}</small>
                                                    {# Podría añadirse fecha inicio/fin si existen en el modelo 'encuesta' #}
                                                    <!-- <small class="text-muted"><i class="far fa-calendar-alt me-1"></i> {{ encuesta.fecha_inicio|date:"d/m/Y" }} - {{ encuesta.fecha_fin|date:"d/m/Y" }}</small> -->
                                                </div>
                                            </div>
                                            <div class="card-footer bg-light border-top-0"> {# Cambiado fondo footer #}
                                                <div class="d-grid gap-2 d-md-flex justify-content-md-end"> {# Alineado a la derecha #}
                                                    <a href="{% url 'resultados_encuesta' encuesta.id %}" class="btn btn-primary btn-sm">
                                                        <i class="fas fa-chart-bar me-1"></i> Resultados
                                                    </a>
                                                    <a href="{% url 'editar_encuesta' encuesta.id %}" class="btn btn-secondary btn-sm">
                                                        <i class="fas fa-cog me-1"></i> Ajustes
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="col-12 text-center py-5">
                                    <i class="far fa-frown fa-3x text-gray-400 mb-3"></i>
                                    <p>No hay encuestas disponibles para mostrar.</p>
                                    {# Considerar añadir un botón para crear una nueva encuesta si el usuario tiene permisos #}
                                    <!-- <a href="{% url 'crear_encuesta' %}" class="btn btn-primary mt-3"><i class="fas fa-plus me-1"></i> Crear Encuesta</a> -->
                                </div>
                            {% endif %}
                            <!-- Placeholder para mensaje de no resultados de filtro -->
                            <div id="mensajeNoResultadosEncuestas" class="col-12 text-center py-5" style="display: none;">
                                <i class="fas fa-search fa-3x text-gray-400 mb-3"></i>
                                <p>No se encontraron encuestas con los filtros seleccionados.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SECCIÓN 5: GRÁFICOS (Movida) -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow collapsible-section">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between" data-bs-toggle="collapse" data-bs-target="#collapseGraficos">
                    <h6 class="m-0 font-weight-bold text-primary">Gráficos y Visualizaciones</h6>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="collapse" id="collapseGraficos"> {# Cambiado a collapse por defecto #}
                    <div class="card-body">
                        <div class="stats-dashboard">
                            <div class="nav-tabs-container">
                                <ul class="nav nav-tabs" id="myTab" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="historial-tab" data-bs-toggle="tab" data-bs-target="#historial" type="button" role="tab" aria-controls="historial" aria-selected="true">
                                            <i class="fas fa-chart-line me-2"></i>Historial de Respuestas
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="distribucion-tab" data-bs-toggle="tab" data-bs-target="#distribucion" type="button" role="tab" aria-controls="distribucion" aria-selected="false">
                                            <i class="fas fa-chart-pie me-2"></i>Distribución Geográfica
                                        </button>
                                    </li>
                                    {# Añadir más pestañas si es necesario, ej: Distribución por Tipo de Pregunta #}
                                </ul>
                            </div>

                            <div class="tab-content p-0" id="myTabContent"> {# Quitado padding extra del tab-content #}
                                <!-- Historial de Respuestas -->
                                <div class="tab-pane fade show active p-3" id="historial" role="tabpanel" aria-labelledby="historial-tab"> {# Añadido padding a cada pane #}
                                    <div class="chart-container">
                                        <div id="historialChart" style="width: 100%; height: 100%;"></div>
                                    </div>
                                </div>

                                <!-- Distribución Geográfica -->
                                <div class="tab-pane fade p-3" id="distribucion" role="tabpanel" aria-labelledby="distribucion-tab"> {# Añadido padding a cada pane #}
                                    <div class="distribution-charts">
                                        <div class="chart-box">
                                            <h6 class="text-center mb-3 font-weight-bold text-primary">Respuestas por Región</h6>
                                            <div class="chart-container" style="height: 500px;"> {# Altura ajustada para pie #}
                                                <div id="pieChart" style="width: 100%; height: 100%;"></div>
                                            </div>
                                        </div>
                                        <div class="chart-box">
                                            <h6 class="text-center mb-3 font-weight-bold text-primary">Top 10 Municipios por Respuestas</h6>
                                            <div class="chart-container" style="height: 500px;"> {# Altura ajustada para bar #}
                                                <div id="barChart" style="width: 100%; height: 100%;"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {# Añadir más tab-panes aquí #}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script id="datos-municipios" type="application/json">
{{ municipios|safe }}
</script>

<script id="datos-graficos" type="application/json">
{{ datos_graficos_json|safe }}
</script>

<script id="datos-tabla-regiones" type="application/json">
{{ datos_regiones_tabla_json|safe }}
</script>

<script id="datos-tabla-municipios" type="application/json">
{{ datos_municipios_json|safe }}
</script>

<!-- Datos de formularios por municipio/región -->
<script id="datos-formularios-detalle" type="application/json">
{{ datos_formularios_detalle_json|safe }}
</script>

<!-- Datos de categorías disponibles -->
<script id="datos-categorias" type="application/json">
{{ todas_categorias_json|safe }}
</script>

<script>
    // Asegurarse de que el JSON se carga correctamente
    let todosMunicipios = [];
    let datosGraficos = {};
    let datosTablaRegiones = []; 
    let datosTablaMunicipios = [];
    let datosFormulariosDetalle = {}; // Detalle de formularios por municipio/región
    let todasCategorias = []; // Todas las categorías disponibles

    // --- Variables Globales para Paginación ---
    let paginaActual = 1;
    const filasPorPagina = 15; // Número de filas por página
    let datosTablaActual = []; // Almacenará los datos de municipios o regiones
    let vistaTablaActual = 'vistaMunicipios'; // Para saber qué datos paginar

    try {
        const jsonMunicipios = document.getElementById('datos-municipios').textContent.trim();
        if (jsonMunicipios) {
            todosMunicipios = JSON.parse(jsonMunicipios);
        } else {
            console.warn("No se encontró JSON para 'datos-municipios'");
        }

        const jsonGraficos = document.getElementById('datos-graficos').textContent.trim();
        if (jsonGraficos) {
            datosGraficos = JSON.parse(jsonGraficos);
        } else {
            console.warn("No se encontró JSON para 'datos-graficos'");
            datosGraficos = {
                historial: { meses: [], conteos: [] },
                regiones: { nombres: [], datos: [] },
                municipios: { nombres: [], valores: [] }
            };
        }
        // Cargar datos para la tabla de regiones
        const jsonTablaRegiones = document.getElementById('datos-tabla-regiones').textContent.trim();
        if (jsonTablaRegiones) {
            datosTablaRegiones = JSON.parse(jsonTablaRegiones);
        } else {
            console.warn("No se encontró JSON para 'datos-tabla-regiones'");
        }
        
        // Cargar datos para la tabla de municipios
        const jsonTablaMunicipios = document.getElementById('datos-tabla-municipios').textContent.trim();
        if (jsonTablaMunicipios) {
            datosTablaMunicipios = JSON.parse(jsonTablaMunicipios);
        } else {
            console.warn("No se encontró JSON para 'datos-tabla-municipios'");
        }

        // Cargar datos de formularios detalle
        const jsonFormulariosDetalle = document.getElementById('datos-formularios-detalle').textContent.trim();
        if (jsonFormulariosDetalle) {
            try {
                datosFormulariosDetalle = JSON.parse(jsonFormulariosDetalle);
                console.log('Datos de formularios detalle cargados:', Object.keys(datosFormulariosDetalle).length);
            } catch (e) {
                console.error('Error al parsear datos de formularios detalle:', e);
                datosFormulariosDetalle = {};
            }
        } else {
            console.warn("No se encontró JSON para 'datos-formularios-detalle'");
            datosFormulariosDetalle = {};
        }
        
        // Cargar datos de categorías 
        const jsonCategorias = document.getElementById('datos-categorias').textContent.trim();
        if (jsonCategorias) {
            todasCategorias = JSON.parse(jsonCategorias);
        } else {
            console.warn("No se encontró JSON para 'datos-categorias'");
            todasCategorias = [];
        }

    } catch (error) {
        console.error("Error al cargar datos JSON iniciales:", error);
        todosMunicipios = [];
        datosGraficos = {
            historial: { meses: [], conteos: [] },
            regiones: { nombres: [], datos: [] },
            municipios: { nombres: [], valores: [] }
        };
        datosTablaRegiones = [];
        datosTablaMunicipios = [];
        datosFormulariosDetalle = {};
        todasCategorias = [];
    }

    function cargarMunicipios() {
        try {
            const regionId = document.getElementById('region').value;
            const municipioSelect = document.getElementById('municipio');
            const municipioSeleccionado = '{{ municipio_seleccionado|default:"todos" }}'; // Valor por defecto 'todos'

            if (!municipioSelect) {
                console.error("No se encontró el elemento select de municipio");
                return;
            }

            // Guardar la opción seleccionada actualmente antes de limpiar
            const opcionSeleccionadaActual = municipioSelect.value;

            // Limpiar opciones actuales
            municipioSelect.innerHTML = '';

            // Opción por defecto
            const optionTodos = document.createElement('option');
            optionTodos.value = 'todos';
            optionTodos.text = 'Todos los municipios';
            // Seleccionar 'todos' si es el valor por defecto o si no hay selección previa
            if (municipioSeleccionado === 'todos' || !municipioSeleccionado) {
                optionTodos.selected = true;
            }
            municipioSelect.appendChild(optionTodos);

            // Si no hay municipios, terminamos aquí
            if (!todosMunicipios || !todosMunicipios.length) {
                console.warn("No hay datos de municipios disponibles para cargar en el select");
                return;
            }

            // Filtrar y agregar municipios por región
            let municipioEncontradoEnNuevaLista = false;
            let municipiosAgregados = 0;

            todosMunicipios.forEach(function(municipio) {
                if (regionId === 'todas' || String(municipio.region) === regionId) {
                    const option = document.createElement('option');
                    option.value = municipio.id;
                    option.text = municipio.nombre;

                    // Marcar como seleccionado si coincide con el municipio que venía del backend
                    if (String(municipio.id) === municipioSeleccionado) {
                        option.selected = true;
                        municipioEncontradoEnNuevaLista = true;
                    }

                    // Si no se encontró el del backend, intentar mantener la selección actual si existe en la nueva lista
                    if (!municipioEncontradoEnNuevaLista && opcionSeleccionadaActual && String(municipio.id) === opcionSeleccionadaActual) {
                    option.selected = true;
                    }


                    municipioSelect.appendChild(option);
                    municipiosAgregados++;
                }
            });

             // Si el municipio seleccionado originalmente ya no está en la lista (porque se cambió de región),
             // y no se seleccionó 'todos' por defecto, asegurarse de que 'todos' quede seleccionado.
            if (!municipioEncontradoEnNuevaLista && municipioSeleccionado !== 'todos' && municipioSelect.value !== 'todos') {
                municipioSelect.value = 'todos';
            }

            // Registrar para debugging
            // console.log(`Municipios cargados para región ${regionId}: ${municipiosAgregados}. Seleccionado: ${municipioSelect.value}`);

        } catch (error) {
            console.error("Error al cargar municipios:", error);
        }
    }

    // Función para actualizar la tabla (cambiar entre municipios y regiones)
    function actualizarVistaTabla() {
        vistaTablaActual = document.querySelector('input[name="vistaTabla"]:checked').id;
        const tabla = document.getElementById('tablaEstadisticas');
        const thead = tabla.querySelector('thead tr');
        
        // Limpiar cabecera actual
        thead.innerHTML = '';
        
        // Reiniciar paginación
        paginaActual = 1;

        if (vistaTablaActual === 'vistaMunicipios') {
            // Configurar cabecera para municipios - columnas básicas
            let encabezados = `
                <th>Municipio</th>
                <th>Región</th>
                <th class="text-center">Total Respuestas</th>
            `;
            
            // Añadir columnas dinámicas para categorías
            todasCategorias.forEach(cat => {
                encabezados += `<th class="text-center categoria-columna">${cat.nombre}</th>`;
            });
            
            // Completar encabezados
            encabezados += `
                <th class="text-center">Acciones</th>
            `;
            
            // Establecer encabezados
            thead.innerHTML = encabezados;
            
            // Poblar tabla con datos de municipios
            datosTablaActual = datosTablaMunicipios;
 
        } else if (vistaTablaActual === 'vistaRegiones') {
            // Configurar cabecera para regiones - columnas básicas
            let encabezados = `
                <th>Región</th>
                <th class="text-center">Total Encuestas</th>
                <th class="text-center">Total Respuestas</th>
            `;
            
            // Añadir columnas dinámicas para categorías
            todasCategorias.forEach(cat => {
                encabezados += `<th class="text-center categoria-columna">${cat.nombre}</th>`;
            });
            
            // Completar encabezados
            encabezados += `
                <th class="text-center">Acciones</th>
            `;
            
            // Establecer encabezados
            thead.innerHTML = encabezados;
            
            // Poblar tabla con datos de regiones
            datosTablaActual = datosTablaRegiones;
        }

        // Renderizar la primera página de la tabla y los controles
        renderizarPaginaTabla();
        renderizarControlesPaginacion();
    }

    // --- Funciones para Paginación ---
    function renderizarPaginaTabla() {
        const tabla = document.getElementById('tablaEstadisticas');
        const tbody = tabla.querySelector('tbody');
        tbody.innerHTML = ''; // Limpiar cuerpo de la tabla

        const inicio = (paginaActual - 1) * filasPorPagina;
        const fin = inicio + filasPorPagina;
        const datosPagina = datosTablaActual.slice(inicio, fin);

        if (datosPagina.length === 0) {
            // Calcular número de columnas (básicas + categorías dinámicas + acciones)
            const numColumnas = (vistaTablaActual === 'vistaMunicipios' ? 6 : 5) + 
                                todasCategorias.length + 3; // +3 por grupos, clasificación y acciones
            
            tbody.innerHTML = `<tr><td colspan="${numColumnas}" class="text-center text-muted py-3">No hay datos para mostrar en esta página.</td></tr>`;
            return;
        }

        datosPagina.forEach(item => {
            
            // Crear elemento de fila
            const tr = document.createElement('tr');
            tr.setAttribute('data-tipo', vistaTablaActual === 'vistaMunicipios' ? 'municipio' : 'region');
            tr.setAttribute('data-id', item.id);
            
            // Añadir contenido básico según tipo de vista
            if (vistaTablaActual === 'vistaMunicipios') {
                tr.innerHTML = `
                    <td>${item.nombre}</td>
                    <td>${item.region}</td>
                    <td class="text-center">${item.totalRespuestas}</td>
                `;
            } else { // vistaRegiones
                tr.innerHTML = `
                    <td>${item.nombre}</td>
                    <td class="text-center">${item.totalEncuestas}</td>
                    <td class="text-center">${item.totalRespuestas}</td>
                `;
            }
            
            // Añadir celdas de categorías dinámicamente
            todasCategorias.forEach(cat => {
                const td = document.createElement('td');
                td.className = 'text-center';
                
                const conteo = item.categorias_count && item.categorias_count[cat.id] 
                    ? item.categorias_count[cat.id] 
                    : 0;
                
                if (conteo > 0) {
                    td.innerHTML = `<span class="badge bg-primary rounded-pill">${conteo}</span>`;
                } else {
                    td.innerHTML = `<span class="text-muted">-</span>`;
                }
                
                tr.appendChild(td);
            });
            
            // Añadir columna de acciones
            const tdAcciones = document.createElement('td');
            tdAcciones.className = 'text-center';
            tdAcciones.innerHTML = `
                <button class="btn btn-sm btn-primary ver-detalle-municipio" title="Ver detalle">
                    <i class="fas fa-search"></i>
                </button>
            `;
            tr.appendChild(tdAcciones);
            
            // Añadir fila a la tabla
            tbody.appendChild(tr);
        });
        
        // Reiniciar tooltips después de actualizar el DOM
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl)
        });
    }

    function renderizarControlesPaginacion() {
        const contenedor = document.getElementById('paginacionControles');
        contenedor.innerHTML = ''; // Limpiar controles existentes
        const totalPaginas = Math.ceil(datosTablaActual.length / filasPorPagina);

        if (totalPaginas <= 1) return; // No mostrar paginación si solo hay una página

        const ul = document.createElement('ul');
        ul.className = 'pagination pagination-sm mb-0';

        // Botón Anterior
        const liPrev = document.createElement('li');
        liPrev.className = `page-item ${paginaActual === 1 ? 'disabled' : ''}`;
        liPrev.innerHTML = `<a class="page-link" href="#" data-page="${paginaActual - 1}">&laquo;</a>`;
        ul.appendChild(liPrev);

        // Botones de Página (simplificado, muestra algunas páginas alrededor de la actual)
        const maxBotonesVisibles = 5; 
        let inicioPag = Math.max(1, paginaActual - Math.floor(maxBotonesVisibles / 2));
        let finPag = Math.min(totalPaginas, inicioPag + maxBotonesVisibles - 1);
        // Ajustar inicio si fin llega al límite
        if (finPag === totalPaginas) {
            inicioPag = Math.max(1, finPag - maxBotonesVisibles + 1);
        }

        if (inicioPag > 1) {
            const liFirst = document.createElement('li');
            liFirst.className = 'page-item';
            liFirst.innerHTML = `<a class="page-link" href="#" data-page="1">1</a>`;
            ul.appendChild(liFirst);
            if (inicioPag > 2) {
                const liEllipsisStart = document.createElement('li');
                liEllipsisStart.className = 'page-item disabled';
                liEllipsisStart.innerHTML = `<span class="page-link">...</span>`;
                ul.appendChild(liEllipsisStart);
            }
        }

        for (let i = inicioPag; i <= finPag; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === paginaActual ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            ul.appendChild(li);
        }

        if (finPag < totalPaginas) {
            if (finPag < totalPaginas - 1) {
                const liEllipsisEnd = document.createElement('li');
                liEllipsisEnd.className = 'page-item disabled';
                liEllipsisEnd.innerHTML = `<span class="page-link">...</span>`;
                ul.appendChild(liEllipsisEnd);
            }
            const liLast = document.createElement('li');
            liLast.className = 'page-item';
            liLast.innerHTML = `<a class="page-link" href="#" data-page="${totalPaginas}">${totalPaginas}</a>`;
            ul.appendChild(liLast);
        }
 
        // Botón Siguiente
        const liNext = document.createElement('li');
        liNext.className = `page-item ${paginaActual === totalPaginas ? 'disabled' : ''}`;
        liNext.innerHTML = `<a class="page-link" href="#" data-page="${paginaActual + 1}">&raquo;</a>`;
        ul.appendChild(liNext);

        contenedor.appendChild(ul);

        // Añadir listeners a los botones de página
        contenedor.querySelectorAll('.page-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetPage = parseInt(e.target.getAttribute('data-page'));
                if (targetPage && targetPage !== paginaActual && targetPage >= 1 && targetPage <= totalPaginas) {
                    paginaActual = targetPage;
                    renderizarPaginaTabla();
                    renderizarControlesPaginacion();
                    // Opcional: Hacer scroll suave a la tabla
                    // document.getElementById('tablaEstadisticas').scrollIntoView({ behavior: 'smooth' });
                }
            });
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        try {
            // Configurar correctamente la región seleccionada al cargar
            const regionSeleccionada = '{{ region_seleccionada|default:"todas" }}';
            const regionSelect = document.getElementById('region');

            if (regionSelect) {
                 if (regionSeleccionada && regionSeleccionada !== 'todas') {
                     regionSelect.value = regionSeleccionada;
                 }
                // Configurar el evento de cambio
                regionSelect.addEventListener('change', cargarMunicipios);
            } else {
                console.error("No se encontró el select de región");
            }

            // Cargar municipios inicialmente basado en la región seleccionada (o todas)
            cargarMunicipios();

            // Establecer el municipio seleccionado si existe uno
             const municipioSeleccionado = '{{ municipio_seleccionado|default:"todos" }}';
             const municipioSelect = document.getElementById('municipio');
             if (municipioSelect && municipioSeleccionado !== 'todos') {
                 // Esperar un breve momento para que las opciones se carguen si es asíncrono
                 setTimeout(() => {
                     if (Array.from(municipioSelect.options).some(opt => opt.value === municipioSeleccionado)) {
                         municipioSelect.value = municipioSeleccionado;
                     } else {
                         console.warn(`El municipio seleccionado ${municipioSeleccionado} no se encontró en la lista cargada.`);
                         municipioSelect.value = 'todos'; // Volver a 'todos' si no se encuentra
                     }
                 }, 100); // Pequeña demora
             }

            // Inicializar tooltips de Bootstrap
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
              return new bootstrap.Tooltip(tooltipTriggerEl)
            });

            // Configurar botones de categorías y grupos de interés
            document.addEventListener('click', function(e) {
                if (e.target.closest('.ver-categorias')) {
                    const btn = e.target.closest('.ver-categorias');
                    const fila = btn.closest('tr');
                    const index = Array.from(fila.parentNode.children).indexOf(fila);
                    
                    // Obtener datos del municipio/región correspondiente
                    const datos = vistaTablaActual === 'vistaMunicipios' 
                                ? datosTablaMunicipios[index] 
                                : datosTablaRegiones[index];
                    
                    if (datos && datos.categorias && datos.categorias.length > 0) {
                        mostrarDetalleModal('Categorías', datos.nombre, datos.categorias);
                    }
                }
                
                if (e.target.closest('.ver-grupos')) {
                    const btn = e.target.closest('.ver-grupos');
                    const fila = btn.closest('tr');
                    const index = Array.from(fila.parentNode.children).indexOf(fila);
                    
                    // Obtener datos del municipio/región correspondiente
                    const datos = vistaTablaActual === 'vistaMunicipios' 
                                ? datosTablaMunicipios[index] 
                                : datosTablaRegiones[index];
                    
                    if (datos && datos.grupos_interes && datos.grupos_interes.length > 0) {
                        mostrarDetalleModal('Grupos de Interés', datos.nombre, datos.grupos_interes);
                    }
                }
            });

            // Función para mostrar modal con detalles
            function mostrarDetalleModal(tipo, nombre, items) {
                // Buscar o crear el modal
                let modal = document.getElementById('detalleModal');
                if (!modal) {
                    const modalHTML = `
                    <div class="modal fade" id="detalleModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="modalLabel"></h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <ul class="list-group" id="modalLista"></ul>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                    
                    const div = document.createElement('div');
                    div.innerHTML = modalHTML;
                    document.body.appendChild(div.firstChild);
                    modal = document.getElementById('detalleModal');
                }
                
                // Actualizar contenido del modal
                document.getElementById('modalLabel').textContent = `${tipo} - ${nombre}`;
                const lista = document.getElementById('modalLista');
                lista.innerHTML = '';
                
                items.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.textContent = item.nombre;
                    
                    // Si tenemos conteo, mostrarlo como badge
                    if (item.count !== undefined) {
                        const span = document.createElement('span');
                        span.className = 'badge bg-primary rounded-pill';
                        span.textContent = item.count;
                        li.appendChild(span);
                    }
                    
                    lista.appendChild(li);
                });
                
                // Mostrar el modal
                const modalInstance = new bootstrap.Modal(modal);
                modalInstance.show();
            }

            // Inicializar gráficos
            inicializarGraficos();

            // Ajustar tamaño de gráficos al cambiar de pestaña de gráficos
            var tabLinksGraficos = document.querySelectorAll('#myTab .nav-link');
            tabLinksGraficos.forEach(function(tabLink) {
                tabLink.addEventListener('shown.bs.tab', function (e) {
                    // Plotly necesita redibujar cuando el contenedor se hace visible
                    window.dispatchEvent(new Event('resize'));
                });
            });

            // Inicializar filtros de encuestas
            const filtroEstado = document.getElementById('filtroEstado');
            const filtroVisibilidad = document.getElementById('filtroVisibilidad');
            const grupoSelect = document.getElementById('filtroGrupoInteres');
            const busquedaInput = document.getElementById('buscarEncuesta');
            const btnBuscarEncuesta = document.getElementById('btnBuscarEncuesta');

            if (filtroEstado) filtroEstado.addEventListener('change', filtrarEncuestas);
            if (filtroVisibilidad) filtroVisibilidad.addEventListener('change', filtrarEncuestas);
            if (grupoSelect) grupoSelect.addEventListener('change', filtrarEncuestas);
            if (btnBuscarEncuesta) btnBuscarEncuesta.addEventListener('click', filtrarEncuestas);
            if (busquedaInput) {
                busquedaInput.addEventListener('keyup', function(event) {
                    if (event.key === 'Enter') {
                        filtrarEncuestas();
                    }
                });
            }
             // Aplicar filtro inicial de encuestas si es necesario
            filtrarEncuestas();


            // Controlar el comportamiento de los botones de colapso
            document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(button => {
                const icon = button.querySelector('i.fa-chevron-down, i.fa-chevron-up');
                if (!icon) return; // Si no hay icono, no hacer nada

                 // Estado inicial del icono basado en si el collapse está 'show'
                const targetSelector = button.getAttribute('data-bs-target');
                const targetElement = document.querySelector(targetSelector);
                if (targetElement && targetElement.classList.contains('show')) {
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                } else {
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                }


                button.addEventListener('click', function() {
                    // El icono cambia inmediatamente al hacer clic
                    if (icon.classList.contains('fa-chevron-down')) {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    } else {
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    }

                    // Ajustar gráficos después de que la animación de colapso termine
                    const target = this.getAttribute('data-bs-target');
                    const collapsibleElement = document.querySelector(target);
                    if (collapsibleElement) {
                        collapsibleElement.addEventListener('shown.bs.collapse', function () {
                            window.dispatchEvent(new Event('resize'));
                        }, { once: true }); // Solo una vez por evento show
                    }
                });
            });

            // Añadir listeners para cambiar la vista de la tabla
            document.querySelectorAll('input[name="vistaTabla"]').forEach(radio => {
                radio.addEventListener('change', actualizarVistaTabla);
            });
            // Llamar a la función una vez al inicio para establecer la vista por defecto (Municipios)
            actualizarVistaTabla();

            // Configurar evento para botones de detalle de municipio/región
            document.addEventListener('click', function(e) {
                // Evento para botones de ver detalle
                if (e.target.closest('.ver-detalle-municipio')) {
                    const btn = e.target.closest('.ver-detalle-municipio');
                    const fila = btn.closest('tr');
                    const entidadId = fila.getAttribute('data-id');
                    const entidadNombre = fila.querySelector('td:first-child').textContent;
                    const tipoEntidad = fila.getAttribute('data-tipo');
                    
                    mostrarDetalleFormularios(entidadId, entidadNombre, tipoEntidad);
                }
                
                // ... existing code para ver grupos ...
            });

        } catch (error) {
            console.error("Error durante la inicialización general:", error);
            // Mostrar un mensaje al usuario podría ser útil aquí
             // alert("Ocurrió un error al cargar la página. Algunos elementos pueden no funcionar correctamente.");
        }
    });

    function exportarExcel() {
        try {
            const vistaActual = document.querySelector('input[name="vistaTabla"]:checked').id;
            const tabla = document.getElementById('tablaEstadisticas');
            const regionSeleccionada = document.getElementById('region').selectedOptions[0].text;
            const municipioSeleccionado = document.getElementById('municipio').selectedOptions[0].text;

            // Crear un libro de Excel
            const wb = XLSX.utils.book_new();
            
            // --- HOJA DE INFORMACIÓN ---
            const hojaInfo = [];
            // Título principal
            hojaInfo.push([`ESTADÍSTICAS POR ${vistaActual === 'vistaMunicipios' ? 'MUNICIPIOS' : 'REGIONES'}`]);
            hojaInfo.push(['']);
            
            // Información del reporte
            hojaInfo.push(['INFORMACIÓN DEL REPORTE']);
            hojaInfo.push(['Fecha de generación:', new Date().toLocaleString()]);
            hojaInfo.push(['']);
            
            // Filtros aplicados
            hojaInfo.push(['FILTROS APLICADOS']);
            hojaInfo.push(['Región:', regionSeleccionada]);
            if (vistaActual === 'vistaMunicipios') {
                hojaInfo.push(['Municipio:', municipioSeleccionado]);
            }
            hojaInfo.push(['']);
            
            // Resumen estadístico
            hojaInfo.push(['RESUMEN ESTADÍSTICO']);
            hojaInfo.push(['Cantidad total de encuestas:', '{{ total_encuestas }}']);
            hojaInfo.push(['Total respuestas recibidas:', '{{ total_respuestas }}']);
            // Eliminar total de encuestas completadas como solicitó el usuario
            
            // Crear hoja de información
            const wsInfo = XLSX.utils.aoa_to_sheet(hojaInfo);
            
            // Combinar celdas para títulos
            if (!wsInfo['!merges']) wsInfo['!merges'] = [];
            wsInfo['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 1 } });
            wsInfo['!merges'].push({ s: { r: 2, c: 0 }, e: { r: 2, c: 1 } });
            wsInfo['!merges'].push({ s: { r: 5, c: 0 }, e: { r: 5, c: 1 } });
            wsInfo['!merges'].push({ s: { r: 9, c: 0 }, e: { r: 9, c: 1 } });
            
            // Ajustar anchos de columna para la hoja de información
            wsInfo['!cols'] = [
                {wch: 25}, // Primera columna (etiquetas)
                {wch: 50}  // Segunda columna (valores)
            ];
            
            // Añadir hoja de información
            XLSX.utils.book_append_sheet(wb, wsInfo, "Información");

            // --- HOJA PRINCIPAL DE DATOS ---
            // Preparar datos para Excel
            const datos = [];
            
            // Título de la tabla
            datos.push([`ESTADÍSTICAS POR ${vistaActual === 'vistaMunicipios' ? 'MUNICIPIOS' : 'REGIONES'}`]);
            datos.push(['']);
            
            // Obtener encabezados dinámicos según categorías
            let encabezados = [];
            if (vistaActual === 'vistaMunicipios') {
                encabezados = [
                    'Municipio', 
                    'Región', 
                    'Cantidad de Encuestas', 
                    'Total Respuestas', 
                    'Tasa Finalización (%)'
                ];
                
                // Añadir columnas de categorías
                todasCategorias.forEach(cat => {
                    encabezados.push(`Categoría: ${cat.nombre}`);
                });
                
                // Agregar encabezados a datos
                datos.push(encabezados);
                
                // Datos de municipios
                datosTablaMunicipios.forEach(item => {
                    // Calcular tasa de finalización
                    const tasaFinalizacion = item.totalRespuestas > 0 
                        ? ((item.encuestasRespondidas / item.totalRespuestas) * 100).toFixed(1) + '%'
                        : '0.0%';
                    
                    // Iniciar fila con datos básicos
                    const fila = [
                        item.nombre,
                        item.region,
                        item.totalEncuestas || 0,
                        item.totalRespuestas || 0,
                        tasaFinalizacion
                    ];
                    
                    // Añadir datos de categorías
                    todasCategorias.forEach(cat => {
                        const conteo = item.categorias_count && item.categorias_count[cat.id] 
                            ? item.categorias_count[cat.id] 
                            : 0;
                        fila.push(conteo);
                    });
                    
                    // Agregar fila a datos
                    datos.push(fila);
                });
                
                // Añadir fila de totales
                const totalesRow = ['TOTAL', '', 0, 0, ''];
                
                // Calcular totales
                let totalEncuestas = 0;
                let totalRespuestas = 0;
                
                datosTablaMunicipios.forEach(item => {
                    totalEncuestas += (item.totalEncuestas || 0);
                    totalRespuestas += (item.totalRespuestas || 0);
                });
                
                totalesRow[2] = totalEncuestas;
                totalesRow[3] = totalRespuestas;
                
                // Calcular totales de categorías
                todasCategorias.forEach((cat, index) => {
                    let total = 0;
                    datosTablaMunicipios.forEach(item => {
                        if (item.categorias_count && item.categorias_count[cat.id]) {
                            total += item.categorias_count[cat.id];
                        }
                    });
                    totalesRow.push(total);
                });
                
                datos.push(totalesRow);
                
            } else { // vistaRegiones
                encabezados = [
                    'Región', 
                    'Cantidad de Encuestas', 
                    'Total Respuestas', 
                    'Tasa Finalización (%)'
                ];
                
                // Añadir columnas de categorías
                todasCategorias.forEach(cat => {
                    encabezados.push(`Categoría: ${cat.nombre}`);
                });
                
                // Agregar encabezados a datos
                datos.push(encabezados);
                
                // Datos de regiones
                datosTablaRegiones.forEach(item => {
                    // Calcular tasa de finalización
                    const tasaFinalizacion = item.totalRespuestas > 0 
                        ? ((item.encuestasRespondidas / item.totalRespuestas) * 100).toFixed(1) + '%'
                        : '0.0%';
                    
                    // Iniciar fila con datos básicos
                    const fila = [
                        item.nombre,
                        item.totalEncuestas || 0,
                        item.totalRespuestas || 0,
                        tasaFinalizacion
                    ];
                    
                    // Añadir datos de categorías
                    todasCategorias.forEach(cat => {
                        const conteo = item.categorias_count && item.categorias_count[cat.id] 
                            ? item.categorias_count[cat.id] 
                            : 0;
                        fila.push(conteo);
                    });
                    
                    // Agregar fila a datos
                    datos.push(fila);
                });
                
                // Añadir fila de totales
                const totalesRow = ['TOTAL', 0, 0, ''];
                
                // Calcular totales
                let totalEncuestas = 0;
                let totalRespuestas = 0;
                
                datosTablaRegiones.forEach(item => {
                    totalEncuestas += (item.totalEncuestas || 0);
                    totalRespuestas += (item.totalRespuestas || 0);
                });
                
                totalesRow[1] = totalEncuestas;
                totalesRow[2] = totalRespuestas;
                
                // Calcular totales de categorías
                todasCategorias.forEach((cat, index) => {
                    let total = 0;
                    datosTablaRegiones.forEach(item => {
                        if (item.categorias_count && item.categorias_count[cat.id]) {
                            total += item.categorias_count[cat.id];
                        }
                    });
                    totalesRow.push(total);
                });
                
                datos.push(totalesRow);
            }
            
            // Crear hoja principal con los datos de la tabla
            const ws = XLSX.utils.aoa_to_sheet(datos);
            
            // Combinar celdas para el título
            if (!ws['!merges']) ws['!merges'] = [];
            ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: encabezados.length - 1 } });
            
            // Calcular anchos de columna dinámicamente
            const wscols = encabezados.map((header, index) => {
                // Determinar ancho según tipo de columna
                if (header.includes('Categoría:')) {
                    return {wch: 15}; // Categorías
                } else if (index < 2) {
                    return {wch: 25}; // Municipio/Región
                } else {
                    return {wch: 20}; // Otras columnas
                }
            });
            
            ws['!cols'] = wscols;
            
            // Agregar hojas al libro
            const nombreHoja = vistaActual === 'vistaMunicipios' ? "Municipios" : "Regiones";
            XLSX.utils.book_append_sheet(wb, ws, nombreHoja);
            
            // Generar el archivo Excel con nombre descriptivo
            const fecha = new Date().toISOString().split('T')[0];
            const nombreArchivo = `estadisticas_${nombreHoja.toLowerCase()}_${fecha}.xlsx`;
            XLSX.writeFile(wb, nombreArchivo);

        } catch (error) {
            console.error("Error al exportar a Excel:", error);
            alert("Error al exportar a Excel. Verifique la consola para más detalles.");
        }
    }

    function inicializarGraficos() {
        const historialElement = document.getElementById('historialChart');
        const pieElement = document.getElementById('pieChart');
        const barElement = document.getElementById('barChart');

        // Si no hay datos o elementos, no hacer nada
        if (!datosGraficos || (!historialElement && !pieElement && !barElement)) {
            console.warn("No hay datos o elementos DOM para inicializar los gráficos.");
             // Opcionalmente, mostrar mensajes en lugar de los gráficos
            if (historialElement) historialElement.innerHTML = '<p class="text-center text-muted mt-5">No hay datos de historial para mostrar.</p>';
            if (pieElement) pieElement.innerHTML = '<p class="text-center text-muted mt-5">No hay datos de regiones para mostrar.</p>';
            if (barElement) barElement.innerHTML = '<p class="text-center text-muted mt-5">No hay datos de municipios para mostrar.</p>';
            return;
        }

        // Colores consistentes
        const colores = ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#5a5c69', '#858796', '#6f42c1', '#e83e8c', '#fd7e14'];

        const configBase = {
            responsive: true,
            displayModeBar: false // Ocultar barra de herramientas de Plotly
        };

        const layoutBase = {
            plot_bgcolor: 'rgba(0,0,0,0)', // Fondo transparente
            paper_bgcolor: 'rgba(0,0,0,0)', // Fondo transparente
            font: {
                family: 'Nunito, sans-serif', // Usar fuente similar a SB Admin 2
                size: 12,
                color: '#5a5c69' // Color de fuente base
            },
            title: {
                font: {
                    size: 16, // Tamaño título más pequeño
                    color: '#2e384d',
                    weight: 'bold'
                },
                x: 0.05, // Alinear título a la izquierda
                xanchor: 'left'
            },
            margin: { l: 50, r: 30, b: 80, t: 60, pad: 4 }, // Márgenes ajustados
            xaxis: {
                gridcolor: '#e3e6f0', // Color suave para la rejilla
                linecolor: '#d1d3e2', // Color línea del eje
                zerolinecolor: '#d1d3e2'
            },
            yaxis: {
                gridcolor: '#e3e6f0',
                linecolor: '#d1d3e2',
                zerolinecolor: '#d1d3e2'
            },
            hovermode: 'closest', // Mostrar tooltip del punto más cercano
            hoverlabel: { // Estilo general para los tooltips
                bgcolor: "#5a5c69",
                bordercolor: "#5a5c69",
                font: { 
                    size: 13, 
                    color: "white" 
                }
            },
            transition: { // Asegurar transiciones suaves por defecto
                duration: 500,
                easing: 'cubic-in-out'
            }
        };


        // Gráfico de Historial (Barras)
        if (historialElement && datosGraficos.historial && datosGraficos.historial.meses && datosGraficos.historial.meses.length > 0) {
            try {
                const traceHistorial = {
                    x: datosGraficos.historial.meses,
                    y: datosGraficos.historial.conteos,
                    type: 'bar',
                    name: 'Respuestas',
                    marker: {
                        color: colores[0],
                        line: { color: '#224abe', width: 1 }
                    },
                    hoverinfo: 'y+name', // Mostrar valor Y y nombre de la traza en tooltip
                    hoverlabel: { // Estilo específico si es necesario
                         // namelength: -1 // Mostrar nombre completo de traza
                    }
                };
                const layoutHistorial = JSON.parse(JSON.stringify(layoutBase)); // Corregido: Usar JSON.parse/stringify para copia profunda
                layoutHistorial.title.text = 'Respuestas por Mes';
                layoutHistorial.xaxis.title = 'Mes';
                layoutHistorial.xaxis.tickangle = -45; // Ángulo para mejor legibilidad
                layoutHistorial.yaxis.title = 'Nº Respuestas';
                layoutHistorial.margin.b = 100; // Más margen inferior por etiquetas rotadas

                Plotly.newPlot(historialElement, [traceHistorial], layoutHistorial, configBase);
            } catch (error) {
                console.error("Error al inicializar gráfico de historial:", error);
                historialElement.innerHTML = '<p class="text-center text-danger mt-5">Error al cargar gráfico de historial.</p>';
            }
        } else if (historialElement) {
            historialElement.innerHTML = '<p class="text-center text-muted mt-5">No hay datos de historial para mostrar.</p>';
        }

        // Gráfico de Regiones (Pie)
        if (pieElement && datosGraficos.regiones && datosGraficos.regiones.datos && datosGraficos.regiones.datos.length > 0) {
            try {
                const tracePie = {
                    // labels: datosGraficos.regiones.nombres, // Nombres pueden ser largos
                    values: datosGraficos.regiones.datos.map(d => d.value),
                    labels: datosGraficos.regiones.datos.map(d => d.name), // Usar 'name' del objeto
                    type: 'pie',
                    hole: 0.4, // Estilo dona
                    marker: { colors: colores },
                    textinfo: 'percent', // Mostrar solo porcentaje en el gráfico
                    hoverinfo: 'label+percent+value', // Mostrar etiqueta, porcentaje y valor
                    // textposition: 'outside', // Puede solaparse, mejor leyenda
                    automargin: true
                };
                const layoutPie = JSON.parse(JSON.stringify(layoutBase)); // Corregido: Usar JSON.parse/stringify para copia profunda
                layoutPie.title.text = 'Distribución por Región';
                layoutPie.margin = { l: 20, r: 20, b: 20, t: 50, pad: 4 }; // Márgenes ajustados para pie
                layoutPie.showlegend = true;
                layoutPie.legend = {
                    orientation: 'v', // Leyenda vertical
                    // x: 1.05, // Posición leyenda (ajustar si es necesario)
                    // y: 0.5,
                    bgcolor: 'rgba(255,255,255,0.7)', // Fondo semitransparente para leyenda
                    bordercolor: '#e3e6f0',
                    borderwidth: 1
                };

                Plotly.newPlot(pieElement, [tracePie], layoutPie, configBase);
            } catch (error) {
                console.error("Error al inicializar gráfico de distribución por región:", error);
                pieElement.innerHTML = '<p class="text-center text-danger mt-5">Error al cargar gráfico de regiones.</p>';
            }
        } else if (pieElement) {
            pieElement.innerHTML = '<p class="text-center text-muted mt-5">No hay datos de regiones para mostrar.</p>';
        }

        // Gráfico de Municipios (Barras Horizontales)
        if (barElement && datosGraficos.municipios && datosGraficos.municipios.nombres && datosGraficos.municipios.nombres.length > 0) {
            try {
                const traceBar = {
                    x: datosGraficos.municipios.valores,
                    y: datosGraficos.municipios.nombres,
                    type: 'bar',
                    orientation: 'h', // Barras horizontales
                    name: 'Respuestas',
                    marker: {
                        color: colores[1],
                        line: { color: '#159a68', width: 1 }
                    },
                    hoverinfo: 'x+y', // Mostrar valor X (respuestas) y Y (municipio)
                };
                const layoutBar = JSON.parse(JSON.stringify(layoutBase)); // Corregido: Usar JSON.parse/stringify para copia profunda
                layoutBar.title.text = 'Top Municipios'; // Título más corto
                layoutBar.xaxis.title = 'Nº Respuestas';
                layoutBar.yaxis.title = ''; // Sin título en eje Y
                layoutBar.yaxis.automargin = true; // Ajuste automático para etiquetas largas
                layoutBar.margin.l = 150; // Más margen izquierdo para nombres de municipios

                Plotly.newPlot(barElement, [traceBar], layoutBar, configBase);
            } catch (error) {
                console.error("Error al inicializar gráfico de barras de municipios:", error);
                barElement.innerHTML = '<p class="text-center text-danger mt-5">Error al cargar gráfico de municipios.</p>';
            }
        } else if (barElement) {
            barElement.innerHTML = '<p class="text-center text-muted mt-5">No hay datos de municipios para mostrar.</p>';
        }

        // Manejar la responsividad general
        window.addEventListener('resize', function() {
            if (historialElement && historialElement.data) {
                Plotly.Plots.resize(historialElement).catch(e => console.warn("Resize error historial:", e));
            }
            if (pieElement && pieElement.data) {
                Plotly.Plots.resize(pieElement).catch(e => console.warn("Resize error pie:", e));
            }
            if (barElement && barElement.data) {
                Plotly.Plots.resize(barElement).catch(e => console.warn("Resize error bar:", e));
            }
        });
    }

    // Funcionalidad para filtrar encuestas
    function filtrarEncuestas() {
        const estadoSelect = document.getElementById('filtroEstado');
        const visibilidadSelect = document.getElementById('filtroVisibilidad');
        const grupoSelect = document.getElementById('filtroGrupoInteres');
        const busquedaInput = document.getElementById('buscarEncuesta');

        // Verificar que los elementos existan
        if (!estadoSelect || !visibilidadSelect || !grupoSelect || !busquedaInput) {
            console.warn("Elementos de filtro de encuestas no encontrados.");
            return;
        }

        const estado = estadoSelect.value; // ej: 'activas', 'finalizadas', 'proximas', 'todas'
        const visibilidad = visibilidadSelect.value; // ej: 'publicas', 'privadas', 'todas'
        const grupo = grupoSelect.value; // ej: 'todas' o id
        const busqueda = busquedaInput.value.toLowerCase().trim();

        const tarjetas = document.querySelectorAll('.encuesta-card');
        const gridEncuestas = document.getElementById('encuestasGrid');
        const mensajeNoResultados = document.getElementById('mensajeNoResultadosEncuestas'); 

        let hayResultados = false;

        tarjetas.forEach(tarjeta => {
            let mostrar = true;
            const estadoEncuesta = tarjeta.getAttribute('data-estado'); // ej: 'activa', 'finalizada', 'proxima'
            const visibilidadEncuesta = tarjeta.getAttribute('data-visibilidad'); // ej: 'publica', 'privada'
            const grupoEncuesta = tarjeta.getAttribute('data-grupo'); // id o 'todos'
            const titulo = tarjeta.querySelector('.card-title')?.textContent.toLowerCase() || '';
            const descripcion = tarjeta.querySelector('.card-text')?.textContent.toLowerCase() || '';

            // Filtrar por estado
            if (estado !== 'todas') {
                // Mapear valor del select ('activas') al valor del atributo ('activa')
                const estadoEsperado = estado.replace('as', 'a').replace('os', 'o'); // 'activas' -> 'activa', 'finalizadas' -> 'finalizada', etc.
                if (estadoEsperado !== estadoEncuesta) {
                    mostrar = false;
                }
            }

            // Filtrar por visibilidad
            if (mostrar && visibilidad !== 'todas') {
                const visibilidadEsperada = visibilidad.replace('as', 'a'); // 'publicas' -> 'publica', 'privadas' -> 'privada'
                if (visibilidadEsperada !== visibilidadEncuesta) {
                    mostrar = false;
                }
            }

            // Filtrar por grupo de interés
            if (mostrar && grupo !== 'todas' && grupoEncuesta !== grupo) {
                mostrar = false;
            }

            // Filtrar por búsqueda
            if (mostrar && busqueda && !titulo.includes(busqueda) && !descripcion.includes(busqueda)) {
                mostrar = false;
            }

            // Mostrar u ocultar tarjeta
            tarjeta.style.display = mostrar ? '' : 'none'; // Usar '' para volver al display por defecto (block, flex, etc.)
            if (mostrar) {
                hayResultados = true;
            }
        });

        // Mostrar/ocultar mensaje si no hay resultados
        if (mensajeNoResultados) {
            mensajeNoResultados.style.display = hayResultados ? 'none' : 'block';
        } else if (!hayResultados && gridEncuestas && tarjetas.length > 0) { // Solo crear si había tarjetas originalmente
            // Crear el mensaje si no existe y no hay resultados
            const mensaje = document.createElement('div');
            mensaje.id = 'mensajeNoResultadosEncuestas'; // ID actualizado
            mensaje.className = 'col-12 text-center py-5';
            mensaje.innerHTML = `
                <i class="fas fa-search fa-3x text-gray-400 mb-3"></i>
                <p>No se encontraron encuestas con los filtros seleccionados.</p>
            `;
            // Insertar antes del primer elemento o al final si está vacío
            const primerElementoVisible = gridEncuestas.querySelector('.encuesta-card:not([style*="display: none"])');
            if(primerElementoVisible){
                gridEncuestas.insertBefore(mensaje, primerElementoVisible);
            } else {
                    gridEncuestas.appendChild(mensaje);
            }
        }

    }

    // Función para mostrar detalles de formularios por municipio/región
    function mostrarDetalleFormularios(entidadId, entidadNombre, tipo) {
        try {
            // Construir clave correctamente - asegurarse que coincida con el formato usado en el backend
            const clave = `${tipo}_${entidadId}`;
            
            console.log('Mostrando detalle para:', clave, entidadNombre);
            
            // Obtener formularios desde los datos recibidos desde el backend
            let formularios = datosFormulariosDetalle[clave] || [];
            
            // Actualizar título del modal
            document.getElementById('modalTituloDetalle').textContent = 
                `Detalle de Formularios - ${tipo === 'municipio' ? 'Municipio' : 'Región'}`;
            document.getElementById('modalEntidadNombre').textContent = entidadNombre;
            
            // Mostrar/ocultar pestañas según tipo
            const tabMunicipios = document.getElementById('tabMunicipios');
            if (tipo === 'municipio') {
                // Si es municipio, ocultar la pestaña de respuestas por municipio
                tabMunicipios.style.display = 'none';
                // Activar pestaña de formularios
                document.getElementById('tabFormularios').click();
            } else {
                // Si es región, mostrar ambas pestañas
                tabMunicipios.style.display = '';
            }
            
            // === PESTAÑA 1: FORMULARIOS ===
            // Referencia a los elementos
            const tbodyFormularios = document.getElementById('cuerpoTablaFormularios');
            const noDataMessage = document.getElementById('noDataMessage');
            const tablaFormularios = document.getElementById('tablaFormularios');
            
            // Limpiar tabla de formularios
            tbodyFormularios.innerHTML = '';
            
            // Verificar si hay formularios
            if (!formularios || formularios.length === 0) {
                // Mostrar mensaje de no datos y ocultar tabla
                noDataMessage.classList.remove('d-none');
                tablaFormularios.classList.add('d-none');
            } else {
                // Ocultar mensaje y mostrar tabla
                noDataMessage.classList.add('d-none');
                tablaFormularios.classList.remove('d-none');
                
                // Llenar tabla con datos de formularios
                let totalRespuestas = 0;
                
                formularios.forEach(form => {
                    totalRespuestas += (form.total_respuestas || 0);
                    
                    const porcentaje = form.total_respuestas > 0 
                        ? ((form.completadas / form.total_respuestas) * 100).toFixed(1)
                        : "0.0";
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${form.titulo}</td>
                        <td><span class="badge bg-info">${form.categoria}</span></td>
                        <td class="text-center">${form.total_respuestas || 0}</td>
                        <td class="text-center">${form.completadas || 0}</td>
                        <td class="text-center">${porcentaje}%</td>
                    `;
                    tbodyFormularios.appendChild(tr);
                });
                
                // Si hay datos, agregar una fila de resumen al final
                const trResumen = document.createElement('tr');
                trResumen.className = 'table-active fw-bold';
                
                // Calcular tasa global de completitud
                const totalCompletadas = formularios.reduce((sum, form) => sum + (form.completadas || 0), 0);
                const porcentajeGlobal = totalRespuestas > 0 
                    ? ((totalCompletadas / totalRespuestas) * 100).toFixed(1)
                    : "0.0";
                    
                trResumen.innerHTML = `
                    <td colspan="2" class="text-end">TOTAL:</td>
                    <td class="text-center">${totalRespuestas}</td>
                    <td class="text-center">${totalCompletadas}</td>
                    <td class="text-center">${porcentajeGlobal}%</td>
                `;
                tbodyFormularios.appendChild(trResumen);
            }
            
            // === PESTAÑA 2: RESPUESTAS POR MUNICIPIO (solo para regiones) ===
            if (tipo === 'region') {
                // Referencias a elementos
                const tbodyMunicipios = document.getElementById('cuerpoTablaRespuestasMunicipios');
                const noMunicipiosMessage = document.getElementById('noMunicipiosMessage');
                const tablaRespuestasMunicipios = document.getElementById('tablaRespuestasMunicipios');
                
                // Limpiar tabla
                tbodyMunicipios.innerHTML = '';
                
                // Filtrar municipios que pertenecen a esta región
                const municipiosFiltrados = datosTablaMunicipios.filter(mun => mun.region === entidadNombre);
                
                if (municipiosFiltrados.length === 0) {
                    // Mostrar mensaje y ocultar tabla
                    noMunicipiosMessage.classList.remove('d-none');
                    tablaRespuestasMunicipios.classList.add('d-none');
                } else {
                    // Ocultar mensaje y mostrar tabla
                    noMunicipiosMessage.classList.add('d-none');
                    tablaRespuestasMunicipios.classList.remove('d-none');
                    
                    // Ordenar por total de respuestas (descendente)
                    municipiosFiltrados.sort((a, b) => b.totalRespuestas - a.totalRespuestas);
                    
                    // Llenar tabla con datos de municipios
                    let totalRespuestasRegion = 0;
                    let totalCompletadasRegion = 0;
                    
                    municipiosFiltrados.forEach(municipio => {
                        totalRespuestasRegion += (municipio.totalRespuestas || 0);
                        totalCompletadasRegion += (municipio.encuestasRespondidas || 0);
                        
                        const porcentaje = municipio.totalRespuestas > 0 
                            ? ((municipio.encuestasRespondidas / municipio.totalRespuestas) * 100).toFixed(1)
                            : "0.0";
                        
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${municipio.nombre}</td>
                            <td class="text-center">${municipio.totalRespuestas || 0}</td>
                            <td class="text-center">${municipio.encuestasRespondidas || 0}</td>
                            <td class="text-center">${porcentaje}%</td>
                        `;
                        tbodyMunicipios.appendChild(tr);
                    });
                    
                    // Agregar fila de resumen
                    if (municipiosFiltrados.length > 1) {
                        const porcentajeGlobal = totalRespuestasRegion > 0 
                            ? ((totalCompletadasRegion / totalRespuestasRegion) * 100).toFixed(1)
                            : "0.0";
                            
                        const trResumen = document.createElement('tr');
                        trResumen.className = 'table-active fw-bold';
                        trResumen.innerHTML = `
                            <td class="text-end">TOTAL REGIÓN:</td>
                            <td class="text-center">${totalRespuestasRegion}</td>
                            <td class="text-center">${totalCompletadasRegion}</td>
                            <td class="text-center">${porcentajeGlobal}%</td>
                        `;
                        tbodyMunicipios.appendChild(trResumen);
                    }
                }
            }
            
            // Configurar botón de exportación de detalle
            const btnExportar = document.getElementById('exportarDetalleExcel');
            btnExportar.onclick = () => exportarDetalleExcel(entidadNombre, tipo, formularios, 
                tipo === 'region' ? datosTablaMunicipios.filter(mun => mun.region === entidadNombre) : null);
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('detalleFormulariosModal'));
            modal.show();
            
        } catch (error) {
            console.error("Error al mostrar detalle de formularios:", error);
            alert("Ocurrió un error al mostrar el detalle de formularios");
        }
    }
    
    // Función para exportar detalle a Excel
    function exportarDetalleExcel(entidadNombre, tipo, formularios, municipiosFiltrados) {
        try {
            // Crear libro Excel
            const wb = XLSX.utils.book_new();
            
            // Crear datos para hoja de información
            const datosInfo = [];
            // Título
            datosInfo.push([`INFORME DE ESTADÍSTICAS - ${tipo === 'municipio' ? 'MUNICIPIO' : 'REGIÓN'}: ${entidadNombre.toUpperCase()}`]);
            datosInfo.push(['']);
            
            // Información general
            datosInfo.push(['INFORMACIÓN DEL REPORTE']);
            datosInfo.push(['Fecha de generación:', new Date().toLocaleString()]);
            datosInfo.push(['Tipo de entidad:', tipo === 'municipio' ? 'Municipio' : 'Región']);
            datosInfo.push(['Nombre:', entidadNombre]);
            
            // Si hay datos adicionales disponibles, añadirlos
            if (tipo === 'municipio') {
                // Buscar el municipio en los datos
                const datosMunicipio = datosTablaMunicipios.find(m => m.nombre === entidadNombre);
                if (datosMunicipio) {
                    datosInfo.push(['Región:', datosMunicipio.region]);
                    datosInfo.push(['Cantidad de encuestas:', formularios ? formularios.length : 0]);
                    datosInfo.push(['Total respuestas:', datosMunicipio.totalRespuestas || 0]);
                    // Quitar el total de encuestas completadas como solicitó el usuario
                    const porcentaje = datosMunicipio.totalRespuestas > 0 
                        ? ((datosMunicipio.encuestasRespondidas / datosMunicipio.totalRespuestas) * 100).toFixed(1)
                        : "0.0";
                    datosInfo.push(['Tasa de finalización:', `${porcentaje}%`]);
                }
            } else {
                // Buscar la región en los datos
                const datosRegion = datosTablaRegiones.find(r => r.nombre === entidadNombre);
                if (datosRegion) {
                    datosInfo.push(['Cantidad de encuestas:', formularios ? formularios.length : 0]);
                    datosInfo.push(['Total respuestas:', datosRegion.totalRespuestas || 0]);
                    // Quitar el total de encuestas completadas como solicitó el usuario
                    const porcentaje = datosRegion.totalRespuestas > 0 
                        ? ((datosRegion.encuestasRespondidas / datosRegion.totalRespuestas) * 100).toFixed(1)
                        : "0.0";
                    datosInfo.push(['Tasa de finalización:', `${porcentaje}%`]);
                    datosInfo.push(['Número de municipios:', municipiosFiltrados ? municipiosFiltrados.length : 'N/A']);
                }
            }
            
            // Crear hoja de información
            const wsInfo = XLSX.utils.aoa_to_sheet(datosInfo);
            
            // Combinar celdas para título
            if (!wsInfo['!merges']) wsInfo['!merges'] = [];
            wsInfo['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 1 } });
            wsInfo['!merges'].push({ s: { r: 2, c: 0 }, e: { r: 2, c: 1 } });
            
            // Ajustar anchos
            wsInfo['!cols'] = [
                { wch: 25 }, // Primera columna
                { wch: 40 }  // Segunda columna
            ];
            
            // Añadir hoja de información
            XLSX.utils.book_append_sheet(wb, wsInfo, "Información");
            
            // === HOJA DE FORMULARIOS ===
            const datosFormularios = [];
            
            // Título
            datosFormularios.push([`FORMULARIOS - ${tipo === 'municipio' ? 'MUNICIPIO' : 'REGIÓN'}: ${entidadNombre.toUpperCase()}`]);
            datosFormularios.push(['']);
            
            // Encabezados
            datosFormularios.push(['Formulario', 'Categoría', 'Total Respuestas', 'Completadas', 'Porcentaje Completitud']);
            
            // Datos
            if (!formularios || formularios.length === 0) {
                datosFormularios.push([`No hay formularios disponibles para este ${tipo === 'municipio' ? 'municipio' : 'región'}`]);
            } else {
                // Variable para calcular totales
                let totalRespuestas = 0;
                let totalCompletadas = 0;
                
                formularios.forEach(form => {
                    const respuestas = form.total_respuestas || 0;
                    const completadas = form.completadas || 0;
                    
                    totalRespuestas += respuestas;
                    totalCompletadas += completadas;
                    
                    const porcentaje = respuestas > 0 
                        ? ((completadas / respuestas) * 100).toFixed(1)
                        : "0.0";
                    
                    datosFormularios.push([
                        form.titulo,
                        form.categoria,
                        respuestas,
                        completadas,
                        `${porcentaje}%`
                    ]);
                });
                
                // Añadir fila de totales
                const porcentajeTotal = totalRespuestas > 0
                    ? ((totalCompletadas / totalRespuestas) * 100).toFixed(1)
                    : "0.0";
                    
                datosFormularios.push([
                    'TOTAL',
                    '',
                    totalRespuestas,
                    totalCompletadas,
                    `${porcentajeTotal}%`
                ]);
            }
            
            // Crear hoja de formularios
            const wsFormularios = XLSX.utils.aoa_to_sheet(datosFormularios);
            
            // Combinar celdas para título
            if (!wsFormularios['!merges']) wsFormularios['!merges'] = [];
            wsFormularios['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 4 } });
            
            // Ajustar anchos
            wsFormularios['!cols'] = [
                { wch: 50 }, // Formulario
                { wch: 20 }, // Categoría
                { wch: 15 }, // Total Respuestas
                { wch: 15 }, // Completadas
                { wch: 20 }  // Porcentaje
            ];
            
            // Añadir hoja de formularios
            XLSX.utils.book_append_sheet(wb, wsFormularios, "Formularios");
            
            // === HOJA DE MUNICIPIOS (solo para regiones) ===
            if (tipo === 'region' && municipiosFiltrados && municipiosFiltrados.length > 0) {
                const datosMunicipios = [];
                
                // Título
                datosMunicipios.push([`RESPUESTAS POR MUNICIPIO - REGIÓN: ${entidadNombre.toUpperCase()}`]);
                datosMunicipios.push(['']);
                
                // Encabezados
                datosMunicipios.push(['Municipio', 'Cantidad de Encuestas', 'Total Respuestas', 'Porcentaje Completitud']);
                
                // Ordenar por total de respuestas (descendente)
                const municipiosOrdenados = [...municipiosFiltrados].sort((a, b) => b.totalRespuestas - a.totalRespuestas);
                
                // Variables para totales
                let totalEncuestas = 0;
                let totalRespuestasRegion = 0;
                let totalCompletadasRegion = 0;
                
                // Datos
                municipiosOrdenados.forEach(municipio => {
                    // Para cada municipio, contar sus encuestas (podríamos obtenerlo de datosFormulariosDetalle si está disponible)
                    const cantidadEncuestas = 0; // Esto debería venir del backend idealmente
                    const respuestas = municipio.totalRespuestas || 0;
                    const completadas = municipio.encuestasRespondidas || 0;
                    
                    totalEncuestas += cantidadEncuestas;
                    totalRespuestasRegion += respuestas;
                    totalCompletadasRegion += completadas;
                    
                    const porcentaje = respuestas > 0 
                        ? ((completadas / respuestas) * 100).toFixed(1)
                        : "0.0";
                    
                    datosMunicipios.push([
                        municipio.nombre,
                        cantidadEncuestas,
                        respuestas,
                        `${porcentaje}%`
                    ]);
                });
                
                // Añadir fila de totales
                const porcentajeTotal = totalRespuestasRegion > 0
                    ? ((totalCompletadasRegion / totalRespuestasRegion) * 100).toFixed(1)
                    : "0.0";
                    
                datosMunicipios.push([
                    'TOTAL REGIÓN',
                    totalEncuestas,
                    totalRespuestasRegion,
                    `${porcentajeTotal}%`
                ]);
                
                // Crear hoja de municipios
                const wsMunicipios = XLSX.utils.aoa_to_sheet(datosMunicipios);
                
                // Combinar celdas para título
                if (!wsMunicipios['!merges']) wsMunicipios['!merges'] = [];
                wsMunicipios['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 3 } });
                
                // Ajustar anchos
                wsMunicipios['!cols'] = [
                    { wch: 40 }, // Municipio
                    { wch: 20 }, // Cantidad de Encuestas
                    { wch: 15 }, // Total Respuestas
                    { wch: 20 }  // Porcentaje
                ];
                
                // Añadir hoja de municipios
                XLSX.utils.book_append_sheet(wb, wsMunicipios, "Municipios");
            }
            
            // === HOJA DE CATEGORÍAS ===
            // Si la entidad tiene categorías, crear una hoja adicional
            const entidadData = tipo === 'municipio' 
                ? datosTablaMunicipios.find(m => m.nombre === entidadNombre)
                : datosTablaRegiones.find(r => r.nombre === entidadNombre);
                
            if (entidadData && entidadData.categorias_count) {
                const datosCategorias = [];
                
                // Título
                datosCategorias.push([`RESPUESTAS POR CATEGORÍA - ${tipo === 'municipio' ? 'MUNICIPIO' : 'REGIÓN'}: ${entidadNombre.toUpperCase()}`]);
                datosCategorias.push(['']);
                
                // Encabezados
                datosCategorias.push(['Categoría', 'Cantidad de Respuestas', 'Porcentaje del Total']);
                
                // Calcular total de respuestas
                const totalRespuestasCategorias = Object.values(entidadData.categorias_count).reduce((a, b) => a + b, 0);
                
                // Datos de categorías (ordenados por cantidad descendente)
                const categoriasOrdenadas = todasCategorias
                    .filter(cat => entidadData.categorias_count[cat.id] > 0)
                    .sort((a, b) => 
                        (entidadData.categorias_count[b.id] || 0) - (entidadData.categorias_count[a.id] || 0)
                    );
                    
                categoriasOrdenadas.forEach(cat => {
                    const cantidad = entidadData.categorias_count[cat.id] || 0;
                    const porcentaje = totalRespuestasCategorias > 0 
                        ? ((cantidad / totalRespuestasCategorias) * 100).toFixed(1)
                        : "0.0";
                        
                    datosCategorias.push([
                        cat.nombre,
                        cantidad,
                        `${porcentaje}%`
                    ]);
                });
                
                // Si no hay categorías con valores
                if (categoriasOrdenadas.length === 0) {
                    datosCategorias.push(['No hay datos de categorías disponibles', '', '']);
                }
                
                // Crear hoja
                const wsCategorias = XLSX.utils.aoa_to_sheet(datosCategorias);
                
                // Combinar celdas para título
                if (!wsCategorias['!merges']) wsCategorias['!merges'] = [];
                wsCategorias['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 2 } });
                
                // Ajustar anchos
                wsCategorias['!cols'] = [
                    { wch: 40 }, // Categoría
                    { wch: 20 }, // Cantidad
                    { wch: 20 }  // Porcentaje
                ];
                
                // Añadir hoja
                XLSX.utils.book_append_sheet(wb, wsCategorias, "Categorías");
            }
            
            // Generar archivo
            const fecha = new Date().toISOString().split('T')[0];
            const nombreArchivo = `detalle_${tipo}_${entidadNombre.toLowerCase().replace(/\s+/g, '_')}_${fecha}.xlsx`;
            XLSX.writeFile(wb, nombreArchivo);
            
        } catch (error) {
            console.error("Error al exportar detalle a Excel:", error);
            alert("Error al exportar detalle. Verifique la consola para más detalles.");
        }
    }

</script>
{% endblock %}

