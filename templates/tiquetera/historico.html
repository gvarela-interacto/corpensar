{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Mensajes de alerta mejorados -->
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show mt-3 shadow-sm">
      <i class="bi bi-info-circle-fill me-2"></i>{{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endfor %}
{% endif %}

<div class="container py-4">
  <!-- Título principal con estilo mejorado -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="display-5 fw-bold text-dark"><i class="bi bi-clock-history me-2"></i>Histórico de Solicitudes</h1>
    <div>
      <button id="exportBtn" class="btn btn-dark">
        <i class="bi bi-download me-1"></i>Exportar a CSV
      </button>
    </div>
  </div>

  <!-- Tabla de solicitudes -->
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle" id="solicitudesTable">
          <thead class="table-light">
            <tr>
              <th><i class="bi bi-person me-1"></i>Solicitante</th>
              <th><i class="bi bi-ticket-perforated me-1"></i>Tiquete</th>
              <th><i class="bi bi-building me-1"></i>Área</th>
              <th><i class="bi bi-calendar-event me-1"></i>Fecha Creación</th>
              <th><i class="bi bi-calendar-check me-1"></i>Fecha Redención</th>
              
              <th><i class="bi bi-clipboard-check me-1"></i>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for solicitud in solicitudes %}
            <tr class="{% if solicitud.estado == 'utilizado' %}border-dark border-start{% elif solicitud.estado == 'inhabilitado' %}border-danger border-start{% endif %}">
              <td>{{ solicitud.usuario.get_full_name }}</td>
              <td>{{ solicitud.tiquete.nombre }}</td>
              <td>{{ solicitud.usuario.secretaria|default:"-" }}</td>
              <td>{{ solicitud.fecha_creacion|date:"d/m/Y H:i" }}</td>
              <td>{{ solicitud.fecha_redencion|date:"d/m/Y"|default:"-" }}</td>
              <td>
                <span class="badge bg-{% if solicitud.estado == 'utilizado' %}dark{% else %}danger{% endif %}">
                  {{ solicitud.get_estado_display }}
                </span>
              </td>
              <td>
                <button class="btn btn-sm btn-outline-dark" data-bs-toggle="modal" data-bs-target="#detalleModal{{ solicitud.id }}">
                  <i class="bi bi-eye me-1"></i>Detalle
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      <!-- Paginación -->
      {% if solicitudes.has_other_pages %}
      <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
          {% if solicitudes.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ solicitudes.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
              </a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link" aria-hidden="true">&laquo;</span>
            </li>
          {% endif %}
          
          {% for i in solicitudes.paginator.page_range %}
            {% if solicitudes.number == i %}
              <li class="page-item active"><span class="page-link">{{ i }}</span></li>
            {% else %}
              <li class="page-item">
                <a class="page-link" href="?page={{ i }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ i }}</a>
              </li>
            {% endif %}
          {% endfor %}
          
          {% if solicitudes.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ solicitudes.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
              </a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link" aria-hidden="true">&raquo;</span>
            </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modales de detalle -->
{% for solicitud in solicitudes %}
<div class="modal fade" id="detalleModal{{ solicitud.id }}" tabindex="-1" aria-labelledby="detalleModalLabel{{ solicitud.id }}" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detalleModalLabel{{ solicitud.id }}">
          <i class="bi bi-ticket-perforated me-2"></i>Detalle de Solicitud #{{ solicitud.id }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <h6 class="fw-bold"><i class="bi bi-person-badge me-2"></i>Información del Solicitante</h6>
              <div class="ps-3">
                <p class="mb-1"><strong>Nombre:</strong> {{ solicitud.usuario.get_full_name }}</p>
                <p class="mb-1"><strong>Área:</strong> {{ solicitud.usuario.secretaria|default:"No especificado" }}</p>
              </div>
            </div>
            
            <div class="mb-3">
              <h6 class="fw-bold"><i class="bi bi-ticket-perforated me-2"></i>Información del Tiquete</h6>
              <div class="ps-3">
                <p class="mb-1"><strong>Nombre:</strong> {{ solicitud.tiquete.nombre }}</p>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="mb-3">
              <h6 class="fw-bold"><i class="bi bi-calendar-event me-2"></i>Fechas</h6>
              <div class="ps-3">
                <p class="mb-1"><strong>Solicitud:</strong> {{ solicitud.fecha_creacion|date:"d/m/Y H:i" }}</p>
                <p class="mb-1"><strong>Redención:</strong> {{ solicitud.fecha_redencion|date:"d/m/Y"|default:"No especificada" }}</p>
                
              </div>
            </div>
            
            <div class="mb-3">
              <h6 class="fw-bold"><i class="bi bi-clipboard-check me-2"></i>Estados de Aprobación</h6>
              <div class="ps-3">
                <p class="mb-1">
                  <strong>Secretaría:</strong> 
                  <span class="badge bg-{% if solicitud.aprobacion_secretario == 'si' %}dark{% elif solicitud.aprobacion_secretario == 'no' %}danger{% else %}warning{% endif %}">
                    {{ solicitud.get_aprobacion_secretario_display }}
                  </span>
                </p>
                <p class="mb-1">
                  <strong>Servicios:</strong> 
                  <span class="badge bg-{% if solicitud.aprobacion_servicios == 'si' %}dark{% elif solicitud.aprobacion_servicios == 'no' %}danger{% else %}warning{% endif %}">
                    {{ solicitud.get_aprobacion_servicios_display }}
                  </span>
                </p>
                <p class="mb-1">
                  <strong>Estado final:</strong> 
                  <span class="badge bg-{% if solicitud.estado == 'utilizado' %}dark{% else %}danger{% endif %}">
                    {{ solicitud.get_estado_display }}
                  </span>
                </p>
              </div>
            </div>
          </div>
        </div>
        
        {% if solicitud.observaciones %}
        <div class="mb-3">
          <h6 class="fw-bold"><i class="bi bi-chat-left-text me-2"></i>Observaciones</h6>
          <div class="ps-3">
            <p>{{ solicitud.observaciones }}</p>
          </div>
        </div>
        {% endif %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
{% endfor %}

<!-- Formulario oculto para exportación -->
<form id="exportForm" method="post" action="{% url 'exportar_solicitudes_csv' %}" style="display: none;">
  {% csrf_token %}
  <input type="hidden" name="estado" value="{{ request.GET.estado }}">
  <input type="hidden" name="fecha_inicio" value="{{ request.GET.fecha_inicio }}">
  <input type="hidden" name="fecha_fin" value="{{ request.GET.fecha_fin }}">
</form>

<script>
  // Script para manejar la exportación a CSV
  document.getElementById('exportBtn').addEventListener('click', function() {
    document.getElementById('exportForm').submit();
  });
</script>

<style>
  /* Estilos para mejorar la apariencia */
  .table-hover tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.03);
  }
  
  .border-start {
    border-left: 4px solid !important;
  }
  
  .border-dark {
    border-color: var(--bs-dark) !important;
  }
  
  .border-danger {
    border-color: var(--bs-danger) !important;
  }
  
  .badge {
    font-weight: 500;
  }
  
  .card {
    border-radius: 0.5rem;
  }
  
  .modal-header {
    border-bottom: 1px solid rgba(0,0,0,0.1);
  }
  
  .modal-footer {
    border-top: 1px solid rgba(0,0,0,0.1);
  }
</style>
{% endblock %}