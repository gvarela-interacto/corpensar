{% extends 'base.html' %}
{% load humanize %}
{% load static %}
{% load tz %} {# Necesario para timesince y timeuntil #}

{% block content %}

<style>
  /* Estilos para las alertas clickeables */
  .alert-clickable {
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 0; /* Elimina el margen inferior para que quede pegado al contenedor */
    position: relative;
    overflow: hidden;
  }

  .alert-clickable:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
  }

  .alert-clickable:active {
    transform: translateY(1px);
  }

  /* Efecto "pulsado" al hacer clic */
  .alert-clickable.active {
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  /* Contenedor de la lista de tiquetera */
  .product-list-container {
    margin-top: -5px; /* Solapa ligeramente con la alerta */
    padding: 15px;
    border-radius: 0 0 5px 5px;
    background-color: #f8f9fa;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-top: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    animation: fadeIn 0.3s ease-out;
    max-height: 300px; /* Limitar altura */
    overflow-y: auto; /* Scroll si es necesario */
  }

  /* Estilos para la lista de tiquetera */
  .product-list-container .list-group {
    margin-bottom: 0;
  }

  .product-list-container .list-group-item {
    border-left: none;
    border-right: none;
    padding: 8px 15px;
    font-size: 0.9rem;
  }

  .product-list-container .list-group-item:first-child {
    border-top: none;
  }

  /* Animación de carga */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Estilo para el mensaje de carga */
  .text-center {
    text-align: center;
    padding: 10px;
    color: #6c757d;
  }

  /* Nuevos estilos para las tarjetas de KPI principales */
  .kpi-card {
    border-radius: 10px;
    transition: transform 0.2s;
  }
  .kpi-card:hover {
    transform: translateY(-5px);
  }
  .chart-container {
    position: relative;
    height: 250px; /* Reducir altura un poco */
    margin-bottom: 0.5rem; /* Reducir margen */
  }

  /* Estilos para el grid personalizable */
  .bento-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    grid-auto-rows: minmax(100px, auto); /* Altura mínima */
    grid-gap: 15px;
    margin-bottom: 20px;
  }

  .grid-item {
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08); /* Sombra más sutil */
    transition: all 0.3s ease;
    overflow: hidden; /* Asegurar que el contenido no se salga */
    display: flex; /* Usar flex para que el card ocupe todo */
    flex-direction: column;
  }

  .grid-item.dragging {
    opacity: 0.8;
    transform: scale(1.02);
    z-index: 10;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }

  .grid-item .card {
    height: 100%; /* Card ocupa todo el grid-item */
    border: none;
    border-radius: 10px;
    overflow: hidden;
    display: flex;
    flex-direction: column; /* Asegurar estructura vertical */
  }

  .grid-item .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.6rem 1rem; /* Ajustar padding */
    background-color: #f8f9fa; /* Fondo ligero */
    border-bottom: 1px solid #dee2e6;
  }

   .grid-item .card-header h6 { /* Usar h6 para títulos */
       margin-bottom: 0;
       font-size: 0.9rem;
   }

   .grid-item .card-body {
       flex-grow: 1; /* Permitir que el body crezca */
       padding: 0.8rem 1rem; /* Ajustar padding */
       overflow-y: auto; /* Scroll si el contenido es largo */
   }

   /* Quitar padding si la tabla es el único contenido */
   .grid-item .card-body.p-0 {
        padding: 0;
   }
   .grid-item .card-body.p-0 .table-responsive {
       height: 100%; /* Hacer que la tabla ocupe espacio */
   }
    .grid-item .card-body.p-0 .table {
       margin-bottom: 0;
   }


  .grid-item .handle {
    display: flex;
    align-items: center;
    cursor: move;
  }

  .grid-item .handle .mdi-drag {
    margin-right: 0.5rem;
    color: #888;
    font-size: 1.1rem; /* Icono más pequeño */
  }

  .grid-item .handle:hover .mdi-drag {
    color: #333;
  }

  /* Botones de cambio de tamaño */
  .resize-item {
    padding: 0.15rem 0.4rem;
    font-size: 0.7rem; /* Más pequeños */
    line-height: 1.2;
  }

  .resize-item.active {
    background-color: #6c757d;
    color: white;
    border-color: #6c757d;
  }

  /* Transición suave para cambios de tamaño */
  .grid-item {
    transition: grid-column 0.3s ease, grid-row 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
  }

  /* Tamaños predefinidos */
  .grid-item.col-span-4 { grid-column: span 4; }
  .grid-item.col-span-6 { grid-column: span 6; }
  .grid-item.col-span-12 { grid-column: span 12; }

  /* Ajustar altura basada en contenido (ejemplo) */
   .grid-item[data-id="mapaColombiaInteractivo"] {
      grid-row: span 3; /* Ejemplo: Hacer que el mapa ocupe más altura */
   }
   /* Puedes añadir más reglas para otros items si es necesario */


  /* Botón guardar distribución */
  #saveLayout {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    transition: all 0.2s ease;
  }

  #saveLayout:hover {
    background-color: #e9ecef;
    transform: translateY(-2px);
  }

  #saveLayout:active {
    transform: translateY(0);
  }

  /* Responsive */
  @media (max-width: 992px) { /* Cambiado a 992px para ajustar antes */
    .bento-grid {
      grid-template-columns: repeat(6, 1fr);
    }
    .grid-item.col-span-4 {
        grid-column: span 3; /* 2 por fila */
    }
    .grid-item.col-span-6 {
      grid-column: span 6; /* Ancho completo */
    }
     .grid-item.col-span-12 {
      grid-column: span 6; /* Ancho completo */
    }
    .grid-item[data-id="mapaColombiaInteractivo"] {
      grid-row: span 2; /* Reducir altura en pantallas medianas */
   }
  }

  @media (max-width: 768px) {
     .bento-grid {
      grid-template-columns: repeat(1, 1fr); /* Una columna */
    }
     .grid-item.col-span-4,
     .grid-item.col-span-6,
     .grid-item.col-span-12 {
         grid-column: span 1; /* Todos ocupan una columna */
     }
     .grid-item[data-id="mapaColombiaInteractivo"] {
       grid-row: span 2; /* Mantener altura reducida */
    }
     .chart-container {
         height: 280px; /* Altura fija para gráficos en móvil */
     }
     .kpi-card .display-4 {
         font-size: 2rem; /* Reducir tamaño KPIs */
     }
  }

  /* Estilos del Mapa y Popup (sin cambios mayores) */
  #mapaColombia {
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }
  .custom-div-icon { transition: transform 0.2s ease; }
  .custom-div-icon:hover { transform: scale(1.2); z-index: 1000; }
  .popup-content { min-width: 250px; padding: 10px; }
  .popup-content h6 { color: #2c3e50; font-size: 1.1rem; margin-bottom: 10px; border-bottom: 1px solid #e9ecef; padding-bottom: 5px; }
  .popup-content p { margin: 5px 0; color: #495057; font-size: 0.95rem; display: flex; justify-content: space-between; }
  .popup-content hr { margin: 8px 0; border-color: #f8f9fa; }
  .leaflet-popup-content-wrapper { border-radius: 8px; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15); }
  .leaflet-popup-tip { box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1); }
  .btn-group .btn { padding: 6px 12px; font-weight: 500; transition: all 0.2s ease; font-size: 0.85rem;}
  .btn-group .btn:hover { transform: translateY(-1px); }
  .btn-group .btn.active { box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1); }

  /* Panel de información del municipio */
  #infoMunicipio {
    background: white;
    border-radius: 8px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
    margin-top: 15px; /* Reducir margen */
  }
  #infoMunicipio h5 { color: #2c3e50; border-bottom: 1px solid #e9ecef; padding-bottom: 8px; margin-bottom: 10px; font-size: 1.1rem;}
  #infoMunicipio .row p { margin: 5px 0; color: #495057; font-size: 0.9rem; }
  #infoMunicipio .row p strong { color: #2c3e50; margin-right: 5px; display: block; font-size: 0.75rem; text-transform: uppercase; }
  #infoMunicipio .row p span { font-size: 1.1rem; font-weight: 600; }

  /* Ajustes para KPIs de PQRSFD */
   .kpi-card-small {
    border-radius: 8px;
    transition: transform 0.2s;
    border-top: 4px solid #6c757d; /* Color gris por defecto */
    border: 1px solid #eee;
  }
  .kpi-card-small:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  }
  .kpi-card-small .card-body {
    padding: 0.8rem 1rem;
  }
  .kpi-card-small .display-5 {
    font-size: 1.8rem;
    font-weight: 600;
  }
  .kpi-card-small .card-title-small {
    font-size: 0.8rem; /* Más pequeño */
    font-weight: 500;
    color: #6c757d;
    margin-bottom: 0.3rem;
    text-transform: uppercase;
  }

  /* Estilos para nuevas tarjetas de actividad reciente */
  .activity-card {
      border-left: 4px solid #17a2b8; /* Color info */
      border: 1px solid #eee;
      border-radius: 8px;
  }
  .activity-card .card-body {
      padding: 1rem;
  }
  .activity-card h6 {
      font-size: 0.9rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 0.25rem;
  }
   .activity-card p {
      font-size: 1.4rem; /* Ajustar tamaño */
      font-weight: 700;
      margin-bottom: 0.1rem;
   }
   .activity-card p .text-muted { /* Estilo para texto dentro de <p> */
       font-size: 0.9rem; /* Más pequeño */
       font-weight: 400;
   }
   .activity-card .small-text {
       font-size: 0.8rem;
       color: #6c757d;
   }
   /* Mejoras tabla */
   .table-sm th, .table-sm td {
        padding: 0.4rem 0.6rem; /* Reducir padding */
        font-size: 0.85rem;
        vertical-align: middle;
   }


</style>

<div class="container-fluid py-4">
  <!-- KPIs Principales (Actualizados) -->
  <div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card kpi-card h-100 border-0 shadow-sm">
        <div class="position-absolute w-100" style="height: 6px; background-color: #0d6efd; top: 0; left: 0"></div>
        <div class="card-body">
          <h5 class="card-title text-muted">Total Encuestas</h5>
          <h2 class="display-4">{{ total_encuestas|intcomma }}</h2>
          <p class="text-success mb-0 small">
            <i class="mdi mdi-check-circle-outline"></i>
            {{ conteo_publicas_privadas.publicas|intcomma }} públicas / {{ conteo_publicas_privadas.privadas|intcomma }} privadas
          </p>
          <p class="text-info mb-0 small">
            <i class="mdi mdi-calendar-plus"></i>
             {{ encuestas_creadas_30d|intcomma }} creadas últ. 30 días
          </p>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card kpi-card h-100 border-0 shadow-sm">
        <div class="position-absolute w-100" style="height: 6px; background-color: #1cc88a; top: 0; left: 0"></div>
        <div class="card-body">
          <h5 class="card-title text-muted">Respuestas Recibidas</h5>
          <h2 class="display-4">{{ total_respuestas|intcomma }}</h2>
           <p class="text-muted mb-0 small">
            <i class="mdi mdi-poll"></i>
            Promedio: {{ avg_respuestas|floatformat:1 }} por encuesta
          </p>
          <p class="text-primary mb-0 small">
             <i class="mdi mdi-bullseye-arrow"></i>
             {{ total_encuesta_respondidas_activas|intcomma }} en enc. públicas activas
          </p>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card kpi-card h-100 border-0 shadow-sm">
        <div class="position-absolute w-100" style="height: 6px; background-color: #ffc107; top: 0; left: 0"></div>
        <div class="card-body">
          <h5 class="card-title text-muted">Tasa de Finalización</h5>
          <h2 class="display-4">{{ tasa_finalizacion|floatformat:1 }}%</h2>
          <p class="text-warning mb-0 small">
            <i class="mdi mdi-flag-checkered"></i>
            Promedio histórico general
          </p>
           <p class="text-muted mb-0 small">
             ({{ total_encuesta_respondidas|intcomma }} encuestas con ≥ 1 resp.)
          </p>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card kpi-card h-100 border-0 shadow-sm">
        <div class="position-absolute w-100" style="height: 6px; background-color: #dc3545; top: 0; left: 0"></div>
        <div class="card-body">
          <h5 class="card-title text-muted">Activas Sin Respuestas</h5>
          <h2 class="display-4">{{ encuestas_sin_respuestas|intcomma }}</h2>
          <p class="text-danger mb-0 small">
            <i class="mdi mdi-alert-circle-outline"></i>
            Necesitan atención / promoción
          </p>
           <p class="text-info mb-0 small">
            <i class="mdi mdi-timer-sand"></i>
            {{ encuestas_activas|intcomma }} encuestas activas en total
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Fila de Alertas y Actividad Reciente -->
    <div class="row mb-4">
        <!-- Alerta Encuestas Próximas a Finalizar -->
        <div class="col-md-4 mb-3">
            <div class="alert alert-warning alert-clickable shadow-sm" data-target="lista-proximo-fin">
                <i class="mdi mdi-clock-alert-outline me-2"></i>
                <strong>{{ encuestas_proximo_fin.count|intcomma }}</strong> encuestas por finalizar (próx. 3 días)
            </div>
            <div id="lista-proximo-fin" class="product-list-container" style="display: none;">
                {% if encuestas_proximo_fin %}
                <ul class="list-group list-group-flush">
                    {% for encuesta in encuestas_proximo_fin %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span class="text-truncate" title="{{ encuesta.titulo }}">{{ encuesta.titulo|truncatechars:40 }}</span>
                        <span class="badge bg-warning rounded-pill">{{ encuesta.fecha_fin|date:"d M" }}</span>
                    </li>
                    {% endfor %}
                </ul>
                 {% else %}
                 <p class="text-muted text-center p-3 small">No hay encuestas próximas a finalizar.</p>
                {% endif %}
            </div>
        </div>

        <!-- Actividad Reciente Encuestas -->
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm activity-card h-100" style="border-left-color: #0d6efd;">
                <div class="card-body">
                    <h6><i class="mdi mdi-calendar-plus me-1"></i>Encuestas Creadas</h6>
                    <p style="color: #0d6efd;">{{ encuestas_creadas_7d|intcomma }} <span class="text-muted">/ últ. 7 días</span></p>
                    <p class="mb-0 small-text">{{ encuestas_creadas_30d|intcomma }} / últ. 30 días</p>
                </div>
            </div>
        </div>

        <!-- Actividad Reciente PQRSFD -->
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm activity-card h-100" style="border-left-color: #6f42c1;">
                 <div class="card-body">
                    <h6><i class="mdi mdi-email-plus-outline me-1"></i>PQRSFD Recientes</h6>
                    <p style="color: #6f42c1;">{{ pqrsfd_creados_7d|intcomma }} <span class="text-muted">Creados / últ. 7 días</span></p>
                    <p class="mb-0" style="color: #1cc88a;">{{ pqrsfd_resueltos_cerrados_7d|intcomma }} <span class="text-muted">Resueltos / últ. 7 días</span></p>
                </div>
            </div>
        </div>
    </div>


  <!-- Grid Personalizable de Gráficos -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm mb-3">
        <div class="card-header d-flex justify-content-between align-items-center bg-light border-bottom">
          <h5 class="mb-0 text-primary"><i class="mdi mdi-view-dashboard-variant me-2"></i>Panel Personalizable</h5>
          <button id="saveLayout" class="btn btn-sm btn-outline-secondary">
            <i class="mdi mdi-content-save"></i> Guardar Distribución
          </button>
        </div>
        <div class="card-body p-3">
          <div class="bento-grid" id="sortableGrid">

            <!-- Gráfico de Tipos de Preguntas -->
            <div class="grid-item col-span-4" data-id="tipoPreguntasChart">
              <div class="card h-100">
                <div class="card-header">
                  <h6 class="mb-0 fw-bold">Tipos de Preguntas</h6>
                   <div class="handle">
                    <i class="mdi mdi-drag"></i>
                    <div class="btn-group btn-group-sm ms-2" role="group">
                      <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="4">M</button>
                      <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="6">L</button>
                      <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="12">XL</button>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="tipoPreguntasChart"></canvas>
                  </div>
                   {% if not tipos_preguntas %}
                    <div class="text-center text-muted py-3 small"><p>No hay datos de tipos de pregunta</p></div>
                    {% endif %}
                </div>
              </div>
            </div>

            <!-- Gráfico de Distribución por Categoría -->
            <div class="grid-item col-span-4" data-id="distribucionCategoriaChart">
              <div class="card h-100">
                <div class="card-header">
                  <h6 class="mb-0 fw-bold">Encuestas por Categoría</h6>
                   <div class="handle">
                    <i class="mdi mdi-drag"></i>
                     <div class="btn-group btn-group-sm ms-2" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="4">M</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="6">L</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="12">XL</button>
                     </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="distribucionCategoriaChart"></canvas>
                  </div>
                  {% if not distribucion_categoria %}
                  <div class="text-center text-muted py-3 small"><p>No hay datos de categorías</p></div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Gráfico de Distribución por Subcategoría -->
            <div class="grid-item col-span-4" data-id="distribucionSubcategoriaChart"> {# NUEVO #}
              <div class="card h-100">
                <div class="card-header">
                  <h6 class="mb-0 fw-bold">Encuestas por Subcategoría</h6>
                   <div class="handle">
                    <i class="mdi mdi-drag"></i>
                     <div class="btn-group btn-group-sm ms-2" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="4">M</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="6">L</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="12">XL</button>
                     </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="distribucionSubcategoriaChart"></canvas> {# NUEVO CANVAS ID #}
                  </div>
                   {% if not distribucion_subcategoria %}
                    <div class="text-center text-muted py-3 small"><p>No hay datos de subcategorías</p></div>
                    {% endif %}
                </div>
              </div>
            </div>

            <!-- Gráfico de Distribución por Tema -->
            <div class="grid-item col-span-4" data-id="distribucionTemaChart"> {# NUEVO #}
              <div class="card h-100">
                <div class="card-header">
                  <h6 class="mb-0 fw-bold">Encuestas por Tema</h6>
                  <div class="handle">
                    <i class="mdi mdi-drag"></i>
                    <div class="btn-group btn-group-sm ms-2" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="4">M</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="6">L</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="12">XL</button>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="distribucionTemaChart"></canvas> {# NUEVO CANVAS ID #}
                  </div>
                   {% if not distribucion_tema %}
                    <div class="text-center text-muted py-3 small"><p>No hay datos de temas</p></div>
                   {% endif %}
                </div>
              </div>
            </div>

            <!-- Gráfico de Distribución por Región -->
            <div class="grid-item col-span-4" data-id="distribucionRegionChart">
              <div class="card h-100">
                <div class="card-header">
                  <h6 class="mb-0 fw-bold">Encuestas por Región</h6>
                  <div class="handle">
                    <i class="mdi mdi-drag"></i>
                    <div class="btn-group btn-group-sm ms-2" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="4">M</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="6">L</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="12">XL</button>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="distribucionRegionChart"></canvas>
                  </div>
                   {% if not distribucion_region %}
                    <div class="text-center text-muted py-3 small"><p>No hay datos de regiones</p></div>
                   {% endif %}
                </div>
              </div>
            </div>

             <!-- Gráfico de Distribución Tipos PQRSFD -->
            <div class="grid-item col-span-4" data-id="distribucionTipoPqrsfdChart"> {# NUEVO #}
              <div class="card h-100">
                <div class="card-header">
                  <h6 class="mb-0 fw-bold">PQRSFD por Tipo</h6>
                  <div class="handle">
                    <i class="mdi mdi-drag"></i>
                    <div class="btn-group btn-group-sm ms-2" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="4">M</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="6">L</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="12">XL</button>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="distribucionTipoPqrsfdChart"></canvas> {# NUEVO CANVAS ID #}
                  </div>
                   {% if not distribucion_tipo_pqrsfd %}
                    <div class="text-center text-muted py-3 small"><p>No hay datos de tipos de PQRSFD</p></div>
                   {% endif %}
                </div>
              </div>
            </div>


            <!-- Top Municipios -->
            <div class="grid-item col-span-6" data-id="topMunicipios">
              <div class="card h-100">
                <div class="card-header">
                  <h6 class="mb-0 fw-bold">Top 5 Municipios (Más Respuestas)</h6>
                  <div class="handle">
                    <i class="mdi mdi-drag"></i>
                    <div class="btn-group btn-group-sm ms-2" role="group">
                      <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="4">M</button>
                      <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="6">L</button>
                      <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="12">XL</button>
                    </div>
                  </div>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                      <thead>
                        <tr>
                          <th>Municipio</th>
                          <th class="text-end">Total Respuestas</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for municipio in top_municipios %}
                        <tr>
                          <td>
                            {{ municipio.municipio__nombre|default:"Sin municipio" }}
                          </td>
                          <td class="text-end">{{ municipio.total|intcomma }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                          <td colspan="2" class="text-center py-3 text-muted small">
                            No hay datos disponibles
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

             <!-- Últimas Respuestas -->
            <div class="grid-item col-span-6" data-id="ultimasRespuestas">
              <div class="card h-100">
                <div class="card-header">
                  <h6 class="mb-0 fw-bold">Últimas 10 Respuestas Recibidas</h6>
                   <div class="handle">
                    <i class="mdi mdi-drag"></i>
                     <div class="btn-group btn-group-sm ms-2" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="4">M</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="6">L</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="12">XL</button>
                    </div>
                  </div>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-hover mb-0 table-sm">
                      <thead>
                        <tr>
                          <th>Encuesta</th>
                          <th>Usuario</th>
                          <th>Fecha</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for respuesta in ultimas_respuestas %}
                        <tr>
                          <td>
                            <a href="{% url 'resultados_encuesta' respuesta.encuesta.pk %}" class="text-dark" title="{{ respuesta.encuesta.titulo }}">
                              {{ respuesta.encuesta.titulo|truncatechars:30 }}
                            </a>
                          </td>
                          <td>
                            {% if respuesta.usuario %}
                            {{ respuesta.usuario.username|truncatechars:15 }}
                            {% else %}
                            <span class="text-muted fst-italic small">Anónimo</span>
                            {% endif %}
                          </td>
                          <td>
                            <span title="{{ respuesta.fecha_respuesta|date:'d M Y H:i:s' }}">
                                {% timezone None %} {# Para que timesince funcione bien #}
                                {{ respuesta.fecha_respuesta|timesince }} atrás
                                {% endtimezone %}
                            </span>
                          </td>
                        </tr>
                        {% empty %}
                        <tr>
                          <td colspan="3" class="text-center py-3 text-muted small">
                            No hay respuestas recientes
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- Encuestas públicas activas ahora -->
            <div class="grid-item col-span-6" data-id="encuestasActivasNow">
               <div class="card h-100">
                <div class="card-header">
                   <h6 class="mb-0 fw-bold">Encuestas Públicas Activas</h6>
                    <div class="handle">
                    <i class="mdi mdi-drag"></i>
                    <div class="btn-group btn-group-sm ms-2" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="4">M</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="6">L</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="12">XL</button>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                    {% if encuestas_publicas_activas %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>Encuesta</th>
                        <th>Región</th>
                        <th>Fecha Inicio</th>
                        <th>Fecha Fin</th>
                            </tr>
                            </thead>
                            <tbody>
                      {% for encuesta in encuestas_publicas_activas %}
                      <tr>
                        <td>{{ encuesta.titulo|truncatechars:30 }}</td>
                        <td>{{ encuesta.region.nombre }}</td>
                        <td>{{ encuesta.fecha_inicio|date:"d M Y" }}</td>
                        <td>{{ encuesta.fecha_fin|date:"d M Y" }}</td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                  <p class="text-center text-muted p-4 small">No hay encuestas públicas activas.</p>
                    {% endif %}
                </div>
              </div>
            </div>

             <!-- Mapa de Colombia Interactivo -->
            <div class="grid-item col-span-12" data-id="mapaColombiaInteractivo">
              <div class="card h-100">
                <div class="card-header">
                  <h6 class="mb-0 fw-bold">Mapa Interactivo - Estadísticas por Municipio</h6>
                  <div class="handle">
                    <i class="mdi mdi-drag"></i>
                     <div class="btn-group btn-group-sm ms-2" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="4">M</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="6">L</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm resize-item" data-size="12">XL</button>
                    </div>
                     <div class="btn-group btn-group-sm ms-3" role="group">
                        <button type="button" class="btn btn-outline-success active" id="btnMostrarOleoductos">
                            <i class="mdi mdi-pipe me-1"></i>Oleoductos
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="btnMostrarMunicipios">
                            <i class="mdi mdi-map-marker-radius me-1"></i>Municipios
                        </button>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div id="loadingMap" class="text-center" style="display: none;">
                     <div class="spinner-border text-primary spinner-border-sm" role="status"><span class="visually-hidden">Cargando...</span></div>
                     <div class="mt-2 small text-muted"><span id="loadingProgress">0%</span> Cargando datos...</div>
                   </div>
                  <div id="mapaColombia" style="height: 450px; width: 100%; border-radius: 6px;"></div>
                  <div id="infoMunicipio" class="mt-3 p-3 border rounded bg-light" style="display: none">
                    <h5 id="nombreMunicipio" class="mb-2"></h5>
                    <div class="row">
                      <div class="col-md-4 col-6 mb-2"> {# Ajustado para móvil #}
                        <p class="mb-1"><strong class="d-block text-muted small">Total Encuestas:</strong> <span id="totalEncuestasMunicipio" class="fs-5 fw-bold">0</span></p>
                      </div>
                      <div class="col-md-4 col-6 mb-2">
                        <p class="mb-1"><strong class="d-block text-muted small">Total Respuestas:</strong> <span id="totalRespuestasMunicipio" class="fs-5 fw-bold">0</span></p>
                      </div>
                      <div class="col-md-4 col-12 mb-2"> {# Ocupa todo el ancho en móvil #}
                        <p class="mb-1"><strong class="d-block text-muted small">Tasa Finalización:</strong> <span id="tasaFinalizacionMunicipio" class="fs-5 fw-bold">0%</span></p>
                      </div>
                    </div>
                    <div class="row mt-2">
                      <div class="col-md-6 mb-2 mb-md-0" id="graficoEncuestasRespondidas">
                        <div class="chart-container" style="height: 120px;"> {# Muy pequeño #}
                          <canvas id="graficoEncuestasRespondidasCanvas"></canvas> {# Añadir ID #}
                        </div>
                      </div>
                      <div class="col-md-6" id="graficoEncuestasAsignadas">
                        <div class="chart-container" style="height: 120px;"> {# Muy pequeño #}
                          <canvas id="graficoEncuestasAsignadasCanvas"></canvas> {# Añadir ID #}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>


          </div> {# Fin bento-grid #}
        </div>
      </div>
    </div>
  </div>

  <!-- Sección PQRSFD -->
  <div class="row">
    <div class="col-12">
        <div class="card mb-4 shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center bg-light border-bottom">
                <h5 class="mb-0 text-secondary"><i class="mdi mdi-email-alert-outline me-2"></i>Estado de PQRSFD</h5>
                <a href="{% url 'listar_pqrsfd' %}" class="btn btn-sm btn-outline-primary">Ver todos</a>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg col-md-6 col-sm-6 col-6 mb-3"> {# Columna flexible #}
                        <div class="card border-0 bg-light h-100 kpi-card-small" style="border-top-color: #ffc107;">
                            <div class="card-body text-center">
                                <div class="display-5 text-warning">{{ conteo_estados_pqrsfd.P|intcomma }}</div>
                                <h6 class="card-title-small">Pendientes</h6>
                                <a href="{% url 'listar_pqrsfd' %}?estado=P" class="btn btn-sm btn-outline-warning mt-1 stretched-link">Ver</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg col-md-6 col-sm-6 col-6 mb-3">
                        <div class="card border-0 bg-light h-100 kpi-card-small" style="border-top-color: #17a2b8;">
                            <div class="card-body text-center">
                                <div class="display-5 text-info">{{ conteo_estados_pqrsfd.E|intcomma }}</div>
                                <h6 class="card-title-small">En Proceso</h6>
                                <a href="{% url 'listar_pqrsfd' %}?estado=E" class="btn btn-sm btn-outline-info mt-1 stretched-link">Ver</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg col-md-6 col-sm-6 col-6 mb-3">
                        <div class="card border-0 bg-light h-100 kpi-card-small" style="border-top-color: #28a745;">
                            <div class="card-body text-center">
                                <div class="display-5 text-success">{{ conteo_estados_pqrsfd.R|intcomma }}</div>
                                <h6 class="card-title-small">Resueltos</h6>
                                <a href="{% url 'listar_pqrsfd' %}?estado=R" class="btn btn-sm btn-outline-success mt-1 stretched-link">Ver</a>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg col-md-6 col-sm-6 col-6 mb-3">
                        <div class="card border-0 bg-light h-100 kpi-card-small" style="border-top-color: {% if conteo_estados_pqrsfd.vencidos > 0 %}#fff{% else %}#dc3545{% endif %};">
                            <div class="card-body text-center">
                                <div class="display-5">{{ conteo_estados_pqrsfd.vencidos|intcomma }}</div>
                                <h6 class="card-title-small {% if conteo_estados_pqrsfd.vencidos > 0 %}text-white{% else %}text-danger{% endif %}">Vencidos</h6>
                                <a href="{% url 'listar_pqrsfd' %}?estado=vencidos" class="btn btn-sm {% if conteo_estados_pqrsfd.vencidos > 0 %}btn-outline-light{% else %}btn-outline-danger{% endif %} mt-1 stretched-link">Ver</a>
                            </div>
                        </div>
                    </div>
                    {# Añadir columna para Cerrados si es relevante #}
                     <div class="col-lg col-md-6 col-sm-6 col-6 mb-3">
                        <div class="card border-0 bg-light h-100 kpi-card-small" style="border-top-color: #6c757d;">
                            <div class="card-body text-center">
                                <div class="display-5 text-secondary">{{ conteo_estados_pqrsfd.C|intcomma }}</div>
                                <h6 class="card-title-small">Cerrados</h6>
                                <a href="{% url 'listar_pqrsfd' %}?estado=C" class="btn btn-sm btn-outline-secondary mt-1 stretched-link">Ver</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>
</div>

<!-- Script para cargar datos JSON para los gráficos -->
<script id="tipos-preguntas-data" type="application/json">{{ tipos_preguntas_json|safe }}</script>
<script id="distribucion-categoria-data" type="application/json">{{ distribucion_categoria_json|safe }}</script>
<script id="distribucion-subcategoria-data" type="application/json">{{ distribucion_subcategoria_json|safe }}</script>
<script id="distribucion-tema-data" type="application/json">{{ distribucion_tema_json|safe }}</script>
<script id="distribucion-region-data" type="application/json">{{ distribucion_region_json|safe }}</script>
<script id="distribucion-tipo-pqrsfd-data" type="application/json">{{ distribucion_tipo_pqrsfd_json|safe }}</script>

<!-- CSS y JS de Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{# togeojson ya no parece ser necesario si usamos la API directamente #}
{# <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script> #}


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      // --- Definir objetos de Chart globales para poder destruirlos/actualizarlos ---
      window.chartInstances = {}; // Almacena instancias por ID de canvas

      // --- Cargar Datos JSON para Gráficos ---
      const chartDataSources = {
          'tipoPreguntasChart': 'tipos-preguntas-data',
          'distribucionCategoriaChart': 'distribucion-categoria-data',
          'distribucionSubcategoriaChart': 'distribucion-subcategoria-data', // Nuevo
          'distribucionTemaChart': 'distribucion-tema-data',             // Nuevo
          'distribucionRegionChart': 'distribucion-region-data',
          'distribucionTipoPqrsfdChart': 'distribucion-tipo-pqrsfd-data' // Nuevo
      };
      let chartData = {};

      for (const chartId in chartDataSources) {
          try {
              const elementId = chartDataSources[chartId];
              const element = document.getElementById(elementId);
              if (element && element.textContent.trim()) { // Verificar que no esté vacío
                  chartData[chartId] = JSON.parse(element.textContent);
              } else {
                  console.warn(`Elemento de datos JSON #${elementId} no encontrado o vacío para ${chartId}`);
                  chartData[chartId] = { labels: [], datasets: [{ data: [] }] }; // Datos vacíos por defecto
              }
          } catch (e) {
              console.error(`Error parsing JSON for ${chartId}:`, e, document.getElementById(chartDataSources[chartId])?.textContent);
              chartData[chartId] = { labels: [], datasets: [{ data: [] }] }; // Datos vacíos en caso de error
          }
      }

      // --- Función para crear/actualizar un gráfico ---
      function createOrUpdateChart(canvasId, type, data, options) {
          const ctx = document.getElementById(canvasId)?.getContext('2d');
          const container = document.getElementById(canvasId)?.closest('.chart-container');

          if (!ctx) {
              // console.warn(`Canvas con ID #${canvasId} no encontrado.`);
              return; // No hacer nada si no existe el canvas
          }

           // Destruir instancia anterior si existe
           if (window.chartInstances[canvasId]) {
               window.chartInstances[canvasId].destroy();
               delete window.chartInstances[canvasId]; // Limpiar referencia
           }

           // Verificar si hay datos válidos
          const hasData = data && data.labels && data.labels.length > 0 && data.datasets && data.datasets[0].data.length > 0 && data.datasets[0].data.some(d => d > 0);

          if (hasData) {
              // Crear nueva instancia y guardarla
               if (container) container.style.opacity = '1'; // Asegurar visibilidad
              window.chartInstances[canvasId] = new Chart(ctx, { type, data, options });
          } else {
              // Mostrar mensaje si no hay datos
              if (container) container.style.opacity = '0.5'; // Atenuar contenedor
              ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); // Limpiar canvas
              ctx.save();
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';
              ctx.fillStyle = '#aaa'; // Gris más claro
              ctx.font = '13px Arial';
              ctx.fillText("No hay datos para mostrar", ctx.canvas.width / 2, ctx.canvas.height / 2);
              ctx.restore();
          }
      }

      // --- Opciones comunes para gráficos tipo Pie/Doughnut ---
       const commonPieOptions = {
           responsive: true,
           maintainAspectRatio: false, // Clave para que el tamaño se ajuste al contenedor
           plugins: { legend: { position: 'right', labels: { boxWidth: 12, padding: 10, font: { size: 11 } } }, tooltip: { enabled: false } },
           animation: { animateScale: false, animateRotate: true } // Solo rotación
       };
       const commonDoughnutOptions = { ...commonPieOptions }; // Pueden ser iguales
       // Podrías ajustar cutout aquí si quieres: cutout: '60%'

       // --- Crear todos los gráficos iniciales ---
       function initializeAllCharts() {
            createOrUpdateChart('tipoPreguntasChart', 'doughnut', chartData['tipoPreguntasChart'], commonDoughnutOptions);
            createOrUpdateChart('distribucionCategoriaChart', 'pie', chartData['distribucionCategoriaChart'], commonPieOptions);
            createOrUpdateChart('distribucionSubcategoriaChart', 'pie', chartData['distribucionSubcategoriaChart'], commonPieOptions); // Nuevo
            createOrUpdateChart('distribucionTemaChart', 'pie', chartData['distribucionTemaChart'], commonPieOptions); // Nuevo
            createOrUpdateChart('distribucionRegionChart', 'pie', chartData['distribucionRegionChart'], commonPieOptions);
            createOrUpdateChart('distribucionTipoPqrsfdChart', 'pie', chartData['distribucionTipoPqrsfdChart'], commonPieOptions); // Nuevo
       }

       initializeAllCharts(); // Llamar al inicio


      // --- Inicializar grid personalizable ---
      const sortableGrid = document.getElementById('sortableGrid');
      let sortableInstance = null;

      if (sortableGrid) {
          loadGridLayout(); // Cargar configuración ANTES de inicializar sortable

          sortableInstance = new Sortable(sortableGrid, {
              animation: 150,
              handle: '.handle',
              draggable: '.grid-item',
              ghostClass: 'sortable-ghost',
              chosenClass: 'sortable-chosen',
              dragClass: 'sortable-drag',
              onStart: function(evt) {
                  evt.item.classList.add('dragging');
              },
              onEnd: function(evt) {
                  evt.item.classList.remove('dragging');
                  saveGridLayout(); // Guardar el nuevo orden
              }
          });

          // Botón para guardar layout
          const saveButton = document.getElementById('saveLayout');
          if (saveButton) {
              saveButton.addEventListener('click', function() {
                  saveGridLayout(); // Guardar explícitamente
                   // Feedback visual
                   this.innerHTML = '<i class="mdi mdi-check"></i> Guardado';
                   this.classList.remove('btn-outline-secondary');
                   this.classList.add('btn-success');
                   this.disabled = true;
                   setTimeout(() => {
                       this.innerHTML = '<i class="mdi mdi-content-save"></i> Guardar Distribución';
                       this.classList.add('btn-outline-secondary');
                       this.classList.remove('btn-success');
                       this.disabled = false;
                   }, 1500);
              });
          }

          // Configurar botones para cambiar tamaño
          setupResizeButtons();

          // Establecer botones activos iniciales (después de cargar layout)
          updateActiveResizeButtons();
      }

       function setupResizeButtons() {
            const resizeButtons = document.querySelectorAll('.resize-item');
            resizeButtons.forEach(button => {
                // Evitar añadir listeners duplicados
                 if (button.dataset.listenerAttached === 'true') return;
                 button.dataset.listenerAttached = 'true';

                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const size = this.getAttribute('data-size');
                    const gridItem = this.closest('.grid-item');
                    if (!gridItem) return;

                    const oldSize = Array.from(gridItem.classList).find(cls => cls.startsWith('col-span-')) || 'col-span-4';
                    const newSizeClass = `col-span-${size}`;

                    if (oldSize !== newSizeClass) {
                        gridItem.classList.remove('col-span-4', 'col-span-6', 'col-span-12');
                        gridItem.classList.add(newSizeClass);

                        // Actualizar botones activos
                        const parentButtons = gridItem.querySelectorAll('.resize-item');
                        parentButtons.forEach(btn => btn.classList.remove('active'));
                        this.classList.add('active');

                        // Redibujar gráfico interno
                        const canvas = gridItem.querySelector('canvas');
                        if (canvas && window.chartInstances[canvas.id]) {
                             // Delay para asegurar que el DOM se actualice
                            window.setTimeout(() => {
                                if (window.chartInstances[canvas.id]) { // Verificar de nuevo
                                     window.chartInstances[canvas.id].resize();
                                }
                            }, 100);
                        }
                        saveGridLayout(); // Guardar layout
                    }
                });
            });
        }

        function updateActiveResizeButtons() {
            const gridItems = document.querySelectorAll('#sortableGrid .grid-item'); // Ser más específico
            gridItems.forEach(item => {
                let currentSize = '4'; // tamaño por defecto

                if (item.classList.contains('col-span-12')) {
                    currentSize = '12';
                } else if (item.classList.contains('col-span-6')) {
                    currentSize = '6';
              }

                // Marcar el botón correspondiente como activo
              const button = item.querySelector(`.resize-item[data-size="${currentSize}"]`);
              if (button) {
                  button.classList.add('active');
                }
            });
        }


      function loadGridLayout() {
          try {
              const savedLayout = localStorage.getItem('dashboardLayout');
              if (savedLayout) {
                  const layout = JSON.parse(savedLayout);
                  const currentItemsMap = new Map(); // Usar Map para acceso rápido
                  sortableGrid.querySelectorAll('.grid-item').forEach(item => {
                       const id = item.getAttribute('data-id');
                       if(id) currentItemsMap.set(id, item);
                  });

                  const fragment = document.createDocumentFragment();
                  let orderedItemsExist = false;

                  // 1. Aplicar orden guardado
                  if (layout.order && layout.order.length > 0) {
                      layout.order.forEach(itemId => {
                           const item = currentItemsMap.get(itemId);
                           if (item) {
                               fragment.appendChild(item); // Mover al fragmento
                               currentItemsMap.delete(itemId); // Quitar del mapa
                               orderedItemsExist = true;
                           }
                      });
                  }

                  // 2. Añadir items nuevos (que no estaban en el layout guardado) al final
                  currentItemsMap.forEach(item => fragment.appendChild(item));

                  // 3. Reemplazar contenido del grid si hubo ordenamiento
                  if(orderedItemsExist || currentItemsMap.size > 0) { // Solo si hubo cambios o items nuevos
                      sortableGrid.innerHTML = ''; // Limpiar solo si es necesario
                      sortableGrid.appendChild(fragment);
                  }


                  // 4. Aplicar tamaños guardados
                  if (layout.sizes) {
                       sortableGrid.querySelectorAll('.grid-item').forEach(item => {
                           const itemId = item.getAttribute('data-id');
                           if (itemId && layout.sizes[itemId]) {
                                item.classList.remove('col-span-4', 'col-span-6', 'col-span-12');
                                item.classList.add(`col-span-${layout.sizes[itemId]}`);
                           } else {
                               // Asegurar tamaño por defecto si no está en layout.sizes
                               if (!item.classList.contains('col-span-6') && !item.classList.contains('col-span-12')) {
                                   item.classList.add('col-span-4');
                               }
                           }
                       });
                  }

                   // 5. Actualizar estado visual de botones y re-adjuntar listeners
                   updateActiveResizeButtons();
                   setupResizeButtons(); // Re-adjuntar listeners por si el DOM cambió

                   // 6. Redibujar gráficos después de aplicar layout
                   window.setTimeout(() => {
                       for (const chartId in window.chartInstances) {
                           if (window.chartInstances[chartId]) {
                                window.chartInstances[chartId].resize();
                           }
                       }
                   }, 150); // Un poco más de tiempo

              } else {
                   // Si no hay layout guardado, asegurar tamaño por defecto y botones activos
                   sortableGrid.querySelectorAll('.grid-item').forEach(item => {
                         if (!item.classList.contains('col-span-6') && !item.classList.contains('col-span-12')) {
                            item.classList.add('col-span-4');
                        }
                   });
                   updateActiveResizeButtons();
              }
          } catch (error) {
              console.error('Error al cargar la configuración del dashboard:', error);
              // Fallback: asegurar botones activos por defecto
               updateActiveResizeButtons();
               setupResizeButtons();
          }
      }

      function saveGridLayout() {
          try {
              const items = sortableGrid.querySelectorAll('.grid-item');
              const order = [];
              const sizes = {};

              items.forEach(item => {
                  const itemId = item.getAttribute('data-id');
                  if(itemId) {
                    order.push(itemId);
                    let size = 4; // Tamaño predeterminado
                    if (item.classList.contains('col-span-12')) {
                        size = 12;
                    } else if (item.classList.contains('col-span-6')) {
                        size = 6;
                    }
                    sizes[itemId] = size;
                  }
              });

              const layout = { order: order, sizes: sizes };
              localStorage.setItem('dashboardLayout', JSON.stringify(layout));
              // console.log('Layout guardado:', layout); // Para debug
          } catch (error) {
              console.error('Error al guardar la configuración del dashboard:', error);
          }
      }


      // --- Funcionalidad para mostrar/ocultar las listas de alertas ---
      document.querySelectorAll('.alert-clickable').forEach(alert => {
        alert.addEventListener('click', function() {
          this.classList.toggle('active');
          const targetId = this.dataset.target;
          const targetElement = document.getElementById(targetId);
          if (targetElement) {
            const isHidden = targetElement.style.display === 'none' || !targetElement.style.display;
            targetElement.style.display = isHidden ? 'block' : 'none';
          }
        });
      });

      // --- Código del Mapa ---
      const mapaContainer = document.getElementById('mapaColombia');
      let map = null; // Definir map fuera para acceso global dentro de este scope

      if (mapaContainer) {
            map = L.map('mapaColombia').setView([4.5709, -74.2973], 6); // Inicializar map
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 18, // Limitar zoom máximo
            }).addTo(map);

            let datosEstadisticas = {};
            let oleoductoLayer = L.layerGroup(); // Para líneas y marcadores de oleoducto
            let municipiosLayer = L.layerGroup(); // Para marcadores de municipios
            let loadingElement = document.getElementById('loadingMap');
            let progressElement = document.getElementById('loadingProgress');
            let infoMunicipioPanel = document.getElementById('infoMunicipio');

            // IDs de los canvas del panel
            const canvasRespondidasId = 'graficoEncuestasRespondidasCanvas';
            const canvasAsignadasId = 'graficoEncuestasAsignadasCanvas';


            function getColorForValue(value, tipo) {
                 // Escalas de color ajustadas (más suaves)
                 const scales = {
                    totalEncuestas: ['#eff3ff','#c6dbef','#9ecae1','#6baed6','#4292c6','#2171b5','#08519c','#08306b'], // Azules
                    totalRespuestas: ['#edf8e9','#bae4b3','#74c476','#31a354','#006d2c'], // Verdes (menos pasos)
                    tasaFinalizacion: ['#feedde','#fdd0a2','#fdae6b','#fd8d3c','#e6550d','#a63603'] // Naranjas (menos pasos)
                };
                 const colors = scales[tipo] || scales.totalEncuestas; // Default a encuestas
                 value = Number(value) || 0; // Asegurar que sea número

                 let idx = 0;
                 if (tipo === 'tasaFinalizacion') {
                     idx = Math.min(Math.floor(value / (100 / colors.length)), colors.length - 1);
                 } else if (tipo === 'totalRespuestas') {
                      // Escala logarítmica suave para respuestas
                      if (value <= 1) idx = 0;
                      else if (value <= 5) idx = 1;
                      else if (value <= 20) idx = 2;
                      else if (value <= 100) idx = 3;
                      else idx = 4;
                      idx = Math.min(idx, colors.length - 1);
                 } else { // totalEncuestas
                      // Escala lineal simple para encuestas
                     if (value <= 1) idx = 0;
                     else if (value <= 3) idx = 1;
                     else if (value <= 7) idx = 2;
                     else if (value <= 15) idx = 3;
                     else if (value <= 30) idx = 4;
                     else if (value <= 50) idx = 5;
                     else if (value <= 100) idx = 6;
                     else idx = 7;
                     idx = Math.min(idx, colors.length - 1);
                 }
                 return colors[Math.max(0, idx)]; // Asegurar índice válido
            }

            function createCustomIcon(color, size = 10) { // Tamaño configurable
                return L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color: ${color}; width: ${size}px; height: ${size}px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.7); box-shadow: 0 0 3px rgba(0,0,0,0.4);"></div>`,
                    iconSize: [size, size],
                    iconAnchor: [size/2, size/2]
                });
            }

             function crearGraficoDoughnutSimple(canvasId, label, valor, total, color) {
                 const ctx = document.getElementById(canvasId)?.getContext('2d');
                 if (!ctx) return;

                 if (window.chartInstances[canvasId]) { window.chartInstances[canvasId].destroy(); }

                 valor = Number(valor) || 0;
                 total = Number(total) || 0;
                 const restante = Math.max(0, total - valor);

                 const data = {
                     datasets: [{
                         data: [valor, restante],
                         backgroundColor: [color, '#e9ecef'],
                         borderColor: ['#ffffff', '#ffffff'],
                         borderWidth: 1, // Borde más fino
                         cutout: '75%', // Más delgado
                     }]
                 };
                 const options = {
                     responsive: true, maintainAspectRatio: false, rotation: -90, circumference: 180, // Semicírculo
                     plugins: { legend: { display: false }, tooltip: { enabled: false } },
                     animation: { animateScale: false, animateRotate: true } // Solo rotación
                 };

                 window.chartInstances[canvasId] = new Chart(ctx, {
                     type: 'doughnut', data: data, options: options,
                     plugins: [{ // Plugin para texto central
                         id: 'doughnutText',
                         afterDraw(chart, args, options) {
                             const {ctx, chartArea: {top, bottom, left, right, width, height}} = chart;
                             ctx.save();
                             const text = valor.toLocaleString(); // Formatear número
                             const textX = width / 2 + left;
                             const textY = top + (height * 0.75); // Ajustar posición vertical para semicírculo

                             ctx.font = 'bold 1.1rem Nunito, sans-serif';
                             ctx.fillStyle = color;
                             ctx.textAlign = 'center';
                             ctx.textBaseline = 'middle';
                             ctx.fillText(text, textX, textY);

                             const labelText = label || ''; // Asegurar que labelText sea siempre un string
                             ctx.font = '0.7rem Nunito, sans-serif';
                             ctx.fillStyle = '#6c757d';
                             ctx.fillText(labelText, textX, textY + 16); // Debajo del número
                             ctx.restore();
                         }
                     }]
                 });
             }


            function mostrarInfoMunicipio(key) {
                 // Convertir key a mayúsculas si no lo está ya
                 const upperKey = key.toUpperCase();
                 const info = datosEstadisticas[upperKey]; // Buscar siempre con mayúsculas

                if (!info || !infoMunicipioPanel) {
                     console.warn("Información no encontrada para clave:", upperKey, "Datos disponibles:", Object.keys(datosEstadisticas));
                     if(infoMunicipioPanel) infoMunicipioPanel.style.display = 'none'; // Ocultar si no hay datos
                     return;
                }

                document.getElementById('nombreMunicipio').textContent = info.nombre || 'N/A';
                document.getElementById('totalEncuestasMunicipio').textContent = info.totalEncuestas?.toLocaleString() || '0';
                document.getElementById('totalRespuestasMunicipio').textContent = info.totalRespuestas?.toLocaleString() || '0';
                document.getElementById('tasaFinalizacionMunicipio').textContent = info.tasaFinalizacion + '%';
                document.getElementById('infoMunicipio').style.display = 'block';
                
                // Crear/Actualizar los gráficos del panel usando IDs definidos
                crearGraficoDoughnutSimple(
                    canvasRespondidasId, 'Respondidas', info.encuestasRespondidas || 0, info.totalEncuestas || 0, '#1cc88a'
                );
                crearGraficoDoughnutSimple(
                    canvasAsignadasId, 'Asignadas', info.totalEncuestas || 0, info.totalEncuestas || 0, '#4e73df'
                );
            }


            function cargarMunicipios() {
                if (loadingElement) loadingElement.style.display = 'block';
                if (progressElement) progressElement.textContent = '0%';
                if(infoMunicipioPanel) infoMunicipioPanel.style.display = 'none'; // Ocultar panel

                municipiosLayer.clearLayers(); // Limpiar marcadores de municipios
                if(map.hasLayer(oleoductoLayer)) map.removeLayer(oleoductoLayer); // Quitar oleoductos si están
                if(!map.hasLayer(municipiosLayer)) map.addLayer(municipiosLayer); // Añadir capa de municipios si no está

                fetch('/api/estadisticas-municipios/')
                    .then(res => res.json())
                    .then(estadisticas => {
                        datosEstadisticas = estadisticas;
                        
                        let total = Object.keys(estadisticas).length;
                        let count = 0;
                        
                        for (const key in estadisticas) {
                            const municipio = estadisticas[key];
                            
                            count++;
                            let porcentaje = Math.round((count / total) * 100);
                            progressElement.textContent = porcentaje + '%';
                            
                            const lat = municipio.latitud || 4.5709;
                            const lng = municipio.longitud || -74.2973;
                            
                            const marker = L.marker([lat, lng], {
                                icon: createCustomIcon('#4e73df')
                            }).bindPopup(`
                                <div class="popup-content">
                                    <h6>${municipio.nombre}</h6>
                                    <p><strong>Región:</strong> ${municipio.region}</p><hr>
                                    <p><span>${municipio.totalRespuestas?.toLocaleString() || 0}</span> <strong>Respuestas</strong></p>
                                    <p><span>${municipio.totalEncuestas?.toLocaleString() || 0}</span> <strong>Enc. Asignadas</strong></p>
                                    <p><span>${(municipio.tasaFinalizacion || 0).toFixed(1)}%</span> <strong>Tasa Finaliz.</strong></p>
                                </div>`);
                            
                            marker.on('click', () => mostrarInfoMunicipio(key));
                            municipiosLayer.addLayer(marker);
                        }
                        
                        loadingElement.style.display = 'none';
                    })
                    .catch(error => {
                        console.error('Error cargando datos de municipios:', error);
                        loadingElement.style.display = 'none';
                    });
            }

            function cargarOleoductos() {
                 if (loadingElement) loadingElement.style.display = 'block';
                 if (progressElement) progressElement.textContent = '0%';
                 if(infoMunicipioPanel) infoMunicipioPanel.style.display = 'none'; // Ocultar panel

                oleoductoLayer.clearLayers(); // Limpiar líneas y marcadores de oleoductos
                 if(map.hasLayer(municipiosLayer)) map.removeLayer(municipiosLayer); // Quitar marcadores de municipios
                 if(!map.hasLayer(oleoductoLayer)) map.addLayer(oleoductoLayer); // Añadir capa de oleoductos

                // 1. Cargar Estadísticas
                fetch('/api/estadisticas-municipios/')
                    .then(res => res.ok ? res.json() : Promise.reject(`Estadisticas HTTP error! status: ${res.status}`))
                    .then(estadisticas => {
                        datosEstadisticas = estadisticas;
                        progressElement.textContent = '30%';

                        // 2. Cargar GeoJSON
                        fetch("{% static 'kml/Trazado_oleoducto_Cenit.geojson' %}")
                            .then(res => res.json())
                            .then(geoJson => {
                                progressElement.textContent = '60%';

                                const geoJsonLayer = L.geoJSON(geoJson, { // Guardamos la capa GeoJSON aquí
                                    style: feature => {
                                        // Usar nombre en MAYUSCULAS como clave
                                        const key = (feature.properties.nombre || feature.properties.name || '').toUpperCase();
                                        const d = datosEstadisticas[key] || {};
                                        const color = getColorForValue(d.totalEncuestas || 0, 'totalEncuestas');

                                        if (feature.geometry.type.includes('LineString')) {
                                             return { color: color, weight: 4, opacity: 0.7, dashArray: '8,4' };
                                        }
                                        // Estilo para polígonos (si aplica)
                                        return { fillColor: color, color: 'white', weight:1, fillOpacity:0.7 };
                                    },
                                    onEachFeature: (feature, layer) => {
                                        const p = feature.properties;
                                        const key = (p.nombre || p.name || '').toUpperCase();
                                        const d = datosEstadisticas[key] || {};

                                        const popupHtml = `
                                            <div class="popup-content">
                                                <h6>${p.nombre || p.name}</h6>
                                                <p><strong>Región:</strong> ${d.region}</p><hr>
                                                <p><strong>Respuestas:</strong> ${d.totalRespuestas?.toLocaleString() || 0}</p>
                                            </div>`;
                                        layer.bindPopup(popupHtml);

                                        layer.on({
                                            mouseover: (e) => e.target.setStyle({ weight:5 }), // Resaltar
                                            mouseout: (e) => geoJsonLayer.resetStyle(e.target), // CORRECCIÓN: usar geoJsonLayer.resetStyle
                                            click: () => mostrarInfoMunicipio(key) // Mostrar info al hacer clic
                                        });
                                    }
                                });

                                oleoductoLayer.addLayer(geoJsonLayer); // Añadir la capa GeoJSON al grupo
                                
                                progressElement.textContent = '80%';
                                
                                const b = geoJsonLayer.getBounds();
                                if (b.isValid && b.isValid()) map.fitBounds(b);
                                else map.setView([4.5709, -74.2973], 6);
                                
                                setTimeout(() => {
                                  progressElement.textContent = '100%';
                                  loadingElement.style.display = 'none';
                                }, 500);
                            })
                            .catch(err => {
                                console.error('Error cargando GeoJSON:', err);
                                map.setView([4.5709, -74.2973], 6);
                                loadingElement.style.display = 'none';
                            });
                    })
                    .catch(err => {
                        console.error('Error al cargar estadísticas para oleoductos:', err);
                        loadingElement.style.display = 'none';
                    });
            }

            // Configuración de botones de control
            const btnMunicipios = document.getElementById('btnMostrarMunicipios');
            const btnOleoductos = document.getElementById('btnMostrarOleoductos');

            if(btnMunicipios && btnOleoductos) {
                btnMunicipios.addEventListener('click', function() {
                    if (!this.classList.contains('active')) {
                        this.classList.add('active');
                        btnOleoductos.classList.remove('active');
                        cargarMunicipios();
                    }
                });
                btnOleoductos.addEventListener('click', function() {
                     if (!this.classList.contains('active')) {
                        this.classList.add('active');
                        btnMunicipios.classList.remove('active');
                        cargarOleoductos();
                     }
                });
            }

            // Cargar oleoductos por defecto al iniciar
            if (btnOleoductos) btnOleoductos.click(); // Simular clic para cargar y marcar activo

        } // Fin if (mapaContainer)

  }); // Fin DOMContentLoaded
</script>

{% endblock %}
