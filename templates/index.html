{% extends 'base.html' %}
{% load humanize %}
{% load static %}
{% load tz %} {# Necesario para timesince y timeuntil #}

{% block content %}

<style>
  /* Estilos para las alertas clickeables */
  .alert-clickable {
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 0; /* Elimina el margen inferior para que quede pegado al contenedor */
    position: relative;
    overflow: hidden;
  }

  .alert-clickable:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
  }

  .alert-clickable:active {
    transform: translateY(1px);
  }

  /* Efecto "pulsado" al hacer clic */
  .alert-clickable.active {
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  /* Contenedor de la lista de tiquetera */
  .product-list-container {
    margin-top: -5px; /* Solapa ligeramente con la alerta */
    padding: 15px;
    border-radius: 0 0 5px 5px;
    background-color: #f8f9fa;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-top: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    animation: fadeIn 0.3s ease-out;
    max-height: 300px; /* Limitar altura */
    overflow-y: auto; /* Scroll si es necesario */
  }

  /* Estilos para la lista de tiquetera */
  .product-list-container .list-group {
    margin-bottom: 0;
  }

  .product-list-container .list-group-item {
    border-left: none;
    border-right: none;
    padding: 8px 15px;
    font-size: 0.9rem;
  }

  .product-list-container .list-group-item:first-child {
    border-top: none;
  }

  /* Animación de carga */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Estilo para el mensaje de carga */
  .text-center {
    text-align: center;
    padding: 10px;
    color: #6c757d;
  }

  /* Nuevos estilos para las tarjetas de KPI principales */
  .kpi-card {
    border-radius: 10px;
    transition: transform 0.2s;
  }
  .kpi-card:hover {
    transform: translateY(-5px);
  }
  .chart-container {
    position: relative;
    height: 250px; /* Reducir altura un poco */
    margin-bottom: 0.5rem; /* Reducir margen */
  }

  /* Estilos para las tarjetas de encuestas */
  .hover-card {
    transition: all 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid rgba(0,0,0,0.08);
    background-color: #fff;
  }
  
  .hover-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 15px 25px rgba(0,0,0,0.12) !important;
    cursor: pointer;
    border-color: rgba(0,0,0,0.04);
  }
  
  .hover-card:active {
    transform: translateY(-4px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.1) !important;
  }
  
  /* Efecto de animación para los filtros */
  #filtroEncuestasPublicas .dropdown-item {
    transition: all 0.2s ease;
    border-radius: 4px;
    margin: 0 4px;
  }
  
  #filtroEncuestasPublicas .dropdown-item:hover {
    background-color: rgba(13, 110, 253, 0.08);
    transform: translateX(3px);
  }
  
  #filtroEncuestasPublicas .dropdown-item.active {
    background-color: rgba(13, 110, 253, 0.12);
    color: #0d6efd;
    font-weight: 500;
  }
  
  /* Transición suave para botones de ordenamiento */
  #btnOrdenarRespuestas {
    transition: all 0.2s ease;
  }
  
  #btnOrdenarRespuestas:hover {
    transform: translateY(-2px);
  }
  
  #btnOrdenarRespuestas:active {
    transform: translateY(0);
  }

  /* Estilos para el grid personalizable */
  .bento-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    grid-auto-rows: minmax(100px, auto); /* Altura mínima */
    grid-gap: 15px;
    margin-bottom: 20px;
  }

  .grid-item {
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08); /* Sombra más sutil */
    transition: all 0.3s ease;
    overflow: hidden; /* Asegurar que el contenido no se salga */
    display: flex; /* Usar flex para que el card ocupe todo */
    flex-direction: column;
  }

  .grid-item.dragging {
    opacity: 0.8;
    transform: scale(1.02);
    z-index: 10;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }

  .grid-item .card {
    height: 100%; /* Card ocupa todo el grid-item */
    border: none;
    border-radius: 10px;
    overflow: hidden;
    display: flex;
    flex-direction: column; /* Asegurar estructura vertical */
  }

  .grid-item .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.6rem 1rem; /* Ajustar padding */
    background-color: #f8f9fa; /* Fondo ligero */
    border-bottom: 1px solid #dee2e6;
  }

   .grid-item .card-header h6 { /* Usar h6 para títulos */
       margin-bottom: 0;
       font-size: 0.9rem;
   }

   .grid-item .card-body {
       flex-grow: 1; /* Permitir que el body crezca */
       padding: 0.8rem 1rem; /* Ajustar padding */
       overflow-y: auto; /* Scroll si el contenido es largo */
   }

   /* Quitar padding si la tabla es el único contenido */
   .grid-item .card-body.p-0 {
        padding: 0;
   }
   .grid-item .card-body.p-0 .table-responsive {
       height: 100%; /* Hacer que la tabla ocupe espacio */
   }
    .grid-item .card-body.p-0 .table {
       margin-bottom: 0;
   }


  .grid-item .handle {
    display: flex;
    align-items: center;
    cursor: move;
  }

  .grid-item .handle .mdi-drag {
    margin-right: 0.5rem;
    color: #888;
    font-size: 1.1rem; /* Icono más pequeño */
  }

  .grid-item .handle:hover .mdi-drag {
    color: #333;
  }

  /* Botones de cambio de tamaño */
  .resize-item {
    padding: 0.15rem 0.4rem;
    font-size: 0.7rem; /* Más pequeños */
    line-height: 1.2;
  }

  .resize-item.active {
    background-color: #6c757d;
    color: white;
    border-color: #6c757d;
  }

  /* Transición suave para cambios de tamaño */
  .grid-item {
    transition: grid-column 0.3s ease, grid-row 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
  }

  /* Tamaños predefinidos */
  .grid-item.col-span-4 { grid-column: span 4; }
  .grid-item.col-span-6 { grid-column: span 6; }
  .grid-item.col-span-12 { grid-column: span 12; }

  /* Ajustar altura basada en contenido (ejemplo) */
   .grid-item[data-id="mapaColombiaInteractivo"] {
      grid-row: span 3; /* Ejemplo: Hacer que el mapa ocupe más altura */
   }
   /* Puedes añadir más reglas para otros items si es necesario */


  /* Botón guardar distribución */
  #saveLayout {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    transition: all 0.2s ease;
  }

  #saveLayout:hover {
    background-color: #e9ecef;
    transform: translateY(-2px);
  }

  #saveLayout:active {
    transform: translateY(0);
  }

  /* Responsive */
  @media (max-width: 992px) { /* Cambiado a 992px para ajustar antes */
    .bento-grid {
      grid-template-columns: repeat(6, 1fr);
    }
    .grid-item.col-span-4 {
        grid-column: span 3; /* 2 por fila */
    }
    .grid-item.col-span-6 {
      grid-column: span 6; /* Ancho completo */
    }
     .grid-item.col-span-12 {
      grid-column: span 6; /* Ancho completo */
    }
    .grid-item[data-id="mapaColombiaInteractivo"] {
      grid-row: span 2; /* Reducir altura en pantallas medianas */
   }
  }

  @media (max-width: 768px) {
     .bento-grid {
      grid-template-columns: repeat(1, 1fr); /* Una columna */
    }
     .grid-item.col-span-4,
     .grid-item.col-span-6,
     .grid-item.col-span-12 {
         grid-column: span 1; /* Todos ocupan una columna */
     }
     .grid-item[data-id="mapaColombiaInteractivo"] {
       grid-row: span 2; /* Mantener altura reducida */
    }
     .chart-container {
         height: 280px; /* Altura fija para gráficos en móvil */
     }
     .kpi-card .display-4 {
         font-size: 2rem; /* Reducir tamaño KPIs */
     }
  }

  /* Estilos del Mapa y Popup (sin cambios mayores) */
  #mapaColombia {
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }
  .custom-div-icon { transition: transform 0.2s ease; }
  .custom-div-icon:hover { transform: scale(1.2); z-index: 1000; }
  .popup-content { min-width: 250px; padding: 10px; }
  .popup-content h6 { color: #2c3e50; font-size: 1.1rem; margin-bottom: 10px; border-bottom: 1px solid #e9ecef; padding-bottom: 5px; }
  .popup-content p { margin: 5px 0; color: #495057; font-size: 0.95rem; display: flex; justify-content: space-between; }
  .popup-content hr { margin: 8px 0; border-color: #f8f9fa; }
  .leaflet-popup-content-wrapper { border-radius: 8px; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15); }
  .leaflet-popup-tip { box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1); }
  .btn-group .btn { padding: 6px 12px; font-weight: 500; transition: all 0.2s ease; font-size: 0.85rem;}
  .btn-group .btn:hover { transform: translateY(-1px); }
  .btn-group .btn.active { box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1); }

  /* Panel de información del municipio */
  #infoMunicipio {
    background: white;
    border-radius: 8px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
    margin-top: 15px; /* Reducir margen */
  }
  #infoMunicipio h5 { color: #2c3e50; border-bottom: 1px solid #e9ecef; padding-bottom: 8px; margin-bottom: 10px; font-size: 1.1rem;}
  #infoMunicipio .row p { margin: 5px 0; color: #495057; font-size: 0.9rem; }
  #infoMunicipio .row p strong { color: #2c3e50; margin-right: 5px; display: block; font-size: 0.75rem; text-transform: uppercase; }
  #infoMunicipio .row p span { font-size: 1.1rem; font-weight: 600; }

  /* Ajustes para KPIs de PQRSFD */
   .kpi-card-small {
    border-radius: 8px;
    transition: transform 0.2s;
    border-top: 4px solid #6c757d; /* Color gris por defecto */
    border: 1px solid #eee;
  }
  .kpi-card-small:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  }
  .kpi-card-small .card-body {
    padding: 0.8rem 1rem;
  }
  .kpi-card-small .display-5 {
    font-size: 1.8rem;
    font-weight: 600;
  }
  .kpi-card-small .card-title-small {
    font-size: 0.8rem; /* Más pequeño */
    font-weight: 500;
    color: #6c757d;
    margin-bottom: 0.3rem;
    text-transform: uppercase;
  }

  /* Estilos para nuevas tarjetas de actividad reciente */
  .activity-card {
      border-left: 4px solid #17a2b8; /* Color info */
      border: 1px solid #eee;
      border-radius: 8px;
  }
  .activity-card .card-body {
      padding: 1rem;
  }
  .activity-card h6 {
      font-size: 0.9rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 0.25rem;
  }
   .activity-card p {
      font-size: 1.4rem; /* Ajustar tamaño */
      font-weight: 700;
      margin-bottom: 0.1rem;
   }
   .activity-card p .text-muted { /* Estilo para texto dentro de <p> */
       font-size: 0.9rem; /* Más pequeño */
       font-weight: 400;
   }
   .activity-card .small-text {
       font-size: 0.8rem;
       color: #6c757d;
   }
   /* Mejoras tabla */
   .table-sm th, .table-sm td {
        padding: 0.4rem 0.6rem; /* Reducir padding */
        font-size: 0.85rem;
        vertical-align: middle;
   }

  /* Estilos para el contador de respuestas */
  .response-counter {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 36px;
    height: 36px;
    background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
    color: white;
    font-weight: bold;
    border-radius: 50%;
    padding: 0 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    font-size: 0.9rem;
    transition: all 0.25s ease;
  }
  
  /* Para contadores grandes (más de 99) */
  .response-counter.large {
    border-radius: 18px;
    min-width: 42px;
  }
  
  /* Para contadores muy grandes (más de 999) */
  .response-counter.x-large {
    font-size: 0.8rem;
    min-width: 48px;
  }
  
  /* Estilo adicional para hover */
  .hover-card:hover .response-counter {
    transform: scale(1.1) translateY(-3px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    background: linear-gradient(135deg, #3c5dd9 0%, #1a3da1 100%);
  }
</style>

<div class="container-fluid py-4">
  <!-- KPIs Principales (Actualizados) -->
  <div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card kpi-card h-100 border-0 shadow-sm">
        <div class="position-absolute w-100" style="height: 6px; background-color: #0d6efd; top: 0; left: 0"></div>
        <div class="card-body">
          <h5 class="card-title text-muted">Total Encuestas</h5>
          <h2 class="display-4">{{ total_encuestas|intcomma }}</h2>
          <p class="text-success mb-0 small">
            <i class="mdi mdi-check-circle-outline"></i>
            {{ conteo_publicas_privadas.publicas|intcomma }} públicas / {{ conteo_publicas_privadas.privadas|intcomma }} privadas
          </p>
          <p class="text-info mb-0 small">
            <i class="mdi mdi-calendar-plus"></i>
             {{ encuestas_creadas_30d|intcomma }} creadas últ. 30 días
          </p>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card kpi-card h-100 border-0 shadow-sm">
        <div class="position-absolute w-100" style="height: 6px; background-color: #dc3545; top: 0; left: 0"></div>
        <div class="card-body">
          <h5 class="card-title text-muted">Activas Sin Respuestas</h5>
          <h2 class="display-4">{{ encuestas_sin_respuestas|intcomma }}</h2>
          <p class="text-danger mb-0 small">
            <i class="mdi mdi-alert-circle-outline"></i>
            Necesitan atención / promoción
          </p>
           <p class="text-info mb-0 small">
            <i class="mdi mdi-timer-sand"></i>
            {{ encuestas_activas|intcomma }} encuestas activas en total
          </p>
        </div>
      </div>
    </div>
  </div>
   <!-- Mapa Interactivo de Colombia -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h5 class="mb-0 fw-bold"><i class="fas fa-map me-2"></i>Mapa Interactivo - Estadísticas por Municipio</h5>
          <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-success active" id="btnMostrarOleoductos">
              <i class="mdi mdi-pipe me-1"></i>Oleoductos
            </button>
            <button type="button" class="btn btn-outline-primary" id="btnMostrarMunicipios">
              <i class="mdi mdi-map-marker-radius me-1"></i>Municipios
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="loadingMap" class="text-center" style="display: none;">
            <div class="spinner-border text-primary spinner-border-sm" role="status"><span class="visually-hidden">Cargando...</span></div>
            <div class="mt-2 small text-muted"><span id="loadingProgress">0%</span> Cargando datos...</div>
          </div>
          <div id="mapaColombia" style="height: 450px; width: 100%; border-radius: 6px;"></div>
          <div id="infoMunicipio" class="mt-3 p-3 border rounded bg-light" style="display: none">
            <h5 id="nombreMunicipio" class="mb-2"></h5>
            <div class="d-flex justify-content-between mb-3">
              <div><strong class="text-muted">Región:</strong> <span id="regionMunicipio" class="ms-1"></span></div>
              <div><strong class="text-muted">Total encuestas:</strong> <span id="totalEncuestasMunicipio" class="badge bg-primary ms-1">0</span></div>
              <div><strong class="text-muted">Total respuestas:</strong> <span id="totalRespuestasMunicipio" class="badge bg-success ms-1">0</span></div>
            </div>
            
            <!-- Tabs para cambiar entre encuestas y respuestas -->
            <ul class="nav nav-tabs" id="infoMunicipioTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="encuestas-tab" data-bs-toggle="tab" data-bs-target="#encuestas-tab-pane" type="button" role="tab" aria-selected="true">
                  <i class="fas fa-poll me-1"></i>Encuestas
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="respuestas-tab" data-bs-toggle="tab" data-bs-target="#respuestas-tab-pane" type="button" role="tab" aria-selected="false">
                  <i class="fas fa-clipboard-check me-1"></i>Respuestas
                </button>
              </li>
            </ul>
            
            <div class="tab-content mt-3" id="infoMunicipioTabsContent">
              <!-- Tab de encuestas -->
              <div class="tab-pane fade show active" id="encuestas-tab-pane" role="tabpanel" tabindex="0">
                <div class="table-responsive">
                  <table class="table table-sm table-hover">
                    <thead>
                      <tr>
                        <th>Encuesta</th>
                        <th>Categoría</th>
                        <th>Grupo de interés</th>
                        <th class="text-center">Estado</th>
                        <th class="text-end">Respuestas</th>
                      </tr>
                    </thead>
                    <tbody id="tablaEncuestas">
                      <!-- Se llena dinámicamente con JavaScript -->
                      <tr>
                        <td colspan="5" class="text-center text-muted py-3">No hay encuestas para esta ubicación</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              
              <!-- Tab de respuestas -->
              <div class="tab-pane fade" id="respuestas-tab-pane" role="tabpanel" tabindex="0">
                <div class="table-responsive">
                  <table class="table table-sm table-hover">
                    <thead>
                      <tr>
                        <th>Encuesta</th>
                        <th>Usuario</th>
                        <th>Fecha</th>
                      </tr>
                    </thead>
                    <tbody id="tablaRespuestas">
                      <!-- Se llena dinámicamente con JavaScript -->
                      <tr>
                        <td colspan="3" class="text-center text-muted py-3">No hay respuestas para esta ubicación</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- Grid Personalizable de Gráficos -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm mb-3">
        <div class="card-header d-flex justify-content-between align-items-center bg-light border-bottom">
          <h5 class="mb-0 text-primary"><i class="mdi mdi-poll-box me-2"></i>Encuestas Públicas Activas</h5>
          <div class="d-flex align-items-center">
            
            <!-- Filtro por Grupo de Interés -->
            <div class="btn-group btn-group-sm me-2" id="filtroGrupoContainer">
              <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" id="btnFiltroGrupo">
                <i class="fas fa-users me-1"></i>Grupo de Interés
              </button>
              <ul class="dropdown-menu dropdown-menu-end shadow-sm py-1" id="filtroEncuestasGrupo">
                <li><a class="dropdown-item active py-2" href="#" data-filter="grupo" data-id="todas">
                  <i class="fas fa-users me-2 text-info"></i>Todos los Grupos
                </a></li>
                <li><hr class="dropdown-divider my-1"></li>
                {% for grupo in grupos_interes %}
                <li><a class="dropdown-item py-2" href="#" data-filter="grupo" data-id="{{ grupo.id }}" style="color: #333;">
                  <i class="fas fa-users me-2 text-info"></i>{{ grupo.nombre }}
                </a></li>
                {% endfor %}
              </ul>
            </div>

            <!-- Filtro por Categoría -->
            <div class="btn-group btn-group-sm me-2" id="filtroCategoriaContainer">
              <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" id="btnFiltroCategoria">
                <i class="fas fa-tag me-1"></i>Categoría
              </button>
              <ul class="dropdown-menu dropdown-menu-end shadow-sm py-1" id="filtroEncuestasCategoria">
                <li><a class="dropdown-item active py-2" href="#" data-filter="categoria" data-id="todas">
                  <i class="fas fa-tag me-2 text-success"></i>Todas las Categorías
                </a></li>
                <li><hr class="dropdown-divider my-1"></li>
                {% for cat in categorias %}
                <li><a class="dropdown-item py-2" href="#" data-filter="categoria" data-id="{{ cat.id }}" style="color: #333;">
                  <i class="fas fa-tag me-2 text-success"></i>{{ cat.nombre }}
                </a></li>
                {% endfor %}
              </ul>
            </div>

            <!-- Filtro por Región -->
            <div class="btn-group btn-group-sm me-2" id="filtroRegionContainer">
              <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" id="btnFiltroRegion">
                <i class="fas fa-map-marked-alt me-1"></i>Región
              </button>
              <ul class="dropdown-menu dropdown-menu-end shadow-sm py-1" id="filtroEncuestasRegion">
                <li><a class="dropdown-item active py-2" href="#" data-filter="region" data-id="todas">
                  <i class="fas fa-map-marked-alt me-2 text-danger"></i>Todas las Regiones
                </a></li>
                <li><hr class="dropdown-divider my-1"></li>
                {% for region_item in regiones %}
                <li><a class="dropdown-item py-2" href="#" data-filter="region" data-id="{{ region_item.id }}" style="color: #333;">
                  <i class="fas fa-map-marked-alt me-2 text-danger"></i>{{ region_item.nombre }}
                </a></li>
                {% endfor %}
              </ul>
            </div>

            <button type="button" class="btn btn-sm btn-outline-primary" id="btnOrdenarRespuestas">
              <i class="fas fa-sort-amount-down me-1"></i>Por respuestas
            </button>
          </div>
        </div>
        <div class="card-body p-3">
          <div class="row" id="contenedorEncuestasActivas">
            {% for encuesta in encuestas_publicas_activas %}
            <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6 mb-3 encuesta-card" 
                 data-respuestas="{{ encuesta.respuestas.count }}"
                 data-categoria="{{ encuesta.categoria.id|default:'0' }}"
                 data-grupo="{{ encuesta.grupo_interes.id|default:'0' }}"
                 data-region="{{ encuesta.region.id|default:'0' }}">
              <div class="card h-100 shadow-sm hover-card">
                <div class="position-absolute w-100" style="height: 4px; background-color: #1cc88a; top: 0; left: 0"></div>
                <div class="card-body py-3 px-3">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="card-title mb-0 text-truncate" style="max-width: 70%;" title="{{ encuesta.titulo }}">{{ encuesta.titulo|truncatechars:30 }}</h6>
                    {% with num_respuestas=encuesta.respuestas.count %}
                    <div class="response-counter">{{ num_respuestas }}</div>
                    {% endwith %}
                  </div>
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge bg-success rounded-pill px-2 py-1">Activa</span>
                    <span class="text-muted small">Hasta: {{ encuesta.fecha_fin|date:"d/m/Y" }}</span>
                  </div>
                  <div class="d-flex flex-wrap text-muted small mb-1" style="font-size: 0.78rem;">
                    <div class="me-2 mb-1"><i class="fas fa-tag me-1 text-success"></i>{{ encuesta.categoria.nombre|default:"Sin cat."|truncatechars:15 }}</div>
                    <div class="me-2 mb-1"><i class="fas fa-users me-1 text-info"></i>{{ encuesta.grupo_interes.nombre|default:"Sin grupo"|truncatechars:15 }}</div>
                  </div>
                  <div class="text-muted small mb-1" style="font-size: 0.78rem;">
                    <i class="fas fa-map-marker-alt me-1 text-danger"></i>{{ encuesta.region.nombre|default:"Sin región"|truncatechars:15 }}
                  </div>
                  <a href="{% url 'resultados_encuesta' encuesta.id %}" class="stretched-link"></a>
                </div>
              </div>
            </div>
            {% empty %}
            <div class="col-12 text-center py-4" id="sinEncuestasMsg">
              <i class="fas fa-poll fa-3x text-muted mb-3"></i>
              <h6>No hay encuestas públicas activas</h6>
              <p class="text-muted small">Las encuestas públicas activas se mostrarán aquí cuando estén disponibles</p>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fila de Estadísticas Adicionales -->
  <div class="row mb-4">
    <!-- Municipios con más respuestas -->
    <div class="col-md-6 mb-3">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light">
          <h5 class="mb-0 fw-bold"><i class="fas fa-map-marked-alt me-2"></i>Top Municipios (Más Respuestas)</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover table-sm mb-0">
              <thead>
                <tr>
                  <th>Municipio</th>
                  <th class="text-end">Total Respuestas</th>
                </tr>
              </thead>
              <tbody>
                {% for municipio in top_municipios %}
                <tr>
                  <td>
                    {{ municipio.municipio__nombre|default:"Sin municipio" }}
                  </td>
                  <td class="text-end">{{ municipio.total|intcomma }}</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="2" class="text-center py-3 text-muted small">
                    No hay datos disponibles
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Últimas Respuestas Recibidas -->
    <div class="col-md-6 mb-3">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light">
          <h5 class="mb-0 fw-bold"><i class="fas fa-reply-all me-2"></i>Últimas Respuestas Recibidas</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0 table-sm">
              <thead>
                <tr>
                  <th>Encuesta</th>
                  <th>Usuario</th>
                  <th>Fecha</th>
                </tr>
              </thead>
              <tbody>
                {% for respuesta in ultimas_respuestas %}
                <tr>
                  <td>
                    <a href="{% url 'resultados_encuesta' respuesta.encuesta.pk %}" class="text-dark" title="{{ respuesta.encuesta.titulo }}">
                      {{ respuesta.encuesta.titulo|truncatechars:30 }}
                    </a>
                  </td>
                  <td>
                    {% if respuesta.usuario %}
                    {{ respuesta.usuario.username|truncatechars:15 }}
                    {% else %}
                    <span class="text-muted fst-italic small">Anónimo</span>
                    {% endif %}
                  </td>
                  <td>
                    <span title="{{ respuesta.fecha_respuesta|date:'d M Y H:i:s' }}">
                      {% timezone None %}
                      {{ respuesta.fecha_respuesta|timesince }} atrás
                      {% endtimezone %}
                    </span>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="3" class="text-center py-3 text-muted small">
                    No hay respuestas recientes
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

 

  <!-- Sección PQRSFD -->
  <div class="row">
    <div class="col-12">
        <div class="card mb-4 shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center bg-light border-bottom">
                <h5 class="mb-0 text-secondary"><i class="mdi mdi-email-alert-outline me-2"></i>Estado de PQRSFD</h5>
                <a href="{% url 'listar_pqrsfd' %}" class="btn btn-sm btn-outline-primary">Ver todos</a>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg col-md-6 col-sm-6 col-6 mb-3"> {# Columna flexible #}
                        <div class="card border-0 bg-light h-100 kpi-card-small" style="border-top-color: #ffc107;">
                            <div class="card-body text-center">
                                <div class="display-5 text-warning">{{ conteo_estados_pqrsfd.P|intcomma }}</div>
                                <h6 class="card-title-small">Pendientes</h6>
                                <a href="{% url 'listar_pqrsfd' %}?estado=P" class="btn btn-sm btn-outline-warning mt-1 stretched-link">Ver</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg col-md-6 col-sm-6 col-6 mb-3">
                        <div class="card border-0 bg-light h-100 kpi-card-small" style="border-top-color: #17a2b8;">
                            <div class="card-body text-center">
                                <div class="display-5 text-info">{{ conteo_estados_pqrsfd.E|intcomma }}</div>
                                <h6 class="card-title-small">En Proceso</h6>
                                <a href="{% url 'listar_pqrsfd' %}?estado=E" class="btn btn-sm btn-outline-info mt-1 stretched-link">Ver</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg col-md-6 col-sm-6 col-6 mb-3">
                        <div class="card border-0 bg-light h-100 kpi-card-small" style="border-top-color: #28a745;">
                            <div class="card-body text-center">
                                <div class="display-5 text-success">{{ conteo_estados_pqrsfd.R|intcomma }}</div>
                                <h6 class="card-title-small">Resueltos</h6>
                                <a href="{% url 'listar_pqrsfd' %}?estado=R" class="btn btn-sm btn-outline-success mt-1 stretched-link">Ver</a>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg col-md-6 col-sm-6 col-6 mb-3">
                        <div class="card border-0 {% if conteo_estados_pqrsfd.vencidos > 0 %}bg-danger text-white{% else %}bg-light{% endif %} h-100 kpi-card-small" style="border-top-color: {% if conteo_estados_pqrsfd.vencidos > 0 %}#fff{% else %}#dc3545{% endif %};">
                            <div class="card-body text-center">
                                <div class="display-5">{{ conteo_estados_pqrsfd.vencidos|intcomma }}</div>
                                <h6 class="card-title-small {% if conteo_estados_pqrsfd.vencidos > 0 %}text-white-50{% else %}text-danger{% endif %}">Vencidos</h6>
                                <a href="{% url 'listar_pqrsfd' %}?estado=vencidos" class="btn btn-sm {% if conteo_estados_pqrsfd.vencidos > 0 %}btn-outline-light{% else %}btn-outline-danger{% endif %} mt-1 stretched-link">Ver</a>
                            </div>
                        </div>
                    </div>
                    {# Añadir columna para Cerrados si es relevante #}
                     <div class="col-lg col-md-6 col-sm-6 col-6 mb-3">
                        <div class="card border-0 bg-light h-100 kpi-card-small" style="border-top-color: #6c757d;">
                            <div class="card-body text-center">
                                <div class="display-5 text-secondary">{{ conteo_estados_pqrsfd.C|intcomma }}</div>
                                <h6 class="card-title-small">Cerrados</h6>
                                <a href="{% url 'listar_pqrsfd' %}?estado=C" class="btn btn-sm btn-outline-secondary mt-1 stretched-link">Ver</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>
</div>

<!-- Script para cargar datos JSON para los gráficos -->
<script id="tipos-preguntas-data" type="application/json">{{ tipos_preguntas_json|safe }}</script>
<script id="distribucion-categoria-data" type="application/json">{{ distribucion_categoria_json|safe }}</script>
<script id="distribucion-subcategoria-data" type="application/json">{{ distribucion_subcategoria_json|safe }}</script>
<script id="distribucion-tema-data" type="application/json">{{ distribucion_tema_json|safe }}</script>
<script id="distribucion-region-data" type="application/json">{{ distribucion_region_json|safe }}</script>
<script id="distribucion-tipo-pqrsfd-data" type="application/json">{{ distribucion_tipo_pqrsfd_json|safe }}</script>

<!-- CSS y JS de Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{# togeojson ya no parece ser necesario si usamos la API directamente #}
{# <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script> #}


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script id="api-recommendation" type="text/javascript">
// Vista recomendada para mejorar la API de estadísticas municipales
/*
def api_estadisticas_municipios(request):
    """
    API que devuelve estadísticas de municipios en formato JSON para el mapa
    """
    try:
        # Obtener todos los municipios con coordenadas
        municipios = Municipio.objects.select_related('region').all()
        
        # Filtrar por región si se proporciona
        region_id = request.GET.get('region')
        if region_id and region_id != 'todas':
            municipios = municipios.filter(region_id=region_id)
        
        # Preparar datos para el mapa
        datos_mapa = {}
        for municipio in municipios:
            # Contar respuestas para este municipio
            respuestas = RespuestaEncuesta.objects.filter(municipio=municipio)
            total_respuestas = respuestas.count()
            
            # Contar encuestas asignadas al municipio (puede variar según la lógica del negocio)
            # Asumimos que las encuestas asignadas son las que corresponden a la región del municipio
            encuestas_asignadas = Encuesta.objects.filter(region=municipio.region)
            total_encuestas = encuestas_asignadas.count()
            
            # Contar encuestas respondidas (únicas)
            encuestas_respondidas = respuestas.values('encuesta').distinct().count()
            
            # Calcular tasa de finalización
            tasa_finalizacion = 0
            if total_encuestas > 0:
                tasa_finalizacion = (encuestas_respondidas / total_encuestas) * 100
                
            # Obtener lista de encuestas para este municipio/región
            encuestas_lista = []
            for encuesta in encuestas_asignadas:
                respuestas_encuesta = respuestas.filter(encuesta=encuesta).count()
                encuestas_lista.append({
                    'id': encuesta.id,
                    'titulo': encuesta.titulo,
                    'categoria': encuesta.categoria.nombre if encuesta.categoria else None,
                    'grupo_interes': encuesta.grupo_interes.nombre if encuesta.grupo_interes else None,
                    'activa': encuesta.activa,
                    'respuestas': respuestas_encuesta
                })
            
            # Obtener lista de últimas respuestas para este municipio (limitado a 20)
            respuestas_lista = []
            ultimas_respuestas = respuestas.select_related('encuesta', 'usuario').order_by('-fecha_respuesta')[:20]
            for resp in ultimas_respuestas:
                respuestas_lista.append({
                    'encuesta_id': resp.encuesta.id,
                    'encuesta_titulo': resp.encuesta.titulo,
                    'usuario': resp.usuario.username if resp.usuario else None,
                    'fecha': resp.fecha_respuesta.isoformat()
                })
            
            # La clave debe ser el nombre del municipio en mayúsculas para consistencia con el frontend
            datos_mapa[municipio.nombre.upper()] = {
                'id': municipio.id,
                'nombre': municipio.nombre,
                'region': municipio.region.nombre,
                'region_id': municipio.region.id,
                'latitud': municipio.latitud or 4.5709,  # Valor por defecto si falta latitud
                'longitud': municipio.longitud or -74.2973,  # Valor por defecto si falta longitud
                'totalRespuestas': total_respuestas,
                'totalEncuestas': total_encuestas, 
                'encuestasRespondidas': encuestas_respondidas,
                'encuestas': encuestas_lista,
                'respuestas': respuestas_lista
            }
        
        return JsonResponse(datos_mapa)
    except Exception as e:
        return JsonResponse({'error': str(e)}, status=500)
*/
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      // --- Definir objetos de Chart globales para poder destruirlos/actualizarlos ---
      window.chartInstances = {}; // Almacena instancias por ID de canvas

      // --- Cargar Datos JSON para Gráficos ---
      const chartDataSources = {
          'tipoPreguntasChart': 'tipos-preguntas-data',
          'distribucionCategoriaChart': 'distribucion-categoria-data',
          'distribucionSubcategoriaChart': 'distribucion-subcategoria-data', // Nuevo
          'distribucionTemaChart': 'distribucion-tema-data',             // Nuevo
          'distribucionRegionChart': 'distribucion-region-data',
          'distribucionTipoPqrsfdChart': 'distribucion-tipo-pqrsfd-data' // Nuevo
      };
      let chartData = {};

      for (const chartId in chartDataSources) {
          try {
              const elementId = chartDataSources[chartId];
              const element = document.getElementById(elementId);
              if (element && element.textContent.trim()) { // Verificar que no esté vacío
                  chartData[chartId] = JSON.parse(element.textContent);
              } else {
                  console.warn(`Elemento de datos JSON #${elementId} no encontrado o vacío para ${chartId}`);
                  chartData[chartId] = { labels: [], datasets: [{ data: [] }] }; // Datos vacíos por defecto
              }
          } catch (e) {
              console.error(`Error parsing JSON for ${chartId}:`, e, document.getElementById(chartDataSources[chartId])?.textContent);
              chartData[chartId] = { labels: [], datasets: [{ data: [] }] }; // Datos vacíos en caso de error
          }
      }

      // --- Función para crear/actualizar un gráfico ---
      function createOrUpdateChart(canvasId, type, data, options) {
          const ctx = document.getElementById(canvasId)?.getContext('2d');
          const container = document.getElementById(canvasId)?.closest('.chart-container');

          if (!ctx) {
              // console.warn(`Canvas con ID #${canvasId} no encontrado.`);
              return; // No hacer nada si no existe el canvas
          }

           // Destruir instancia anterior si existe
           if (window.chartInstances[canvasId]) {
               window.chartInstances[canvasId].destroy();
               delete window.chartInstances[canvasId]; // Limpiar referencia
           }

           // Verificar si hay datos válidos
          const hasData = data && data.labels && data.labels.length > 0 && data.datasets && data.datasets[0].data.length > 0 && data.datasets[0].data.some(d => d > 0);

          if (hasData) {
              // Crear nueva instancia y guardarla
               if (container) container.style.opacity = '1'; // Asegurar visibilidad
              window.chartInstances[canvasId] = new Chart(ctx, { type, data, options });
          } else {
              // Mostrar mensaje si no hay datos
              if (container) container.style.opacity = '0.5'; // Atenuar contenedor
              ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); // Limpiar canvas
              ctx.save();
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';
              ctx.fillStyle = '#aaa'; // Gris más claro
              ctx.font = '13px Arial';
              ctx.fillText("No hay datos para mostrar", ctx.canvas.width / 2, ctx.canvas.height / 2);
              ctx.restore();
          }
      }

      // --- Opciones comunes para gráficos tipo Pie/Doughnut ---
       const commonPieOptions = {
           responsive: true,
           maintainAspectRatio: false, // Clave para que el tamaño se ajuste al contenedor
           plugins: { legend: { position: 'right', labels: { boxWidth: 12, padding: 10, font: { size: 11 } } }, tooltip: { enabled: false } },
           animation: { animateScale: false, animateRotate: true } // Solo rotación
       };
       // Animacion de rotacion con
       const commonDoughnutOptions = { ...commonPieOptions, cutout: '20%', animation: { animateScale: true, animateRotate: true, duration: 3000, easing: 'easeOutBounce', delay: 1000 }}; // Pueden ser iguales
       // Podrías ajustar cutout aquí si quieres: cutout: '60%'

       // --- Crear todos los gráficos iniciales ---
       function initializeAllCharts() {
            createOrUpdateChart('tipoPreguntasChart', 'doughnut', chartData['tipoPreguntasChart'], commonDoughnutOptions);
            createOrUpdateChart('distribucionCategoriaChart', 'doughnut', chartData['distribucionCategoriaChart'], commonDoughnutOptions);
            createOrUpdateChart('distribucionSubcategoriaChart', 'doughnut', chartData['distribucionSubcategoriaChart'], commonDoughnutOptions); // Nuevo
            createOrUpdateChart('distribucionTemaChart', 'pie', chartData['distribucionTemaChart'], commonPieOptions); // Nuevo
            createOrUpdateChart('distribucionRegionChart', 'pie', chartData['distribucionRegionChart'], commonPieOptions);
            createOrUpdateChart('distribucionTipoPqrsfdChart', 'pie', chartData['distribucionTipoPqrsfdChart'], commonPieOptions); // Nuevo
       }

       initializeAllCharts(); // Llamar al inicio


      // --- Inicializar grid personalizable ---
      const sortableGrid = document.getElementById('sortableGrid');
      let sortableInstance = null;

      if (sortableGrid) {
          loadGridLayout(); // Cargar configuración ANTES de inicializar sortable

          sortableInstance = new Sortable(sortableGrid, {
              animation: 150,
              handle: '.handle',
              draggable: '.grid-item',
              ghostClass: 'sortable-ghost',
              chosenClass: 'sortable-chosen',
              dragClass: 'sortable-drag',
              onStart: function(evt) {
                  evt.item.classList.add('dragging');
              },
              onEnd: function(evt) {
                  evt.item.classList.remove('dragging');
                  saveGridLayout(); // Guardar el nuevo orden
              }
          });

          // Botón para guardar layout
          const saveButton = document.getElementById('saveLayout');
          if (saveButton) {
              saveButton.addEventListener('click', function() {
                  saveGridLayout(); // Guardar explícitamente
                   // Feedback visual
                   this.innerHTML = '<i class="mdi mdi-check"></i> Guardado';
                   this.classList.remove('btn-outline-secondary');
                   this.classList.add('btn-success');
                   this.disabled = true;
                   setTimeout(() => {
                       this.innerHTML = '<i class="mdi mdi-content-save"></i> Guardar Distribución';
                       this.classList.add('btn-outline-secondary');
                       this.classList.remove('btn-success');
                       this.disabled = false;
                   }, 1500);
              });
          }

          // Configurar botones para cambiar tamaño
          setupResizeButtons();

          // Establecer botones activos iniciales (después de cargar layout)
          updateActiveResizeButtons();
      }

       function setupResizeButtons() {
            const resizeButtons = document.querySelectorAll('.resize-item');
            resizeButtons.forEach(button => {
                // Evitar añadir listeners duplicados
                 if (button.dataset.listenerAttached === 'true') return;
                 button.dataset.listenerAttached = 'true';

                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const size = this.getAttribute('data-size');
                    const gridItem = this.closest('.grid-item');
                    if (!gridItem) return;

                    const oldSize = Array.from(gridItem.classList).find(cls => cls.startsWith('col-span-')) || 'col-span-4';
                    const newSizeClass = `col-span-${size}`;

                    if (oldSize !== newSizeClass) {
                        gridItem.classList.remove('col-span-4', 'col-span-6', 'col-span-12');
                        gridItem.classList.add(newSizeClass);

                        // Actualizar botones activos
                        const parentButtons = gridItem.querySelectorAll('.resize-item');
                        parentButtons.forEach(btn => btn.classList.remove('active'));
                        this.classList.add('active');

                        // Redibujar gráfico interno
                        const canvas = gridItem.querySelector('canvas');
                        if (canvas && window.chartInstances[canvas.id]) {
                             // Delay para asegurar que el DOM se actualice
                            window.setTimeout(() => {
                                if (window.chartInstances[canvas.id]) { // Verificar de nuevo
                                     window.chartInstances[canvas.id].resize();
                                }
                            }, 100);
                        }
                        saveGridLayout(); // Guardar layout
                    }
                });
            });
        }

        function updateActiveResizeButtons() {
            const gridItems = document.querySelectorAll('#sortableGrid .grid-item'); // Ser más específico
            gridItems.forEach(item => {
                let currentSize = '4'; // tamaño por defecto

                if (item.classList.contains('col-span-12')) {
                    currentSize = '12';
                } else if (item.classList.contains('col-span-6')) {
                    currentSize = '6';
              }

                // Marcar el botón correspondiente como activo
              const button = item.querySelector(`.resize-item[data-size="${currentSize}"]`);
              if (button) {
                  button.classList.add('active');
                }
            });
        }


      function loadGridLayout() {
          try {
              const savedLayout = localStorage.getItem('dashboardLayout');
              if (savedLayout) {
                  const layout = JSON.parse(savedLayout);
                  const currentItemsMap = new Map(); // Usar Map para acceso rápido
                  sortableGrid.querySelectorAll('.grid-item').forEach(item => {
                       const id = item.getAttribute('data-id');
                       if(id) currentItemsMap.set(id, item);
                  });

                  const fragment = document.createDocumentFragment();
                  let orderedItemsExist = false;

                  // 1. Aplicar orden guardado
                  if (layout.order && layout.order.length > 0) {
                      layout.order.forEach(itemId => {
                           const item = currentItemsMap.get(itemId);
                           if (item) {
                               fragment.appendChild(item); // Mover al fragmento
                               currentItemsMap.delete(itemId); // Quitar del mapa
                               orderedItemsExist = true;
                           }
                      });
                  }

                  // 2. Añadir items nuevos (que no estaban en el layout guardado) al final
                  currentItemsMap.forEach(item => fragment.appendChild(item));

                  // 3. Reemplazar contenido del grid si hubo ordenamiento
                  if(orderedItemsExist || currentItemsMap.size > 0) { // Solo si hubo cambios o items nuevos
                      sortableGrid.innerHTML = ''; // Limpiar solo si es necesario
                      sortableGrid.appendChild(fragment);
                  }


                  // 4. Aplicar tamaños guardados
                  if (layout.sizes) {
                       sortableGrid.querySelectorAll('.grid-item').forEach(item => {
                           const itemId = item.getAttribute('data-id');
                           if (itemId && layout.sizes[itemId]) {
                                item.classList.remove('col-span-4', 'col-span-6', 'col-span-12');
                                item.classList.add(`col-span-${layout.sizes[itemId]}`);
                           } else {
                               // Asegurar tamaño por defecto si no está en layout.sizes
                               if (!item.classList.contains('col-span-6') && !item.classList.contains('col-span-12')) {
                                   item.classList.add('col-span-4');
                               }
                           }
                       });
                  }

                   // 5. Actualizar estado visual de botones y re-adjuntar listeners
                   updateActiveResizeButtons();
                   setupResizeButtons(); // Re-adjuntar listeners por si el DOM cambió

                   // 6. Redibujar gráficos después de aplicar layout
                   window.setTimeout(() => {
                       for (const chartId in window.chartInstances) {
                           if (window.chartInstances[chartId]) {
                                window.chartInstances[chartId].resize();
                           }
                       }
                   }, 150); // Un poco más de tiempo

              } else {
                   // Si no hay layout guardado, asegurar tamaño por defecto y botones activos
                   sortableGrid.querySelectorAll('.grid-item').forEach(item => {
                         if (!item.classList.contains('col-span-6') && !item.classList.contains('col-span-12')) {
                            item.classList.add('col-span-4');
                        }
                   });
                   updateActiveResizeButtons();
              }
          } catch (error) {
              console.error('Error al cargar la configuración del dashboard:', error);
              // Fallback: asegurar botones activos por defecto
               updateActiveResizeButtons();
               setupResizeButtons();
          }
      }

      function saveGridLayout() {
          try {
              const items = sortableGrid.querySelectorAll('.grid-item');
              const order = [];
              const sizes = {};

              items.forEach(item => {
                  const itemId = item.getAttribute('data-id');
                  if(itemId) {
                    order.push(itemId);
                    let size = 4; // Tamaño predeterminado
                    if (item.classList.contains('col-span-12')) {
                        size = 12;
                    } else if (item.classList.contains('col-span-6')) {
                        size = 6;
                    }
                    sizes[itemId] = size;
                  }
              });

              const layout = { order: order, sizes: sizes };
              localStorage.setItem('dashboardLayout', JSON.stringify(layout));
              // console.log('Layout guardado:', layout); // Para debug
          } catch (error) {
              console.error('Error al guardar la configuración del dashboard:', error);
          }
      }


      // --- Funcionalidad para mostrar/ocultar las listas de alertas ---
      document.querySelectorAll('.alert-clickable').forEach(alert => {
        alert.addEventListener('click', function() {
          this.classList.toggle('active');
          const targetId = this.dataset.target;
          const targetElement = document.getElementById(targetId);
          if (targetElement) {
            const isHidden = targetElement.style.display === 'none' || !targetElement.style.display;
            targetElement.style.display = isHidden ? 'block' : 'none';
          }
        });
      });

      // --- Código del Mapa ---
      const mapaContainer = document.getElementById('mapaColombia');
      let map = null; // Definir map fuera para acceso global dentro de este scope

      if (mapaContainer) {
            map = L.map('mapaColombia').setView([4.5709, -74.2973], 6); // Inicializar map
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                maxZoom: 18, // Limitar zoom máximo
            }).addTo(map);

            let datosEstadisticas = {};
            let oleoductoLayer = L.layerGroup().addTo(map); // Añadir directamente al mapa
            let municipiosLayer = L.layerGroup(); // Para marcadores de municipios
            let loadingElement = document.getElementById('loadingMap');
            let progressElement = document.getElementById('loadingProgress');
            let infoMunicipioPanel = document.getElementById('infoMunicipio');

            // IDs de los canvas del panel
            const canvasRespondidasId = 'graficoEncuestasRespondidasCanvas';
            const canvasAsignadasId = 'graficoEncuestasAsignadasCanvas';


            function getColorForValue(value, tipo) {
                 // Escalas de color ajustadas (más suaves)
                 const scales = {
                    totalEncuestas: ['#eff3ff','#c6dbef','#9ecae1','#6baed6','#4292c6','#2171b5','#08519c','#08306b'], // Azules
                    totalRespuestas: ['#edf8e9','#bae4b3','#74c476','#31a354','#006d2c'], // Verdes (menos pasos)
                    tasaFinalizacion: ['#feedde','#fdd0a2','#fdae6b','#fd8d3c','#e6550d','#a63603'] // Naranjas (menos pasos)
                };
                 const colors = scales[tipo] || scales.tasaFinalizacion; // Default a encuestas
                 value = Number(value) || 0; // Asegurar que sea número

                 let idx = 0;
                 if (tipo === 'tasaFinalizacion') {
                     idx = Math.min(Math.floor(value / (100 / colors.length)), colors.length - 1);
                 } else if (tipo === 'totalRespuestas') {
                      // Escala logarítmica suave para respuestas
                      if (value <= 1) idx = 0;
                      else if (value <= 5) idx = 1;
                      else if (value <= 20) idx = 2;
                      else if (value <= 100) idx = 3;
                      else idx = 4;
                      idx = Math.min(idx, colors.length - 1);
                 } else { // totalEncuestas
                      // Escala lineal simple para encuestas
                     if (value <= 1) idx = 0;
                     else if (value <= 3) idx = 1;
                     else if (value <= 7) idx = 2;
                     else if (value <= 15) idx = 3;
                     else if (value <= 30) idx = 4;
                     else if (value <= 50) idx = 5;
                     else if (value <= 100) idx = 6;
                     else idx = 7;
                     idx = Math.min(idx, colors.length - 1);
                 }
                 return colors[Math.max(0, idx)]; // Asegurar índice válido
            }

            function createCustomIcon(color, size = 10) { // Tamaño configurable
              // Permite personalizar el tipo o la forma en como se va mostrar
              // el icono de los municipios
                return L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color: ${color}; width: ${size}px; height: ${size}px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.7); box-shadow: 0 0 3px rgba(0,0,0,0.4);"></div>`,
                    iconSize: [size, size],
                    iconAnchor: [size/2, size/2]
                });
            }

            function crearGraficoDoughnutSimple(canvasId, label, valor, total, color) {
              const ctx = document.getElementById(canvasId)?.getContext('2d');
              if (!ctx) return;

              if (window.chartInstances[canvasId]) { window.chartInstances[canvasId].destroy(); }

              valor = Number(valor) || 0;
              total = Number(total) || 1; // Mínimo 1 para evitar divisiones por cero
              const restante = Math.max(0, total - valor);

              const data = {
                datasets: [{
                    data: [valor, restante],
                    backgroundColor: [color, '#e9ecef'],
                    borderColor: ['#ffffff', '#ffffff'],
                    borderWidth: 1, // Borde más fino
                    cutout: '75%', // Más delgado
                }]
              };

              const options = {
                  responsive: true, maintainAspectRatio: false, rotation: -90, circumference: 180, // Semicírculo
                  plugins: { legend: { display: false }, tooltip: { enabled: false } },
                  animation: { animateScale: false, animateRotate: true } // Solo rotación
              };

              window.chartInstances[canvasId] = new Chart(ctx, {
                type: 'doughnut', data: data, options: options,
                plugins: [{ // Plugin para texto central
                  id: 'doughnutText',
                  afterDraw(chart, args, options) {
                    const {ctx, chartArea: {top, bottom, left, right, width, height}} = chart;
                    ctx.save();
                    const text = valor.toLocaleString(); // Formatear número
                    const textX = width / 2 + left;
                    const textY = top + (height * 0.75); // Ajustar posición vertical para semicírculo

                    ctx.font = 'bold 1.1rem Nunito, sans-serif';
                    ctx.fillStyle = color;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(text, textX, textY);

                    const labelText = label || ''; // Asegurar que labelText sea siempre un string
                    ctx.font = '0.7rem Nunito, sans-serif';
                    ctx.fillStyle = '#6c757d';
                    ctx.fillText(labelText, textX, textY + 16); // Debajo del número
                    ctx.restore();
                  }
                }]
              });
            }


            function mostrarInfoMunicipio(key) {
              // Convertir key a mayúsculas si no lo está ya
              const upperKey = key.toUpperCase();
              let info = datosEstadisticas[upperKey]; // Buscar siempre con mayúsculas

              if (!info) {
                // Si no hay datos, crear un objeto con datos por defecto
                info = {
                  nombre: upperKey,
                  region: 'No especificada',
                  totalEncuestas: 0,
                  totalRespuestas: 0,
                  encuestasRespondidas: 0,
                  encuestas: [],
                  respuestas: []
                };
              }

              // Asegurar valores por defecto en caso de datos nulos
              info.nombre = info.nombre || upperKey;
              info.region = info.region || 'No especificada';
              info.totalEncuestas = Number(info.totalEncuestas) || 0;
              info.totalRespuestas = Number(info.totalRespuestas) || 0;
              info.encuestasRespondidas = Number(info.encuestasRespondidas) || 0;
              info.encuestas = Array.isArray(info.encuestas) ? info.encuestas : [];
              info.respuestas = Array.isArray(info.respuestas) ? info.respuestas : [];

              // Actualizar la información en el panel
              document.getElementById('nombreMunicipio').textContent = info.nombre;
              document.getElementById('regionMunicipio').textContent = info.region;
              document.getElementById('totalEncuestasMunicipio').textContent = info.totalEncuestas;
              document.getElementById('totalRespuestasMunicipio').textContent = info.totalRespuestas;
              
              // Mostrar el panel
              document.getElementById('infoMunicipio').style.display = 'block';
              
              // Llenar tabla de encuestas
              const tablaEncuestas = document.getElementById('tablaEncuestas');
              if (info.encuestas && info.encuestas.length > 0) {
                let html = '';
                info.encuestas.forEach(enc => {
                  // Convertir valores a string antes de usarlos, con valores predeterminados
                  const encId = enc.id ? enc.id.toString() : '0';
                  const titulo = enc.titulo || 'Sin título';
                  const categoria = enc.categoria || 'Sin categoría';
                  const grupoInteres = enc.grupo_interes || 'Sin grupo';
                  const activa = !!enc.activa; // Convertir a booleano
                  const respuestas = Number(enc.respuestas) || 0;
                  
                  html += `<tr>
                    <td><a href="/encuestas/resultados/${encId}/" class="text-dark" title="${titulo}">${truncateText(titulo, 30)}</a></td>
                    <td>${categoria}</td>
                    <td>${grupoInteres}</td>
                    <td class="text-center"><span class="badge ${activa ? 'bg-success' : 'bg-warning'}">${activa ? 'Activa' : 'Inactiva'}</span></td>
                    <td class="text-end">${respuestas}</td>
                  </tr>`;
                });
                tablaEncuestas.innerHTML = html;
              } else {
                tablaEncuestas.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">No hay encuestas para esta ubicación</td></tr>';
              }
              
              // Llenar tabla de respuestas
              const tablaRespuestas = document.getElementById('tablaRespuestas');
              if (info.respuestas && info.respuestas.length > 0) {
                let html = '';
                info.respuestas.forEach(resp => {
                  // Convertir valores a string antes de usarlos, con valores predeterminados
                  const encuestaId = resp.encuesta_id ? resp.encuesta_id.toString() : '0';
                  const encuestaTitulo = resp.encuesta_titulo || 'Sin título';
                  const usuario = resp.usuario || '';
                  const fecha = resp.fecha || '';
                  
                  html += `<tr>
                    <td><a href="/encuestas/resultados/${encuestaId}/" class="text-dark" title="${encuestaTitulo}">${truncateText(encuestaTitulo, 30)}</a></td>
                    <td>${usuario || '<span class="text-muted fst-italic">Anónimo</span>'}</td>
                    <td>${formatearFecha(fecha)}</td>
                  </tr>`;
                });
                tablaRespuestas.innerHTML = html;
              } else {
                tablaRespuestas.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">No hay respuestas para esta ubicación</td></tr>';
              }
              
              // Registrar para depuración
              console.log('Datos de municipio:', info);
            }

            // Función auxiliar para truncar texto
            function truncateText(text, maxLength) {
              if (!text) return '';
              return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
            }

            // Función auxiliar para formatear fechas
            function formatearFecha(fechaStr) {
              if (!fechaStr) return '';
              try {
                const fecha = new Date(fechaStr);
                return fecha.toLocaleDateString('es-ES', { 
                  day: '2-digit', 
                  month: '2-digit',
                  year: 'numeric'
                });
              } catch (e) {
                return fechaStr;
              }
            }

            function cargarMunicipios() {
              if (loadingElement) loadingElement.style.display = 'block';
              if (progressElement) progressElement.textContent = '0%';
              if(infoMunicipioPanel) infoMunicipioPanel.style.display = 'none'; // Ocultar panel

              municipiosLayer.clearLayers(); // Limpiar marcadores de municipios
              if(map.hasLayer(oleoductoLayer)) map.removeLayer(oleoductoLayer); // Quitar oleoductos si están
              if(!map.hasLayer(municipiosLayer)) map.addLayer(municipiosLayer); // Añadir capa de municipios si no está

              fetch('/api/estadisticas-municipios/')
              .then(res => res.json())
              .then(estadisticas => {
                datosEstadisticas = estadisticas;
                
                let total = Object.keys(estadisticas).length;
                let count = 0;
                
                // Si no hay datos, mostrar mensaje informativo
                if (total === 0) {
                  if (loadingElement) loadingElement.style.display = 'none';
                  return;
                }
                
                for (const key in estadisticas) {
                    const municipio = estadisticas[key] || {};
                    
                    count++;
                    let porcentaje = Math.round((count / total) * 100);
                    progressElement.textContent = porcentaje + '%';
                    
                    // Valores por defecto para evitar undefined
                    const lat = municipio.latitud || 4.5709;
                    const lng = municipio.longitud || -74.2973;
                    const nombre = municipio.nombre || key;
                    const region = municipio.region || 'No especificada';
                    const totalRespuestas = Number(municipio.totalRespuestas) || 0;
                    const totalEncuestas = Number(municipio.totalEncuestas) || 0;
                    const tasaFinalizacion = Number(municipio.tasaFinalizacion) || 0;
                    
                    const marker = L.marker([lat, lng], {
                        icon: createCustomIcon(getColorForValue(totalEncuestas, 'totalEncuestas'), 12)
                    }).bindPopup(`
                        <div class="popup-content">
                            <h6>${nombre}</h6>
                            <p><strong>Región:</strong> ${region}</p><hr>
                            <p><span>${totalRespuestas.toLocaleString()}</span> <strong>Respuestas</strong></p>
                            <p><span>${totalEncuestas.toLocaleString()}</span> <strong>Enc. Asignadas</strong></p>
                            <p><span>${tasaFinalizacion.toFixed(1)}%</span> <strong>Tasa Finaliz.</strong></p>
                            <div class="mt-2 text-center">
                                <button class="btn btn-sm btn-outline-primary" onclick="mostrarInfoMunicipio('${key}')">
                                    <i class="fas fa-list-ul me-1"></i> Ver encuestas
                                </button>
                            </div>
                        </div>`);
                    
                    marker.on('click', () => mostrarInfoMunicipio(key));
                    municipiosLayer.addLayer(marker);
                }
                    
                loadingElement.style.display = 'none';
              })
              .catch(error => {
                  console.error('Error cargando datos de municipios:', error);
                  loadingElement.style.display = 'none';
              });
            }

            function cargarOleoductos() {
              if (loadingElement) loadingElement.style.display = 'block';
              if (progressElement) progressElement.textContent = '0%';
              if(infoMunicipioPanel) infoMunicipioPanel.style.display = 'none'; // Ocultar panel

              oleoductoLayer.clearLayers(); // Limpiar líneas y marcadores de oleoductos
              if(map.hasLayer(municipiosLayer)) map.removeLayer(municipiosLayer); // Quitar marcadores de municipios
              if(!map.hasLayer(oleoductoLayer)) map.addLayer(oleoductoLayer); // Añadir capa de oleoductos

                // 1. Cargar Estadísticas
              fetch('/api/estadisticas-municipios/')
              .then(res => res.ok ? res.json() : Promise.reject(`Estadisticas HTTP error! status: ${res.status}`))
              .then(estadisticas => {
                datosEstadisticas = estadisticas;
                progressElement.textContent = '30%';

                // 2. Cargar GeoJSON
                fetch("{% static 'kml/Trazado_oleoducto_Cenit.geojson' %}")
                .then(res => res.json())
                .then(geoJson => {
                  progressElement.textContent = '60%';

                  const geoJsonLayer = L.geoJSON(geoJson, { // Guardamos la capa GeoJSON aquí
                    style: feature => {
                      // Usar nombre en MAYUSCULAS como clave
                      const key = (feature.properties.nombre || feature.properties.name || '').toUpperCase();
                      const d = datosEstadisticas[key] || {};
                      const totalEncuestas = Number(d.totalEncuestas) || 0;
                      const color = getColorForValue(totalEncuestas, 'totalEncuestas');

                      if (feature.geometry.type.includes('LineString')) {
                            return { color: color, weight: 4, opacity: 0.7, dashArray: '8,4' };
                      }
                      // Estilo para polígonos (si aplica)
                      return { fillColor: color, color: 'white', weight:1, fillOpacity:0.7 };
                    },
                    onEachFeature: (feature, layer) => {
                      const p = feature.properties;
                      const key = (p.nombre || p.name || '').toUpperCase();
                      const d = datosEstadisticas[key] || {};
                      const nombre = p.nombre || p.name || 'Sin nombre';
                      const region = d.region || 'No especificada';
                      const totalRespuestas = Number(d.totalRespuestas) || 0;
                      const totalEncuestasOleoducto = Number(d.totalEncuestas) || 0; // Definir correctamente la variable

                      const popupHtml = `
                          <div class="popup-content">
                              <h6>${nombre}</h6>
                              <p><strong>Región:</strong> ${region}</p><hr>
                              <p><strong>Respuestas:</strong> ${totalRespuestas.toLocaleString()}</p>
                              <p><span>${totalEncuestasOleoducto.toLocaleString()}</span> <strong>Enc. Asignadas</strong></p>
                              <div class="mt-2 text-center">
                                  <button class="btn btn-sm btn-outline-primary" onclick="mostrarInfoMunicipio('${key}')">
                                      <i class="fas fa-list-ul me-1"></i> Ver encuestas
                                  </button>
                              </div>
                          </div>`;
                      layer.bindPopup(popupHtml);

                      layer.on({
                          mouseover: (e) => e.target.setStyle({ weight:5 }), // Resaltar
                          mouseout: (e) => geoJsonLayer.resetStyle(e.target), 
                          click: () => mostrarInfoMunicipio(key) // Mostrar info al hacer clic
                      });
                    }
                  });

                  oleoductoLayer.addLayer(geoJsonLayer); // Añadir la capa GeoJSON al grupo
                  
                  progressElement.textContent = '80%';
                  
                  const b = geoJsonLayer.getBounds();
                  if (b.isValid && b.isValid()) map.fitBounds(b);
                  else map.setView([4.5709, -74.2973], 6);
                  
                  setTimeout(() => {
                    progressElement.textContent = '100%';
                    loadingElement.style.display = 'none';
                  }, 500);
                })
                .catch(err => {
                    console.error('Error cargando GeoJSON:', err);
                    map.setView([4.5709, -74.2973], 6);
                    loadingElement.style.display = 'none';
                });
              })
              .catch(err => {
                  console.error('Error al cargar estadísticas para oleoductos:', err);
                  loadingElement.style.display = 'none';
              });
            }

            // Configuración de botones de control
            const btnMunicipios = document.getElementById('btnMostrarMunicipios');
            const btnOleoductos = document.getElementById('btnMostrarOleoductos');

            if(btnMunicipios && btnOleoductos) {
              btnMunicipios.addEventListener('click', function() {
                if (!this.classList.contains('active')) {
                    this.classList.add('active');
                    btnOleoductos.classList.remove('active');
                    cargarMunicipios();
                }
              });
              btnOleoductos.addEventListener('click', function() {
                if (!this.classList.contains('active')) {
                  this.classList.add('active');
                  btnMunicipios.classList.remove('active');
                  cargarOleoductos();
                }
              });
            }

            // CORRECCIÓN: Cargar oleoductos inmediatamente sin esperar a click
            // Marcar el botón como activo visualmente y ejecutar la carga directamente
            if (btnOleoductos) {
              btnOleoductos.classList.add('active');
              // Ejecutar con pequeño retraso para asegurar que el DOM esté listo
              setTimeout(cargarOleoductos, 100);
            }

        } // Fin if (mapaContainer)

  }); // Fin DOMContentLoaded
</script>

<script>
  // Redirigir al usuario a los resultados de la encuesta al hacer clic en la tarjeta
  document.addEventListener('DOMContentLoaded', function() {
    // Función para formatear los contadores de respuestas
    function formatearContador() {
      document.querySelectorAll('.response-counter').forEach(counter => {
        const value = parseInt(counter.textContent.trim());
        
        // Aplicar clases según el tamaño del número
        if (value > 999) {
          counter.classList.add('x-large');
          counter.classList.add('large');
          
          // Para números mayores a 999, mostrar en formato K (ej: 1.2K)
          if (value >= 10000) {
            counter.textContent = Math.floor(value / 1000) + 'K';
          } else {
            counter.textContent = (value / 1000).toFixed(1) + 'K';
          }
        } else if (value > 99) {
          counter.classList.add('large');
        }
      });
    }

    // Formatear contadores en carga inicial
    formatearContador();
    
    // Redirigir al hacer clic en tarjeta
    const cards = document.querySelectorAll('.hover-card');
    cards.forEach(card => {
      card.addEventListener('click', function(e) {
        // Solo redirigir si no se hizo clic en el botón
        if (!e.target.closest('.btn')) {
          const resultLink = this.querySelector('a[href*="resultados_encuesta"]');
          if (resultLink) {
            window.location.href = resultLink.getAttribute('href');
          }
        }
      });
    });

    // Variables para el estado de ordenamiento
    let ordenDescendente = true; // Por defecto, mayor a menor
    let activeFilters = { grupo: 'todas', categoria: 'todas', region: 'todas' }; // Objeto para filtros activos

    // Ordenar tarjetas por número de respuestas
    function ordenarTarjetasPorRespuestas(descendente = true) {
      const contenedor = document.getElementById('contenedorEncuestasActivas');
      if (!contenedor) return;
      
      const tarjetas = Array.from(contenedor.querySelectorAll('.encuesta-card:not(.d-none)'));
      
      // Ordenar por respuestas 
      tarjetas.sort((a, b) => {
        const respuestasA = parseInt(a.dataset.respuestas || 0);
        const respuestasB = parseInt(b.dataset.respuestas || 0);
        return descendente ? (respuestasB - respuestasA) : (respuestasA - respuestasB);
      });
      
      // Reordenar en el DOM
      tarjetas.forEach(tarjeta => contenedor.appendChild(tarjeta));
    }
    
    // Función para mostrar/ocultar las tarjetas según el filtro aplicado
    function aplicarFiltro() {
      const tarjetas = document.querySelectorAll('.encuesta-card');
      let hayVisibles = false;
      
      tarjetas.forEach(tarjeta => {
        const coincideGrupo = activeFilters.grupo === 'todas' || tarjeta.dataset.grupo === activeFilters.grupo;
        const coincideCategoria = activeFilters.categoria === 'todas' || tarjeta.dataset.categoria === activeFilters.categoria;
        const coincideRegion = activeFilters.region === 'todas' || tarjeta.dataset.region === activeFilters.region;

        if (coincideGrupo && coincideCategoria && coincideRegion) {
          tarjeta.classList.remove('d-none');
          hayVisibles = true;
        } else {
          tarjeta.classList.add('d-none');
        }
      });
      
      // Mostrar mensaje si no hay encuestas
      const sinEncuestasMsg = document.getElementById('sinEncuestasMsg');
      if (sinEncuestasMsg) {
        sinEncuestasMsg.style.display = hayVisibles ? 'none' : 'block';
      }
      
      return hayVisibles;
    }
    
    // Activar filtros de encuestas
    const filtroContainers = [
      { id: 'filtroEncuestasGrupo', btnId: 'btnFiltroGrupo', defaultText: '<i class="fas fa-users me-1"></i>Grupo de Interés' },
      { id: 'filtroEncuestasCategoria', btnId: 'btnFiltroCategoria', defaultText: '<i class="fas fa-tag me-1"></i>Categoría' },
      { id: 'filtroEncuestasRegion', btnId: 'btnFiltroRegion', defaultText: '<i class="fas fa-map-marked-alt me-1"></i>Región' }
    ];

    filtroContainers.forEach(containerConfig => {
      const filtroItems = document.querySelectorAll(`#${containerConfig.id} .dropdown-item`);
      const dropdownButton = document.getElementById(containerConfig.btnId);

      filtroItems.forEach(item => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          
          // Marcar como activo este elemento y desmarcar otros en el mismo menú
          const parentMenu = this.closest('.dropdown-menu');
          parentMenu.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('active'));
          this.classList.add('active');
          
          const filtroTipo = this.dataset.filter;
          const filtroId = this.dataset.id;
          activeFilters[filtroTipo] = filtroId; // Actualizar el filtro activo para este tipo
          
          // Aplicar todos los filtros activos
          aplicarFiltro();
          
          // Reordenar después de filtrar
          ordenarTarjetasPorRespuestas(ordenDescendente);
          
          // Actualizar texto del botón de filtro
          if (dropdownButton) {
            if (filtroId === 'todas') {
              dropdownButton.innerHTML = containerConfig.defaultText;
            } else {
              const textoFiltro = this.textContent.trim();
              // Usar un ícono genérico de filtro si no es el default, o el específico del botón
              const iconHtml = containerConfig.defaultText.match(/<i class=".*?"><\/i>/)[0]; 
              dropdownButton.innerHTML = `${iconHtml}${textoFiltro}`;
            }
          }
        });
      });
    });
    
    // Configurar botón de ordenar
    const btnOrdenar = document.getElementById('btnOrdenarRespuestas');
    if (btnOrdenar) {
      btnOrdenar.addEventListener('click', function() {
        // Cambiar el estado de ordenamiento
        ordenDescendente = !ordenDescendente;
        
        // Actualizar el ícono según el ordenamiento
        const icon = ordenDescendente ? 'fa-sort-amount-down' : 'fa-sort-amount-up';
        this.innerHTML = `<i class="fas ${icon} me-1"></i>Por respuestas`;
        
        // Aplicar el ordenamiento
        ordenarTarjetasPorRespuestas(ordenDescendente);
      });
    }
    
    // Iniciar con ordenamiento por respuestas (de mayor a menor)
    ordenarTarjetasPorRespuestas(true);
    
    // Añadir observador para detectar cambios en el mapa
    const observerConfig = { childList: true, subtree: true };
    const observer = new MutationObserver((mutationsList) => {
      for (const mutation of mutationsList) {
        if (mutation.type === 'childList') {
          if (mutation.target.id === 'infoMunicipio' && mutation.target.style.display !== 'none') {
            console.log('Panel de información de municipio mostrado');
          }
        }
      }
    });
    
    // Observar cambios en el panel de información
    const targetNode = document.body;
    if (targetNode) {
      observer.observe(targetNode, { childList: true, subtree: true });
    }
  });
</script>

{% endblock %}
