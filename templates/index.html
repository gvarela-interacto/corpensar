{% extends 'base.html' %} 
{% load humanize %} 
{% load static %} 
{% block content %}

<style>
  /* Estilos para las alertas clickeables */
  .alert-clickable {
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 0; /* Elimina el margen inferior para que quede pegado al contenedor */
    position: relative;
    overflow: hidden;
  }

  .alert-clickable:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
  }

  .alert-clickable:active {
    transform: translateY(1px);
  }

  /* Efecto "pulsado" al hacer clic */
  .alert-clickable.active {
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  /* Contenedor de la lista de tiquetera */
  .product-list-container {
    margin-top: -5px; /* Solapa ligeramente con la alerta */
    padding: 15px;
    border-radius: 0 0 5px 5px;
    background-color: #f8f9fa;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-top: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    animation: fadeIn 0.3s ease-out;
  }

  /* Estilos para la lista de tiquetera */
  .product-list-container .list-group {
    margin-bottom: 0;
  }

  .product-list-container .list-group-item {
    border-left: none;
    border-right: none;
    padding: 8px 15px;
    font-size: 0.9rem;
  }

  .product-list-container .list-group-item:first-child {
    border-top: none;
  }

  /* Animación de carga */
  @keyframes fadeIn {
    from {
      opacity: 0;
      max-height: 0;
    }
    to {
      opacity: 1;
      max-height: 500px;
    }
  }

  /* Estilo para el mensaje de carga */
  .text-center {
    text-align: center;
    padding: 10px;
    color: #6c757d;
  }

  .text-center .bi-hourglass {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  /* Nuevos estilos para las tarjetas de KPI */
  .kpi-card {
    border-radius: 10px;
    transition: transform 0.2s;
  }
  .kpi-card:hover {
    transform: translateY(-5px);
  }
  .chart-container {
    position: relative;
    height: 300px;
    margin-bottom: 1rem;
  }

  /* Estilos para el grid personalizable */
  .bento-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    grid-gap: 15px;
    margin-bottom: 20px;
  }

  .grid-item {
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    cursor: move;
    overflow: hidden;
  }

  .grid-item.dragging {
    opacity: 0.8;
    transform: scale(1.02);
    z-index: 10;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }

  .grid-item .card {
    height: 100%;
    border: none;
    border-radius: 10px;
    overflow: hidden;
  }

  .grid-item .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
  }

  .grid-item .handle {
    display: flex;
    align-items: center;
    cursor: move;
  }

  .grid-item .handle .mdi-drag {
    margin-right: 0.5rem;
    color: #888;
    font-size: 1.2rem;
  }

  .grid-item .handle:hover .mdi-drag {
    color: #333;
  }

  /* Botones de cambio de tamaño */
  .resize-item {
    padding: 0.15rem 0.4rem;
    font-size: 0.75rem;
  }

  .resize-item.active {
    background-color: #6c757d;
    color: white;
    border-color: #6c757d;
  }

  /* Transición suave para cambios de tamaño */
  .grid-item {
    transition: grid-column 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
  }

  /* Tamaños predefinidos para los elementos del grid */
  .grid-item.col-span-4 {
    grid-column: span 4;
  }

  .grid-item.col-span-6 {
    grid-column: span 6;
  }

  .grid-item.col-span-12 {
    grid-column: span 12;
  }

  /* Botón guardar distribución */
  #saveLayout {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    transition: all 0.2s ease;
  }

  #saveLayout:hover {
    background-color: #e9ecef;
    transform: translateY(-2px);
  }

  #saveLayout:active {
    transform: translateY(0);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .bento-grid {
      grid-template-columns: repeat(6, 1fr);
    }

    .grid-item.col-span-4,
    .grid-item.col-span-6 {
      grid-column: span 6;
    }
  }

  @media (max-width: 576px) {
    .bento-grid {
      grid-template-columns: repeat(1, 1fr);
    }

    .grid-item.col-span-4,
    .grid-item.col-span-6,
    .grid-item.col-span-12 {
      grid-column: span 1;
    }
  }

  .legend {
    line-height: 18px;
    color: #555;
  }
  .legend i {
    width: 18px;
    height: 18px;
    float: left;
    margin-right: 8px;
    opacity: 0.7;
  }
  .popup-content {
    min-width: 200px;
  }
  .popup-content h6 {
    color: #333;
    margin-bottom: 5px;
  }
  .popup-content p {
    margin: 0;
    color: #666;
  }
  .popup-content hr {
    margin: 5px 0;
    border-color: #eee;
  }

  /* Estilos mejorados para el mapa */
  #mapaColombia {
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .custom-div-icon {
    transition: transform 0.2s ease;
  }

  .custom-div-icon:hover {
    transform: scale(1.2);
    z-index: 1000;
  }

  .popup-content {
    min-width: 250px;
    padding: 10px;
  }

  .popup-content h6 {
    color: #2c3e50;
    font-size: 1.1rem;
    margin-bottom: 10px;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 5px;
  }

  .popup-content p {
    margin: 5px 0;
    color: #495057;
    font-size: 0.95rem;
    display: flex;
    justify-content: space-between;
  }

  .popup-content hr {
    margin: 8px 0;
    border-color: #f8f9fa;
  }

  .leaflet-popup-content-wrapper {
    border-radius: 8px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
  }

  .leaflet-popup-tip {
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
  }

  /* Estilos para los botones de control del mapa */
  .btn-group .btn {
    padding: 8px 16px;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .btn-group .btn:hover {
    transform: translateY(-1px);
  }

  .btn-group .btn.active {
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  /* Panel de información del municipio */
  #infoMunicipio {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    margin-top: 20px;
  }

  #infoMunicipio h5 {
    color: #2c3e50;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 10px;
    margin-bottom: 15px;
  }

  #infoMunicipio .row p {
    margin: 8px 0;
    color: #495057;
  }

  #infoMunicipio .row p strong {
    color: #2c3e50;
    margin-right: 8px;
  }

  /* Mejoras para las tarjetas de estadísticas */
  .counter-card {
    border-radius: 12px;
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: 1px solid rgba(0, 0, 0, 0.08);
    background-color: white;
    color: #333;
  }
  
  .counter-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
  }
  
  .counter-card .card-header {
    background-color: rgba(255, 215, 0, 0.05);
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    font-weight: 600;
  }
  
  .counter-card .counter {
    font-size: 2rem;
    font-weight: 700;
    color: #1a1a1a;
  }
  
  .counter-card .counter-label {
    color: #6c757d;
    font-size: 0.9rem;
  }
  
  .counter-card.blue-card {
    border-top: 4px solid var(--primary-color);
  }
  
  .counter-card.green-card {
    border-top: 4px solid var(--success-color);
  }
  
  .counter-card.yellow-card {
    border-top: 4px solid var(--warning-color);
  }
  
  .counter-card.red-card {
    border-top: 4px solid var(--danger-color);
  }
  
  /* Mejoras para los gráficos */
  .chart-container {
    background-color: white;
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.08);
  }
  
  .chart-title {
    font-size: 1rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 1rem;
  }
  
  /* Mejoras para las tarjetas con información geográfica */
  .geo-card {
    border-radius: 12px;
    background-color: white;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.08);
    height: 100%;
  }
  
  .geo-card .card-header {
    background-color: rgba(255, 215, 0, 0.05);
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    font-weight: 600;
    color: #333;
  }
  
  /* Mejoras para badges y etiquetas */
  .stats-label {
    display: inline-block;
    padding: 0.35rem 0.65rem;
    font-size: 0.75rem;
    font-weight: 600;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 6px;
    background-color: rgba(255, 215, 0, 0.1);
    color: #1a1a1a;
  }
  
  /* Mejoras para tarjetas con información de encuestas */
  .survey-card {
    border-radius: 12px;
    background-color: white;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.08);
    height: 100%;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .survey-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
  }
  
  .survey-card .card-header {
    background-color: rgba(255, 215, 0, 0.05);
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    font-weight: 600;
    color: #333;
  }
  
  .survey-title {
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 0.5rem;
  }
  
  .survey-meta {
    color: #6c757d;
    font-size: 0.85rem;
  }
</style>

<div class="container-fluid py-4">
  <!-- KPIs Principales -->
  <div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card kpi-card h-100 border-0 shadow-sm">
        <div
          class="position-absolute w-100"
          style="height: 6px; background-color: #0d6efd; top: 0; left: 0"
        ></div>
        <div class="card-body">
          <h5 class="card-title text-muted">Total Encuestas</h5>
          <h2 class="display-4">{{ total_encuestas }}</h2>
          <p class="text-success mb-0">
            <i class="mdi mdi-arrow-up"></i>
            {{ encuestas_activas }} activas
          </p>
        </div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card kpi-card h-100 border-0 shadow-sm">
        <div
          class="position-absolute w-100"
          style="height: 6px; background-color: #198754; top: 0; left: 0"
        ></div>
        <div class="card-body">
          <h5 class="card-title text-muted">Total Respuestas</h5>
          <h2 class="display-4">{{ total_respuestas|intcomma }}</h2>
          <p class="text-success mb-0">
            <i class="mdi mdi-chart-line"></i>
            {{ avg_respuestas }} promedio
          </p>
        </div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card kpi-card h-100 border-0 shadow-sm">
        <div
          class="position-absolute w-100"
          style="height: 6px; background-color: #ffc107; top: 0; left: 0"
        ></div>
        <div class="card-body">
          <h5 class="card-title text-muted">Tasa de Finalización</h5>
          <h2 class="display-4">{{ tasa_finalizacion }}%</h2>
          <p class="text-warning mb-0">
            <i class="mdi mdi-flag-checkered"></i>
            promedio general
          </p>
        </div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card kpi-card h-100 border-0 shadow-sm">
        <div
          class="position-absolute w-100"
          style="height: 6px; background-color: #dc3545; top: 0; left: 0"
        ></div>
        <div class="card-body">
          <h5 class="card-title text-muted">Encuestas Sin Respuestas</h5>
          <h2 class="display-4">{{ encuestas_sin_respuestas }}</h2>
          <p class="text-danger mb-0">
            <i class="mdi mdi-alert"></i>
            necesitan atención
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Alertas -->
  <div class="row mb-4">
    <div class="col-md-6 mb-3">
      <div class="alert alert-warning alert-clickable">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <strong>{{ encuestas_proximo_fin.count }}</strong> encuestas por
        finalizar en 3 días
      </div>

      <div
        id="reorden-products"
        class="product-list-container"
        style="display: none"
      >
        <ul class="list-group">
          {% for encuesta in encuestas_proximo_fin %}
          <li
            class="list-group-item d-flex justify-content-between align-items-center"
          >
            <span class="text-truncate">{{ encuesta.titulo }}</span>
            <span class="badge bg-warning"
              >{{ encuesta.fecha_fin|date:"d M" }}</span
            >
          </li>
          {% empty %}
          <li class="list-group-item text-muted">
            No hay encuestas próximas a finalizar
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <!-- Grid Personalizable de Gráficos -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm mb-3">
        <div
          class="card-header d-flex justify-content-between align-items-center bg-primary text-white"
        >
          <h5 class="mb-0">Panel Personalizable</h5>
          <button id="saveLayout" class="btn btn-sm btn-light">
            <i class="mdi mdi-content-save"></i> Guardar Distribución
          </button>
        </div>
        <div class="card-body p-3">
          <div class="bento-grid" id="sortableGrid">
            <!-- Gráfico de Tipos de Preguntas -->
            <div class="grid-item col-span-4" data-id="tipoPreguntasChart">
              <div class="card h-100 shadow-sm">
                <div class="card-header">
                  <h5 class="mb-0">Tipos de Preguntas</h5>
                  <div class="handle">
                    <i class="mdi mdi-drag"></i>
                    <div class="btn-group btn-group-sm ms-2">
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="4"
                      >
                        S
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="6"
                      >
                        M
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="12"
                      >
                        L
                      </button>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="tipoPreguntasChart"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <!-- Gráfico de Tendencia de Respuestas -->
            <div
              class="grid-item col-span-4"
              data-id="tendenciaRespuestasChart"
            >
              <div class="card h-100 shadow-sm">
                <div class="card-header">
                  <h5 class="mb-0">Tendencia de Respuestas</h5>
                  <div class="handle">
                    <i class="mdi mdi-drag"></i>
                    <div class="btn-group btn-group-sm ms-2">
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="4"
                      >
                        S
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="6"
                      >
                        M
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="12"
                      >
                        L
                      </button>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="tendenciaRespuestasChart"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <!-- Gráfico de Distribución por Categoría -->
            <div
              class="grid-item col-span-4"
              data-id="distribucionCategoriaChart"
            >
              <div class="card h-100 shadow-sm">
                <div class="card-header">
                  <h5 class="mb-0">Distribución por Categoría</h5>
                  <div class="handle">
                    <i class="mdi mdi-drag"></i>
                    <div class="btn-group btn-group-sm ms-2">
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="4"
                      >
                        S
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="6"
                      >
                        M
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="12"
                      >
                        L
                      </button>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="distribucionCategoriaChart"></canvas>
                  </div>
                  {% if not distribucion_categoria %}
                  <div class="text-center text-muted py-3">
                    <p>No hay datos de categorías disponibles</p>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Gráfico de Distribución por Región -->
            <div class="grid-item col-span-4" data-id="distribucionRegionChart">
              <div class="card h-100 shadow-sm">
                <div class="card-header">
                  <h5 class="mb-0">Distribución por Región</h5>
                  <div class="handle">
                    <i class="mdi mdi-drag"></i>
                    <div class="btn-group btn-group-sm ms-2">
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="4"
                      >
                        S
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="6"
                      >
                        M
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="12"
                      >
                        L
                      </button>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="distribucionRegionChart"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <!-- Top Municipios -->
            <div class="grid-item col-span-6" data-id="topMunicipios">
              <div class="card h-100 shadow-sm">
                <div class="card-header">
                  <h5 class="mb-0">Top Municipios</h5>
                  <div class="handle">
                    <i class="mdi mdi-drag"></i>
                    <div class="btn-group btn-group-sm ms-2">
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="4"
                      >
                        S
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="6"
                      >
                        M
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="12"
                      >
                        L
                      </button>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-hover">
                      <thead>
                        <tr>
                          <th>Municipio</th>
                          <th class="text-end">Total Encuestas</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for municipio in top_municipios %}
                        <tr>
                          <td>
                            {{ municipio.municipio__nombre|default:"Sin municipio" }}
                          </td>
                          <td class="text-end">{{ municipio.total }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                          <td colspan="2" class="text-center">
                            No hay datos disponibles
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- Mapa de Colombia Interactivo -->
            <div
              class="grid-item col-span-12"
              data-id="mapaColombiaInteractivo"
            >
              <div class="card h-100 shadow-sm">
                <div class="card-header">
                  <h5 class="mb-0">
                    Mapa de Colombia - Estadísticas por Municipio
                  </h5>
                  <div class="handle">
                    <i class="mdi mdi-drag"></i>
                    <div class="btn-group btn-group-sm ms-2">
                      <button
                        type="button"
                        class="btn btn-outline-primary"
                        id="btnTotalEncuestas"
                      >
                        Total Encuestas
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-success"
                        id="btnTotalRespuestas"
                      >
                        Total Respuestas
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-warning"
                        id="btnTasaFinalizacion"
                      >
                        Tasa de Finalización
                      </button>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div
                    id="mapaColombia"
                    style="height: 500px; width: 100%"
                  ></div>
                  <div
                    id="infoMunicipio"
                    class="mt-3 p-3 border rounded"
                    style="display: none"
                  >
                    <h5 id="nombreMunicipio" class="mb-2"></h5>
                    <div class="row">
                      <div class="col-md-4">
                        <p>
                          <strong>Total Encuestas:</strong>
                          <span id="totalEncuestasMunicipio">0</span>
                        </p>
                      </div>
                      <div class="col-md-4">
                        <p>
                          <strong>Total Respuestas:</strong>
                          <span id="totalRespuestasMunicipio">0</span>
                        </p>
                      </div>
                      <div class="col-md-4">
                        <p>
                          <strong>Tasa de Finalización:</strong>
                          <span id="tasaFinalizacionMunicipio">0%</span>
                        </p>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-4">
                        <div class="chart-container" style="height: 200px">
                          <canvas id="estadisticasEncuestasMunicipio"></canvas>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="chart-container" style="height: 200px">
                          <canvas id="estadisticasRespuestasMunicipio"></canvas>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="chart-container" style="height: 200px">
                          <canvas
                            id="estadisticasFinalizacionMunicipio"
                          ></canvas>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Últimas Respuestas -->
            <div class="grid-item col-span-6" data-id="ultimasRespuestas">
              <div class="card h-100 shadow-sm">
                <div class="card-header">
                  <h5 class="mb-0">Últimas Respuestas</h5>
                  <div class="handle">
                    <i class="mdi mdi-drag"></i>
                    <div class="btn-group btn-group-sm ms-2">
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="4"
                      >
                        S
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="6"
                      >
                        M
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="12"
                      >
                        L
                      </button>
                    </div>
                  </div>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-hover mb-0">
                      <thead>
                        <tr>
                          <th>Encuesta</th>
                          <th>Usuario</th>
                          <th>Fecha</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for respuesta in ultimas_respuestas %}
                        <tr>
                          <td>
                            <a href="#" class="text-dark">
                              {{ respuesta.encuesta.titulo|truncatechars:30 }}
                            </a>
                          </td>
                          <td>
                            {% if respuesta.usuario %} 
                            {{ respuesta.usuario.username|truncatechars:15 }} 
                            {% else %}
                            <span class="text-muted">Anónimo</span>
                            {% endif %}
                          </td>
                          <td>
                            {{ respuesta.fecha_respuesta|date:"d M H:i" }}
                          </td>
                        </tr>
                        {% empty %}
                        <tr>
                          <td colspan="3" class="text-center py-4 text-muted">
                            No hay respuestas recientes
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sección PQRSFD -->
  <div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Estado de PQRSFD</h5>
                <a href="{% url 'listar_pqrsfd' %}" class="btn btn-sm btn-primary">Ver todos</a>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card border-0 bg-light h-100">
                            <div class="card-body text-center">
                                <div class="display-4 text-warning">{{ conteo_estados.P }}</div>
                                <h6 class="text-muted">Pendientes</h6>
                                <a href="{% url 'listar_pqrsfd' %}?estado=P" class="btn btn-sm btn-outline-warning mt-2">Ver pendientes</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 bg-light h-100">
                            <div class="card-body text-center">
                                <div class="display-4 text-info">{{ conteo_estados.E }}</div>
                                <h6 class="text-muted">En Proceso</h6>
                                <a href="{% url 'listar_pqrsfd' %}?estado=E" class="btn btn-sm btn-outline-info mt-2">Ver en proceso</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 bg-light h-100">
                            <div class="card-body text-center">
                                <div class="display-4 text-success">{{ conteo_estados.R }}</div>
                                <h6 class="text-muted">Resueltos</h6>
                                <a href="{% url 'listar_pqrsfd' %}?estado=R" class="btn btn-sm btn-outline-success mt-2">Ver resueltos</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 {% if conteo_estados.vencidos > 0 %}bg-danger text-white{% else %}bg-light{% endif %} h-100">
                            <div class="card-body text-center">
                                <div class="display-4">{{ conteo_estados.vencidos }}</div>
                                <h6 class="{% if conteo_estados.vencidos > 0 %}text-white{% else %}text-muted{% endif %}">Vencidos</h6>
                                <a href="{% url 'listar_pqrsfd' %}?estado=vencidos" class="btn btn-sm {% if conteo_estados.vencidos > 0 %}btn-outline-light{% else %}btn-outline-danger{% endif %} mt-2">Ver vencidos</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
      // Inicializar grid personalizable
      const sortableGrid = document.getElementById('sortableGrid');
      if (sortableGrid) {
          // Cargar configuración guardada si existe
          loadGridLayout();

          // Inicializar SortableJS
          const sortable = new Sortable(sortableGrid, {
              animation: 150,
              handle: '.handle',
              draggable: '.grid-item',
              onStart: function(evt) {
                  evt.item.classList.add('dragging');
              },
              onEnd: function(evt) {
                  evt.item.classList.remove('dragging');

                  // Actualizar charts después de mover para asegurar que se rendericen correctamente
                  window.setTimeout(function() {
                      updateCharts();
                  }, 100);
              }
          });

          // Configurar botón para guardar layout
          const saveButton = document.getElementById('saveLayout');
          if (saveButton) {
              saveButton.addEventListener('click', function() {
                  saveGridLayout();
                  alert('Distribución guardada correctamente');
              });
          }

          // Configurar botones para cambiar tamaño
          const resizeButtons = document.querySelectorAll('.resize-item');
          resizeButtons.forEach(button => {
              button.addEventListener('click', function(e) {
                  e.preventDefault();
                  e.stopPropagation();

                  const size = this.getAttribute('data-size');
                  const gridItem = this.closest('.grid-item');

                  // Remover todas las clases de tamaño
                  gridItem.classList.remove('col-span-4', 'col-span-6', 'col-span-12');

                  // Añadir la clase de tamaño seleccionada
                  gridItem.classList.add(`col-span-${size}`);

                  // Actualizar los botones para mostrar cuál está activo
                  const buttons = gridItem.querySelectorAll('.resize-item');
                  buttons.forEach(btn => {
                      btn.classList.remove('active');
                      if (btn.getAttribute('data-size') === size) {
                          btn.classList.add('active');
                      }
                  });

                  // Actualizar charts después de cambiar el tamaño
                  window.setTimeout(function() {
                      updateCharts();
                  }, 100);
              });
          });

          // Establecer los botones activos según el tamaño actual de cada elemento
          const gridItems = document.querySelectorAll('.grid-item');
          gridItems.forEach(item => {
              let currentSize = '4'; // tamaño por defecto

              if (item.classList.contains('col-span-12')) {
                  currentSize = '12';
              } else if (item.classList.contains('col-span-6')) {
                  currentSize = '6';
              }

              // Marcar el botón correspondiente como activo
              const button = item.querySelector(`.resize-item[data-size="${currentSize}"]`);
              if (button) {
                  button.classList.add('active');
              }
          });
      }

      function loadGridLayout() {
          try {
              const savedLayout = localStorage.getItem('dashboardLayout');
              if (savedLayout) {
                  const layout = JSON.parse(savedLayout);

                  // Aplicar orden
                  if (layout.order && layout.order.length > 0) {
                      for (let i = 0; i < layout.order.length; i++) {
                          const itemId = layout.order[i];
                          const item = document.querySelector(`.grid-item[data-id="${itemId}"]`);
                          if (item) {
                              sortableGrid.appendChild(item);
                          }
                      }
                  }

                  // Aplicar tamaños
                  if (layout.sizes) {
                      for (const itemId in layout.sizes) {
                          const item = document.querySelector(`.grid-item[data-id="${itemId}"]`);
                          if (item) {
                              // Remover clases de tamaño existentes
                              item.classList.remove('col-span-4', 'col-span-6', 'col-span-12');
                              // Añadir nueva clase de tamaño
                              item.classList.add(`col-span-${layout.sizes[itemId]}`);
                          }
                      }
                  }
              }
          } catch (error) {
              console.error('Error al cargar la configuración del dashboard:', error);
          }
      }

      function saveGridLayout() {
          try {
              // Guardar orden actual
              const items = sortableGrid.querySelectorAll('.grid-item');
              const order = [];
              const sizes = {};

              items.forEach(item => {
                  const itemId = item.getAttribute('data-id');
                  order.push(itemId);

                  // Determinar tamaño
                  let size = 4; // Tamaño predeterminado
                  if (item.classList.contains('col-span-12')) {
                      size = 12;
                  } else if (item.classList.contains('col-span-6')) {
                      size = 6;
                  }

                  sizes[itemId] = size;
              });

              const layout = {
                  order: order,
                  sizes: sizes
              };

              localStorage.setItem('dashboardLayout', JSON.stringify(layout));
          } catch (error) {
              console.error('Error al guardar la configuración del dashboard:', error);
          }
      }

      function updateCharts() {
          // Reconstruir gráficos si es necesario
          if (window.categoriaChartObj) {
              window.categoriaChartObj.resize();
          }
          if (window.regionChartObj) {
              window.regionChartObj.resize();
          }
      }

      // Gráfico de Tipos de Preguntas
      const tipoPreguntasData = {
        labels: [
          {% for tipo in tipos_preguntas %}
            "{{ tipo.tipo }}"{% if not forloop.last %},{% endif %}
          {% endfor %}
        ],
        datasets: [{
          data: [
            {% for tipo in tipos_preguntas %}
              {{ tipo.total }}{% if not forloop.last %},{% endif %}
            {% endfor %}
          ],
          backgroundColor: [
            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e',
            '#e74a3b', '#858796', '#5a5c69', '#6f42c1', '#20c997'
          ],
          hoverOffset: 10
        }]
      };

      new Chart(document.getElementById('tipoPreguntasChart').getContext('2d'), {
        type: 'doughnut',
        data: tipoPreguntasData,
        options: {
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { boxWidth: 15, padding: 20 }
            }
          }
        }
      });

      // Gráfico de Tendencia de Respuestas
      const tendenciaData = {
        labels: [
          {% for item in tendencia_respuestas %}
            "{{ item.fecha|date:'d M' }}"{% if not forloop.last %},{% endif %}
          {% endfor %}
        ],
        datasets: [{
          label: 'Respuestas',
          data: [
            {% for item in tendencia_respuestas %}
              {{ item.total }}{% if not forloop.last %},{% endif %}
            {% endfor %}
          ],
          borderColor: '#4e73df',
          backgroundColor: 'rgba(78, 115, 223, 0.1)',
          fill: true,
          tension: 0.4
        }]
      };

      new Chart(document.getElementById('tendenciaRespuestasChart').getContext('2d'), {
        type: 'line',
        data: tendenciaData,
        options: {
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                drawBorder: false
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });

      // Gráfico de Distribución por Categoría
      const categoriaData = {
        labels: [
          {% for item in distribucion_categoria %}
            "{{ item.categoria__nombre|default:'Sin categoría' }}"{% if not forloop.last %},{% endif %}
          {% endfor %}
        ],
        datasets: [{
          label: 'Encuestas por Categoría',
          data: [
            {% for item in distribucion_categoria %}
              {{ item.total }}{% if not forloop.last %},{% endif %}
            {% endfor %}
          ],
          backgroundColor: [
            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e',
            '#e74a3b', '#858796', '#5a5c69', '#6f42c1', '#20c997',
            '#6610f2', '#fd7e14', '#dc3545', '#6c757d', '#28a745'
          ],
          borderColor: 'rgba(255, 255, 255, 0.8)',
          borderWidth: 1
        }]
      };

      // Inicializar gráfico de categorías como circular (pie)
      window.categoriaChartObj = new Chart(document.getElementById('distribucionCategoriaChart').getContext('2d'), {
        type: 'pie',
        data: categoriaData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                boxWidth: 15,
                padding: 20
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  if (label.includes('Tasa Finalización')) {
                    return `${label}: ${value}%`;
                  }
                  return `${label}: ${value}`;
                }
              }
            }
          }
        }
      });

      // Gráfico de Distribución por Región
      const regionData = {
        labels: [
          {% for region in distribucion_region %}
            "{{ region.region__nombre|default:'Sin región' }}"{% if not forloop.last %},{% endif %}
          {% endfor %}
        ],
        datasets: [{
          label: 'Encuestas por Región',
          data: [
            {% for region in distribucion_region %}
              {{ region.total }}{% if not forloop.last %},{% endif %}
            {% endfor %}
          ],
          backgroundColor: [
            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e',
            '#e74a3b', '#858796', '#5a5c69', '#6f42c1', '#20c997',
            '#6610f2', '#fd7e14', '#dc3545', '#6c757d', '#28a745'
          ],
          borderColor: 'rgba(255, 255, 255, 0.8)',
          borderWidth: 1
        }]
      };

      window.regionChartObj = new Chart(document.getElementById('distribucionRegionChart').getContext('2d'), {
        type: 'pie',
        data: regionData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                boxWidth: 15,
                padding: 20
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  if (label.includes('Tasa Finalización')) {
                    return `${label}: ${value}%`;
                  }
                  return `${label}: ${value}`;
                }
              }
            }
          }
        }
      });

      // Funcionalidad para mostrar/ocultar las listas de alertas
      document.querySelectorAll('.alert-clickable').forEach(alert => {
        alert.addEventListener('click', function() {
          const targetId = this.dataset.target;
          const targetElement = document.getElementById(targetId);
          if (targetElement) {
            targetElement.style.display = targetElement.style.display === 'none' ? 'block' : 'none';
          }
        });
      });
  });
</script>

<!-- CSS de Leaflet para mapas -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>

<!-- Asegúrate de haber cargado antes Leaflet y Omnivore -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const mapaContainer = document.getElementById('mapaColombia');
  if (!mapaContainer) return;

  const map = L.map('mapaColombia').setView([4.5709, -74.2973], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let datosEstadisticas = {};
  let tipoEstadisticaActual = 'totalEncuestas';
  let markerLayer = L.layerGroup().addTo(map);

  function getColorForValue(value, tipo) {
    const scales = {
      totalEncuestas: ['#f7fbff','#deebf7','#c6dbef','#9ecae1','#6baed6','#4292c6','#2171b5','#08519c'],
      totalRespuestas: ['#f7fcf5','#e5f5e0','#c7e9c0','#a1d99b','#74c476','#41ab5d','#238b45','#005a32'],
      tasaFinalizacion: ['#fff5eb','#fee6ce','#fdd0a2','#fdae6b','#fd8d3c','#f16913','#d94801','#8c2d04']
    };
    const colors = scales[tipo] || scales.totalEncuestas;
    let idx = tipo === 'tasaFinalizacion'
      ? Math.min(Math.floor(value/12.5), colors.length-1)
      : Math.min(Math.floor(Math.log2(value+1)), colors.length-1);
    return colors[idx];
  }

  function createCustomIcon(color) {
    return L.divIcon({
      className: 'custom-div-icon',
      html: `<div style="background-color: ${color}; width: 10px; height: 10px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.5);"></div>`,
      iconSize: [10, 10],
      iconAnchor: [5, 5]
    });
  }

  // Función para mostrar información del municipio dentro del mapa
  function mostrarInfoMunicipio(key) {
    const info = datosEstadisticas[key];
    console.log(info);
    if (!info) return;

    document.getElementById('nombreMunicipio').textContent = info.nombre;
    document.getElementById('totalEncuestasMunicipio').textContent = info.totalEncuestas;
    document.getElementById('totalRespuestasMunicipio').textContent = info.totalRespuestas;
    document.getElementById('tasaFinalizacionMunicipio').textContent = info.tasaFinalizacion + '%';
    document.getElementById('infoMunicipio').style.display = 'block';
    
    // Crear gráficos básicos inmediatamente
    crearGraficoEncuestas(info);
    crearGraficoFinalizacion(info);
    
    // Para el gráfico de respuestas históricas, hacer una petición específica
    // Identificamos el municipio mediante su nombre
    const municipioNombre = encodeURIComponent(info.nombre);
    
    // Mostrar indicador de carga
    const ctx = document.getElementById('estadisticasRespuestasMunicipio').getContext('2d');
    if (chartRespuestas) {
      chartRespuestas.destroy();
    }
    ctx.canvas.style.opacity = '0.5';
    ctx.font = '14px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('Cargando datos...', ctx.canvas.width / 2, ctx.canvas.height / 2);
    
    fetch(`/api/municipio/${municipioNombre}/respuestas-historicas/`)
      .then(res => {
        if (!res.ok) {
          throw new Error('Error en la respuesta del servidor');
        }
        return res.json();
      })
      .then(datos => {
        ctx.canvas.style.opacity = '1';
        crearGraficoRespuestas(datos);
      })
      .catch(error => {
        console.error("Error al cargar datos históricos:", error);
        ctx.canvas.style.opacity = '1';
        // En caso de error, generar datos históricos localmente
        generarYMostrarDatosSimulados(info);
      });
  }
  
  // Función para generar datos simulados cuando hay error del servidor
  function generarYMostrarDatosSimulados(info) {
    // Generar meses recientes (6 meses)
    const meses = [];
    const now = new Date();
    for (let i = 5; i >= 0; i--) {
      let fecha = new Date(now);
      fecha.setMonth(now.getMonth() - i);
      const mes = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'][fecha.getMonth()];
      const año = fecha.getFullYear();
      meses.push(`${mes} ${año}`);
    }
    
    // Generar datos aproximados basados en el total de respuestas
    const respuestasPorMes = [];
    const respuestaTotal = info.totalRespuestas || 100;
    const respuestaPromedio = respuestaTotal / 6;
    
    for (let i = 0; i < 6; i++) {
      // Variación basada en el índice para simular tendencia creciente
      const factor = 0.7 + (i * 0.1);
      respuestasPorMes.push(Math.round(respuestaPromedio * factor));
    }
    
    // Crear el gráfico con los datos simulados
    const datos = {
      labels: meses,
      data: respuestasPorMes
    };
    
    crearGraficoRespuestas(datos);
  }
  
  // Variables para almacenar instancias de gráficos y poder destruirlas
  let chartEncuestas = null;
  let chartRespuestas = null;
  let chartFinalizacion = null;
  
  // Función para crear gráfico de encuestas
  function crearGraficoEncuestas(info) {
    // Destruir gráfico anterior si existe
    if (chartEncuestas) {
      chartEncuestas.destroy();
    }

    console.log(info);
    
    // Datos para el gráfico de encuestas (ejemplo: distribución por estado)
    const datosEncuestas = {
      labels: ['Activas', 'Cerradas', 'Pausadas'],
      datasets: [{
        label: 'Encuestas por estado',
        data: [
          info.encuestasActivas || Math.round(info.totalEncuestas * 0.7), // Si no hay dato real, uso un porcentaje aproximado
          info.encuestasCerradas || Math.round(info.totalEncuestas * 0.2),
          info.encuestasPausadas || Math.round(info.totalEncuestas * 0.1)
        ],
        backgroundColor: ['#4e73df', '#e74a3b', '#f6c23e'],
        borderWidth: 1
      }]
    };
    
    chartEncuestas = new Chart(
      document.getElementById('estadisticasEncuestasMunicipio').getContext('2d'),
      {
        type: 'pie',
        data: datosEncuestas,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { boxWidth: 10, padding: 10, font: { size: 10 } }
            }
          }
        }
      }
    );
  }
  
  // Modificar la función para usar datos dinámicos
  function crearGraficoRespuestas(datos) {
    // Destruir gráfico anterior si existe
    if (chartRespuestas) {
      chartRespuestas.destroy();
    }
    
    const datosRespuestas = {
      labels: datos.labels,
      datasets: [{
        label: 'Respuestas',
        data: datos.data,
        borderColor: '#1cc88a',
        backgroundColor: 'rgba(28, 200, 138, 0.1)',
        fill: true,
        tension: 0.4
      }]
    };
    
    chartRespuestas = new Chart(
      document.getElementById('estadisticasRespuestasMunicipio').getContext('2d'),
      {
        type: 'line',
        data: datosRespuestas,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { font: { size: 9 } }
            },
            x: {
              ticks: { font: { size: 9 } }
            }
          }
        }
      }
    );
  }
  
  // Función para crear gráfico de finalización
  function crearGraficoFinalizacion(info) {
    // Destruir gráfico anterior si existe
    if (chartFinalizacion) {
      chartFinalizacion.destroy();
    }
    
    // Datos para la tasa de finalización vs promedio nacional
    const datosFinalizacion = {
      labels: ['Este Municipio', 'Promedio Nacional'],
      datasets: [{
        label: 'Tasa de Finalización (%)',
        data: [info.tasaFinalizacion, info.tasaPromedioNacional || 65], // Valor por defecto si no hay dato real
        backgroundColor: ['#ffc107', '#858796'],
        borderWidth: 1
      }]
    };
    
    chartFinalizacion = new Chart(
      document.getElementById('estadisticasFinalizacionMunicipio').getContext('2d'),
      {
        type: 'bar',
        data: datosFinalizacion,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              beginAtZero: true,
              max: 100,
              ticks: { font: { size: 9 } }
            },
            y: {
              ticks: { font: { size: 9 } }
            }
          }
        }
      }
    );
  }

  // 1) Traigo estadísticas
  fetch('/api/estadisticas-municipios/')
    .then(res => res.json())
    .then(estadisticas => {
      datosEstadisticas = estadisticas;

      // 2) Traigo GeoJSON ya convertido
      fetch("{% static 'kml/Trazado_oleoducto_Cenit.geojson' %}")
        .then(res => res.json())
        .then(geoJson => {
          // 3) Creo layer
          const oleoLayer = L.geoJSON(geoJson, {
            style(feature) {
              // Si es línea (LineString) la pinto fija
              if (feature.geometry.type.includes('LineString')) {
                return { color: '#006837', weight: 4, dashArray: '8,4' };
              }
              // Polígonos (si hubiera), con escala:
              const key = (feature.properties.nombre || feature.properties.name || '').toUpperCase();

              // Si no existe la clave, asigno 0 a todas las estadísticas
              const d = datosEstadisticas[key] || { totalEncuestas:0, totalRespuestas:0, tasaFinalizacion:0 };
              return {
                fillColor: getColorForValue(d[tipoEstadisticaActual], tipoEstadisticaActual),
                color: 'white', weight:1, fillOpacity:0.7
              };
            },
            onEachFeature(feature, layer) {
              const p = feature.properties;
              const key = (p.nombre || p.name || '').toUpperCase();
              const d = datosEstadisticas[key] || { totalEncuestas:0, totalRespuestas:0, tasaFinalizacion:0 };
              
              // Si es un LineString, agregar markers en los puntos clave
              if (feature.geometry.type === 'LineString') {
                const coords = feature.geometry.coordinates;
                // Agregar markers al inicio y fin de cada línea
                const startPoint = coords[0];
                const endPoint = coords[coords.length - 1];
                
                // Color basado en las estadísticas
                const color = getColorForValue(d[tipoEstadisticaActual], tipoEstadisticaActual);
                
                // Crear markers con iconos personalizados
                L.marker([startPoint[1], startPoint[0]], {
                  icon: createCustomIcon(color)
                }).bindPopup(`
                  <div class="popup-content">
                    <h6>Inicio: ${p.nombre || p.name}</h6>
                    <p>Región: ${d.region}</p>
                    <hr>
                    <p>Encuestas: ${d.totalEncuestas}</p>
                    <p>Respuestas: ${d.totalRespuestas}</p>
                    <p>Finalización: ${d.tasaFinalizacion}%</p>
                  </div>
                `).addTo(markerLayer);
                
                L.marker([endPoint[1], endPoint[0]], {
                  icon: createCustomIcon(color)
                }).bindPopup(`
                  <div class="popup-content">
                    <h6>Fin: ${p.nombre || p.name}</h6>
                    <p>Región: ${d.region}</p>
                    <hr>
                    <p>Encuestas: ${d.totalEncuestas}</p>
                    <p>Respuestas: ${d.totalRespuestas}</p>
                    <p>Finalización: ${d.tasaFinalizacion}%</p>
                  </div>
                `).addTo(markerLayer);
              }

              layer.bindPopup(`
                <div class="popup-content">
                  <h6>${p.nombre || p.name}</h6>
                  <p>Región: ${d.region}</p>
                  <hr>
                  <p>Encuestas: ${d.totalEncuestas}</p>
                  <p>Respuestas: ${d.totalRespuestas}</p>
                  <p>Finalización: ${d.tasaFinalizacion}%</p>
                </div>
              `);
              
              layer.on({
                mouseover() { layer.setStyle({ weight:5 }); },
                mouseout()  { layer.setStyle({ weight:4 }); },
                click()     { mostrarInfoMunicipio(key); }
              });
            }
          }).addTo(map);

          // 4) Ajusto vista a bounds
          const b = oleoLayer.getBounds();
          if (b.isValid && b.isValid()) map.fitBounds(b);
          else map.setView([4.5709, -74.2973], 6);
        })
        .catch(err => {
          console.error('Error cargando GeoJSON:', err);
          map.setView([4.5709, -74.2973], 6);
        });

      // 5) Botones para cambiar estadística
      document.querySelectorAll('#btnTotalEncuestas, #btnTotalRespuestas, #btnTasaFinalizacion')
        .forEach(btn => btn.addEventListener('click', function() {
          tipoEstadisticaActual = this.id.replace('btn','').toLowerCase();
          markerLayer.clearLayers(); // Limpiar markers existentes
          oleoLayer.eachLayer(layer => {
            const props = layer.feature.properties;
            const key = (props.nombre || props.name).toUpperCase();
            const d = datosEstadisticas[key] || { totalEncuestas:0, totalRespuestas:0, tasaFinalizacion:0 };
            if (layer.setStyle) {
              layer.setStyle({ fillColor: getColorForValue(d[tipoEstadisticaActual], tipoEstadisticaActual) });
            }
          });
          document.querySelectorAll('.btn-group button').forEach(b=>b.classList.remove('active'));
          this.classList.add('active');
        }));
    })
    .catch(err => console.error('Error al cargar estadísticas:', err));
});
</script>

{% endblock %}
