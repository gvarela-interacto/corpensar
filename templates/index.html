{% extends 'base.html' %} 
{% load humanize %} 
{% load static %} 
{% block content %}

<style>
  /* Estilos para las alertas clickeables */
  .alert-clickable {
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 0; /* Elimina el margen inferior para que quede pegado al contenedor */
    position: relative;
    overflow: hidden;
  }

  .alert-clickable:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
  }

  .alert-clickable:active {
    transform: translateY(1px);
  }

  /* Efecto "pulsado" al hacer clic */
  .alert-clickable.active {
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  /* Contenedor de la lista de tiquetera */
  .product-list-container {
    margin-top: -5px; /* Solapa ligeramente con la alerta */
    padding: 15px;
    border-radius: 0 0 5px 5px;
    background-color: #f8f9fa;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-top: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    animation: fadeIn 0.3s ease-out;
  }

  /* Estilos para la lista de tiquetera */
  .product-list-container .list-group {
    margin-bottom: 0;
  }

  .product-list-container .list-group-item {
    border-left: none;
    border-right: none;
    padding: 8px 15px;
    font-size: 0.9rem;
  }

  .product-list-container .list-group-item:first-child {
    border-top: none;
  }

  /* Animaci칩n de carga */
  @keyframes fadeIn {
    from {
      opacity: 0;
      max-height: 0;
    }
    to {
      opacity: 1;
      max-height: 500px;
    }
  }

  /* Estilo para el mensaje de carga */
  .text-center {
    text-align: center;
    padding: 10px;
    color: #6c757d;
  }

  .text-center .bi-hourglass {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  /* Nuevos estilos para las tarjetas de KPI */
  .kpi-card {
    border-radius: 10px;
    transition: transform 0.2s;
  }
  .kpi-card:hover {
    transform: translateY(-5px);
  }
  .chart-container {
    position: relative;
    height: 300px;
    margin-bottom: 1rem;
  }

  /* Estilos para el grid personalizable */
  .bento-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    grid-gap: 15px;
    margin-bottom: 20px;
  }

  .grid-item {
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    cursor: move;
    overflow: hidden;
  }

  .grid-item.dragging {
    opacity: 0.8;
    transform: scale(1.02);
    z-index: 10;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }

  .grid-item .card {
    height: 100%;
    border: none;
    border-radius: 10px;
    overflow: hidden;
  }

  .grid-item .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
  }

  .grid-item .handle {
    display: flex;
    align-items: center;
    cursor: move;
  }

  .grid-item .handle .mdi-drag {
    margin-right: 0.5rem;
    color: #888;
    font-size: 1.2rem;
  }

  .grid-item .handle:hover .mdi-drag {
    color: #333;
  }

  /* Botones de cambio de tama침o */
  .resize-item {
    padding: 0.15rem 0.4rem;
    font-size: 0.75rem;
  }

  .resize-item.active {
    background-color: #6c757d;
    color: white;
    border-color: #6c757d;
  }

  /* Transici칩n suave para cambios de tama침o */
  .grid-item {
    transition: grid-column 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
  }

  /* Tama침os predefinidos para los elementos del grid */
  .grid-item.col-span-4 {
    grid-column: span 4;
  }

  .grid-item.col-span-6 {
    grid-column: span 6;
  }

  .grid-item.col-span-12 {
    grid-column: span 12;
  }

  /* Bot칩n guardar distribuci칩n */
  #saveLayout {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    transition: all 0.2s ease;
  }

  #saveLayout:hover {
    background-color: #e9ecef;
    transform: translateY(-2px);
  }

  #saveLayout:active {
    transform: translateY(0);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .bento-grid {
      grid-template-columns: repeat(6, 1fr);
    }

    .grid-item.col-span-4,
    .grid-item.col-span-6 {
      grid-column: span 6;
    }
  }

  @media (max-width: 576px) {
    .bento-grid {
      grid-template-columns: repeat(1, 1fr);
    }

    .grid-item.col-span-4,
    .grid-item.col-span-6,
    .grid-item.col-span-12 {
      grid-column: span 1;
    }
  }

  .legend {
    line-height: 18px;
    color: #555;
  }
  .legend i {
    width: 18px;
    height: 18px;
    float: left;
    margin-right: 8px;
    opacity: 0.7;
  }
  .popup-content {
    min-width: 200px;
  }
  .popup-content h6 {
    color: #333;
    margin-bottom: 5px;
  }
  .popup-content p {
    margin: 0;
    color: #666;
  }
  .popup-content hr {
    margin: 5px 0;
    border-color: #eee;
  }
</style>

<div class="container-fluid py-4">
  <!-- KPIs Principales -->
  <div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card kpi-card h-100 border-0 shadow-sm">
        <div
          class="position-absolute w-100"
          style="height: 6px; background-color: #0d6efd; top: 0; left: 0"
        ></div>
        <div class="card-body">
          <h5 class="card-title text-muted">Total Encuestas</h5>
          <h2 class="display-4">{{ total_encuestas }}</h2>
          <p class="text-success mb-0">
            <i class="mdi mdi-arrow-up"></i>
            {{ encuestas_activas }} activas
          </p>
        </div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card kpi-card h-100 border-0 shadow-sm">
        <div
          class="position-absolute w-100"
          style="height: 6px; background-color: #198754; top: 0; left: 0"
        ></div>
        <div class="card-body">
          <h5 class="card-title text-muted">Total Respuestas</h5>
          <h2 class="display-4">{{ total_respuestas|intcomma }}</h2>
          <p class="text-success mb-0">
            <i class="mdi mdi-chart-line"></i>
            {{ avg_respuestas }} promedio
          </p>
        </div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card kpi-card h-100 border-0 shadow-sm">
        <div
          class="position-absolute w-100"
          style="height: 6px; background-color: #ffc107; top: 0; left: 0"
        ></div>
        <div class="card-body">
          <h5 class="card-title text-muted">Tasa de Finalizaci칩n</h5>
          <h2 class="display-4">{{ tasa_finalizacion }}%</h2>
          <p class="text-warning mb-0">
            <i class="mdi mdi-flag-checkered"></i>
            promedio general
          </p>
        </div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card kpi-card h-100 border-0 shadow-sm">
        <div
          class="position-absolute w-100"
          style="height: 6px; background-color: #dc3545; top: 0; left: 0"
        ></div>
        <div class="card-body">
          <h5 class="card-title text-muted">Encuestas Sin Respuestas</h5>
          <h2 class="display-4">{{ encuestas_sin_respuestas }}</h2>
          <p class="text-danger mb-0">
            <i class="mdi mdi-alert"></i>
            necesitan atenci칩n
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Alertas -->
  <div class="row mb-4">
    <div class="col-md-6 mb-3">
      <div class="alert alert-warning alert-clickable">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <strong>{{ encuestas_proximo_fin.count }}</strong> encuestas por
        finalizar en 3 d칤as
      </div>

      <div
        id="reorden-products"
        class="product-list-container"
        style="display: none"
      >
        <ul class="list-group">
          {% for encuesta in encuestas_proximo_fin %}
          <li
            class="list-group-item d-flex justify-content-between align-items-center"
          >
            <span class="text-truncate">{{ encuesta.titulo }}</span>
            <span class="badge bg-warning"
              >{{ encuesta.fecha_fin|date:"d M" }}</span
            >
          </li>
          {% empty %}
          <li class="list-group-item text-muted">
            No hay encuestas pr칩ximas a finalizar
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <!-- Grid Personalizable de Gr치ficos -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm mb-3">
        <div
          class="card-header d-flex justify-content-between align-items-center bg-primary text-white"
        >
          <h5 class="mb-0">Panel Personalizable</h5>
          <button id="saveLayout" class="btn btn-sm btn-light">
            <i class="mdi mdi-content-save"></i> Guardar Distribuci칩n
          </button>
        </div>
        <div class="card-body p-3">
          <div class="bento-grid" id="sortableGrid">
            <!-- Gr치fico de Tipos de Preguntas -->
            <div class="grid-item col-span-4" data-id="tipoPreguntasChart">
              <div class="card h-100 shadow-sm">
                <div class="card-header">
                  <h5 class="mb-0">Tipos de Preguntas</h5>
                  <div class="handle">
                    <i class="mdi mdi-drag"></i>
                    <div class="btn-group btn-group-sm ms-2">
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="4"
                      >
                        S
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="6"
                      >
                        M
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="12"
                      >
                        L
                      </button>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="tipoPreguntasChart"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <!-- Gr치fico de Tendencia de Respuestas -->
            <div
              class="grid-item col-span-4"
              data-id="tendenciaRespuestasChart"
            >
              <div class="card h-100 shadow-sm">
                <div class="card-header">
                  <h5 class="mb-0">Tendencia de Respuestas</h5>
                  <div class="handle">
                    <i class="mdi mdi-drag"></i>
                    <div class="btn-group btn-group-sm ms-2">
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="4"
                      >
                        S
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="6"
                      >
                        M
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="12"
                      >
                        L
                      </button>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="tendenciaRespuestasChart"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <!-- Gr치fico de Distribuci칩n por Categor칤a -->
            <div
              class="grid-item col-span-4"
              data-id="distribucionCategoriaChart"
            >
              <div class="card h-100 shadow-sm">
                <div class="card-header">
                  <h5 class="mb-0">Distribuci칩n por Categor칤a</h5>
                  <div class="handle">
                    <i class="mdi mdi-drag"></i>
                    <div class="btn-group btn-group-sm ms-2">
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="4"
                      >
                        S
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="6"
                      >
                        M
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="12"
                      >
                        L
                      </button>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="distribucionCategoriaChart"></canvas>
                  </div>
                  {% if not distribucion_categoria %}
                  <div class="text-center text-muted py-3">
                    <p>No hay datos de categor칤as disponibles</p>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Gr치fico de Distribuci칩n por Regi칩n -->
            <div class="grid-item col-span-4" data-id="distribucionRegionChart">
              <div class="card h-100 shadow-sm">
                <div class="card-header">
                  <h5 class="mb-0">Distribuci칩n por Regi칩n</h5>
                  <div class="handle">
                    <i class="mdi mdi-drag"></i>
                    <div class="btn-group btn-group-sm ms-2">
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="4"
                      >
                        S
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="6"
                      >
                        M
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="12"
                      >
                        L
                      </button>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="distribucionRegionChart"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <!-- Top Municipios -->
            <div class="grid-item col-span-6" data-id="topMunicipios">
              <div class="card h-100 shadow-sm">
                <div class="card-header">
                  <h5 class="mb-0">Top Municipios</h5>
                  <div class="handle">
                    <i class="mdi mdi-drag"></i>
                    <div class="btn-group btn-group-sm ms-2">
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="4"
                      >
                        S
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="6"
                      >
                        M
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="12"
                      >
                        L
                      </button>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-hover">
                      <thead>
                        <tr>
                          <th>Municipio</th>
                          <th class="text-end">Total Encuestas</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for municipio in top_municipios %}
                        <tr>
                          <td>
                            {{ municipio.municipio__nombre|default:"Sin municipio" }}
                          </td>
                          <td class="text-end">{{ municipio.total }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                          <td colspan="2" class="text-center">
                            No hay datos disponibles
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- Mapa de Colombia Interactivo -->
            <div
              class="grid-item col-span-12"
              data-id="mapaColombiaInteractivo"
            >
              <div class="card h-100 shadow-sm">
                <div class="card-header">
                  <h5 class="mb-0">
                    Mapa de Colombia - Estad칤sticas por Municipio
                  </h5>
                  <div class="handle">
                    <i class="mdi mdi-drag"></i>
                    <div class="btn-group btn-group-sm ms-2">
                      <button
                        type="button"
                        class="btn btn-outline-primary"
                        id="btnTotalEncuestas"
                      >
                        Total Encuestas
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-success"
                        id="btnTotalRespuestas"
                      >
                        Total Respuestas
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-warning"
                        id="btnTasaFinalizacion"
                      >
                        Tasa de Finalizaci칩n
                      </button>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div
                    id="mapaColombia"
                    style="height: 500px; width: 100%"
                  ></div>
                  <div
                    id="infoMunicipio"
                    class="mt-3 p-3 border rounded"
                    style="display: none"
                  >
                    <h5 id="nombreMunicipio" class="mb-2"></h5>
                    <div class="row">
                      <div class="col-md-4">
                        <p>
                          <strong>Total Encuestas:</strong>
                          <span id="totalEncuestasMunicipio">0</span>
                        </p>
                      </div>
                      <div class="col-md-4">
                        <p>
                          <strong>Total Respuestas:</strong>
                          <span id="totalRespuestasMunicipio">0</span>
                        </p>
                      </div>
                      <div class="col-md-4">
                        <p>
                          <strong>Tasa de Finalizaci칩n:</strong>
                          <span id="tasaFinalizacionMunicipio">0%</span>
                        </p>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-4">
                        <div class="chart-container" style="height: 200px">
                          <canvas id="estadisticasEncuestasMunicipio"></canvas>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="chart-container" style="height: 200px">
                          <canvas id="estadisticasRespuestasMunicipio"></canvas>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="chart-container" style="height: 200px">
                          <canvas
                            id="estadisticasFinalizacionMunicipio"
                          ></canvas>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 칔ltimas Respuestas -->
            <div class="grid-item col-span-6" data-id="ultimasRespuestas">
              <div class="card h-100 shadow-sm">
                <div class="card-header">
                  <h5 class="mb-0">칔ltimas Respuestas</h5>
                  <div class="handle">
                    <i class="mdi mdi-drag"></i>
                    <div class="btn-group btn-group-sm ms-2">
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="4"
                      >
                        S
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="6"
                      >
                        M
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm resize-item"
                        data-size="12"
                      >
                        L
                      </button>
                    </div>
                  </div>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-hover mb-0">
                      <thead>
                        <tr>
                          <th>Encuesta</th>
                          <th>Usuario</th>
                          <th>Fecha</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for respuesta in ultimas_respuestas %}
                        <tr>
                          <td>
                            <a href="#" class="text-dark">
                              {{ respuesta.encuesta.titulo|truncatechars:30 }}
                            </a>
                          </td>
                          <td>
                            {% if respuesta.usuario %} {{
                            respuesta.usuario.username|truncatechars:15 }} {%
                            else %}
                            <span class="text-muted">An칩nimo</span>
                            {% endif %}
                          </td>
                          <td>
                            {{ respuesta.fecha_respuesta|date:"d M H:i" }}
                          </td>
                        </tr>
                        {% empty %}
                        <tr>
                          <td colspan="3" class="text-center py-4 text-muted">
                            No hay respuestas recientes
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
      // Inicializar grid personalizable
      const sortableGrid = document.getElementById('sortableGrid');
      if (sortableGrid) {
          // Cargar configuraci칩n guardada si existe
          loadGridLayout();

          // Inicializar SortableJS
          const sortable = new Sortable(sortableGrid, {
              animation: 150,
              handle: '.handle',
              draggable: '.grid-item',
              onStart: function(evt) {
                  evt.item.classList.add('dragging');
              },
              onEnd: function(evt) {
                  evt.item.classList.remove('dragging');

                  // Actualizar charts despu칠s de mover para asegurar que se rendericen correctamente
                  window.setTimeout(function() {
                      updateCharts();
                  }, 100);
              }
          });

          // Configurar bot칩n para guardar layout
          const saveButton = document.getElementById('saveLayout');
          if (saveButton) {
              saveButton.addEventListener('click', function() {
                  saveGridLayout();
                  alert('Distribuci칩n guardada correctamente');
              });
          }

          // Configurar botones para cambiar tama침o
          const resizeButtons = document.querySelectorAll('.resize-item');
          resizeButtons.forEach(button => {
              button.addEventListener('click', function(e) {
                  e.preventDefault();
                  e.stopPropagation();

                  const size = this.getAttribute('data-size');
                  const gridItem = this.closest('.grid-item');

                  // Remover todas las clases de tama침o
                  gridItem.classList.remove('col-span-4', 'col-span-6', 'col-span-12');

                  // A침adir la clase de tama침o seleccionada
                  gridItem.classList.add(`col-span-${size}`);

                  // Actualizar los botones para mostrar cu치l est치 activo
                  const buttons = gridItem.querySelectorAll('.resize-item');
                  buttons.forEach(btn => {
                      btn.classList.remove('active');
                      if (btn.getAttribute('data-size') === size) {
                          btn.classList.add('active');
                      }
                  });

                  // Actualizar charts despu칠s de cambiar el tama침o
                  window.setTimeout(function() {
                      updateCharts();
                  }, 100);
              });
          });

          // Establecer los botones activos seg칰n el tama침o actual de cada elemento
          const gridItems = document.querySelectorAll('.grid-item');
          gridItems.forEach(item => {
              let currentSize = '4'; // tama침o por defecto

              if (item.classList.contains('col-span-12')) {
                  currentSize = '12';
              } else if (item.classList.contains('col-span-6')) {
                  currentSize = '6';
              }

              // Marcar el bot칩n correspondiente como activo
              const button = item.querySelector(`.resize-item[data-size="${currentSize}"]`);
              if (button) {
                  button.classList.add('active');
              }
          });
      }

      function loadGridLayout() {
          try {
              const savedLayout = localStorage.getItem('dashboardLayout');
              if (savedLayout) {
                  const layout = JSON.parse(savedLayout);

                  // Aplicar orden
                  if (layout.order && layout.order.length > 0) {
                      for (let i = 0; i < layout.order.length; i++) {
                          const itemId = layout.order[i];
                          const item = document.querySelector(`.grid-item[data-id="${itemId}"]`);
                          if (item) {
                              sortableGrid.appendChild(item);
                          }
                      }
                  }

                  // Aplicar tama침os
                  if (layout.sizes) {
                      for (const itemId in layout.sizes) {
                          const item = document.querySelector(`.grid-item[data-id="${itemId}"]`);
                          if (item) {
                              // Remover clases de tama침o existentes
                              item.classList.remove('col-span-4', 'col-span-6', 'col-span-12');
                              // A침adir nueva clase de tama침o
                              item.classList.add(`col-span-${layout.sizes[itemId]}`);
                          }
                      }
                  }
              }
          } catch (error) {
              console.error('Error al cargar la configuraci칩n del dashboard:', error);
          }
      }

      function saveGridLayout() {
          try {
              // Guardar orden actual
              const items = sortableGrid.querySelectorAll('.grid-item');
              const order = [];
              const sizes = {};

              items.forEach(item => {
                  const itemId = item.getAttribute('data-id');
                  order.push(itemId);

                  // Determinar tama침o
                  let size = 4; // Tama침o predeterminado
                  if (item.classList.contains('col-span-12')) {
                      size = 12;
                  } else if (item.classList.contains('col-span-6')) {
                      size = 6;
                  }

                  sizes[itemId] = size;
              });

              const layout = {
                  order: order,
                  sizes: sizes
              };

              localStorage.setItem('dashboardLayout', JSON.stringify(layout));
          } catch (error) {
              console.error('Error al guardar la configuraci칩n del dashboard:', error);
          }
      }

      function updateCharts() {
          // Reconstruir gr치ficos si es necesario
          if (window.categoriaChartObj) {
              window.categoriaChartObj.resize();
          }
          if (window.regionChartObj) {
              window.regionChartObj.resize();
          }
      }

      // Gr치fico de Tipos de Preguntas
      const tipoPreguntasData = {
        labels: [
          {% for tipo in tipos_preguntas %}
            "{{ tipo.tipo }}"{% if not forloop.last %},{% endif %}
          {% endfor %}
        ],
        datasets: [{
          data: [
            {% for tipo in tipos_preguntas %}
              {{ tipo.total }}{% if not forloop.last %},{% endif %}
            {% endfor %}
          ],
          backgroundColor: [
            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e',
            '#e74a3b', '#858796', '#5a5c69', '#6f42c1', '#20c997'
          ],
          hoverOffset: 10
        }]
      };

      new Chart(document.getElementById('tipoPreguntasChart').getContext('2d'), {
        type: 'doughnut',
        data: tipoPreguntasData,
        options: {
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { boxWidth: 15, padding: 20 }
            }
          }
        }
      });

      // Gr치fico de Tendencia de Respuestas
      const tendenciaData = {
        labels: [
          {% for item in tendencia_respuestas %}
            "{{ item.fecha|date:'d M' }}"{% if not forloop.last %},{% endif %}
          {% endfor %}
        ],
        datasets: [{
          label: 'Respuestas',
          data: [
            {% for item in tendencia_respuestas %}
              {{ item.total }}{% if not forloop.last %},{% endif %}
            {% endfor %}
          ],
          borderColor: '#4e73df',
          backgroundColor: 'rgba(78, 115, 223, 0.1)',
          fill: true,
          tension: 0.4
        }]
      };

      new Chart(document.getElementById('tendenciaRespuestasChart').getContext('2d'), {
        type: 'line',
        data: tendenciaData,
        options: {
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                drawBorder: false
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });

      // Gr치fico de Distribuci칩n por Categor칤a
      const categoriaData = {
        labels: [
          {% for item in distribucion_categoria %}
            "{{ item.categoria__nombre|default:'Sin categor칤a' }}"{% if not forloop.last %},{% endif %}
          {% endfor %}
        ],
        datasets: [{
          label: 'Encuestas por Categor칤a',
          data: [
            {% for item in distribucion_categoria %}
              {{ item.total }}{% if not forloop.last %},{% endif %}
            {% endfor %}
          ],
          backgroundColor: [
            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e',
            '#e74a3b', '#858796', '#5a5c69', '#6f42c1', '#20c997',
            '#6610f2', '#fd7e14', '#dc3545', '#6c757d', '#28a745'
          ],
          borderColor: 'rgba(255, 255, 255, 0.8)',
          borderWidth: 1
        }]
      };

      // Inicializar gr치fico de categor칤as como circular (pie)
      window.categoriaChartObj = new Chart(document.getElementById('distribucionCategoriaChart').getContext('2d'), {
        type: 'pie',
        data: categoriaData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                boxWidth: 15,
                padding: 20
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  if (label.includes('Tasa Finalizaci칩n')) {
                    return `${label}: ${value}%`;
                  }
                  return `${label}: ${value}`;
                }
              }
            }
          }
        }
      });

      // Gr치fico de Distribuci칩n por Regi칩n
      const regionData = {
        labels: [
          {% for region in distribucion_region %}
            "{{ region.region__nombre|default:'Sin regi칩n' }}"{% if not forloop.last %},{% endif %}
          {% endfor %}
        ],
        datasets: [{
          label: 'Encuestas por Regi칩n',
          data: [
            {% for region in distribucion_region %}
              {{ region.total }}{% if not forloop.last %},{% endif %}
            {% endfor %}
          ],
          backgroundColor: [
            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e',
            '#e74a3b', '#858796', '#5a5c69', '#6f42c1', '#20c997',
            '#6610f2', '#fd7e14', '#dc3545', '#6c757d', '#28a745'
          ],
          borderColor: 'rgba(255, 255, 255, 0.8)',
          borderWidth: 1
        }]
      };

      window.regionChartObj = new Chart(document.getElementById('distribucionRegionChart').getContext('2d'), {
        type: 'pie',
        data: regionData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                boxWidth: 15,
                padding: 20
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  if (label.includes('Tasa Finalizaci칩n')) {
                    return `${label}: ${value}%`;
                  }
                  return `${label}: ${value}`;
                }
              }
            }
          }
        }
      });

      // Funcionalidad para mostrar/ocultar las listas de alertas
      document.querySelectorAll('.alert-clickable').forEach(alert => {
        alert.addEventListener('click', function() {
          const targetId = this.dataset.target;
          const targetElement = document.getElementById(targetId);
          if (targetElement) {
            targetElement.style.display = targetElement.style.display === 'none' ? 'block' : 'none';
          }
        });
      });
  });
</script>

<!-- CSS de Leaflet para mapas -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>

<!-- Aseg칰rate de haber cargado antes Leaflet y Omnivore -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const mapaContainer = document.getElementById('mapaColombia');
  if (!mapaContainer) return;

  const map = L.map('mapaColombia').setView([4.5709, -74.2973], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let datosEstadisticas = {};
  let tipoEstadisticaActual = 'totalEncuestas';

  function getColorForValue(value, tipo) {
    const scales = {
      totalEncuestas: ['#f7fbff','#deebf7','#c6dbef','#9ecae1','#6baed6','#4292c6','#2171b5','#08519c'],
      totalRespuestas: ['#f7fcf5','#e5f5e0','#c7e9c0','#a1d99b','#74c476','#41ab5d','#238b45','#005a32'],
      tasaFinalizacion: ['#fff5eb','#fee6ce','#fdd0a2','#fdae6b','#fd8d3c','#f16913','#d94801','#8c2d04']
    };
    const colors = scales[tipo] || scales.totalEncuestas;
    let idx = tipo === 'tasaFinalizacion'
      ? Math.min(Math.floor(value/12.5), colors.length-1)
      : Math.min(Math.floor(Math.log2(value+1)), colors.length-1);
    return colors[idx];
  }

  // 1) Traigo estad칤sticas
  fetch('/api/estadisticas-municipios/')
    .then(res => res.json())
    .then(estadisticas => {
      datosEstadisticas = estadisticas;

      // 2) Cargo el KML
      const kmlUrl = "{% static 'kml/Trazado oleoducto Cenit.kml' %}";
      const kmlLayer = omnivore.kml(kmlUrl)
        .on('ready', function() {

          console.log('游댌 KML cargado, capas:', this.getLayers().length);
          
          // 3) Pinta cada feature seg칰n datos
          this.eachLayer(layer => {
            const geom = layer.feature.geometry.type;
            const isLine = geom.includes('LineString');

            if (layer.setStyle) {
            if (isLine) {
              // l칤neas visibles siempre
              layer.setStyle({ color:'#006837', weight:4, dashArray:'8,4' });
            } else {
              // pol칤gonos (si hay), usando datos
              const props = layer.feature.properties;
              const key   = (props.nombre||props.name).toUpperCase();
              const d     = datosEstadisticas[key] || { totalEncuestas:0, totalRespuestas:0, tasaFinalizacion:0 };
              layer.setStyle({
                fillColor: getColorForValue(d[tipoEstadisticaActual], tipoEstadisticaActual),
                color:'white', weight:1, fillOpacity:0.7
              });
            }
          }

            // pop-up
            layer.bindPopup(`
              <strong>${props.nombre||props.name}</strong><br>
              Regi칩n: ${d.region}<br>
              Encuestas: ${d.totalEncuestas}<br>
              Respuestas: ${d.totalRespuestas}<br>
              Finalizaci칩n: ${d.tasaFinalizacion}%
            `);

            // interactividad
            layer.on({
              mouseover()  { if (layer.setStyle) layer.setStyle({ fillOpacity:0.9, weight:2 }); },
              mouseout()   { if (layer.setStyle) layer.setStyle({ fillOpacity:0.7, weight:1 }); },
              click()      { mostrarInfoMunicipio(key); }
            });
          });

          const bounds = this.getBounds();
          if (bounds.isValid && bounds.isValid()) {
            map.fitBounds(bounds);
          } else {
            console.warn('Bounds inv치lidos, uso vista por defecto');
            map.setView([4.5709, -74.2973], 6);
          }
        })
        .on('error', err => console.error('Error cargando KML:', err))
        .addTo(map);

      // 5) Botones para cambiar estad칤stica
      document.querySelectorAll('#btnTotalEncuestas, #btnTotalRespuestas, #btnTasaFinalizacion')
        .forEach(btn => btn.addEventListener('click', function() {
          tipoEstadisticaActual = this.id.replace('btn','').toLowerCase();
          kmlLayer.eachLayer(layer => {
            const props = layer.feature.properties;
            const key = (props.nombre || props.name).toUpperCase();
            const d = datosEstadisticas[key] || { totalEncuestas:0, totalRespuestas:0, tasaFinalizacion:0 };
            if (layer.setStyle) {
              layer.setStyle({ fillColor: getColorForValue(d[tipoEstadisticaActual], tipoEstadisticaActual) });
            }
          });
          // actualizar leyenda aqu칤...
          document.querySelectorAll('.btn-group button').forEach(b=>b.classList.remove('active'));
          this.classList.add('active');
        }));
    })
    .catch(err => console.error('Error al cargar estad칤sticas:', err));
});
</script>

{% endblock %}
